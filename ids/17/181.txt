[3] 
[[ファイル名]]における[[文字]]の取り扱いは難しい問題です。


* 文字コード

[18] [[ファイル名]]が[[文字列]]なのか[[バイト列]]なのか問題があります。

[20] 
表示と安全性については[[識別子文字]]、[[ファイル名安全]]も参照。

* 文字の制限


[4] 
多くのファイル・システムやその実装では、その環境で使える文字の全てかファイル名に使えるわけではない。例えば、 [[FAT]] や [[NTFS]] ではディレクトリ (フォルダ) 区切子として使われる [CODE(file)[\]] を名前に使うことが出来ない。

[1] [[特別なファイル名]]も参照。

* 大文字と小文字

[5] 
[DFN[ファイル名における大文字と小文字]]の取り扱いは、
[[プラットフォーム]]と[[ファイルシステム]]に依存する複雑な問題です。

[6] 
[[大文字と小文字]]の違いは、単にその[[プラットフォーム]]内部だけの問題に留まりません。
例えば[[大文字と小文字]]を区別しない[[プラットフォーム]]で作られた [[HTML文書]]中の[[相対URL]]
に[[大文字と小文字]]の違いを気にしないで[[ファイル名]]を書くと、
区別される[[プラットフォーム]]に移動したときに[[リンク]]が機能しなくなります。

[7] 
[[比較]] ([[ファイル]]の参照や[[ファイル名]]の衝突の判定)
において[[大文字と小文字]]を区別するかという問題と、
[[ファイル名]]が[[大文字と小文字]]を[[正規化]]した状態で保存されるかという問題があります。

[8] 
その他に比較的軽微な問題として、
[[大文字と小文字]]のみ異なる[[改名]]が可能かどうか、
[[整列]]でどう扱われるかなどの問題もあります。

[9] 
当該[[ファイルシステム]]でどのような[[文字コード]]を使うかにより、
[[大文字と小文字]]の変換や同一視が行われる[[文字集合]]の範囲も変わってきます。
[[ロケール]]等で異なる[[大文字と小文字]]の扱いや、
[[Unicodeの版]]による違いを[[ファイルシステム]]や[[プラットフォーム]]の [[API]]
でどう扱うかも問題になってきます。

[10] 
[[ファイルシステム]]をまたがる移動、
[[書庫ファイル]]や[[ネットワーク]]による転送などで、
取り扱いの違いが問題となることがあります。

[EG[

[11] 
例えば[[ファイル名]]をすべて[[大文字]]に置き換える必要が生じたり、
2つの[[ファイル]]の[[ファイル名]]が衝突するので保存できなかったりします。

]EG]

[12] 
[[ファイルシステム]]によっては[[長いファイル名]]と[[短いファイル名]]のような異なる[[ファイル名]]を1つの[[ファイル]]に与えることが出来る場合がありますが、
[[ファイル名]]ごとに適用される規則が違うことがあります。

;; [36] [[識別子文字]]も参照。

-*-*-

[21] 
[[ISO 9660]] では[[大文字]]と[[小文字]]を区別しません。

[23] 
[[OpenVMS]] の [[ODS-2]],
[[NetWare]] の [[NSS]], [[NWFS]] も区別しないとのこと。

[22] 
[[APFS]] は[[大文字]]と[[小文字]]を区別しないモード (既定値)
と区別するモードがあります。

[24] 
[[OpenVMS]] の [[ODS-5]] も両モードあって区別しないのが既定値とのこと。

[25] 
[[HFS+]] の既定値は不区別、 [[case-preserving]] で、区別するモードもある。

[31] 
[[NTFS]] は不区別、 [[case-preserving]] で、[[フォルダー]]単位で区別させることもできる。
[SRC[>>30]]

[33] 
[[ext4]] は区別しますが、[[ディレクトリー]]単位で区別させないこともできます。
[SRC[>>32]]


[19] [CITE@ja[ファイルシステムと大文字小文字 #case-sensitive - Qiita]], [TIME[2024-07-13T08:56:28.000Z]] <https://qiita.com/jokester/items/f8a106832af2d3eb3436>

[REFS[

- [30] [CITE@ja[ASCII.jp:Windows 10 RS5で改良されたファイル名の大文字/小文字の区別 (1/2)]], [[ASCII]], [TIME[2024-07-13T09:10:46.000Z]] <https://ascii.jp/elem/000/001/786/1786156/>
- [32] 
[CITE@ja[fast23-basu.pdf]], [TIME[2024-07-13T09:15:00.000Z]] <https://www.usenix.org/system/files/fast23-basu.pdf>



]REFS]

[42] 
[CITE@en[Using the Linux kernel's Case-insensitive feature in Ext4]], [TIME[2024-07-13T09:23:43.000Z]] <https://www.collabora.com/news-and-blog/blog/2020/08/27/using-the-linux-kernel-case-insensitive-feature-in-ext4/>



[29] 
[[FAT]] など古くからある[[ファイルシステム]]では[[ASCII大文字・小文字不区別]]。

[27] 
[[NTFS]] は[[初期化]]時に作られる [CODE[$UpCase]] ファイルで[[大文字と小文字]]の関係を決めている。
[[初期化]]に使った[[プラットフォーム]]が持っている対応表が反映される。
[SRC[>>28, >>26]]

[REFS[

- [28] [CITE@en[$UpCase (10) - File - NTFS Documentation]], [TIME[2022-06-12T19:25:54.000Z]], [TIME[2024-07-13T09:07:53.509Z]] <https://flatcap.github.io/linux-ntfs/ntfs/files/upcase.html>
- [26] [CITE@ja[グルジア文字と case insensitive filesystem - 彷徨えるフジワラ]], [TIME[2024-07-13T09:06:20.000Z]] <https://flying-foozy.hatenablog.com/entry/20120101/1325384327>

]REFS]

[44] 
[CITE@ja[トルコ文字と case insensitive filesystem - 彷徨えるフジワラ]], [TIME[2024-07-13T09:28:49.000Z]] <https://flying-foozy.hatenablog.com/entry/20120102/1325473117>


[43] 
[CITE@en[Internationalization for the NFSv4 Protocols]], [[David Noveck]], [TIME[2023-11-20T13:13:48.000Z]], [TIME[2024-07-13T09:25:12.609Z]] <https://www.ietf.org/archive/id/draft-ietf-nfsv4-internationalization-07.html#section-6.3>




* 正規化

;; [37] [[識別子文字]]も参照。

[38] [[Unicode正規化]]は破壊的処理なので要注意です。

[39] [[HFS+]] はデータ破壊を避けるために独自の手法を使っています。
[SEE[ [[HFS+のNFD]] ]]


[40] 
>>34 >>35 は [[NFC]] と [[full case folding]] を採用しています。

[41] >>40 本当に実装されているのかは謎。まあこれはファイルの要件なので、
意図的にそういうファイルを作ろうとしなければ自然に満たせる、か?


- [34] 
[CITE@en[Case folding of the file names · Issue #1631 · w3c/epub-specs · GitHub]], [TIME[2024-07-13T09:18:37.000Z]] <https://github.com/w3c/epub-specs/issues/1631>
- [35] [CITE@en[Require Unicode full case folding and NFC normalization by mattgarrish · Pull Request #1648 · w3c/epub-specs · GitHub]], [TIME[2024-07-13T09:19:25.000Z]] <https://github.com/w3c/epub-specs/pull/1648/files>


[45] [CITE@ja[case の insensitive と preserve - 彷徨えるフジワラ]], [TIME[2024-07-13T09:29:36.000Z]] <https://flying-foozy.hatenablog.com/entry/20120104/1325657430>

* プラットフォームとファイルシステムの事情

** MIME ファイル名

[2] [CODE[filename=""]] も参照。

** ZIP ファイル



[53] 
[[ZIPファイル]]の仕様では[[ファイル名]]の[[文字コード]]は
[[CP437]]
とされますが、実際には各[[プラットフォーム]]の各言語環境の[[文字コード]]として扱われていました。

[54] 
例えば[[日本]]の [[DOS]] 系[[プラットフォーム]]では [[CP932]] が使われてきました。

[55] 
比較的新しく [[UTF-8]]
であることを[[中央ディレクトリー]]の
[[general purpose bit flag]] 第11ビット ([N[0x0800]])
で明示できるようになりました。

[58] 
現在では [[UTF-8]] フラグを利用して出力する実装が多くなってきており、
[[ZIP]] を使う[[ファイル形式]]等でこれの利用を要求する技術仕様もあります。

[13] 
一方で [[UTF-8]] 以外の [[ZIPファイル]]も過去に作成され大量に蓄積されていますし、
現在でも依然として生産され続けている実情があります。


[59] 
[[後方互換性]]のため、実装は、

- [60] フラグなし、各種文字コード
- [61] フラグなし、 [[UTF-8]]
- [62] フラグあり、 [[UTF-8]]

の読み込みに対応する必要があります。

[FIG(middle list)[ [67] [[ファイル名]]で使われることがあるとされる[[文字コード]] [要出典]

- [[CP437]]
- [[CP850]]
- [[CP857]]
- [[CP866]] ([CODE[ibm866]])
- [[CP932]] ([CODE[shift_jis]])
- [[CP936]] ([CODE[gb18030]])
- [[CP950]] ([CODE[big5]])
- [[CP949]] ([CODE[euc-kr]])
- [[CP874]] ([CODE[windows-874]])
- [[CP1250]] ([CODE[windows-1250]])
- [[CP1251]] ([CODE[windows-1251]])
- [[CP1252]] ([CODE[windows-1252]])
- [[CP1253]] ([CODE[windows-1253]])
- [[CP1254]] ([CODE[windows-1254]])
- [[CP1255]] ([CODE[windows-1255]])
- [[CP1256]] ([CODE[windows-1256]])
- [[UTF-8]] ([CODE[utf-8]])

]FIG]

[68] 
同じ [[UTF-8]] でも [[Windows]] などでは [[NFC]] 系の[[正規化]]に近い状態が一般的で
(ただし必ずしも[[正規化]]されるわけではない)、
[[Mac]] では [[NFD]] 系の[[正規化]]が適用されている状態
([SEE[ [[HFS+のNFD]] ]])
が標準的です。

-*-*-

[56] 
この他に
[[Extra Field]]
に 
[N[0x7075]] (Info-ZIP Unicode Path Extra Field)
として [[UTF-8]] [[ファイル名]]を通常の[[ファイル名]]と別に格納することができます。

[57] 
現在ではこの方法は一部の実装が読み取りに対応しているものの、書き込みには対応していないか、
特別に指定しないと出力しないようです。

-*-*-

[63] 
[[ファイル名]]の[[文字コード]]は[[ファイル]] ([[ディレクトリー]]を含みます。) 
ごとに違うものとできます。

[64] 
異なる[[文字コード]]の[[ファイル名]]の混在に対応している実装もありますが、
対応していない実装もあります。

[EG[
[65]
例えば[[文字コード]]の扱いが異なる[[アプリケーション]]によって[[ファイル]]を追加することで、
そのような[[ZIP]]ファイルが生成される可能性があります。
]EG]

*** 自動判定


[76] 
実装関連:

[REFS[

- [77] 
[CITE@en[Bug #177929 “Should autodetect filename character encoding in zi...” : Bugs : file-roller package : Ubuntu]], [TIME[2025-05-16T09:43:23.000Z]] <https://bugs.launchpad.net/ubuntu/+source/file-roller/+bug/177929>
- [78] 
[CITE@ja[Develop/UnzipTestcase - Ubuntu Japanese Wiki]], [TIME[2025-05-16T09:43:54.000Z]] <https://wiki.ubuntulinux.jp/Develop/UnzipTestcase>


]REFS]

[81] 
[CITE@en[GitHub - vlm/zip-fix-filename-encoding: Fix cyrillic character encoding of filenames inside zip archives]], [TIME[2025-05-16T10:03:38.000Z]] <https://github.com/vlm/zip-fix-filename-encoding>

>Convert filenames inside ZIP archives from autodetected older Russian encodings (koi8-r, koi8-u, cp866, windows-1251) to UTF-8.




*** 実ファイル例

[69] 各種[[文字コード]]の[[ファイル名]]の入った[[ZIPファイル]]:

[REFS[

- [14] [[CP874]]
-- [15] 
[TIME[2025-05-17T03:38:24.000Z]] <https://pathumthani.industry.go.th/th/3/content>
--- [16] 
<https://pathumthani.industry.go.th/web-upload/45x67bf7a6fe8eeb7d38245cecd679435cf/m_document/28692/99893/file_download/3a457beb0c64023c079bb0275d87b88f.zip>
- [72] [[CP932]] 
-- [74] 
[TIME[2025-05-12T12:47:57.00Z]]
<https://www.city.yokohama.lg.jp/tsuzuki/kusei/koho/koho_tsuzuki/kohoback/R2tzkoho.files/2004tsuzuki-text.zip>
-- [75] 
[TIME[2025-05-12T12:53:38.00Z]]
<https://www.city.yokohama.lg.jp/totsuka/shokai/gaiyo/totsukafuoto/kategori_sagasu/sonota/c04-01-mt_fuji01.files/c04-01-0006.zip>
-- [73] 
[TIME[2025-05-12T11:46:36.00Z]]
<https://www2s.biglobe.ne.jp/~ant/gaiji.zip>
--- ([[半角カタカナ]])
-- >>78
- [79] [[EUC-JP]]
-- >>78
--- [80] 
<https://wiki.ubuntulinux.jp/Develop/UnzipTestcase?action=AttachFile&do=get&target=unzip_EUC-JP_testfile.zip>
- [71] [[CP950]]
-- [70] 
[TIME[2025-05-12T11:45:46.700Z]]
<https://www.cns11643.gov.tw/opendata/MapingTables.zip>
- [17] [[CP1252]]
-- [46] 
[CITE@fr[Recherche - Les services de l'État en Gironde]], [TIME[2025-05-22T02:50:00.000Z]], [TIME[2025-05-23T10:54:08.958Z]] <https://www.gironde.gouv.fr/contenu/recherche/(offset)/1350?SearchText=&dateFilter[]=>
--- [47] 
<https://www.gironde.gouv.fr/contenu/telechargement/45738/310633/file/G%C3%A9n%C3%A9rac.zip>
---- [48] [CODE[[[Content-Language]]: [[fr-FR]]]]



]REFS]



* メモ