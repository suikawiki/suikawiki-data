[3] [DFN[[CODE(URI)@en[[[blob:]]]] [[URL]]]] は [CODE(DOMi)@en[[[Blob]]]] や 
[CODE(DOMi)@en[[[File]]]] を表すために使われます。

* 仕様書

[REFS[
- [2] '''[CITE[File API]] ([TIME[2011-05-18 03:16:07 +09:00]] 版) <http://dev.w3.org/2006/webapi/FileAPI/#url>'''
- [30] [CITE@en[URL Standard]] ([TIME[2015-07-07 17:17:42 +09:00]] 版) <https://url.spec.whatwg.org/#concept-url-object>
- [35] [CITE@en[URL Standard]] ([TIME[2015-07-07 17:17:42 +09:00]] 版) <https://url.spec.whatwg.org/#local-scheme>
- [32] [CITE@en[URL Standard]] ([TIME[2015-07-07 17:17:42 +09:00]] 版) <https://url.spec.whatwg.org/#concept-url-parser>
- [34] [CITE@en[URL Standard]] ([TIME[2015-07-07 17:17:42 +09:00]] 版) <https://url.spec.whatwg.org/#concept-url-origin>
- [37] [CITE@en-US[Fetch Standard]] ([TIME[2015-07-07 18:54:30 +09:00]] 版) <https://fetch.spec.whatwg.org/#concept-basic-fetch>
]REFS]

* 構文

[14] [DFN[[[Blob URL]]]] は、 [[URL scheme]] [CODE(URI)@en[[[blob:]]]]
の後に[[起源]]、 [CODE[[[/]]]]、 [[UUID]] を続けたものです。
[[素片識別子]]を使うこともできます。 [SRC[>>2]]

[FIG(railroad)[
= [CODE(URI)@en[[[blob:]]]]
= [[起源]]
= [CODE[[[/]]]]
= [[UUID]]
= ?
== [CODE[#]]
== [[素片識別子]]
]FIG]

[10] [[Blob URL]] を生成する手順である
[DFN[[RUBYB[Blob URLのUnicode直列化]@en[Unicode Serialization of a Blob URL]]]]は、
次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [11] 文字列を [CODE(URI)@en[[[blob:]]]] とします。
= [13] [[Blob URL]] の[[起源]]の [[Unicode直列化]]を得ます。
== [21] 得られた値が [CODE[[[null]]]] なら、実装依存の値を末尾に連結します。
== [22] それ以外なら、得られた値を末尾に連結します。
= [23] [CODE[[[/]]]] を末尾に連結します。
= [24] [[RFC 4122]] [[UUID]] を生成し、末尾に連結します。
= [25] 得られた文字列を返します。
]FIG]

[27] [[素片識別子]]の処理は [[MIME型]]に依存します。
[[利用者エージェント]]が[[MIME型]]を認識できない時や当該[[資源]]中で意味が無い時は、
無視しなければ[['''なりません''']]。[[素片識別子]]は、
[[資源]]を識別するために使っては[['''なりません''']]。[SRC[>>2]]

* 起源

** Blob URL の生成時

[17] [[Blob URL]] の [[URLの起源]]は、作成する[[メソッド]]が呼び出された時の[[現職設定群オブジェクト]]の[[実効スクリプト起源]]と同じでなければ[['''なりません''']] [SRC[>>2]]。

[18] 直列化した [[Blob URL]] の[[起源]]は、[[起源]]の [[Unicode直列化]]でなければ[['''なりません''']] [SRC[>>2]]。

[20] [[File API]] 仕様書としては、 [CODE(URI)@en[[[http:]]]] と [CODE(URI)@en[[[https:]]]]
が[[起源]]の場合しか規定していません。 [CODE(URI)@en[[[file:]]]] [[URL]]
の[[起源]]は実装依存となっており、例えば 
[CODE(URI)@en[blob:file:///Users/arunranga/702efefb-c234-4988-a73b-6104f1b615ee]]
は実装によっては妥当かもしれませんし、そうでないかもしれません。 [SRC[>>2]]

[19] [[Blob URL]] に対する [[cross-origin]] の[[要求]]は、[[ネットワークエラー]]としなければ[['''なりません''']] [SRC[>>2]]。

** Blob URL の利用時

[26] [CODE(URI)@en[[[blob:]]]] [[URL]] の[[起源]]は、 [[scheme data]]
を[[URLの構文解析]]した結果得られる [[URLの起源]]です。
[[構文解析]]に失敗する場合は、新しい[[大域的に固有な識別子]]です。 [SRC[>>34]]

* 分類

[36] [CODE(URI)@en[[[blob:]]]] [[URL scheme]] は、[[局所スキーム]]です [SRC[>>35]]。

* URL のオブジェクト

[31] [[URL構文解析器]]によって[[構文解析]]した [[URL]] は、
[DFN[[RUBYB[オブジェクト]@en[object]]]]を持つことができます [SRC[>>30]]。

[33] 通常は [[null]] です [SRC[>>30]] が、
[[Blob URL Store]] に [[Blob URL]] が登録されていれば、その
[CODE(DOMi)@en[[[Blob]]]] の[[構造化クローン]]となります [SRC[>>32]]。

[41] [[URLの構文解析]]の時点で [CODE(DOMi)@en[[[Blob]]]] との関連付けが行われることになりますから、
[[自動revoke]]や手動の [CODE(DOMm)@en[[[revokeObjectURL]]]] で [[Blob URL Store]]
から削除されたとしても、既に [[fetch]] が始まっていれば、その [[fetch]]
は成功するはずです。

* 作成

[15] [[Blob URL]] は、次の方法で作成できます。
[FIG(list short)[
- [CODE(JS)@en[[[URL.createObjectURL]]]]
- [CODE(JS)@en[[[URL.createFor]]]]
]FIG]

* fetch

[38] [CODE(URI)@en[[[blob:]]]] [[URL]] の[[基本fetch]]は、次のようにしなければ[['''なりません''']] [SRC[>>37]]。
[FIG(steps)[
= [39] 構文解析した [[URL]] の[[オブジェクト]]が [[null]] なら、[[ネットワークエラー]]を返し、停止します。
= [51] [[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] 以外なら、[[ネットワークエラー]]を返し、
停止します。
= [40] 新しい[[応答]]を作成し、返します。
[FIG(list members)[
[FIGCAPTION[
[[応答]]
]FIGCAPTION]
:[[ヘッダーリスト]]:
[FIG(list)[
= [CODE(HTTP)@en[[[Content-Length]]]]: [[URL]] の[[オブジェクト]]である
[CODE(DOMi)@en[[[Blob]]]] の [CODE(DOMa)@en[[[size]]]]
= [CODE(HTTP)@en[[[Content-Type]]]]: [[URL]] の[[オブジェクト]]である
[CODE(DOMi)@en[[[Blob]]]] の [CODE(DOMa)@en[[[type]]]]
]FIG]
:[[HTTPS状態]]:[[要求]]の[[クライアント]]が [[null]] でなければ、その [[HTTPS状態]]
:[[本体]]:[[URL]] の[[オブジェクト]]である
[CODE(DOMi)@en[[[Blob]]]] の[[読み取り操作]]の結果
]FIG]
]FIG]

;; [48] 実際には[[読み取り操作]]は[[非同期的]]に結果を返すものですから、
[[応答]]も一度に返されるものではなく、[[非同期的]]に[[本体]]が完成してゆくものと考えるべきでしょう。

;; [46] [[読み取り操作]]はエラーになるかもしれません。 [[Fetch Standard]]
には明記されていませんが、他のプロトコルで[[応答]]の途中でエラーとなった場合同様に取り扱うべきと思われます。

;; [42] [[File API]] が[[参考]]として述べている [SRC[>>2]] 次の点は、 [[Fetch Standard]]
には反映されていないようです。これが意図的なものなのかどうか、実装はどうなっているのかは不明です。
[TIME[2015-07-08T12:32:12.00Z]]
[FIG(list)[
- [43] [DEL[[CODE(HTTP)@en[[[GET]]]] 以外の[[要求メソッド]]は、[[ネットワークエラー]]]]
- [45] [[異なる起源]]への要求なら[[ネットワークエラー]]
([CODE(JS)@en[[[document.domain]]]] により[[実効スクリプト起源]]が変化した場合)
- [44] [CODE(DOMi)@en[[[File]]]] の [CODE(DOMa)@en[[[name]]]] が
[CODE(HTTP)@en[[[Content-Disposition:]]]] [[ヘッダー]]の [CODE(MIME)@en[[[filename]]]]
[[引数]]となる
- [47] [[読み取り操作]]を行う前に [CODE(DOMi)@en[[[Blob]]]]
の[[読み取り可能性状態]]が [[closed]] なら、[[ネットワークエラー]]
]FIG]

* 破棄

[16] [[Blob URL]] は、次の方法で [[revoke]] できます。
[FIG(short list)[
- [CODE(JS)@en[[[URL.revokeObjectURL]]]]
]FIG]

[29] [CODE(DOMm)@en[[[createFor]]]] [[メソッド]]で作成された [[Blob URL]]
は、[[自動revoke]]の対象となります。

* 歴史

[28] 当初 [[Gecko]] は [DFN[[CODE(URI)@en[[[moz-filedata:]]]]]] [[URL scheme]]
を使っていました。

* 実装

[1] [CITE[url_constants.cc - chrome/common - Code Search]]
( ([TIME[2011-02-11 16:29:55 +09:00]] 版))
<http://www.google.co.jp/codesearch/p?hl=ja#hfE6470xZHk/chrome/common/url_constants.cc&q=package:chromium>

* 例

[4] 
[PRE(URI example code)[
blob:550e8400-e29b-41d4-a716-446655440000#aboutABBA
]PRE]

[5] [[Chrome]] が [CODE(DOMm)@en[[[createObjectURL]]]] で返す例
[PRE(URI example code)[
blob:http://suika.fam.cx/6ff6e0e9-51d5-41e2-8752-411cbfc3fc7a
]PRE]

* メモ

[6] [CITE[IRC logs: freenode / #whatwg / 20140508]]
( ([TIME[2014-05-12 14:41:45 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20140508#l-839>

[7] [CITE@en[Blob URL Origin]]
( ([[Arun Ranganathan]] 著, [TIME[2014-05-10 06:29:40 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-webapps/2014AprJun/0369.html>

[8] [CITE[Data URL loading is now controlled through a flag. Blob URLs have an ori... · 5b64685 · whatwg/fetch]]
( ([TIME[2014-06-03 03:28:22 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/5b64685a97a7d6f24814172de68399d0225a4cae>

[9] [CITE[Define fetching blob URLs part 1 · a53a57d · whatwg/fetch]]
( ([TIME[2014-07-03 07:38:52 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/a53a57dfc66911686488111d6cd19297cdb5c354#diff-8d4d847e6257b75f4bf8030496281de4L1105>

[12] [CITE@en[Reference File API's read operation https://www.w3.org/Bugs/Public/show_... · ecf0661 · whatwg/fetch]]
( ([TIME[2014-11-27 20:40:40 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/ecf06611c36b4beae4a50fd039957dd8f7238a22>

[FIG(quote)[
[FIGCAPTION[
[49] ([TIME[2015-07-18 08:10:31 +09:00]] 版)
<http://www.iana.org/assignments/uri-schemes/prov/blob>
]FIGCAPTION]

> (last updated 2015-07-17)
> Scheme name:  blob
> Status:  Provisional

]FIG]


[50] [CITE@en[Fix #125: only allow fetching blob URLs with `GET` · whatwg/fetch@53c071b]]
([TIME[2015-09-17 14:40:53 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/53c071b078bf345aaad7e9cbf2d1d425d53c82ef>

[52] [CITE@en[28925 – Append the hyperlink suffix to the URL before resolving]]
([TIME[2016-04-05 14:02:52 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=28925>

[53] [CITE@en[Make the Blob URL creating/revoking methods not be exposed on the ser… · w3c/FileAPI@b9c2275]]
([TIME[2016-04-16 15:35:20 +09:00]] 版)
<https://github.com/w3c/FileAPI/commit/b9c2275df53cf3a808f1f272f3d6134d1b920549>