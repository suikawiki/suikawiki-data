* 仕様書

[REFS[
- [1] [CITE@en[RFC 6570 - URI Template]] ([TIME[2014-10-27 23:08:55 +09:00]] 版) <http://tools.ietf.org/html/rfc6570#section-2.3>
- [16] [CITE@en[RFC 6570 - URI Template]] ([TIME[2014-10-27 23:08:55 +09:00]] 版) <http://tools.ietf.org/html/rfc6570#section-3.2.1>
]REFS]

* 構文

[2] [[雛形式]]に指定する[DFN[[RUBYB[[[変数リスト]]]@en[variable-list]]]]は、
1つ[[以上]]の[[変数指定子]]の[[コンマ]]区切りリストです。 [SRC[>>1]]

[FIG(railroad)[
= [[変数指定子]]
= *
== [CODE[[[,]]]]
== [[変数指定子]]
]FIG]

[3] [DFN[[RUBYB[変数指定子]@en[variable specifier]]]]
([DFN[[[varspec]]]]) は、[[変数名]]と省略可能な[[値修飾子]]です。 [SRC[>>1]]

[FIG(railroad)[
= [[変数名]]
= ?
== [[値修飾子]]
]FIG]

[15] [DFN[[RUBYB[[[値修飾子]]]@en[value modifier]]]]には、
[[接頭辞修飾子]] ([CODE[[[:]]]]) と[[爆発修飾子]] ([CODE[[[*]]]]) があります [SRC[>>1]]。

* 変数名

[4] 変数名は、
[FIG(list)[
- [5] どのような種類の値が期待されるかを[[文書化]]したもの
- [6] [[雛形処理器]]での値の関連付けのための[[識別子]]
- [7] 名前=値の形で[[展開]]するときの名前に使う文字列
]FIG]
... という役割を持ちます [SRC[>>1]]。

[9] [[変数名]]は、[[ASCIIラテン文字]]、[[ASCII数字]]、 [CODE[[[_]]]]、
[[パーセント符号化]]、[CODE[[[.]]]] の1つ以上の列です。ただし
[CODE[[[.]]]] は最初と最後には使えません。 [SRC[>>1]]

[FIG(railroad)[
= |
== [[ASCIIラテン文字]]
== [[ASCII数字]]
== [CODE[[[_]]]]
== [[パーセント符号化]]
= *
== ?
=== [CODE[[[.]]]]
== |
=== [[ASCIIラテン文字]]
=== [[ASCII数字]]
=== [CODE[[[_]]]]
=== [[パーセント符号化]]
]FIG]

[8] [[変数名]]は、[[大文字・小文字を区別します]] [SRC[>>1]]。

[10] [[パーセント符号化]]は[[変数名]]の一部として扱い、
[[復号]]はしません。[[パーセント符号化]]された[[変数名]]とそれを[[復号]]した[[変数名]]は、
異なるものとします。 [SRC[>>1]]

* 展開

[22] 1つの [[URI雛形]]では、同名の[[変数]]はすべて同じ値として処理しなければ[['''なりません''']] [SRC[>>16]]。

;; [23] これは入力として用いられる値が同じであるだけであり、
出力として得られる[[展開]]は異なることがあります。

[11] [[雛形式]]は、[[雛形処理器]]が知らない[[変数]]や、
特別な「[RUBYB[未定義]@en[undefined]]」値に設定された[[変数]]を参照しても構いません [SRC[>>1]]。

;; [12] [[変数]]の値が[[空文字列]]なものと、未定義は異なります [SRC[>>1]]。

[14] [[リスト]]に含まれる個数が0個の時や、[[連想配列]]の名前と値の組の個数が0個の時や、
名前がすべて未定義に関連付けられている時には、未定義とします。 [SRC[>>1]]

[17] 未定義である[[変数]]は、値を持たず、[[展開]]の過程では無視されます [SRC[>>16]]。

[18] [[雛形式]]の[[変数]]のすべてが未定義なら、その[[雛形式]]の[[展開]]は[[空文字列]]です
[SRC[>>16]]。

[21] 定義された[[変数]]の[[展開]]は、次のように求めます。
[FIG(steps)[
= [30] 値が単純な[[文字列]]なら、
== [33] [[接頭辞修飾子]]があれば、適用します [SRC[>>16]]。
== [31] >>13 により[[符号化]]します [SRC[>>16]]。
=- [32] [[爆発修飾子]]は無視します [SRC[>>16]]。
= [24] 値が[[連想配列]]なら、
== [25] [[爆発修飾子]]がなければ、
=== [34] 含まれる名前と値の組のうち、値が定義されているものを使って [SRC[>>16]]、
(名前[SUB[1]]、値[SUB[1]]、名前[SUB[2]]、値[SUB[2]]、...) のようなリストを作成します。
=== [35] リストの要素それぞれに >>13 の[[符号化]]を適用します。
=== [36] リストの要素を [CODE[[[,]]]] で連結します [SRC[>>13]]。
== [26] [[爆発修飾子]]があれば、
=== [37] 含まれる名前と値の組のうち、値が定義されているものについて [SRC[>>16]]、
==== [38] 値が[[空文字列]]で、[[演算子]]が [CODE[[[?]]]] でも [CODE[[[&]]]]
でもなければ、名前に >>13 の[[符号化]]を適用します [SRC[>>16]]。
==== [39] それ以外なら、名前に >>13 の[[符号化]]を適用したものと値に >>13
の[[符号化]]を適用したものを [CODE[[[=]]]] で連結します [SRC[>>16]]。
=== [40] 得られた値を連結します。この時、[[演算子]]が [CODE[[[?]]]] か [CODE[[[&]]]]
なら [CODE[[[&]]]] を、 [CODE[[[;]]]]、[CODE[[[/]]]]、[CODE[[[.]]]]
なら[[演算子]]と同じ[[文字]]を、それ以外なら [CODE[[[,]]]] を区切りに使います。 [SRC[>>16]]
=- [41] [[接頭辞修飾子]]は無視します。
= [42] 値が[[リスト]]なら、
== [44] 構成要素それぞれに >>13 の[[符号化]]を適用します。
== [43] [[爆発修飾子]]がなければ、
=== [48] 各値を [CODE[[[,]]]] で連結します [SRC[>>16]]。
== [45] [[爆発修飾子]]があれば、
=== [46] [[演算子]]が [CODE[[[;]]]], [CODE[[[?]]]], [CODE[[[&]]]] なら、
各値の前に[[変数名]]と [CODE[[[=]]]] を連結します [SRC[>>16]]。
ただし[[変数名]]は[[雛形リテラル]]と同じ方法で[[符号化]]します。
=== [47] 各値を >>40 と同じ文字で区切って連結します [SRC[>>16]]。
]FIG]

[13] 文字列値の[[符号化]]は次のように行います [SRC[>>16]]。
[FIG(steps)[
= [27] [[UTF-8]] で[[符号化]]します。
= [28] [[演算子]]が [CODE[[[+]]]] や [CODE[[[''#'']]]] なら、
[[RFC 3986]] [CODE(ABNF)@en[[[unreserved]]]] と [[RFC 3986]] [CODE(ABNF)@en[[[reserved]]]]
と[[パーセント符号化]]以外は、[[パーセント符号化]]します。
= [29] それ以外なら、[[RFC 3986]] [CODE(ABNF)@en[[[unreserved]]]]
以外は、[[パーセント符号化]]します。
]FIG]

;; [19] [CODE[[[+]]]] や [CODE[[[''#'']]]] では、
入力中の[[パーセント符号化]]以外の [CODE[[[%]]]] は、[[パーセント符号化]]が必要です。
入力中の[[パーセント符号化]]はそのまま出力されます。
なおこれは[[雛形リテラル]]に適用されるのと同じ[[符号化]]です。

;; [20] それ以外では、入力中の[[パーセント符号化]]は認識されず、すべての [CODE[[[%]]]]
は[[パーセント符号化]]が必要です。