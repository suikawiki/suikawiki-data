[2] 
[[文字列]]を[[識別子]]とする場合、[[識別子]]を構成可能な[[文字]]の[[集合]]が問題となります。


* 識別子文字拡張問題

[3] 
旧来[[計算機]]処理において[[識別子]]は [[ASCII文字]]の一部のみ等、
極めて限定的な[[文字]]しか使えないことが非常によくありました。

[4] 
関連:
[[非英語プログラミング言語]], [[国際化]], [[欧米中心主義]],
[[名前文字]],
[[ENR]]

[6]
[CITE[WG20 - Standards]] <http://www.open-std.org/JTC1/SC22/WG20/docs/standards#10176>

ISO/IEC TR 10176 追補1 : プログラム言語の識別子の多文字化に関する推奨


[1] 
[[XML 1.0]] (第4版以前) や [[IDNA2003]] / [[Stringprep]]
は
[[Unicodeの版]]を固定し、その時点で存在していた[[文字]]から[[識別子]]に使える[[文字]]を決めていました。

[5] 
[[XML 1.1]] や [[XML 1.0]] (第5版以降) や [[IDNA2008]] や [[PRECIS]]
は
[[Unicode]] の[[文字特性]]を基に利用可能な条件を定めていて、
新しい[[Unicodeの版]]に自動追随可能としました。

[9] 関連: [[XMLにおける文字]], [[IDNA2008]], [[PRECIS]],
[[Unicodeの版]]



* 記号・特殊文字

[11] 
多くの場合、[[記号]]は[[識別子文字]]に含まれません。しかし何を[[識別子]]で使えない[[記号]]と見なすかには色々な考え方があります。

[12] 
[[記号]]が[[識別子]]で使えないのは、
[[記号]]に[[区切子]]や[[演算子]]など特殊な役割を当てはめるためというのが主な理由です。

[13] 
機能を持っている[[記号]]を[[識別子]]で使えないのは当然として、
現時点で機能を持っていない[[記号]]もできるだけ排除して[[将来の拡張]]に備えるのがいいという考え方と、
[[識別子]]の表現力や処理の簡潔性のため不要な制限はできるだけ排除すべく特別な意味を持たない[[記号]]は[[識別子文字]]に含める考え方があります。

** 排除された記号が使えない問題

[14] 
[[識別子]]に使うべきでない[[記号]]の決定は、かなり難しい問題です。
ある文化圏での常識が他の文化圏でも常識とは限りません。

[15] 
[[日本語]]ではしばしば[[長音]]表記に使われる[CH[〜]]が排除されて実害が生じています。
[SEE[ [[長音]] ]]


[7] [CITE@ja[まゆまゆさんはTwitterを使っています 「多くの人工言語は ASCII のなかに文字を収めようとして ⟨q⟩ に曖昧母音を振ると聞きますけど,X-SAMPA や白氏拼音は ⟨@⟩ や ⟨+⟩ を中母音に使っているんですよ?」 / Twitter]]
(午後9:04 · 2021年5月16日 [TZ[+09:00]], [TIME[2021-06-15T00:39:04.000Z]])
<https://twitter.com/nekw0/status/1393900176620679173>

[8] [CITE@ja[真空さんはTwitterを使っています 「Unicode で文字または数字とされているもののみを使わないと,(正書法に必要な制御文字さえも) インターネット上のサーヴィスのお節介入力フィルタに弾かれてものの名前等に設定できないという例があります.(西洋文化圏のエンジニアは記号や制御文字がまさか使う必要があると思わない)」 / Twitter]]
(午後9:19 · 2021年5月16日 [TZ[+09:00]], [TIME[2021-06-15T04:12:05.000Z]])
<https://twitter.com/masora_m/status/1393903980745428992>

** 識別子安全性

[43] 
[[識別子]]に使える[[文字]]のみによって構成されることを「安全」ということがあります。

[44] 関連:
[[サニタイズ]],
[[URL安全]]

** 識別子で禁止するべき特殊文字

[53] [[応用]]によって事情も異なるとはいえ、実害の方が多く[[識別子]]では使うべきではない[[符号位置]]はいくらかあります。

- [55] [[Unicode符号位置]]でないもの ([[Unicode]] 以外の[[文字コード]]の[[符号位置]]や
[CC[U-110000]] [[以上]]の[[符号位置]]や[[文字]]でない[[バイト]]) 
は、[[相互運用性]]のために禁止するべきです。
- [56] [[サロゲート符号位置]] ([CODE[Cs]]) は[[相互運用性]]と[[セキュリティー][文字のセキュリティー]]のために禁止するべきです。
- [57] [[非文字符号位置]]は[[相互運用性]]のために禁止するべきです。
- [60] [[私用文字]]は[[相互運用性]]のために禁止するべきです。
- [61] [[制御文字]] ([CODE[Cc]]) は[[相互運用性]]と[[セキュリティー][文字のセキュリティー]]のために禁止するべきです。
- [65] [[結合文字]]が先頭にあると直前の[[文字]]と交わり[[表示上の変化][文字のレンダリング]]をもたらすことがあります。
混乱を防ぐため禁止するべきです。
- [93] [[二重ダイアクリティカルマーク]]が末尾にあると直後の[[文字]]と交わり[[表示上の変化][文字のレンダリング]]をもたらすことがあります。
混乱を防ぐため禁止するべきです。


[58] 
[[Unicodeの版]]によって適切な処理が変化することに注意が必要です。

- >>3
- [59] [[未割当符号位置]]を禁止するか、認めるかは慎重な判断が求められます。
- [64] それ以外も分類の変化があり得ることに注意が必要です。

[63] 
状況によって判断が求められるものもあります。

- [62] [CODE[White_Space]] は構文上周囲と[[空白]]によって区別されるべき[[識別子]]では禁止するべきです。
それ以外の場合でも、 [CC[U+0020]] のみを認める、
[CC[U+0020]] に[[正規化]]する、
連続を認めないなど、
実用上の配慮が必要です。
- [70] [[書式文字]]は基本的に禁止するべきです。
-- [71] [[bidi]] に関する制御のための[[文字]]は、それがなければ表現できないものもありますが、
[[フィッシング]]目的で悪用されることもあり ([SEE[ [[文字のセキュリティー]] ]])、
そうでなくても混乱の元で、慎重な対処が必要です。
[EG[
[73] 見かけ上の[[文字]]の表示の順序を反転させて[[利用者]]の判断を誤らせることがあります。
]EG]
-- [72] [CN[ZWJ]] や [CN[ZWNJ]] が、それがなければ表現できないものもありますが、
あってもなくても良い(があった方が見た目がいいなど)程度でも使われることもありますし、
悪用されることもあり、そうでなくても混乱の元で、
慎重な対処が必要です。
[EG[
[74] [[IDNA]] では [[CONTEXTJ]] で制限が加えられています。
]EG]
-- [94] [CODE[Prepended_Concatenation_Mark]] 
は有害性がなく、言語によっては必要なので、認めるべきです。
- [75] [CN[CGJ]] は混乱の元になる可能性があり、場合によっては規制するべきです。
- [76] 利用方法によっては、似た形の文字への配慮が必要です。 >>10
- [82] 利用方法によっては[[bidi規則]]が必要です。 >>83

[89] 
[[ASCII文字]]のうち [CH[-]] は区切りに使うので先頭や末尾に持ってこれないようにしたい、
のような規則を[[非ASCII文字]]にも拡張したいと思うかもしれません。
しかし[[文字]]の使われ方は多様で、あらゆる[[言語]]、
表記法を考慮して適切な規則を設定するのは困難です。
強い動機がない限り、無闇に制約を付けるべきではありません。


[54] 
[[IDNA2008]] は [CODE[IgnorableProperties]],
[[PRECIS]] は [CODE[PrecisIgnorableProperties]]
を定めていて、
[[識別子]]に不適切な[[符号位置]]と説明しています。
しかし他の[[応用]]では必ずしも不適切ではない (むしろ適切な表現のためには認めるべき) 
[[符号位置]]も含まれています。

[EG[
[69] 例えば[[異体選択子]]が含まれますが、適切な表示のために必要な[[言語]]があります。
]EG]


[REFS[

- [87] 
[CITE@en[[[Character set]] "$unicode:Cs | $unicode:Noncharacter_Code_Point | $unicode:private-use | $unicode:Cc | $unicode:Format | $unicode:White_Space | '''['''\u034F''']''' -$unicode:Prepended_Concatenation_Mark"]], [TIME[2024-07-08T01:44:09.000Z]] <https://chars.suikawiki.org/set?expr=%24unicode%3ACs+%7C+%24unicode%3ANoncharacter_Code_Point+%7C+%24unicode%3Aprivate-use+%7C+%24unicode%3ACc+%7C+%24unicode%3AFormat+%7C+%24unicode%3AWhite_Space+%7C+%5B%5Cu034F%5D+-$unicode:Prepended_Concatenation_Mark>
]REFS]

[88] >>87 禁止したほうがいい[[Unicode文字]]のリスト

* 似た字形の文字

[10] 関連: [[文字のセキュリティー]]

[77] 
[[Unicode正規化]]すればいいと思ってしまいますが、安易に適用するのは危険です。 >>45

[80] 
また、違う意味ながら[[字形]]が似ている事例は膨大にありますが、
それらは[[Unicode正規化]]ではまったく解決しません。

[EG[

[81] 例えば[CH[1]]と[CH[I]]と[CH[l]]や[CH[A]]と[CH[Α]]は似ています。

]EG]


** 人間に入力させる識別子

[42] 関連: [[Base58]]

[25] 
[CITE@ja[XユーザーのLove Live! School idol festival 2 MIRACLE LIVE!さん: 「【SIF→SIF2 Memory Album transfer Notice】 We've noticed that many of you having trouble with '''['''SIF1→SIF2 Memory Album transfer''']''' are experiencing issues due to incorrect input of '0' (zero) and 'o' (/oʊ/). If you're encountering this difficulty, please double-check before… https://t.co/U4SoupQ0N4」 / X]], [TIME[午後3:35 · 2024年2月7日][2024-02-07T06:35:02.000Z]], [TIME[2024-02-07T05:29:15.000Z]] <https://twitter.com/lovelive_SIF_GL/status/1755117951295144319>


[26] まともな技術者 (設計者) なら人間に発行するIDには絶対やらないんだけどな。。。
過去に何かしら (まともじゃないシステムに遭遇して) 痛い目をみているから。。。

* 文字の位置による規則

[19] 
多くの[[識別子]]仕様は、[[識別子]]の先頭文字にそれ以外の[[文字]]よりも厳しい制限を与えています。

[20] 
例えば多くの場合[[識別子]]の先頭に[[数字]]は認められません。
また、
[CH[-]]
が認められないことも多いです。
これは構文上[[識別子]]と[[数値]]を両立させる必要性に起因しています。

[21] 
末尾の[[文字]]に制限が加わる場合もあります。

[EG[
[22] [[LDHラベル]]の末尾に [CH[-]] は使えません。
]EG]

[24] 
特定の[[文字]]の連続が規制されることもたまにあります。

[EG[
[27] [[インターネットメールアドレス]]の[[local-part]]では[CH[.]]を連続させられません。
]EG]

[51] 
[[IDNA2008]] / [[PRECIS]] はいくつかの[[文字]]に[[文脈的規則]]を定めています。
複雑な規則ですが、簡単に言えば特定の[[文字]]の並びでのみ特定の[[記号]]を認めています。

-*-*-

[90] 
[[識別子]]が内なる構造を持つ時は、その構造も考慮が必要です。

[EG[
[91] [[ファイル名]]は[[拡張子]]とその前の部分で構成されることが多いです。
[[拡張子]]はそれだけを取り出して使うことがあります。
全体としてだけでなく[[拡張子]]単独のときにも困らないように検査が必要になります。

]EG]

[EG[
[92] 
[[ドメイン名]] ([[IDN]]) は複数の[[名札]]を [CH[.]] で連結して構成されます。
[[IDN]] では[CH[。]]や[CH[⒋]]が[[正規化]]によって[CH[.]]を生成することに注意した処理を必要とします。

]EG]

* 書字方向の規則

[83] 
[[bidi]] アルゴリズムとの関係にも注意が必要です。

[84] 
[[bidi]] の制御のための[[文字]]は悪用されることもあり、
そうでなくても誤用時の混乱は必至で、注意が必要です。
>>71

[85] 
制御用の[[文字]]が皆無でも、[[左横書き]]文字と[[右横書き]]文字の混在や[[識別子]]の前後に置かれる[[文字]]との関係で、
表示が混乱することがあります。

[86] 
[[IDNA2008]] / [[PRECIS]] は[[bidi規則]]を定めています。簡単に言えば[[左横書き]]と[[右横書き]]の混在を禁止しています。


* 正規化

[45] [[識別子]]は[[Unicode正規化]]が適用されることがしばしばありますが、
危険です。

[46] [[Unicode正規化]]は破壊的な操作です。[[言語]]によっては似た[[文字]]に置き換えられて適正な表示ができなくなります。
[SEE[ [[Unicode正規化]] ]]

[50] 
従って[[Unicode正規化]]を[[識別子]]仕様に持ち込まないのが賢明です。


[78] 
[[Unicode正規化]]の一部を修正した[[HFS+のNFD]]なら、意味が変わってしまう変更はほぼ避けられます。

[79] 
しかし同じ意味の[[Unicode符号位置]]の列でも[[Unicode正規化]]で一意にならない事例は多々あります。




-*-*-

[47] 
[[識別子]]の[[大文字と小文字の区別]]はされることも、されないこともあります。
古くからある技術ほど、[[ASCII大文字・小文字不区別]]な傾向があります。

[48] 
[[大文字と小文字]]の関係性は[[自然言語]]によっても違いがあり複雑です。
ある文化圏の人にとって自然でも他の文化圏の人にとって不自然な同一視がされてしまう
(見かけ上違う[[識別子]]が一致したり、書き換わったりする) ことがあります。

[49] 
よって[[大文字と小文字]]の関係を[[識別子]]仕様に持ち込まないのが賢明です。

-*-*-

[52] 
[[PRECIS]] は[[幅写像規則]]として[[半角文字]]と[[全角文字]]の[[正規化]]を定めています。

* 長さ

[28] 
[[プログラミング言語]]等の[[識別子]]は[[空文字列]]を認めないのが普通です。

[29] 
[[プロトコル要素]]などとして使われる[[識別子]]で[[空文字列]]が認められることもたまにあります。

-*-*-

[30] 
[[識別子]]には長さの上限が決められていることが多いです。

[31] 
古い時代の技術ほど制限が厳しいことが多いです。

[32] 
制限が厳しいと自由な命名が厳しくなります。
特定の文化圏の常識によって厳しい制限を加えると困る人が出てくることがあります。

[EG[
[33] [[言語]]によって[[単語]]を表すために必要な平均的な[[文字]]数は違います。
[[文字]]の種類によっては[[基底文字]]と[[結合文字]]のようないくつかの
[[Unicode文字]]の組み合わせでようやく一般的に認知される「文字」
が記述できる場合もあります。
]EG]

* 予約名

[39] 
特定の値に完全一致する、または特定の条件に一致する[[識別子]]が、
特別な意味を持つことがしばしばあります。

[40] 関連: [[特殊ドメイン名]],
[[特殊ファイル名]],
[[ファイル配置]]

[41] 
一般公開された[[Webサービス]]では、サービス名や運営事業者名などを含む[[識別子]]が運営事業者によって予約されていることが多いです。

* エスケープ

[66] 
[[識別子]]を使う文脈によって、[[エスケープ]]を使って記述できることもあれば、
できないこともあります。

[67] 
[[エスケープ]]が使えることを前提に、構文要素としての[[識別子]]よりも[[プロトコル要素]]としての[[識別子]]がより自由度が高い場合があります。

[68] 
一口に[[識別子]]といってもいろいろなものがあるので注意が必要です。



* レンダリング

[34] ほとんどすべての場合、[[識別子]]には[[言語情報]]を含められません。
しかし[[言語情報]]のない[[Unicode文字列]]は正しく[[レンダリング][文字のレンダリング]]できません。
[SEE[ [[言語情報]], [[文字のレンダリング]], [[言語情報によるフォント選択]] ]]

[35] 
従って[[識別子]]はそれが含まれる[[文書]]の[[言語情報]]や[[利用者]]の閲覧環境など、
外部的な条件に依存して[[レンダリング][文字のレンダリング]]されることに注意が必要です。

[EG[

[37] 例えば[[プログラミング言語]]の[[ソースコード]]に[[日本語]]の[[識別子]]と[[中文]]の[[識別子]]が混在していると、
両方を正しく表示することができません。
閲覧者の言語設定次第で表示方法が決まります。

]EG]

[36] 
[[応用]]の設計時には適切に[[言語情報]]が設定されるように注意が必要です。

[EG[

[38] 
例えば[[Webサービス]]で[[利用者]]の[[名前]]に[[漢字]]を使える場合、
[[日本語]]の[[利用者]]と[[中文]]の[[利用者]]を区別しておかないと、
両者が出現するメンバーリストのようなものを正しく表示できません。

]EG]

* 応用

[16] 
[[識別子]]の[[文字]]の取り扱いを一般化して定めたもの:

- [[Stringprep]]
- [[PRECIS]]

[17] 
特定の技術において[[識別子]]の[[文字]]の取り扱いを定めたもの:

- [[IDNA2003]]
- [[IDNA2008]]
- [[XMLにおける文字]]
- [[ハンドル (YouTube)]]

[18] 
[[識別子]]の[[文字]]の[[集合]]の記述:

- [[SGMLにおける名前]]

[23] 
その他特に注意されるもの:

- [[ハッシュタグ]]

* メモ
