[306] [RUBYB[[[メッセージ本体]]]@en[message body]]は、[[メッセージ]]のうち、
[[ヘッダー]]の後の[[空行]]の後にある部分です。

* 仕様書

[REFS[
- [310] '''[CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-3.3>'''
-- [320] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-3.3.3>
-- [511] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-3.5>
- [515] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#page-50>
- [1] [CITE@en[RFC 5621 - Message Body Handling in the Session Initiation Protocol (SIP)]]
([TIME[2009-09-12 07:37:40 +09:00]] 版)
<http://tools.ietf.org/html/rfc5621>
]REFS]

* 文脈

[308] [[メッセージ本体]]は、[[HTTPメッセージ]]の[[ヘッダー]]の後の [[CRLF]]
の後に置くことができます。場合によっては省略もできます。

[312] [[要求メッセージ]]では、 [CODE(HTTP)@en[[[Content-Length:]]]] [[ヘッダー]]や
[CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]があるとき、
[[メッセージ本体]]が含まれることとなります [SRC[>>310]]。

;; [313] [[要求メソッド]]には依存しません。

[314] [[応答メッセージ]]では、[[メッセージ本体]]が含まれるかどうかは[[要求メソッド]]と[[状態符号]]に依存して次のように決まります
[SRC[>>310]]。
- [315] [CODE(HTTP)@en[[[HEAD]]]] [[要求]]に対する[[応答]]は、[[メッセージ本体]]を持ちません。
- [316] [CODE(HTTP)@en[[[CONNECT]]]] [[要求]]に対する [CODE(HTTP)[[[2xx]]]]
[[応答]]は、[[メッセージ本体]]を持たず、かわりに[[トンネル]]モードに切り替えます。
- [317] [CODE(HTTP)[[[1xx]]]], [CODE(HTTP)[[[204]]]], [CODE(HTTP)[[[304]]]]
の[[応答]]は、[[メッセージ本体]]を持ちません。
- [318] それ以外の[[応答]]は、[[メッセージ本体]]を持ちます。

[307] [[HTTP/0.9]] [[要求メッセージ]]には、[[メッセージ本体]]を含めることができません。

[309] [[HTTP/0.9]] [[応答メッセージ]]は、その全体が[[メッセージ本体]]です。

* 構文

[311] [[メッセージ本体]]は、零個以上の[[オクテット]]の列です [SRC[>>310]]。

[512] 初期の[[鯖]]は[[メッセージ本体]]の末尾が[[改行]]でないと[[メッセージ本体]]を読めないものがあったため、
古い [[HTTP/1.0]] [[利用者エージェント]]は [CODE(HTTP)[[[POST]]]]
[[要求]]の後に余分な [[CRLF]] を送ることがあります。 しかし
[[HTTP/1.1]] [[利用者エージェント]]は[[要求]]の前後に余分な [[CRLF]]
をつけては[['''なりません''']]。そのような対処が必要であれば、
[[CRLF]] も[[メッセージ本体]]に含めなければ[['''なりません''']]。 [SRC[>>511]]

* 長さの決定

[321] [[メッセージ本体]]の長さは、次のようにして決定します [SRC[>>320]]。
[FIG[
= [322] 次の場合、[[メッセージ本体]]はありません。
=- [323] [CODE(HTTP)@en[[[HEAD]]]] [[要求]]に対する[[応答]]
=- [324] [CODE(HTTP)[[[1xx]]]] [[応答]]
=- [325] [CODE(HTTP)[[[204]]]] [[応答]]
=- [326] [CODE(HTTP)[[[304]]]] [[応答]]
= [327] [CODE(HTTP)@en[[[CONNECT]]]] [[要求]]に対する [CODE(HTTP)[[[2xx]]]] 
[[応答]]なら、[[メッセージ本体]]はなく、かわりに[[トンネル]]が始まります。
= [328] [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]の最後の[[転送符号化]]が
[CODE(HTTP)@en[[[chunked]]]] なら、[[メッセージ本体]]の長さは
[CODE(HTTP)@en[[[chunked]]]] [[符号化]]により決まります。
= [329] [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]の最後の[[転送符号化]]が
[CODE(HTTP)@en[[[chunked]]]] 以外なら、
=- [330] [[応答メッセージ]]では、[[鯖]]が[[接続]]を閉じたところまでが[[メッセージ本体]]です。
=- [331] [[要求メッセージ]]では、[[メッセージ本体]]の長さを決定できないので、
[CODE(HTTP)[[[400]]]] [[応答]]を返して[[接続]]を閉じなければ[['''なりません''']]。
= [402] [CODE(HTTP)@en[[[Transfer-Encoding:]]]] がなく、
[CODE(HTTP)@en[[[Content-Length:]]]] があるものの、
複数あって値が異なるか、値が[[非妥当]]な時は、回復不能な誤りであり、
=- [403] [[鯖]]が[[要求メッセージ]]を受信した場合は [CODE(HTTP)[[[400]]]]
[[応答]]を返して[[接続]]を閉じなければ[['''なりません''']]。
=- [404] [[串]]が[[応答メッセージ]]を受信した場合は[[鯖]]への[[接続]]を閉じて、
[[応答]]は捨てて、 [CODE(HTTP)[[[502]]]] [[応答]]を[[クライアント]]に返さなければ[['''なりません''']]。
=- [503] [[利用者エージェント]]が[[応答メッセージ]]を受信した場合は[[鯖]]への[[接続]]を閉じて、
[[応答]]は捨てなければ[['''なりません''']]。
= [504] [CODE(HTTP)@en[[[Transfer-Encoding:]]]] がなく、
[CODE(HTTP)@en[[[Content-Length:]]]] があって[[妥当]]な値の時は、
その[[十進数]]が[[メッセージ本体]]の[[オクテット]]単位の長さです。
=- [505] この長さに至らずに[[接続]]が閉じられたり、[[タイムアウト]]したりした場合は、
[[メッセージ]]は不完全とみなし、[[接続]]は閉じなければ[['''なりません''']]。
= [506] それ以外で[[要求メッセージ]]なら、[[メッセージ本体]]の長さは0です。
= [507] それ以外なら、[[鯖]]が[[接続]]を閉じるまでが[[メッセージ本体]]です。
]FIG]

[510] 長さの決定には [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]と
[CODE(HTTP)@en[[[Content-Length:]]]] [[ヘッダー]]が深く関わっています。
両者の解釈と適合性については、それぞれの項も参照してください。

[401] [CODE(HTTP)@en[[[Transfer-Encoding:]]]] と [CODE(HTTP)@en[[[Content-Length:]]]]
の両方がある時は、 [CODE(HTTP)@en[[[Transfer-Encoding:]]]]
が優先されます。 [[request smuggling]] や [[response splitting]]
の兆候かもしれませんから、[[誤り]]として扱う[RUBYB[べき]@en[ought to]]です。 [SRC[>>320]]

[508] [CODE(HTTP)@en[[[Content-Length:]]]] も[[転送符号化]]もないと、
ネットワークエラーで[[接続]]が中断されたのと[[メッセージ本体]]の末端まで来たのと区別がつきませんから、
どちらかの方法を使う[['''べきです''']] [SRC[>>320]]。
[[鯖]]は、[[メッセージ本体]]が含まれているにも関わらず [CODE(HTTP)[[[Content-Length:]]]]
が含まれていなければ、 [CODE(HTTP)[[[411]]]] を返して構いません [SRC[>>320]]。

* 転送符号化

[513] [[メッセージ本体]]は、 [[payload body]] そのものか、 [[payload body]]
に[[転送符号化]]を適用したものです。

;; [514] [[転送符号化]]や [CODE(HTTP)@en[[[Transfer-Encoding:]]]] や
[CODE(HTTP)@en[[[chunked]]]] の項を参照してください。

[516] [[串]]は、[[転送符号化]]を適用したり、除去したりできます [SRC[>>515]]。

* 構文解析

[509] [[利用者エージェント]]は、最後の[[要求]]に対する最後の[[応答]]をすべて受信して、
尚もデータが残っているなら、これを捨てても構いませんし、
前の[[応答]]の本体の一部であるか判定しようとしても構いません。
しかし[[クライアント]]は、この余分なデータを別の[[応答]]として処理したり、
[[キャッシュ]]したり、[[転送]]したりしては[['''なりません''']]。 [SRC[>>320]]

* 変形

[517] [[串]]は、 [CODE(HTTP)@en[[[no-transform]]]] [[キャッシュ指令]]が指定されていれば、
[[payload]] を[[変形]]しては[['''なりません''']]。指定されていなければ、
[[変形]]して構いません。 [SRC[>>515]]

[518] [[変形]]が行われた場合、値 [CODE(HTTP)[[[214]]]] の [CODE(HTTP)@en[[[Warning:]]]] 
[[ヘッダー]]を (まだなければ) 追加しなければ[['''なりません''']]。 [SRC[>>515]]

[519] [CODE(HTTP)[[[200]]]] [[応答]]を[[変形]]した場合、[[状態符号]]を
[CODE(HTTP)[[[203]]]] に変更できます。 [SRC[>>515]]

* 歴史

[FIG[
[FIGCAPTION[
[305] RFC 2068・2616 (HTTP/1.1) 4.3 Message Body
]FIGCAPTION]

> The message-body (if any) of an HTTP message is used to carry the
entity-body associated with the request or response. The message-body
differs from the entity-body only when a transfer[INS[-]]coding has been
applied, as indicated by the Transfer-Encoding header field (section [DEL[14.40]] [INS[14.41]]).

HTTP [[メッセージ]]の [CODE(ABNF)[message-body]] は (あれば)
その[[要求]]または[[応答]]に関連付けられた [CODE(ABNF)[[[entity-body]]]]
を伝達するのに使います。 [CODE(ABNF)[message-body]] は、
[CODE(HTTP)[[[Transfer-Encoding]]]] 頭欄で示されたとおりの
[CODE(ABNF)[transfer-coding]] ([[転送符号化]]) を適用した時だけ
[CODE(ABNF)[entity-body]] と違います。

>
- message-body = entity-body | <entity-body encoded as per Transfer-Encoding [INS[[CODE(HTTP)[Transfer-Encoding]] により符号化した [CODE(ABNF)[entity-body]]]]>

> Transfer-Encoding MUST be used to indicate any transfer[INS[-]]codings
applied by an application to ensure safe and proper transfer of the
message. Transfer-Encoding is a property of the message, not of the
entity, and thus [DEL[can]] [INS[MAY]] be added or removed by any application along the
request/response chain. [INS[(However, section 3.6 places restrictions on when certain transfer-codings may be used.)]]

[[応用]]がメッセージの安全で適切な転送のために適用した [CODE(ABNF)[transfer-coding]]
を示すために [CODE(HTTP)[Transfer-Encoding]] を使用しなければ'''なりません'''。
[CODE(HTTP)[Transfer-Encoding]] はメッセージの特性であって、
[[実体]]の特性ではなく、従って要求・応答鎖の任意の応用が追加したり削除したりして'''構いません'''。 [INS[(しかし、3.6節である [CODE(ABNF)[transfer-coding]] をいつ使っても良いかを制限しています。)]]

> The rules for when a message-body is allowed in a message differ for
requests and responses.

メッセージ中でいつ [CODE(ABNF)[message-body]] が認められるかの規則は要求と応答で異なります。

> The presence of a message-body in a request is signaled by the
inclusion of a Content-Length or Transfer-Encoding header field in
the request's message-headers. A message-body [DEL[MAY]] [INS[MUST NOT]] be included in a request [DEL[only when the request method (section 5.1.1) allows an entity-body]] [INS[if the specification of the request method (section 5.1.1) does not allow sending an entity-body in requests]]. [INS[A server SHOULD read and forward a message-body on any request; if the request method does not include defined semantics for an entity-body, then the message-body SHOULD be ignored when handling the request]].

要求で [CODE(ABNF)[message-body]] があることは、
要求の [CODE(ABNF)[message-headers]] 中に [CODE(HTTP)[[[Content-Length]]]]
頭欄または [CODE(ABNF)[[[Transfer-Encoding]]]] 頭欄を含めることで示します。
[CODE(ABNF)[message-body]] は、[DEL[[[要求方式]]が [CODE(ABNF)[entity-body]] を認めているときだけ]][INS[要求方式の仕様が要求で [CODE(ABNF)[entity-body]] を送ることを認めていなければ]]要求に含めて[DEL['''構いません''']][INS[は'''なりません''']]。[INS[サーバーは、任意の要求の [CODE(ABNF)[message-body]] を読み、転送する'''べきです'''。 [CODE(ABNF)[entity-body]] の意味を定義していない要求方式のときには、要求を処理するに当たって [CODE(ABNF)[message-body]] を無視する'''べきです'''。]]

> For response messages, whether or not a message-body is included with
a message is dependent on both the request method and the response
status code (section 6.1.1). All responses to the HEAD request method
MUST NOT include a message-body, even though the presence of entity-header fields might lead one to believe they do. All 1xx
(informational), 204 (no content), and 304 (not modified) responses
MUST NOT include a message-body. All other responses do include a
message-body, although it [DEL[may]] [INS[MAY]] be of zero length.

応答メッセージでは、メッセージに [CODE(ABNF)[message-body]]
を含めることができるかどうかは要求方式と応答[[状態符号]]の両方によって決まります。
[CODE(HTTP)[[[HEAD]]]] 要求方式に対するすべての要求は、
[CODE(ABNF)[entity-header]] (実体頭) 欄が示されていて [CODE(ABNF)[message-body]] 
が含まれていると思えるように見えたとしても、 [CODE(ABNF)[message-body]]
を含めては'''なりません'''。すべての [CODE(HTTP)[[[1xx]]]] (情報提供),
[CODE(HTTP)[[[204]]]] (無内容), [CODE(HTTP)[[[304]]]] (無修正)
応答は [CODE(ABNF)[message-body]] を含んでは'''なりません'''。
他のすべての応答は [CODE(ABNF)[message-body]] を含みます。
長さ零でも'''構いません'''が。
]FIG]

[FIG[
[FIGCAPTION[
[319] RFC 1945 (HTTP/1.0) ; RFC 2068・2616 (HTTP/1.1) 7.2 Entity Body
]FIGCAPTION]

> The entity[INS[-]]body (if any) sent with an HTTP request or response is in
a format and encoding defined by the [DEL[Entity-Header]] [INS[entity-header]] fields.

HTTP の要求または応答で送信される [CODE(ABNF)[entity-body]] は、
(ある場合) 実体頭欄で定義される書式と符号化を使います。

>
- [DEL[ Entity-Body    = *OCTET]]
- [INS[ entity-body    = *OCTET]]

[DEL[

> An entity body is included with a request message only when the
request method calls for one. The presence of an entity body in a
request is signaled by the inclusion of a Content-Length header field
in the request message headers. HTTP/1.0 requests containing an
entity body must include a valid Content-Length header field.

実体本体は、要求方式がそれを呼び出すときのみ要求メッセージに含めます。
要求に実体本体があることは、 [CODE(HTTP)[[[Content-Length]]]]
頭欄が要求メッセージ頭並びに含まれていることで通知されます。
実体本体を含んでいる HTTP/1.0 要求は妥当な [CODE(HTTP)[Content-Length]]
頭欄を含んでいなければなりません。
]DEL]

[INS[

> An entity-body is only present in a message when a message-body is
present, as described in section 4.3. The entity-body is obtained
from the message-body by decoding any Transfer-Encoding that [DEL[may]] [INS[might]] have
been applied to ensure safe and proper transfer of the message.

[CODE(ABNF)[entity-body]] は4.3節で説明しているように [CODE(ABNF)[[[message-body]]]]
が示されている時にのみメッセージに存在します。
[CODE(ABNF)[entity-body]] は、
メッセージの安全で適切な転送を確保するために適用されているかもしれない
[CODE(HTTP)[[[Transfer-Encoding]]]] を復号することで
[CODE(ABNF)[message-body]] から得ます。
]INS]

[DEL[

> For response messages, whether or not an entity body is included with
a message is dependent on both the request method and the response
code. All responses to the HEAD request method must not include a
body, even though the presence of entity header fields may lead one
to believe they do. All 1xx (informational), 204 (no content), and
304 (not modified) responses must not include a body. All other
responses must include an entity body or a Content-Length header
field defined with a value of zero (0).

応答メッセージでは、メッセージに実体本体が含まれているかどうかは要求方式と応答符号の両方に依存します。
[CODE(HTTP)[[[HEAD]]]] 要求方式に対するすべての応答は、
たとえ実体頭欄が存在して本体を含むように見えたとしても、本体を含んではいけません。
すべての [CODE(HTTP)[[[1xx]]]] (情報提供), [CODE(HTTP)[[[204]]]] (無内容),
[CODE(HTTP)[[[304]]]] (未修正) 応答は本体を含んではなりません。
他のすべての応答は実体本体を含むか、値が零 ([CODE(HTTP)[0]])
で定義された [CODE(HTTP)[Content-Length]] 頭欄を含んでいなければなりません。

[INS[

注: この段落は RFC 2068・2616 では [CODE(WikiPage)[[[message-body]]]]
の節にありあます。
]INS]
]DEL]

[INS[

注: 注記なき変更点は 1945→2068 のもの。
]INS]
]FIG]