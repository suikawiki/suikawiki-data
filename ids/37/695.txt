[1] 
[[文字のレンダリング]]における[[グリフ]]の選択 (決定) にはいろいろな情報が影響しており、
いろいろな処理があります。

* 仕様書

[REFS[

- [9] 
[CITE@en[CSS Fonts Module Level 4]], [TIME[2025-11-15T11:39:40.000Z]], [TIME[2025-11-16T01:39:21.293Z]] <https://drafts.csswg.org/css-fonts/#font-matching-algorithm>

]REFS]


* フォントの選択とグリフの選択

[10] 
[[文字のレンダリング]]のための[[グリフ]]の選択は、

- [11] [DFN[フォントの選択]] : 選択肢となる[[フォント]]を決定する
- [12] [DFN[グリフの選択]] : 選択肢となる[[フォント]]の中から適当な[[グリフ]]を決定する

の2つの段階に分けられますが、両者は完全に分離できるものではなく、
選ばれた[[フォント]]に必要な[[グリフ]]がなければ次の[[フォント]]を探すという走査が必要となります。

[34] 
単一の[[フォント]]であらゆる[[文字列]]を適切に[[レンダリング][文字のレンダリング]]することはできないため、
[[文字のレンダリング]]を行う実装は複数の[[フォント]]からの[[グリフ]]の混合に対応する必要があります。

[13] 
[[フォントの選択]]は、 [CODE[font-family]] や [CODE[<font face>]] 
やその他の[[応用]]依存の[[フォント]]指定の方法で[[著者]]によって指定された[[フォント名]]、
[[利用者スタイルシート]]や設定画面などで[[利用者]]によって指定された[[フォント名]]、
[[利用者エージェントスタイルシート]]などで[[利用者エージェント]]によって指定された[[フォント名]]や、
その他の条件に基づき適切な[[フォント]]を選択する操作です。
[[URL]] で指定した[[フォント]]や[[プラットフォーム]]の準備する[[フォント]]から選ばれますが、
[[fetch]] 待ちやエラーなども考慮が必要になります。



* フォントを選ぶ

[14] 
[[フォント]]は、その出所が何種類かあります。

- [15] [[installed font]] : [[プラットフォーム]]が具備する[[フォント]]
-- [16] [[preinstalled font]] : 標準で提供される[[フォント]]
-- [17] [[user-installed font]] : [[利用者]]が[[プラットフォーム]]に追加した[[フォント]]
- [18] [[Webフォント]] : [[著者]]がデータを提供した[[フォント]]

[21] 
[[フォント名]]は、その解釈が何種類かあります。

- [22] [[Webフォント]]を参照する[[フォント名]]
- [23] その他の具体的な[[フォント名]]
- [25] 汎化された[[フォント名]]
-- [26] [CODE[<generic-family>]]
--- [29] [[システムフォント]]
--- [32] それ以外
-- [28] [CODE[<system-family-name>]]

-*-*-

[33] [[プラットフォーム]]は、
[[Web互換性]]のため、
具体的な[[フォント名]]で指定されるものとして
[[Web]] で歴史的によく使われてきたものを具備する必要があります。
当該[[フォント]]が[[自由ソフトウェア]]でない場合、
[[自由ソフトウェア]]である同等の[[フォント]]を具備し、
当該[[フォント名]]で選択されるべきです。
[SEE[ [[フォント名のWeb互換性]] ]]

;; [38] 指定された[[フォント]]が[[自由ソフトウェア]]でない場合、
想定された表示と完全に同じにすることは不可能ですが、
[[文字幅]]や表示上の雰囲気が著しく異ならない代替[[フォント]]を利用することが望まれます。

[EG[
[39] [[20世紀]]の [[Webサイト]]の表示には世界的に [CITE[Comic Sans MS]]
と同等の雰囲気を持つ[[自由ソフトウェア]]な[[フォント]]が必要です。
[SEE[ [[Comic Sans MS]] ]]
]EG]

[EG[
[37] [[平成時代]]の[[日本]]の [[Webサイト]]との[[互換性]]のため、
[CITE[MS Pゴシック]]と同等の機能性を持つ[[自由ソフトウェア]]な[[フォント]]が必要です。
[SEE[ [[AA]] ]]
]EG]

[35] [[Web]] 以外 (たとえば [[RTF]]) も同様に[[互換性]]のために必要な[[フォント]]の[[集合]]があります。


;; [40] 指定された[[フォント名]]の一覧にそれ自体が [[installed font]]
であるものと互換フォントだけが [[installed font]] であるものが混在するとき、
一覧中の優先順位を調整する必要があるかもしれません。

[41] 
[[プラットフォーム]]は、 
[[Webサイト]]で利用されてきた[[フォント依存符号化]]の[[フォント]]を具備する必要があります。
[SEE[ [[フォント依存符号化]] ]]

[43] 
[[Web]] 以外 (たとえば [[RTF]]) も同様に[[互換性]]のために必要な[[フォント依存符号化]]の[[フォント]]の[[集合]]があります。


-*-*-

[FIG(short list)[ [2] [[フォントの選択]]

- [CODE[font-family]]
- [CODE[<font face>]]
- [[色フォント]]
- [[東アジアの幅]]
- [[絵文字]]
- [[外字]]
- [[√]]
- [[…]]
- [[句読点]]
- [[結合文字]]
- [CODE[unicode-range]]
- [CODE[font-display]]

]FIG]







* グリフを選ぶ

[FIG(short list)[ [24] [[グリフ]]の選択
- [[異体字セレクター]]
-- [[VS]]
-- [[IVS]]
-- [[EVS]]
- [[合字]]
- [[続け字]]
- [[言語情報によるグリフ選択]]
- [[用字系]]、[[数式]]
- [[フォント]]
- [[イタリック]]
- [[small-caps]]
- [[書字方向]]
-- [[書字方向依存グリフ]]
-- [[回転][回転 (書字方向)]]
- [[SAPV]]
- [CODE[altGlyph]]
- [[語頭形]]、[[語中形]]、[[語末形]]
- [[shaping]]
- [CODE[cmap]]
- [CODE[GSUB]]
]FIG]

* 言語情報による選択



[30] 
同じとされる[[文字]]でも[[言語]]によって違った形で使われていることがあります。
従って[[文字のレンダリング]]の過程には[DFN[言語情報によるフォント選択]]、
[DFN[言語情報によるグリフ選択]]が必要となります。
また、[[文字列]]には[[言語情報]]が必要となります。

[42] 
[[著者]]が[[フォント]]を指定する場合は、
[[言語]]に沿った適切な[[フォントの選択]]は[[著者]]の責任となります。

[36] 
汎化された[[フォント名]]が指定された場合や、
指定されたどの[[フォント名]]の[[フォント]]にも適切な[[グリフ]]がない場合の[[フォントの選択]]は、
当該[[文字列]]に必要な[[グリフ]]の有無は当然のこと、
[[言語情報]]をも考慮する必要があります。

[EG[

[44] [[日本語]]の[[文字列]]に含まれる[[漢字]]に [CODE[serif]]
が指定されている場合は、 [[installed font]] のうち[[日本語]]に対応しているとされる[[フォント]]を選ぶ必要があります。

]EG]

[51] 
複数の[[言語]]に対応する[[フォント]]の場合は、
対応[[言語]]に沿った適切な表示のための[[フォント]]の情報を整えるのは[[フォント開発者]]の責任となります。
[SEE[ [[OpenTypeにおける言語]] ]]

[EG[

[52] [CODE[meta]] に適切な[[言語]]の情報を記述したり、
[CODE[locl]] で[[グリフ]]の切り替え規則を記述したりする必要があります。

]EG]


[FIG(short list)[ [19] [[文字のレンダリング]]と[[言語]]
- [[CJK統合漢字]]
- [[結合文字]]
- [[ドイツ文字]]
- [[キリル文字]]
- [CH[i]] の[[合字]]化と[[トルコ語]]
- [[句読点]]
- [[・・・]]
- [[EAW]]
- [[円問題]]
- [[用字系タグ]]
- [[言語系タグ]]
- [[中華フォント問題]]
]FIG]

[31] 
[[言語]]によって変化するのは主として[[グリフの選択]] (によって選ばれる[[グリフ]])
ですが、それだけに留まりません。[[グリフ]]と連動して[[メトリクス][OpenTypeの座標]]も変化させる必要が出てくることが多いですし、
[[合字]]化の有無、
[[縦書き]]表示と[[横書き]]表示で[[グリフ]]を変化させるか否か、
[[傍線]]、[[傍点]]、[[ルビ]]の位置、
その他周辺の諸事項にも[[言語情報]]の影響が及びます。

[46] 
[[言語情報]]が [[CJK]] のとき、 [CODE[monospace]] は[[半角]]と[[全角]]の慣習に沿った[[フォント]]であることが[[期待]]されます。

[47] 
[[言語情報]]が [[CJK]] ''以外''のとき、
[[ラテン文字]]、[[ギリシャ文字]]、[[キリル文字]]は[[全角]]の[[フォント]]で''ない''ことが[[期待]]されます。




** 文字列の言語の識別

[20] 
[[文字列]]には適切な[[表示][文字のレンダリング]]のため[[言語情報]]が必要です。

[48] 
現代の多くの[[データ形式]]等は[[言語情報]]を指定できます。
実際に[[言語]]が指定されたデータが多く存在します。その場合はこれをそのまま利用できます。

[EG[
[49] [[HTML]] には [CODE[lang]] [[属性]]があります。
]EG]

[50] 
しかし[[言語情報]]を伴わない場合や誤っている場合も多いのが実情です。
[SEE[ [[言語タグ]], [[識別子文字]] ]]

[53] 
[[文字コード]]や [[TLD]] を[[言語情報]]のヒントとして使える場合があります。
[SEE[ [[文字コード等に依存した特殊な表示処理]] ]]

[27] 
歴史的には 
[[ISO/IEC 2022]] [[図形文字集合]]、
[[TRONコード]]の面、
[[OEMコードページ]]、
[[Windowsコードページ]]、
[[ESC:]]、
[[IANA charset]] 
といったものが[[言語]]に応じた[[グリフ]]の選択に活用されていました。
[SEE[ [[文字コードの変換]] ]]

[54] 
[[Unicode]] 以前の[[文字コード]]で作られたデータを表示するときは、
明示的な[[言語情報]]が欠けている場合も多いので、
これらの情報を[[言語]]のヒントとして活用するべきです。


[55] 
明示的な[[言語情報]]もヒントも存在しない (または信用できない) ときは、
表示される[[文字列]]から[[自然言語処理]]の手法による[[言語判定]]を行うこともできます。

[59] 
当記事では[DFN[補正済み言語情報]]を本項の諸戦略によって決めた[[言語タグ]]または
[CODE[null]] とします。

-*-*-

[60] 
[[表示][文字のレンダリング]]対象の[[文字列]]から[[補正済み言語情報]]を決めかねるときは、
[[利用者]]の環境 ([[ロケール]], [[言語]]の設定) に従うのが適切と考えられます。

[61] 
当記事では[DFN[利用者の言語情報]]を[[利用者の言語]]である1個以上の[[言語タグ]]とします。

** フォントの対応言語等の識別

[45] 
[[フォント]]の対応する[[言語]]の判定は、基本的には当該[[フォント]]の申告に基づきます。
[SEE[ [[OpenTypeにおける言語]] ]]
しかし古く[[言語]]の情報が備わっていない[[フォント]]や、
誤った[[言語]]の情報が記載された[[フォント]]などの情報を[[応用]]が個別に対処する必要がある場合もあります。


[56] 
[CH[\]] 
の[[字形]]など[[フォント]]自体に情報がない事項は、
[[応用]]が[[フォント名]]の表を保持するなどして個別に対応する必要があります。


[87] [CITE[Intent to ship: Changing default Japanese fonts to modern fonts - Google グループ]]
([TIME[2017-08-27 18:24:44 +09:00]])
<https://groups.google.com/forum/#!topic/mozilla.dev.platform/DZ4QgKAWEnY>

*** 円問題

[57] [[後方互換性]]のため、
[CH[\]] の[[字形]]は[[日本語]]のとき [CH[¥]]、
[[韓国語]]のとき [CH[₩]]
とすることを原則とする必要があります。
ただし最近の[[日本語]]や[[韓国語]]の[[フォント]]の中には 
[CH[\]]
のままとすることもあるので、細かな制御が必要となります。
[SEE[ [[円問題]] ]]


[58] 
本来これは [[Shift_JIS]] の仕様であり、 [[EUC-JP]] では適用しないなど[[[VAR[文書]]の[F[文字符号化]]]]に依存した細かな調整が求められるところです。
しかし長年 [CITE[Windows]] が区別せず一緒くたに扱ってきたため、
[[Shift_JIS]], [[EUC-JP]], [[ISO-2022-JP]], [[UTF-8]]
の[[文字コード]]の違いに実効性がなく、
かわりに和文フォントと欧文フォント等との違いとして扱うのが現在となっては妥当と考えられます。


[62] 
推奨される実装戦略: [[フォント名]]が明示されないまま[[フォント]]を選ぶ場合において、

[FIG(steps)[

= [64] [VAR[[[補正済み言語情報]]]]が[[日本語言語タグ]]のいずれかの場合、
== [65] [[installed font]] であって [CH[\]]
が [CN[YEN SIGN]] の字形では''ない''と知られているものがあれば、
これを除外します。
= [67] [VAR[[[補正済み言語情報]]]]が[[韓国語言語タグ]]のいずれかの場合、
== [66] [[installed font]] であって [CH[\]]
が [CN[WON SIGN]] の字形では''ない''と知られているものがあれば、
これを除外します。



]FIG]


[63] 
[[Webブラウザー]]やその他の現在や過去の実装事例については[[円問題]]参照。


* メモ


[3] 
[CITE[DSSSL]], [TIME[2001-08-19T05:28:49.000Z]], [TIME[2023-11-23T08:18:49.079Z]] <http://www.y-adagio.com/public/standards/jis_dsssl/cls12.txt>

>
(4) 特質glyph-subst-table:は,#f,グリフ代替表又はグリフ代替表のリストであって,特質glyph-idが指定するglyph-idに対して,その代替グリフを探索する対象を指定する。値がリストの場合,指定された順序で代替グリフが探す。初期値は,#fとする。
>
(5) 特質glyph-subst-method:は,#f,文字列又は文字列のリストとする。各文字列は,グリフ代替を行う方法を指定する公開識別子でなければならない。初期値は#fとする。
>
備考 これにより,文脈依存のグリフ代替及び複数のグリフを含むグリフ代替が可能になる。
>
(6) 特質glyph-reorder-method:は,#f,文字列又は文字列のリストとする。各文字列は,グリフの再順序付けの方法の公開識別子を指定する。初期値は,#fとする。
>
備考 これは,普通ヒンズースクリプトで使用する。



[4] [CITE@ja[利用者:emk - GlyphWiki]], [TIME[2024-04-30T03:47:56.000Z]] <https://glyphwiki.org/wiki/User:emk#i0>

>webブラウザーによっては、内蔵のUnicodeデータベースで未定義のコードポイントは、ページがCSSなどでフォント名を直接指定しない限り表示しないよう制限している。[SNIP[]]


[5] 
[[Chrome]] でも [[Firefox]] でも、複数の[[文字]]の列の途中が [CODE[cmap]]
になくて[[グリフID]] [N[0]] を含む列になって、それが [CODE[GSUB]]
によって(一部)置き換えられるような場合に、その通りに動作します。
([[グリフID]] [N[0]] が出現したところで打ち切って他の[[フォント]]を探したりしません。)
[TIME[2024-10-24T08:12:14.700Z]]

[6] [[タグ文字]]の処理の項も参照。



[7] 
[CITE@ja[グループ-ノート:住基 - GlyphWiki]], [TIME[2025-03-17T05:32:15.000Z]] <https://glyphwiki.org/wiki/Group-talk:%e4%bd%8f%e5%9f%ba>

>[SNIP[]](2010年7月の情報)Fedoraではフォント管理にfontconfigを使っています。fontconfigがフォントを日本語用と認識するにはあるテーブルのグリフをすべて収録している必要があります。で、基本的にJIS X 0208:1990の部分集合でした。--kamichi 2012年6月9日(土) 16:00

[8] [CITE@en[ja.orth « fc-lang - fontconfig - Font customization and configuration library (mirrored from https://gitlab.freedesktop.org/fontconfig/fontconfig)]], [TIME[2025-03-17T05:32:15.000Z]], [TIME[2025-03-17T05:32:33.772Z]] <https://cgit.freedesktop.org/fontconfig/tree/fc-lang/ja.orth>

