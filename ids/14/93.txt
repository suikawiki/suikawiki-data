* 仕様書

[REFS[
- [20] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#session-history>
- [41] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-10-23 20:18:13 +09:00]] 版) <https://html.spec.whatwg.org/#pagetransitionevent>
- [32] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#unloading-documents>
]REFS]

* セッション履歴エントリーにおける文書

[21] [[利用者エージェント]]は、[[現在エントリー]]以外の[[セッション履歴エントリー]]の[[文書]]で[[スクリプト]]から参照されていないものについて、
[[文書を捨てる]]ことにしても構いません。 [SRC[>>20]]

[23] [[利用者エージェント]]がいつ[[キャッシュ]]を保持し続けるべきか、
いつ捨てるべきかは [[HTML Standard]] としては規定していません [SRC[>>20]]。

;; [25] [[利用者エージェント]]は、[[利用者]]体験と利用可能な[[メモリー]]等の[[資源]]の制約のバランスを考慮して保持するかどうかを決められます。

[22] 捨てられた場合、[[利用者]]または[[スクリプト]]により再度そのページに遷移した時は、
新たにそのページを読み込む ([[エントリー更新]]の [[navigate]]
を実行する) ことになります [SRC[>>20]]。

[24] 捨てたかどうかによって[[セッション履歴]]に関する処理に影響があってはなりません。
文書が捨てられていて新たに読み込み直した場合は、同じ[[文書]]を共有していた他の[[セッション履歴エントリー]]の[[文書]]も同じ新しい[[文書]]としなければ[['''なりません''']] [SRC[>>20]]。

[28] しかしながら、捨てて再 [[navigate]] して同じ状態が復元される保証はありません。
(むしろ一般には異なる状態になります。) [[ネットワーク]]が切断されて接続できなくなれば、
以前は通常の[[文書]]だったものが[[ネットワークエラー]]の表示に変わったりします。

[FIG(list)[
- [29] 再 [[navigate]] が[[閲覧文脈]]内の表示ではなく、[[ダウンロード]]等[[閲覧文脈]]外の表示となった場合、
[[セッション履歴エントリー]]の更新は行われず、[[セッション履歴]]の移動 ([[履歴の探索]])
も行われません。
- [30] 再 [[navigate]] が[[閲覧文脈]]の[[活性文書]]の[[素片識別子へのスクロール]]だけに留まった場合、[[セッション履歴エントリー]]の更新は行われず、かわりに[[現在エントリー]]の次に[[素片識別子]]へスクロールした[[セッション履歴エントリー]]が挿入されることになります。
- [31] それ以外なら[[エントリー更新]]が行われますが、新しい[[文書]]の[[スクリプト]]が
[[navigate]] を行った場合など、新[[現在エントリー]]とそれ以後の[[セッション履歴エントリー]]を新しく作成することになる場合もあります。[[文書]]の破棄前の[[セッション履歴]]の状態が復元される保証はありません。
]FIG]

[34] [[文書]]は、 [DFN[[[''salvageable'']]]] かどうかの状態を持ちます。
初期値は[[真]]です。 [SRC[>>32]]

* bfcache (Firefox)

[1] [CITE@en-us[Using Firefox 1.5 caching - MDC]] ([TIME[2009-01-24 00:43:53 +09:00]] 版) <https://developer.mozilla.org/ja/Using_Firefox_1.5_caching>

- [11] [[Firebug]] が動作していると機能しない? [TIME[2011-02-08T06:29:29.700Z]]
- [12] [[XHR]] が接続中だと機能しない? [TIME[2011-02-08T06:29:40.500Z]]

* Fast history navigation (Opera)

[2] [CITE@en[JavaScript and History Navigation - Opera Knowledge Base]] ([TIME[2009-02-08 17:32:47 +09:00]] 版) <http://www.opera.com/support/kb/view/827/>

>Starting in Opera 9.0 Technical Preview 2, Opera attempts to detect pages that rely on this behavior, and will not use fast history navigation on those pages. This means that the page, and any scripts it contains, will be loaded from cache, and processed again when the page is loaded using the back or forward navigation. This is known as "compatible history navigation". 

[5] いつ互換モードになるのかの条件は >>2 に明記されていませんが、
[CODE(JS)@en[[[onload]]]] と [CODE(JS)@en[[[onunload]]]] が関わっているようです。

[3] [[利用者JavaScript]] で[[履歴ナビゲーション・モード]]を指定するには、
[CODE(JS)@en[[[opera.setOverrideHistoryNavigationMode]]]] [[特性]]を使います。
値は [CODE(JS)@en[[[automatic]]]]、[CODE(JS)@en[[[fast]]]]、
[CODE(JS)@en[[[compatible]]]] です。 [SRC[>>2]]

[4] [[著者]]が[[スクリプト]]で[[履歴ナビゲーション・モード]]を明示的に指定するには、
[CODE(JS)@en[[[history.navigationMode]]]] [[特性]]を使います。
値は [CODE(JS)@en[[[automatic]]]]、[CODE(JS)@en[[[fast]]]]、
[CODE(JS)@en[[[compatible]]]] です。 [SRC[>>2]]

[6] なんか、 [CODE(DOMa)@en[[[onunload]]]] を設定しても [CODE(DOMa)@en[[[onload]]]]
が呼ばれないという情報がありました。どういうときに自動判定で互換モードになるのでしょうかね?

* Page cache (WebKit)

[REFS[
- [17] [CITE[Surfin' Safari - Blog Archive » WebKit Page Cache I – The Basics]] ([TIME[2014-10-27 02:01:28 +09:00]] 版) <https://www.webkit.org/blog/427/webkit-page-cache-i-the-basics/>
- [18] [CITE[Surfin' Safari - Blog Archive » WebKit Page Cache II – The unload Event]] ([TIME[2014-10-27 02:01:43 +09:00]] 版) <https://www.webkit.org/blog/516/webkit-page-cache-ii-the-unload-event/>
]REFS]

* イベント

[FIG(short list)[
- [CODE(DOMe)@en[[[pageshow]]]]
- [CODE(DOMe)@en[[[pagehide]]]]
]FIG]

[33] [[文書]]の [DFN[[[page showing]]]] フラグは、 [CODE(DOMe)@en[[[pageshow]]]]
と [CODE(DOMe)@en[[[pagehide]]]] の整合性を保つためのフラグです [SRC[>>32]]。 
[[文書]]作成時の初期値は[[偽]]です [SRC[>>32]]。

* [CODE(DOMi)@en[PageTransitionEvent]] インターフェイス

[42] [DFN[[CODE(DOMi)@en[[[PageTransitionEvent]]]]]] [[インターフェイス]] [SRC[>>41]] は、
[CODE(DOMe)@en[[[pageshow]]]]/[CODE(DOMe)@en[[[pagehide]]]] [[イベント]]と共に用いられます。
[[文書環境]]と[[ワーカー環境]]に[[晒され]]ています [SRC[>>41]]。

;; [[ワーカー環境]]では使われることは無さそうですが・・・。

[44] [CODE(DOMi)@en[[[PageTransitionEvent]]]] [[インターフェイス]]は、
他の [CODE(DOMi)@en[[[Event]]]] [[インターフェイス]]同様の[[コンストラクター]]を持ちます
[SRC[>>41]]。
初期化のための辞書は [DFN[[CODE(DOMi)@en[[[PageTransitionEventInit]]]]]] です [SRC[>>41]]。

[43] [CODE(DOMi)@en[[[PageTransitionEvent]]]] [[インターフェイス]]は、
[CODE(DOMi)@en[[[Event]]]] [[インターフェイス]]を[[継承]]しています [SRC[>>41]]。
[CODE(DOMi)@en[[[PageTransitionEventInit]]]] [[辞書]]は、
[CODE(DOMi)@en[[[EventInit]]]] [[辞書]]を[[継承]]しています [SRC[>>41]]。

[45] [CODE(DOMi)@en[[[PageTransitionEvent]]]] [[インターフェイス]]および
[CODE(DOMi)@en[[[PageTransitionEventInit]]]] [[辞書]]は、[CODE(IDL)@en[[[boolean]]]]
型の[[IDL属性]] [DFN[[CODE(DOMa)@en[[[persisted]]]]]]を持ちます [SRC[>>41]]。
初期値は[[偽]]です [SRC[>>41]]。

* 歴史

[7] [CITE@en[(X)HTML5 Tracking]]
([TIME[2009-10-21 23:23:27 +09:00]] 版)
<http://html5.org/tools/web-apps-tracker?from=4230&to=4231>

[8] [CITE[Bug 7896 – Specify pageshow and pagehide events]]
([TIME[2009-10-25 15:53:56 +09:00]] 版)
<http://www.w3.org/Bugs/Public/show_bug.cgi?id=7896>

[9] [CITE[Changeset 47824 – WebKit]]
([TIME[2009-10-25 15:58:08 +09:00]] 版)
<http://trac.webkit.org/changeset/47824>

[10] [CITE[IRC logs: freenode / #whatwg / 20100113]]
([TIME[2010-01-15 23:57:05 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20100113#l-474>

[13] [CITE[''''''[''''''whatwg'''''']'''''' pagehide vs pagevis]]
( ([TIME[2013-08-30 00:53:42 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-August/040657.html>

[14] [CITE@en[Web Applications 1.0 r8160     Provide hook for pagevis. Correctly return false for event.persisted in pagehide. Define one of the variables in an algorithm.]]
( ([TIME[2013-09-01 06:43:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8159&to=8160>

[15] [CITE@en[274784 – (blazinglyfastback) Make back and forward blazingly fast and side-effect free]]
( ([TIME[2013-12-16 09:05:37 +09:00]] 版))
<https://bugzilla.mozilla.org/show_bug.cgi?id=blazinglyfastback>

[16] [CITE[IRC logs: freenode / #whatwg / 20131214]]
( ([TIME[2013-12-16 09:01:34 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20131214>

[FIG(quote)[
[FIGCAPTION[
[19] [CITE@ja[Chrome で高速にページを読み込む新しい技術のご紹介 - Google Developer Japan Blog]]
([TIME[2015-04-10 17:01:36 +09:00]] 版)
<http://googledevjp.blogspot.jp/2015/04/chrome.html>
]FIGCAPTION]

> Chrome 42 では、このコンパイル済みコードのローカルコピーを保持する拡張技術を採用することで、ユーザーがそのページに戻ってきたときにパースをダウンロードしてコンパイルする手順をすべて省略できるようになります。これによってすべてのページでコンパイル時間の 40% を削減し、モバイル端末において貴重なバッテリーの消費量を減らすことができます。 

]FIG]

[26] [CITE[Surfin’ Safari - Blog Archive » WebKit Page Cache II – The unload Event]]
([TIME[2009-10-25 15:54:55 +09:00]] 版)
<http://webkit.org/blog/516/webkit-page-cache-ii-the-unload-event/>

[27] [CITE@en[Web Applications 1.0 r8160     Provide hook for pagevis. Correctly return false for event.persisted in pagehide. Define one of the variables in an algorithm.]]
( ([TIME[2013-09-01 06:43:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8159&to=8160>