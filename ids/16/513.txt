[3] [DFN[[RUBYB[タスク源]@en[task source]]]]は、[[タスク]]の分類です。
[[タスク]]が[[タスクキュー]]に追加される際には、[[タスク源]]が指定されます。
[[タスクキュー]]は[[タスク源]]によって分けられており、
同じ[[タスク源]]の[[タスク]]同士の実行順序は[[タスクキュー]]への追加順序となることが保証されます。

* 仕様書

[REFS[
- [2] '''[CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#task-source>'''
- [11] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2013-02-09 02:07:40 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#unshipped-port-message-queue>
]REFS]

* 処理モデル

[4] 同じ[[タスク源]]の[[タスク]]は、同じ[[タスクキュー]]に追加され[['''なければなりません''']]。
[SRC[>>2]]

;; [5] [[利用者エージェント]]は1つの[[イベントループ]]に複数の[[タスクキュー]]を持つことができ、
好きな[[タスクキュー]]に好きな[[タスク]]を入れて[[優先度付きキュー]]として処理できます。
ただし、 >>4 の制約があり、同じ[[タスク源]]にある[[タスク]]については実行順序が入れ替わらないことが保証されています。

* タスク源の一覧

[6] [[タスク源]]としては次のものがあります。
[FIG(list short)[
- [[DOM操作タスク源]]
- [[利用者対話タスク源]]
- [[ネットワーク処理タスク源]]
- [[履歴探索タスク源]]
- [[媒体要素イベントタスク源]]
- [[画布blob直列化タスク源]]
- [[画布更新タスク源]]
- [[タイマー・タスク源]]
- [[遠隔イベント・タスク源]]
- [[WebSocketタスク源]]
- [[投稿済みメッセージタスク源]]
- [[ポート・メッセージ・キュー]]
- [[未出荷ポート・メッセージ・キュー]]
- [[[CODE(DOMi)@en[XMLHttpRequest]]タスク源]]
- [[[CODE(DOMi)@en[FileReader]]タスク源]]
- [[データベース・アクセス・タスク源]]
- [[埋め込みタスク源]]
- [[WebGLタスク源]]
- [[マイクロタスクタスク源]]
- [[フォント読み込みタスク源]]
- [[application life-cycle task source]]
]FIG]

[18] かつて定義されていた次の[[タスク源]]は既に削除されています。
[FIG(short list)[
- [[雛形タスク源]]
- [[[CODE(DOMi)@en[FileSaver]]タスク源]]
- [[装置タスク源]]
- [[[CODE(DOMi)@en[PendingOp]]タスク源]]
]FIG]

[7] ほとんどの[[タスク源]]は[[イベントループ]]に1つずつ存在していますが、
[[ポートメッセージキュー]]は[[著者]]が [CODE(DOMi)@en[[[MessagePort]]]]
[[オブジェクト]]を作成することによって任意個作成されます。
[[媒体要素イベントタスク源]]と
[[[CODE(DOMi)@en[XMLHttpRequest]]タスク源]] もオブジェクトごとに存在します。
[[[CODE(DOMi)@en[FileReader]]タスク源]]、[[[CODE(DOMi)@en[FileSaver]]タスク源]]もオブジェクトごとに存在するようです。

[12] [[ポートメッセージキュー]]と[[未出荷ポートメッセージキュー]]は特別な関係にあります。
[CODE(DOMi)@en[[[MessagePort]]]] は他の[[閲覧文脈]]に転送することができますが、
それまでは[[未出荷ポートメッセージキュー]]にも属します。また[[タスク]]の削除は、どちらからも削除します。
なお[[未出荷ポートメッセージキュー]]は[[イベントループ]]ごとに1つだけあります。
[SRC[>>11]]

;; [13] 転送していない [CODE(DOMi)@en[[[MessagePort]]]] では必ず同じ順序で[[タスク]]が実行されることを保証し、
転送してしまった [CODE(DOMi)@en[[[MessagePort]]]] では任意の実行順序となることを認めるためにこのような複雑な構造になっています。

[16] [[タスク源]]の一覧は >>17 にあります。

[REFS[
- [17] [CITE[data-web-defs/data/browsers.json at master · manakai/data-web-defs]] ([TIME[2014-04-09 13:08:57 +09:00]] 版) <https://github.com/manakai/data-web-defs/blob/master/data/browsers.json>
]REFS]


* イベント順との関係

[8] [[DOM3イベント]]は[[イベント]]同士の関係を[[イベント順]]により規定しています。
[[DOM3イベント]]は[[イベント・ループ]]や[[タスク]]という概念を使っておらず、
この[[イベント順]]は適宜[[タスク源]]として使うことによって[[イベント・ループ]]と互換性がある形で実装できる、
としています。

[REFS[
- [9] [CITE@en-US[Document Object Model (DOM) Level 3 Events Specification]] ([TIME[2012-03-21 00:00:37 +09:00]] 版) <http://dev.w3.org/2006/webapi/DOM-Level-3-Events/html/DOM3-Events.html#event-order-and-loops>
]REFS]

;; [10] 具体的にどう対応付けるのかは説明を読んでもあんまりよくわかりません。 [[HTML]]
は[[マウス]]も[[鍵盤]]も同じ[[利用者対話タスク源]]で扱っていますが、
[[DOM3イベント]]は独立してるからそれぞれ別の[[タスク源]]だ、とか言っていますし、
[[焦点]]の変更など独立した操作がそれぞれ[[タスク源]]だ、とか訳のわからないことも言ってます。

* マイクロタスクとの関係

[15] [[マイクロタスク]]の[[タスク源]]はすべて[[マイクロタスクタスク源]]と定義されています。

[14] [[マイクロタスク]]には[[タスクキュー]]とは別の[[マイクロタスクキュー]]が存在しています。
これは[[マイクロタスク源]]の[[タスク]] ([[マイクロタスク]]) を実行する[[タスクキュー]]とは別のものです。

* 歴史

[REFS[
- [1] [CITE[IRC logs: freenode / #whatwg / 20100824]]
( ([TIME[2010-09-02 21:15:06 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20100824>
]REFS]

[19] [CITE@en[Fix #19: Remove majority of "DOM Event Architecture" section · w3c/uievents@6cb42db]]
([TIME[2016-03-08 18:11:43 +09:00]] 版)
<https://github.com/w3c/uievents/commit/6cb42db4054c5502d28c3f53c6ae64da5e475747>