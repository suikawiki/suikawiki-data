[88] [DFN[[[navigate]]]] ([[名詞形]] [DFN[navigation]]) は、
[[資源]]へのアクセスを行い[[閲覧文脈]]の表示を切り替えたり、
[[ダウンロード]]その他の動作を発生させたりする操作です。[[ハイパーリンク]]の[[クリック]]やそれに相当する
[[JavaScript]] の操作などにより呼び出されます。
[[Webブラウザー]]を構成する最も基礎的で重要な
(しかし複雑で難解な) [[アルゴリズム]]の1つです。

* 仕様書

[REFS[
- [12] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#navigate>'''
-- [246] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#initialise-the-document-object>
- [191] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#an-overridden-reload>
- [210] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#dom-navigator-registercontenthandler>
- [244] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#origin-2>
- [258] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#the-sessionstorage-attribute>
- [266] [CITE@en[DOM Standard]] ([TIME[2015-07-16 14:57:57 +09:00]] 版) <https://dom.spec.whatwg.org/#document>
- [285] [CITE@en[Upgrade Insecure Requests]] ([TIME[2015-10-07 03:24:10 +09:00]] 版) <https://w3c.github.io/webappsec-upgrade-insecure-requests/#nesting>
- [416] [CITE@en[High Resolution Time Level 2]] ([TIME[2016-02-26 04:49:50 +09:00]]) <https://w3c.github.io/hr-time/#h-time-origin-1>
]REFS]

* 意味

[282] [[navigate]] は、[[閲覧文脈]]の[[履歴]]上に新しい[[エントリー][セッション履歴エントリー]]を作成し、
移動することを目的とした様々な一連の処理です。新しい[[エントリー][セッション履歴エントリー]]は新たにネットワークから取得
([[fetch]]) した[[資源]]かもしれませんし、現在[[閲覧文脈]]で表示中の[[文書]]の[[素片][素片識別子]]かもしれません。

[283] [[navigate]] の結果[[閲覧文脈]]の[[履歴]]上の移動が発生し表示が更新されるのが基本的な動作ですが、
[[navigate]] 先によっては[[ダウンロード]]などの処理が起動することがあります。
あるいは現在の[[閲覧文脈]]ではなく、新しい[[閲覧文脈]] (新しい[[窓]]や[[タブ]])
を開いて [[navigate]] することもあります。

* 文脈

[16] [[navigate]] は、[[仕様書]]で規定されている手順により ([[著者]]の指示により)
実行される場合もあれば、[[利用者エージェント]]依存の方法で ([[利用者]]の直接の指示により)
実行される場合もあります。

[EG[
[17] 前者の例として [CODE(JS)@en[[[location.href]]]] の設定が、
後者の例として[[アドレスバー]]からの [[URL]] の指定があります。
]EG]

[13] [[navigate]] を発生させる操作には、例えば次のものがあります。
[FIG(list middle)[
- [[利用者]]の指示
-- [[再読込]]操作
-- [[アドレスバー]]、[[メニュー]]、[[DnD]] 等[[利用者インターフェイス]]からの [[URL]] の指定
-- [[栞]]の選択
-- [[navigate]] によって生成された[[利用者]]に対する選択肢の実行
-- [[ソースの表示]]
-- [[入れ子閲覧文脈]]内の[[文書]]を新しい[[閲覧文脈]]で開く
--
[178] [[履歴の探索]]が行われる場合で、[[セッション履歴エントリー]]の[[文書]]が既に破棄されている時 ([[bfcache]] 上に[[文書]]が保存されていない時)
には、[RUBYB[エントリー更新]@en[entry update]]のための [[navigate]]
が行われます。
([[履歴の探索]]や[[セッション履歴エントリー]]を参照。)
-- [CODE(HTMLe)@en[[[blockquote]]]]/[CODE(HTMLe)@en[[[ins]]]]/[CODE(HTMLe)@en[[[del]]]] [CODE(HTMLa)@en[[[cite]]]]
をたどる[[利用者インターフェイス]]上の操作
- [[利用者]]または[[著者]]の指示
-- [[ハイパーリンクをたどる]]
-- [[フォーム提出]]
- [[著者]]の指示
-- [[フレーム]]
-- [CODE(HTMLe)@en[[[object]]]] [[要素]]
-- [CODE(HTMLe)@en[[[embed]]]] [[要素]]
-- [CODE(JS)@en[[[window.open]]]]
-- [CODE(JS)@en[[[location.assign]]]]
-- [CODE(JS)@en[[[location.replace]]]]
-- [CODE(JS)@en[location.href]] および各[[URL分解属性]]
-- [CODE(JS)@en[[[location.reload]]]]
-- [CODE(JS)@en[navigator.plugins.refresh]]
-- [CODE(HTTP)@en[[[Refresh]]]]
-- [[プラグイン]]からの指示
-- [[change the encoding]]
- 他のアプリケーションからの指示
-- [[コマンドライン引数]]や[[プロセス間通信]]等の他の[[アプリケーション]]からの [[URL]] の指定
-- [[WebDriver]] の操作
-- [[ブラウザー拡張]]からの指示
-- [[開発者コンソール]]など[[ブラウザー]]内の外部機能からの指示
]FIG]

* 入力

[41] [[navigate]] には、次の入力 ([[引数]]) があります。最初の3つは必須です。
[FIG(list members)[
:[14] [VAR[[[navigate]] する[[閲覧文脈]]]]:[[navigate]] によって[VAR[新しい[[資源]]]]を表示するべき[[閲覧文脈]]です。
:[21] [VAR[新しい[[資源]]]]:[VAR[[[navigate]] する[[閲覧文脈]]]]に新たに表示するべき[[資源]]です。
ここで[[資源]]は次のものによって表されます。
[FIG(list members)[
: [F[要求]] : [[要求]]または [[null]]。
[FIG(list members)[
([[要求]]は[F[URL][要求URL]] ([[URL記録]]。必須。)、
[F[参照元]] ([CODE[client]] または [CODE[no-referrer]]。既定値は [CODE[client]]。)、
[F[参照元ポリシー]] ([[参照元ポリシー]]。既定値は[[空文字列]]。)、
[F[メソッド][要求メソッド]] ([CODE(HTTP)@en[GET]] または [CODE(HTTP)@en[POST]]。
既定値は [CODE(HTTP)[GET]]。)
を持ちます。)
: [VAR[[CODE[acceptSslCerts]]]] :
[[WebDriver]] の [CODE[acceptSslCerts]] か、それに相当する[[利用者インターフェイス]]上の操作を[[利用者]]が行ったかどうかを表すフラグです。
[[既定値]]は[[偽]]です。
]FIG]
: [F[応答]] : [[応答]]または [[null]]。
([CODE(HTMLe)@en[embed]]/[CODE(HTMLe)@en[object]] の [[fetch]] の結果、
[[ネットワークエラー]]など。)

- ([[リダイレクト]]前の) 最初の [[URL]]
- [[応答]]
- [[a known definite encoding]]
- [[AppCache]] から [[fetch]] したか否か

[EG[
[24] [CODE(HTMLe)@en[[[object]]]] [[要素]]や [CODE(HTMLe)@en[[[embed]]]] の処理では、
[[資源]]の [[fetch]] が開始されてから [[navigate]] が呼び出されることがあります。
]EG]
[EG[
[55] [[navigate]] の結果表示される [[navigate]] の選択肢を[[利用者]]が選んだ場合にも、
(再度 [[fetch]] するのは無駄なので) [[fetch]] 結果付きで [[navigate]] を呼び出すべきかもしれません。
]EG]
[EG[
[186] [[ハイパーリンクをたどる]]場合や [CODE(JS)@en[[[window.open]]]] や [[overridden reload]] では、
[[URL]] のかわりにソースやエラーページが指定された [[navigate]] が実行されることもあります。
]EG]
[EG[
[188] [[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]では [[URL]]
と共にソースが指定されます。
]EG]
[EG[
[189] [CODE(JS)@en[[[document.open]]]] で追加される[[セッション履歴エントリー]]の[[エントリー更新]]では指定されたソースが使われます。
]EG]
[EG[
[225] [[change the encoding]] は[[応答]]を指定して、または [[URL]] 等 [[fetch]]
条件を指定しての [[navigate]] を呼び出すことがあります。その際
[[a known definite encoding]] も指定されます。
]EG]
]FIG]
: [VAR[ナビゲーション型]] : [CODE[form-submission]] または [CODE[other]]。
[[既定値]]は [CODE[other]]。
:[15] [DFN[[VAR[[RUBYB[始点閲覧文脈]@en[source browsing context]]]]]]:
[[navigate]] の開始に責任を持つ[[閲覧文脈]]です [SRC[>>12]]。
[VAR[[[始点閲覧文脈]]]]は、 [VAR[[[navigate]] する[[閲覧文脈]]]]について
[[navigate]] を認められているか、いないかのいずれかです。
:[19] [DFN[[VAR[[RUBYB[例外有効]@en[exceptions enabled]]]]]] [SRC[>>12]]:
[[navigate]] できない時に[[例外]]を投げるかどうかのフラグです。
:[22] [DFN[[VAR[[[reload-triggered navigation]]]]]] [SRC[>>12]]:[[再読込]]操作かどうかのフラグです。
このフラグが設定されていれば、[[素片識別子]]を無視すると現在表示中の[[文書]]の
[[URL]] と等しい時でも、 [[navigate]] が行われます。
:[43] [DFN[[VAR[[RUBYB[上書きURL][override URL]]]]]] [SRC[>>12]]:[[文書の番地]]として使う [[URL]]
です。外部から設定されるのは [[override reload]] やそれに相当する[[履歴の探索]]の時だけですが、
[[navigate]] 中に [CODE(URI)@en[[[javascript:]]]] の処理で設定されることもあります。
:[65] [[ポップアップ]]が認められるか否か:[[外部アプリケーション]]を起動するべきかどうかに影響します。
[[navigate]] 呼び出し元の[[タスク]]によって決まります。
[[allowed to show a popup]] や[[閲覧文脈の選択]]を参照。
:[238] 新しい[[最上位閲覧文脈]]か否か:[[閲覧文脈]]を使わなかった時に[[窓]]や[[タブ]]を閉じるべきかどうかに影響します。
[[閲覧文脈の選択]]を参照。
:[98] [VAR[[[エントリー更新]]する[[エントリー]]]]:[[エントリー更新]]のための [[navigate]]
の場合には、その[[セッション履歴エントリー]]。
:[179] [VAR[キャッシュ上書き]] : [[再読込]]による [[navigate]] 時に指定されます。
:[190] [VAR[[[reload override flag]]]]:[CODE(JS)@en[[[document.open]]]] により破棄された[[文書]]を再表示するために使います。
:[195] [VAR[[[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]]]:
[[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]かどうかを表します。
:[245] [VAR[[[文書の起源]]]] [DEL[と[VAR[[[実効スクリプト起源]]]]]] :
[VAR[新しい[[資源]]]]の[F[URL]]の[F[scheme][URL scheme]]が
[CODE(URI)@en[data][data:]] や [CODE(URI)@en[javascript][javascript:]]
の場合に使われる可能性のある[[起源]][DEL[と[[実効スクリプト起源]]]]です。
[CODE(URI)@en[[[data:]]]] [[URL]] では、
[[スクリプト]]による呼び出しの場合は[[現職設定群オブジェクト]]の[F[起源][文書の起源]][DEL[と[F[実効スクリプト起源]]]]、
そうでない場合は[[要素]]の[F[節点文書]]の[F[起源][文書の起源]][DEL[と[F[実効スクリプト起源]]]]です [SRC[>>244]]。
[CODE(URI)@en[[[javascript:]]]] [[URL]] では、
[VAR[[[navigate]] する[[閲覧文脈]]]]の[F[活性文書]]の[F[起源][文書の起源]][DEL[と[F[実効スクリプト起源]]]]です [SRC[>>244]]。
(いずれにせよ、 [[navigate]] 呼び出し時点での値です。)
: [VAR[提案ファイル名]] :
[[navigate]] の結果[[ダウンロード]]となった時に使う[[ファイル名]]です。
[[リンク元]]の[[要素]]の [CODE(HTMLa)@en[download]] [[属性値]]が設定されます。
: [VAR[[[遷移型]]]] : ページ遷移を発生させた利用者等の操作の種類を表す値です。
: [VAR[[[遷移修飾子]]群]] : [[navigate]] の発生要因を表す値のリストです。

[HISTORY[
[310] 次のオプションは廃止されました:

:[20] [DFN[[VAR[[RUBYB[明示的自己ナビゲーション上書き]@en[explicit self-navigation override]]]]]] [SRC[>>12]]:
[VAR[[[navigate]] する[[閲覧文脈]]]]の選択方法についてのフラグです。
[CODE(DOMa)@en[[[seamless]]]] な [CODE(HTMLe)@en[[[iframe]]]] 内での[[リンク]]が外側の[[閲覧文脈]]の
[[navigate]] に読み替えられるべきかどうかの判断に影響します。 ([CODE(HTMLa)@en[[[target]]]]
による[[閲覧文脈]]の選択と [[navigate]] は別[[タスク]]で行われることがあるため、
その間に [CODE(HTMLa)@en[[[seamless]]]] かどうかは変化することがあり、
一般に [[navigate]] 呼び出し前に予めその判断を済ませておくことはできません。)
]HISTORY]
]FIG]

[116] [VAR[[[navigate]] する[[閲覧文脈]]]]や[VAR[新しい[[資源]]]]はアルゴリズム内で変更されることがあります。

[121] [[navigate]] は [[unload a document]] や [[prompt to unload a document]]
が実行中かどうかにより分岐することがあります。それらが同じ[[閲覧文脈]]の [[navigate]]
と[[並列]]に実行されることは無いので、事実上、それらの手続きの内側での呼び出しかどうかを調べるものです。

[120] [[navigate]] や [[traverse the history by a delta]] や
[CODE(JS)@en[[[window.stop]]]] は、
同じ[[閲覧文脈]]に関する他の [[navigate]] にアクセスすることがあります。

;; [167] [[navigate]] から呼び出した [[unload a document]] を実行中か調べることもあります。

[122] [[navigate]] は、取り消しされることがあります (>>123)。
[VAR[取り消し]]フラグは取り消されたかどうかを表します。
取り消された場合は理由が設定されます。

[108] 入力ではありませんが、アルゴリズム中で
[DFN[[VAR[[[mature]]]]]] フラグを使います。どちらも初期値は[[偽]]です。 [SRC[>>12]]
[VAR[時刻起源]]の初期値は[[未定義]]です。

;; [177] [[mature]] フラグは [[traverse the history by a delta]] からも参照されます。

[HISTORY[
[422] かつては [DFN[[VAR[gone async]]]] フラグがあり、
[[リダイレクト]]に関する複雑な処理が記述されていました。
2016年7月改訂でこれを使わない形に改められました。
]HISTORY]

[117] 入力ではありませんが、アルゴリズム内で[VAR[新しい[[文書]]]]が作成されることがあります。

[42] [VAR[始点文書]]は、[[navigate]] 開始時点の[VAR[始点閲覧文脈]]の[F[活性文書]]です。
[VAR[始点設定群オブジェクト]]は、 [[navigate]] 
開始時点の[VAR[始点文書]]の[F[環境設定群オブジェクト]]です。

;; [330] [[HTML Standard]] は「[[navigate]] 開始時点」とは規定していませんが、
[[リダイレクト]]を含む場合、[VAR[始点閲覧文脈]]の他の [[navigate]]
によって[F[活性文書]]が変化する可能性がありそうで、
その場合でも元の[F[活性文書]]を使うのが適切そうです。

* 概略

[226] [[navigate]] は次のように複雑に動作します。

[FIG(flow)[
:start:開始 >>18
:->:terminate
:->:url

:terminate: 停止
:>>:5

:url:URL >>162
:->:fragment
:->:fetch
:->:nondoc
:->:outside

:fetch: Fetch >>145
:->:cleanup
:->:res

:res:[[応答]] >>26
:->:mime
:->:nondoc
:->:outside

:mime:MIME 型 >>44
:->:doc
:->:nondoc
:->:outside

:doc: 文書 >>30
:->:history

:nondoc:非文書 >>47
:>>:1
:->:history

:outside: 文脈外 >>48
:>>:2
:->:cleanup

:history: 履歴 >>95
:->:cleanup

:fragment: 素片 >>163
:>>:4
:->:cleanup

:cleanup: 停止 >>109
:v:
:>>:5
]FIG]

* navigate の開始

[18] [[利用者エージェント]]は、 [[navigate]] を次のように行わなければ[['''なりません''']]
[SRC[>>12]]。

[FIG(steps)[
= [293] [VAR[[[始点閲覧文脈]]]]が [VAR[[[navigate]] する[[閲覧文脈]]]]を 
[[navigate することを認められてい][allowed to navigate]]なければ、
== [296] [VAR[例外有効]]なら、 [CODE(DOMe)@en[[[SecurityError]]]] [[例外]]を投げます。
== [237] 其れ以外なら、[[利用者エージェント]]は、[[利用者]]に次の選択肢を提示しても構いません。
(>>236 も参照)
==- [294] 新しい[[最上位閲覧文脈]]を開き、そちらをかわりに [[navigate]]
==- [295] [VAR[[[始点閲覧文脈]]]]の[[最上位閲覧文脈]]をかわりに [[navigate]]
== [297] 停止します。
= [298] 
[FIG(list)[
- [VAR[[[始点閲覧文脈]]]]と [VAR[[[navigate]] する[[閲覧文脈]]]]が同じで、
- [VAR[[[navigate]] する[[閲覧文脈]]]]が他の [[navigate]] を実行中で、
- その [[navigate]] が [[unload a document]] を実行中で、
- その [[navigate]] の[VAR[新しい[[資源]]]]の [[URL]] の[[起源]]と本 [[navigate]] 
の[VAR[新しい[[資源]]]]の [[URL]] の[[起源]]が[[同じ起源]]では''ない''なら、
]FIG]
... ここで停止します。
= [[traverse the history by a delta]] の[[タスク]]が [[unload a document]]
を実行中で、それが [VAR[[[navigate]] する[[閲覧文脈]]]]の[[活性文書]]に関するものなら、
ここで停止します。
= [[prompt to unload a document]] を実行中で、
それが [VAR[[[navigate]] する[[閲覧文脈]]]]の[[活性文書]]に関するものなら、ここで停止します。
= [[URL]] に基づく処理 (>>162) に移ります。
]FIG]

;; [180] [VAR[新しい[[資源]]]]の [[URL]] が無い場合は[[上書きURL]]
を使うものと思われます。

[236] [[入れ子閲覧文脈]]で [[navigate]] するべきところ、かわりに
>>237 操作を[[利用者]]に選択させるのは、[[著者]]の[[砂箱化]]の要求を無視する場合もあり、
危険かもしれません [SRC[>>12]]。 [[Webブラウザー]]は、 [[popup sandboxing flag set]]
を活用するなど、安全性への配慮が必要かもしれません。

;; [[砂箱化]]や[[閲覧文脈の選択]]も参照。

[404] [CODE[webNavigation]] API の [CODE[onBeforeNavigate]] はこの付近のタイミングで現在時刻と共に呼び出されるものと思われますが、
明文規定は存在しないようです。

* URL に基づく処理

[162] [[利用者エージェント]]は次のようにしなければ[['''なりません''']] [SRC[>>12]]。

[FIG(steps)[
= [382] 
[FIG(list)[
- [383] [VAR[[[reload-triggered navigation]]]] が[[偽]]
- [434] [VAR[新しい[[資源]]]]の[F[要求]]が [[null]] でない
- [384] [VAR[新しい[[資源]]]]の[F[要求]]の [F[URL][要求URL]] と
[VAR[[[navigate]] する[[閲覧文脈]]]]の[F[活性文書]]の[F[URL][文書の番地]]が
[VAR[[[URL除外フラグ]]]]付き[[URL等価]]
- [385] [VAR[新しい[[資源]]]]の[F[要求]]の [F[URL][要求URL]] の[F[素片][素片識別子]]が [[null]] でない
-
@@ [386] [DEL[[VAR[新しい[[資源]]]]の[F[メソッド][要求メソッド]]が [CODE(HTTP)@en[[[GET]]]]]]
]FIG]
... のすべてを満たすなら、
== [387] [[素片識別子]]に navigate (>>163) する処理に移り、こちらはここで終わります。
= [423] [VAR[[[navigate]] する[[閲覧文脈]]]]が同じ [[navigate]] のうち、 [VAR[[[mature]]]]
フラグが設定されていないものがあれば、当該 [[navigate]] の取り消し処理を実行します。
= [411] [[prompt to unload a document]] を実行します。
= [412] [VAR[取り消し]]フラグが設定されているか、 [[refused to allow the document to be unloaded]] なら、
== [413] 後片付け (>>109) に移り、こちらはここで終わります。
= [414] [VAR[[[navigate]] する[[閲覧文脈]]]]の[F[活性文書]]を[[abort][文書のabort]]します。
= [415] [VAR[時刻起源]]を、現在時刻に設定します。 [SRC[>>416]]
= [VAR[[[navigate]] する[[閲覧文脈]]]]が[[入れ子閲覧文脈]]の場合は、
その[[入れ子閲覧文脈]]の [[delaying [CODE(DOMe)@en[load]] events mode]] フラグを設定します。
= [155] [[並列に]]、[[fetch]] またはそれに相当するもの (>>145) を実行します。
]FIG]

;; [196] [[navigate]] の続きの処理は[[並列に]]実行され、 [[navigate]] 
の呼び出し元はそちらの次の処理へと進みます。

;; [224] [[素片識別子]]が無い [[URL]] なら、[[文書の番地]]と同じ [[URL]]
であっても、[[素片識別子]]への [[navigate]] ではなく通常の [[navigate]]
になります。

[410] [VAR[新しい[[資源]]]]の [F[URL]] に [[userinfo]] が含まれる場合、
[[Chrome]] は無視する (認証に使わない) ようです。
[[Firefox]] は[[フィッシング]]の可能性を指摘する [[confirm]]
[[モーダルダイアログ]]を表示し、[[利用者]]が拒んだ場合は何もしないこととするようです。
[TIME[2016-06-19T15:55:48.300Z]]

[403] [[事前レンダリング]]が実装されていて本 [[navigate]] で利用できる場合には、
[[fetch]] のかわりに[[事前レンダリング]]への差し替えが行われるものと思われますが、
明文規定はありません。

;; [[事前レンダリング]]参照。

* fetch またはそれに相当するもの

[145] [[navigate]] は、 [[fetch]] やそれに相当する操作を次の通り行わなければ[['''なりません''']]。

[FIG(steps)[
= [146] [VAR[新しい[[資源]]]]の[F[応答]]が [[null]] でなければ、
== [201] [[navigate応答の処理]] (>>26) を実行します [SRC[>>12]]。
[FIG(list members)[
: [VAR[要求]] : [CODE[null]]
: [VAR[応答]] : [VAR[新しい[[資源]]]]の[F[応答]]
: [VAR[閲覧文脈]] : [VAR[[[navigate]]する[[閲覧文脈]]]]
: [VAR[始点閲覧文脈]] : [VAR[始点閲覧文脈]]
: [VAR[ナビゲーション型]] : [VAR[ナビゲーション型]]
]FIG]
= [147] それ以外で、 [VAR[新しい[[資源]]]]の [F[URL]] の [F[scheme][URL scheme]]
が [CODE(URI)@en[javascript][javascript:]] なら、
== [148] [[[CODE(URI)@en[javascript:]] URLへのnavigate]]を実行します [SRC[>>12]]。
[VAR[[[navigate]] する[[閲覧文脈]]]]、[VAR[新しい[[資源]]]]、
[VAR[[[始点閲覧文脈]]]]、[VAR[[[上書きURL]]]]を引き渡します。
= [149] それ以外で、
[FIG(list)[
- [VAR[新しい[[資源]]]]の[[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- [VAR[新しい[[資源]]]]の [[URL]] と[[同じ起源]]の [[URL]] を持つ [[relevant application cache]]  があり、
- その [[AppCache]] [[エントリー]]のいずれかが[VAR[新しい[[資源]]]]の [[URL]] を持ち、
- ただしその[[エントリー]]は [[foreign]] ではなく、
- その [[mode]] が [[fast]] であり、
- [[利用者エージェント]]が[[AppCache]]を使わないモードでなければ、
]FIG]
... [[最適AppCache]]からの[VAR[新しい[[資源]]]]の [[fetch]] を呼び出します [SRC[>>12]]。
=- [150] この時、[VAR[ナビゲーション型]]が [CODE[form-submission]] なら、
[[fetch]] の呼び出し元の[[起源]]は[VAR[始点文書]]の[[起源]]に (あれば)
します [SRC[>>12]]。
==
@@
= [154] [VAR[新しい[[資源]]]]の[F[要求]]の[F[URL][要求URL]]の[F[scheme][URL scheme]]が
[[fetch scheme]] なら、
== [198] [[navigate fetchの処理]]を実行します。
[FIG(list members middle)[
: [VAR[要求]] : [VAR[新しい[[資源]]]]の[F[要求]]
: [VAR[閲覧文脈]] : [VAR[[[navigate]]する[[閲覧文脈]]]]
: [VAR[始点閲覧文脈]] : [VAR[始点閲覧文脈]]
: [VAR[ナビゲーション型]] : [VAR[ナビゲーション型]]
]FIG]
= [199] それ以外なら、
== [202] [VAR[新しい[[資源]]]]の[F[URL]]と[VAR[[[navigate]]する[[閲覧文脈]]]]について[[navigate URL schemeの処理]]を実行します。
]FIG]

[214] 以前は、 [[Webブラウザー]]依存の条件 (>>206) 次第で[[閲覧文脈]]外 (>>48) または[[非文書表示]]に移れることになっていました。
2016年7月の改訂で条件が明確化されたのですが、それによって、例えば
[CODE(URI)@en[about:blank]] 以外の [CODE(URI)@en[about:]] [[URL]]
の表示や、一部の [CODE(URI)@en[http:]] [[URL]] で[[アプリ]]が起動される機能が認められない形になってしまいました。

[398] [VAR[要求]]、[VAR[閲覧文脈]]、[VAR[始点閲覧文脈]]、
[VAR[ナビゲーション型]]についての
[DFN[[RUBYB[navigate fetchの処理]@en[process a navigate fetch]]]]は、
次のようにします [SRC[>>12]]。

[FIG(steps)[
= [151] [[要求]]の各欄を次の通り設定します。
[FIG(list members)[
: [F[クライアント]] : [VAR[始点設定群オブジェクト]]
: [F[対象閲覧文脈]] : [VAR[閲覧文脈]]
: [F[終点]]         : [CODE[document]]
: [F[モード]]       : [CODE[navigate]]
: [F[credentialsモード]]: [CODE[include]]
: [F[URL credentials利用フラグ]]: [[真]]
: [F[リダイレクトモード]]: [CODE[manual]]
: [F[[[[CODE(HTTP)@en[Origin]]ヘッダー省略フラグ]]]]: 
次のいずれかの場合を''除き''、設定する:
[FIG(list)[
- [273] 
@@ [VAR[始点文書]]の[F[起源][文書の起源]]があり、かつ、
- [274] 次のいずれかを満たす:
-- [271] 本[[要求]]の[[メソッド]]が [CODE(HTTP)@en[[[GET]]]] ''以外''の場合
-- [272] [VAR[ナビゲーション型]]が [CODE[form-submission]] の場合
]FIG]
... あるいは:
[FIG(list)[
- [153] [VAR[[[navigate]] する[[閲覧文脈]]]]が[[子供閲覧文脈]]で、かつ、
- [275] [VAR[[[navigate]] する[[閲覧文脈]]]]の[[閲覧文脈包含子]]が[[閲覧文脈適用範囲起源]]を持つ
]FIG]
: [F[起源]] :
[FIG(list)[
- [276] [VAR[[[navigate]] する[[閲覧文脈]]]]が[[子供閲覧文脈]]で、かつ、
- [277] [VAR[[[navigate]] する[[閲覧文脈]]]]の[[閲覧文脈包含子]]が[[閲覧文脈適用範囲起源]]を持つ
]FIG]
... なら、その[[閲覧文脈適用範囲起源]]
: [F[キャッシュモード]] : [VAR[キャッシュ上書き]]により定める [SRC[仕様書に規定なし]]
]FIG]
= [443] [VAR[要求]]、[VAR[ナビゲーション型]]、
[VAR[始点閲覧文脈]]、[VAR[閲覧文脈]]について
[[Should navigation request of type from source in target be blocked by Content Security Policy?]]
を実行した結果が [CODE[Blocked]] なら、
== [444] [[ネットワークエラー]]について >>156 を実行します。
= [445] それ以外なら、
== [152] [VAR[要求]]を [[fetch]] します。 [[process response]] は、 >>156 とします。
]FIG]

[156] 次の処理は、[VAR[応答]]について次のようにします [SRC[>>12]]。
[FIG(steps)[
= [362] [VAR[応答]]の[F[location URL]]が[[失敗]]なら、
== [363] [VAR[要求]]と[VAR[応答]]について、[[HTTPリダイレクトfetch]]を実行します。
[[process response]] は、 >>156 とします。
= [364] それ以外で、[VAR[応答]]の[F[location URL]]が [[URL記録]]なら、
[VAR[応答]]の[F[location URL]]の[F[scheme][URL scheme]]により、
[FIG(switch)[
: [[HTTP(S) scheme]] :
[VAR[要求]]と[VAR[応答]]について、[[HTTPリダイレクトfetch]]を実行します。
[[process response]] は、 >>156 とします。
: [CODE(URI)@en[blob]], [CODE(URI)@en[file]], [CODE(URI)@en[filesystem]], [CODE(URI)@en[javascript]] :
[VAR[応答]]を、[[ネットワークエラー]]に設定します。
: その他の [[fetch scheme]] :
[[navigate fetchの処理]]を実行します。
[FIG(list members)[
: [VAR[要求]] :
[FIG(list members)[
[FIGCAPTION[
[[要求]]
]FIGCAPTION]
: [F[URL][要求URL]] : [VAR[応答]]の[F[location URL]]
]FIG]
: [VAR[閲覧文脈]] : [VAR[閲覧文脈]]
: [VAR[始点閲覧文脈]] : [VAR[始点閲覧文脈]]
: [VAR[ナビゲーション型]] : [VAR[ナビゲーション型]]
]FIG]
: それ以外 :
[[navigate URL schemeの処理]]を実行します。[VAR[応答]]の[F[location URL]]と[VAR[閲覧文脈]]を引き渡します。
こちらはここで終わります。
]FIG]
= [365] '''Fallback in prefer-online mode''': 
[FIG(list)[
- [VAR[応答]]を [[AppCache]] から [[fetch]] した場合で、
- [VAR[要求]]の[F[メソッド][要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- [VAR[応答]]の[F[URL]]と[[同じ起源]]の [[URL]] を持つ [[relevant application cache]]  があり、
- その [[AppCache]] [[エントリー]]のいずれかの[F[URL]]が[VAR[応答]]の[F[URL]]で、
- ただしその[[エントリー]]は [[foreign]] ではなく、
- その [[mode]] が [[prefer-online]] であり、
- [VAR[取り消し]]フラグが理由 [[end-user abort]] で設定されておらず、
- [VAR[応答]]が[[ネットワークエラー]]か[VAR[応答]]の[F[状態][状態符号]]が非[[OK状態]]
]FIG]
... のすべてを満たすなら、
== [366] [[最適AppCache]]から[VAR[応答]]の[F[URL]]で識別されるエントリーを得ます。
== [367] そのエントリーが [[foreign]] でないなら、
=== [368] [VAR[応答]]を、そのエントリーの[[応答]]に設定します。
=== [[利用者]]に対して失敗したこととキャッシュを使うことを示して構いません。
= [369] '''Fallback for fallback entries''':
[FIG(list)[
- [VAR[応答]]を [[AppCache]] から [[fetch]] しなかった場合で、
- [VAR[要求]]の[F[メソッド][要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- [VAR[応答]]の[F[URL]]が [[relevant application cache]] の [[fallback namespace]]
に一致する場合で、
- その[[最適AppCache]]の [[online whitelist]] に[VAR[応答]]の[F[URL]]と[[同じ起源]]の [[URL]] を持ち、
[VAR[応答]]の[F[URL]]の先頭と一致するようなエントリーが無く、
- [VAR[取り消し]]フラグが理由 [[end-user abort]] で設定されておらず、
- [VAR[応答]]が[[ネットワークエラー]]か[VAR[応答]]の[F[状態][状態符号]]が非[[OK状態]]
]FIG]
... のすべてを満たすなら、
== [424] [[最適AppCache]]の [[fallback namespace]] に対する [[fallback resource]] を得ます。
== [425] そのエントリーが [[foreign]] でないなら、
=== [426] [VAR[応答]]を、そのエントリーの[[応答]]に設定します。
=== [427] [[利用者]]に対して失敗したことと [[fallback resource]] を使うことを示して構いません。
= [428] [[navigate応答の処理]] (>>26) を実行します。
[FIG(list members middle)[
: [VAR[要求]] : [VAR[要求]]
: [VAR[応答]] : [VAR[応答]]
: [VAR[閲覧文脈]] : [VAR[閲覧文脈]]
: [VAR[始点閲覧文脈]] : [VAR[始点閲覧文脈]]
: [VAR[ナビゲーション型]] : [VAR[ナビゲーション型]]
]FIG]
]FIG]

[HISTORY[
[370] 以前は[[安全なメソッド]]と [CODE(HTTP)@en[POST]] の場合を除き、
[[リダイレクト]]先も[[同じ起源]]でなければエラーとしてそれ以上処理しないことになっていました。
[[WF2]] 時代には[[フォームの提出]]で [CODE(HTTP)@en[PUT]] や [CODE(HTTP)@en[DELETE]]
を使って [[navigate]] できました。 [[Opera]] ([[Presto]]) がこれを実装していました。
しかし現在では [CODE(HTTP)@en[GET]] と [CODE(HTTP)@en[POST]]
でしか [[navigate]] する方法はありません。
]HISTORY]

* 応答の処理

[26] [VAR[要求]]、[VAR[応答]]、[VAR[閲覧文脈]]、[VAR[始点閲覧文脈]]、
[VAR[ナビゲーション型]]に関する[DFN[[RUBYB[navigate応答の処理]@en[process a navigate response]]]]は、次のようにします。
[FIG(steps)[
= [25] [VAR[取り消し]]フラグが設定されていれば、終わりとします (>>109 へ)。
= [52] それ以外で、
[FIG(list)[
- [435] [VAR[応答]]が[[ネットワークエラー]]
- [441] 
@@ [CODE(HTTP)@en[X-Frame-Options:]] 違反
- [442] [VAR[要求]]、[VAR[応答]]、[VAR[ナビゲーション型]]、[VAR[始点閲覧文脈]]、
[VAR[閲覧文脈]]について
[[Should navigation response to navigation request of type from source in target be blocked by Content Security Policy?]]
が [CODE[Blocked]] を返す場合
]FIG]
... のいずれかの場合、
== [440] [[非文書表示]] (>>47) によることとします [SRC[>>12]]。
= [51] それ以外で、[VAR[応答]]の[F[状態][状態符号]]が [CODE(HTTP)[204]] か [CODE(HTTP)[205]]
なら、終わりとします (>>109 へ) [SRC[>>12]]。
= [53] それ以外で、[VAR[応答]]が [CODE(HTTP)@en[[[Content-Disposition:]] [[attachment]]]] 
なら、[[ダウンロード]]とします [SRC[>>12]] ([VAR[閲覧文脈]]外の処理 >>48)。
= [158] それ以外なら、[[MIME型]]依存の処理 (>>44) に進みます [SRC[>>12]]。
]FIG]

;; [157] [[navigate応答の処理]]は、[[navigate]] 本体の他に、 
[[[CODE(URI)@en[javascript:]] URLへのnavigate]] からも呼び出されます。

[183] [[Webブラウザー]]によっては、[VAR[応答]]の[F[状態][状態符号]]が
[CODE[4[VAR[xx]]]] や [CODE[5[VAR[xx]]]] で[F[本体][応答本体]]が一定サイズ以下の時、
[[非文書表示]]とすることがあります (>>134)。

[408] おそらく[[既読化]]もこの段階で行われると思われます。
[[既読化]]には[VAR[新しい[[資源]]]]の[F[URL]]や[VAR[応答]]の[F[URL][応答のURL]]を引き渡します。

[HISTORY[
[132] 2016年6月の改訂までは次のような規定がありましたが、削除されました。

[FIG(list)[
- [27] ここで、[[利用者エージェント]]が認識できる [[challenge]] を含まない
[CODE(HTTP)[[[401]]]] [[応答]]は、 [CODE(HTTP)[[[200]]]] 
[[応答]]同様に扱わなければ[['''なりません''']] [SRC[>>12]]。
- [28] [[利用者エージェント]]は [CODE(HTTP)[[[401]]]] [[応答]]で認識できる [[challenge]]
を含む場合であっても、[[応答]]を表示した上で、
非[[モーダルダイアログ]]によって[[ログイン]]できるようにしても構いません [SRC[>>12]]。
]FIG]

[184] [[TLSクライアント認証]]のダイアログの処理は [[fetch]] 側で規定されています。
[CODE(HTTP)[401]] や [CODE(HTTP)[407]] の[[HTTP認証ダイアログ]]の処理は、
以前より明確な規定はありませんが、将来的に [[fetch]] 側で規定されるものと思われます。

;; [284] [[クライアント認証]]のダイアログは、処理が更に進んだ[[応答]]の受信の後の方でも表示されることがあります。

[54] 改訂前は [[HTML Standard]] は [[HTTP]] の規定に委ねており、理論上はこれら以外にも
[[HTTPヘッダー]]等の指示に基づく動作を行う余地が残されていました (が[[仕様書]]の[[注釈]]で、
他のものは考えつかないと記されていました)。 [[fetch]] との統合と明確化により、
そうした曖昧な規定は削除されて動作が明確になりました。
]HISTORY]

* MIME 型依存の処理

[44] [[navigate]] により [[fetch]] (相当) を行い最終的に処理するべき[[資源]]が確定したら、
その[[資源]]の[[MIME型]]によって適切な処理を行います。

[45] ここで [[MIME型]]は、 [[sniffed MIME type]] を使わなければ[['''なりません''']]
[SRC[>>12]]。

;; [[Fetch Standard]] と [[MIME Sniffing]] の規定に基づき、 [[HTTP]] [CODE(HTTP)@en[[[Content-Type:]]]]
[[ヘッダー]]を無視することがあります。

[46] [[利用者エージェント]]は、[[MIME型]]と設定に基づき次のいずれかの処理を行わなければ[['''なりません''']] [SRC[>>12]]。
[FIG(list)[
- [VAR[閲覧文脈]]内で[[文書]]を[[レンダリング]]する (>>30)
- [VAR[閲覧文脈]]内で非[[文書]]を表示する (>>47)
- [VAR[閲覧文脈]]に影響しない処理を行う (>>48)
]FIG]

[50] いずれを選択するかは実装や設定に依存します (>>206)。 [[HTML Standard]]
仕様上「設定により」となっており、完全には規定されていませんが、
実際上は任意の動作が許されているわけではありません。例えば
[CODE(MIME)@en[[[text/html]]]] を常に[[ダウンロード]]として扱うような実装は
[[Web互換]]とは言えません。

[68] [[著者]]は、[[Webブラウザー]]の実装や設定によって挙動が変わり得る
[[MIME型]]を使わないよう、使う場合は特定の挙動を仮定しないよう注意するべきでしょう。

[EG[
[69] 例えば [[PDF]] が[[プラグイン]]により表示されるか、[[外部アプリケーション]]により表示されるか仮定するべきではありません。
]EG]

[399] この段階に達した時点で、 [CODE[webNavigation]] [[API]] の
[CODE[onCommitted]] を呼び出せるものと思われます。
[VAR[遷移型]]と[VAR[遷移修飾子群]]と現在時刻を引き渡します。

* 閲覧文脈内の文書表示

[30] [[閲覧文脈]]内に内容を[[レンダリング]]する方法は、
次の各 [[MIME型]]について規定されています。
[FIG(switch)[
:[31] [[HTML文書]]: [CODE(MIME)@en[[[text/html]]]] [SRC[>>12]]
:[32] [[XML文書]] (>>33 も参照) :[[明示的対応XML型]]以外の [[XML MIME型]] [SRC[>>12]]
:[35] [[平文]] :[CODE(MIME)@en[[[text/plain]]]] や [[JSON]] などの[[テキストファイル]] ([[明示的対応JSON型]]以外) [SRC[>>12]]
:[37] [[媒体]]: [[利用者エージェントが対応]]している[[画像形式]]、[[動画形式]]、[[音声形式]] [SRC[>>12]]
:[38] [[プラグイン]]: [[外部アプリケーション]]を使って[[閲覧文脈]]内に内容を[[レンダリング]]する型 [SRC[>>12]]
]FIG]

;; [216] 実際の[[Webブラウザー]]は、ごく限られた [[XML MIME型]]を除き、ほとんどの
[[XML MIME型]]を ([[XML]] としてではなく) 未対応として扱うことがあります。

;; [36] [[HTML Standard]] では [CODE(MIME)@en[[[multipart/x-mixed-replace]]]] 
の処理方法も規定されています [SRC[>>12]] が、最近の [[Webブラウザー]]からは削除されています。
([[画像形式]]としての [[MJPEG over HTTP]] には対応していますが、 [[navigate]]
では対応しないようになっています。)

;; [215] [[Webブラウザー]]によってはこの他にも独自の [[MIME型]]の処理を実装している場合があります。
例えば [[IE]] や [[Chrome]] は [[MHT]] に対応しています。

** 閲覧文脈内の文書の作成

[70] [[閲覧文脈]]で表示する[[文書]]は、次のように作成します。
[[HTML文書]]や[[平文]]の場合は、次のような[[タスク]]を[[ネットワークタスク源]]で[[キュー]]に追加しなければ[['''なりません''']] [SRC[>>12]]。
[[XML文書]]の場合も、次のように行います [SRC[>>12]]。
[[媒体]]や[[プラグイン]]の場合も、次のような[[タスク]]を[[ネットワークタスク源]]で[[キュー]]に追加する[['''べきです''']] [SRC[>>12]]。
非 [[DOM]] 行内内容の場合 (>>47) も、次のように行う[['''べき''']]です。
[FIG(steps)[
= [135] [VAR[取り消し]]フラグが設定されていれば、何もしない処理 (>>48) に移り、こちらはここで終わります。
= [102] [CODE(DOMi)@en[[[Document]]]] を作成します [SRC[>>12]]。
[VAR[新しい[[文書]]]]をこの[[文書]]に設定します。
= [103] [[MIME型]]などを設定します [SRC[>>12]]。
= [197] [VAR[[[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]]]が設定されていれば、
[[文書]]を[[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]とします。
= [192] [VAR[[[reload override flag]]]] が[[真]]なら、
== [193] [VAR[新しい[[文書]]]]の [[reload override flag]] を、[[真]]に設定します [SRC[>>191]]。
== [194] [VAR[新しい[[文書]]]]の [[reload override buffer]] を、[VAR[新しい[[資源]]]]の[[応答]]の[[本体]]の[[文字列]]に設定します [SRC[>>191]]。
= [417] [VAR[新しい[[文書]]]]の[F[時刻起源]]を、[VAR[時刻起源]]に設定します [SRC[>>416]]。
= [181] [VAR[新しい[[文書]]]]の[[文書の番地]]を設定します (>>182)。
= [267] [VAR[新しい[[文書]]]]の[[文書の起源]]と[[実効スクリプト起源]]を設定します
(>>268)。
= [104] [DFN[[RUBYB[文書オブジェクトの初期化]@en[initialise the document object]]]] [SRC[>>246]] を実行します [SRC[>>12]]。
== [248] 
[FIG(list)[
- [VAR[[[navigate]] する[[閲覧文脈]]]]の[F[[[セッション履歴]]]]が[[初期「[CODE(URI)@en[about:blank]]」文書]][VAR[初期文書]]の[[セッション履歴エントリー]]しか含まず、
- [VAR[[[置換有効]]]]であり、
- [VAR[初期文書]]の[F[起源][文書の起源]]と[VAR[新しい[[文書]]]]の[F[起源][文書の起源]]が[[同じ起源]]なら、
]FIG]
=== [301] [VAR[窓]]を、[VAR[初期文書]]の [F[[CODE(DOMi)@en[[[Window]]]]]] に設定します。 [SRC[>>246]]
== [249] そうでなければ、
=== [304] [VAR[窓]]を、新しい [CODE(DOMi)@en[[[Window]]]] に設定します [SRC[>>246]]。
=== [336] [CODE[InitializeHostDefinedRealm]] を実行します。
[FIG(list members)[
: [VAR[[[大域オブジェクト]]]] : [VAR[窓]]
: [VAR[大域[CODE[this]]値]] : [VAR[[[navigate]] する[[閲覧文脈]]]]の [F[[CODE(DOMi)@en[WindowProxy]]]]
]FIG]
[VAR[realm実行文脈]]を、作成された[[JavaScript実行文脈]]に設定します。 [SRC[>>246]]
=== [337] [VAR[realm実行文脈]]について[[閲覧文脈環境設定群オブジェクトの設定]]を実行します。 [SRC[>>246]]
== [302] [VAR[窓]]の[F[文書]]を[VAR[新しい[[文書]]]]に設定します [SRC[>>246]]。
== [324] [VAR[[[navigate]] する[[閲覧文脈]]]]の [F[[CODE(DOMi)@en[WindowProxy]]]] の
[F(ss)[Window]] を、[VAR[窓]]に設定します [SRC[>>246]]。
== [279] [VAR[新しい[[文書]]]]の[F[[[HTTPS状態]]]]を、[VAR[新しい[[資源]]]]の[F[[[応答]]]]の[F[[[HTTPS状態]]]]に設定します
[SRC[>>246]]。
== [378] [VAR[新しい[[文書]]]]の[F[参照元ポリシー]]を、[VAR[新しい[[資源]]]]の[F[応答]]について
[CODE(HTTP)@en[Referrer-Policy:]] [[ヘッダー]]の構文解析の結果得られた[[参照元ポリシー]]に設定します [SRC[>>246]]。
== [141] [VAR[新しい[[文書]]]]と[VAR[新しい[[資源]]]]について[[[CODE(DOMi)@en[Document]]のCSPリストの初期化]]を実行します [SRC[>>246]]。
== [379] [VAR[新しい[[資源]]]]の[[要求]]の[F[参照元]]が [CODE[no-referrer]] でなければ、
=== [250] [VAR[新しい[[文書]]]]の[F[参照元]]を、[VAR[新しい[[資源]]]]の[[要求]]の[F[参照元]]に設定します。 [SRC[>>246]]
== [251] [VAR[新しい[[文書]]]]について[[砂箱化を実装]]します。 [SRC[>>246]]
= [105] [[構文解析器]][VAR[構文解析器]]を作成し (>>77)、
[VAR[新しい[[文書]]]]を関連付けます [SRC[>>12]]。
= [286] [VAR[[[navigate]] する[[閲覧文脈]]]]が[[入れ子閲覧文脈]]の場合、 [SRC[>>285]]
== [287] [VAR[[[navigate]] する[[閲覧文脈]]]]の[[非保安要求ポリシー]]が「格上げする」なら、
=== [288] [VAR[新しい[[文書]]]]の[[現職設定群オブジェクト]]の[[非保安要求ポリシー]]を、「格上げする」に設定します。
=== [289] [VAR[[[navigate]] する[[閲覧文脈]]]]の[[非保安navigate格上げ集合]]の各値について、
[VAR[新しい[[文書]]]]の[[現職設定群オブジェクト]]の[[非保安navigate格上げ集合]]に追加します。
= [223] 必要があれば、[[ブラウザー拡張]]によって指定された [[CSS]]
を読み込んだり、[[内容スクリプト]]を実行したりします。
= [106] これより後、[[スクリプト]]の実行や [[stop parsing]] よりも前に、
(他のモードに移行 (>>33) したり[VAR[取り消し]]されたりしていなければ)
[[update the session history with the new page]] (>>95) を実行します [SRC[>>12]]。
]FIG]

;; [253] [[初期「[CODE(URI)@en[about:blank]]」文書]]なら
[CODE(DOMi)@en[[[Window]]]] [[オブジェクト]]が新しい[[文書]]に再利用されます。
これは [CODE(DOMi)@en[[[Window]]]] と[[文書]]との一対一対応関係が崩れる例外の1つです。

;; [254] 仕様書上は[[セッションストレージ領域]]の初期化に関する規定 [SRC[>>258]]
がありますが、実際上は [CODE(DOMa)@en[[[sessionStorage]]]] の最初の利用時まで遅延させられます。

[79] [[XML文書]]の場合[[タスクキュー]]に追加しなければならないと仕様書には明記されていませんが、
おそらくそうすることが想定されていると思われます。もっともそうしないとしても[[著者]]から違いを観測できるのか不明です。できたとしても困難と思われます。

[75] [[MIME型]]の設定においては、[[XML文書]]以外の時は[VAR[新しい[[文書]]]]の
[[HTML文書]]フラグを設定しなければ[['''なりません''']] [SRC[>>12]]。
[[プラグイン]]の時は[[プラグイン文書]]フラグを設定する[['''べきです''']] [SRC[>>12]]。 
また[VAR[新しい[[文書]]]]の[[内容型]]を [[HTML文書]]なら [CODE(MIME)@en[[[text/html]]]] に、
[[平文]]なら [[sniffed MIME type]] に設定しなければ[['''なりません''']] [SRC[>>12]]。
[[媒体]]や[[プラグイン]]なら [[sniffed MIME type]] に設定する[['''べきです''']] [SRC[>>12]]。

;; [76] [[XML文書]]の場合の[[文書]]の[[内容型]]の設定の規定はなぜかありません。

[235] 更に [[sniffed type]] が [CODE(MIME)@en[[[image/svg+xml]]]] であれば、
その旨のフラグ ([F[[[SVG]] [[navigate]] フラグ]]) を設定する必要があります。

;; [CODE(DOMm)@en[[[getSVGDocument]]]] で参照されます。

[182] [[文書の番地]]は、[[上書きURL]]が設定されていればその値に、
そうでなければ[VAR[新しい[[資源]]]]の [[URL]] に設定しなければ[['''なりません''']]
[SRC[>>12]]。

;; [185] [[リダイレクト]]を辿った場合には、最終的な [[URL]] に設定されます。

;; [329] [CODE(URI)@en[view-source:]] も参照。

[268] [[文書の[F[起源]]]][DEL[と[[実効スクリプト起源]]]]は、次のように決定しなければ[MUST[なりません]]。
[FIG(steps)[
= [256] [VAR[新しい[[文書]]]]の[F[活性砂箱化フラグ集合]]の[F[砂箱化起源閲覧文脈フラグ]]が設定されていれば、 [SRC[>>244]]
== [257] [VAR[新しい[[文書]]]]の[F[文書の起源]]を、新しい[[不透明起源]]に設定します。
= [119] それ以外で、[VAR[新しい[[文書]]]]の[F[文書の番地]]の[F[scheme][URL scheme]]が
[[network scheme]] なら、[SRC[>>244]]
== [247] [VAR[新しい[[文書]]]]の[F[文書の起源]]を、[VAR[新しい[[文書]]]]の[F[番地][文書の番地]]の[F[起源][URLの起源]]の複製に設定します。
= [255] それ以外で、
[VAR[新しい[[文書]]]]の[F[文書の番地]]が [CODE(URI)@en[about:blank]] か、
[VAR[新しい[[資源]]]]の [F[URL]] ([[リダイレクト]]前の最初のもの)
があってその [F[scheme][URL scheme]] が [CODE(URI)@en[data][data:]] なら、
[SRC[>>244]]
== [259] [VAR[新しい[[文書]]]]の[F[起源][文書の起源]]を、[VAR[文書の起源]]に設定します。
= [260] それ以外で、[VAR[新しい[[資源]]]]の [F[URL]] ([[リダイレクト]]前の最初のもの)
があってその [F[scheme][URL scheme]] が [CODE(URI)@en[javascript][javascript:]] なら、
[SRC[>>244]]
== [261] [VAR[新しい[[文書]]]]の[F[起源][文書の起源]]を、[VAR[文書の起源]]に設定します。
= [262] それ以外で、 [VAR[[[[CODE(HTMLa)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]]]なら、
[SRC[>>244]]
== [263] [VAR[新しい[[文書]]]]の[F[文書の起源]]を、
[VAR[[[navigate]] する[[閲覧文脈]]]]の[F[閲覧文脈包含子]]の[F[節点文書]]の[F[起源][文書の起源]]に設定します。
= [264] それ以外なら、 [SRC[>>244, >>266]]
== [265] [VAR[新しい[[文書]]]]の[F[文書の起源]]を、新しい[[不透明起源]]に設定します。
]FIG]

;; [334] [[HTML Standard]] は [CODE(URI)@en[about:blank]] への [[navigate]] をすべて >>255
としていますが、[[著者]]以外が [[URL]] を与えた場合 ([[アドレスバー]]や[[お気に入り]]からの選択の場合など)
は >>264 が適用されると思われます。

;; [333] [[初期[CODE(URI)@en[about:blank]]文書]]は [[navigate]] で作成される[[文書]]ではなく、
[[閲覧文脈の作成]]で作成される[[文書]]です。[[起源]]は[[初期[CODE(URI)@en[about:blank]]文書]]を参照。

;; [327] [CODE(URI)@en[view-source:]] は >>264 より[[不透明起源]]となります。

;; [328] [CODE(URI)@en[chrome:]] や [CODE(URI)@en[chrome-extension:]]
やその他の [CODE(URI)@en[about:]] のような[[Webブラウザー]]固有の [[URL]]
や[[ブラウザー拡張]]の [[URL]] への [[navigate]]
では、[[Webブラウザー]]依存の方法で決めた[[起源]]に設定すると思われます。

** 文書木の構築

[77] 表示する[[文書木]]を構築するために使う[[構文解析器]][VAR[構文解析器]]は、 
[[HTML文書]]なら[[HTML構文解析器]]、[[XML文書]]なら[[XML構文解析器]]です。
ただし[[平文]]の場合は[[テキストファイルのDOM構築]]方法を使います。
[[媒体]]の場合は[[構文解析器]]のかわりに[[媒体文書]]のDOMを構築し、
[[プラグイン]]の場合は[[構文解析器]]のかわりに[[プラグイン文書]]のDOMを構築します。
非 [[DOM]] 行内内容の場合は[[構文解析器]]のかわりに任意の [[DOM]] を構築できます (>>84)。

;; [72] [VAR[構文解析器]]は、 [[fetch]] によって得られた[[応答]]の [[MIME型]]に含まれる[[文字符号化]]の指定を入力として受け取ります。
ここでの [[MIME型]]は、 [[sniffed MIME type]] ではありません [SRC[>>12]]。

[71] [[process response body]] は、次のようにしなければ[['''なりません''']]。
[FIG(steps)[
= [312] [VAR[構文解析器]]の[[入力バイト列]]に受信した[[バイト列]]を連結します [SRC[>>12]]。
= [313] [VAR[構文解析器]]の処理を行います [SRC[>>12]]。
]FIG]

[73] [[process response end-of-file]] は、次のようにしなければ[['''なりません''']]。
[FIG(steps)[
= [314] [VAR[構文解析器]]の入力として暗黙の [[EOF]] 文字を与えます [SRC[>>12]]。
= [315] [VAR[構文解析器]]の処理を行います [SRC[>>12]]。
]FIG]

[316] [[process response body]] と [[process response end-of-file]]
を実行する[[ネットワークタスク源]]の[[タスク]]の[F[実行可否判断]]は、
次のようにしなければ[['''なりません''']]。
[FIG(steps)[
= [319] [VAR[構文解析器]]の[F[[[字句化器]]をブロック]]フラグが設定されていれば、
== [320] [[偽]]を返します。
= [318] それ以外なら、
== [317] [[真]]を返します。
]FIG]

;; [321] [[構文解析器]]の [CODE(HTMLe)@en[[[script]]]] [[要素]]の処理により、
[[字句化]]を行う[[タスク]]の処理が中断されることがあります。
[CODE(HTMLe)@en[[[script]]]] を参照。

[74] [VAR[構文解析器]]は、構文解析中のいずれかのタイミングで[[文書の文字符号化]]を設定します。

[78] [[構文解析器]]や[[プラグイン文書]]の構築処理は、
[[文書要素]]を[[文書に挿入]]するタイミングで
[[AppCache選択アルゴリズム]]を実行します [SRC[>>12]]。

;; [221] [[文書要素]]は、[[XML構文解析器]]が [[XML]] [[整形式制約]]違反を通知するものかもしれません。 ([[XML構文解析器]]参照。)

[222] [[Webブラウザー]]によっては、[[ブラウザー拡張]]の[[内容スクリプト]]を[[文書要素]]の最初の挿入時点で実行するものもあります。

[33] [[XML文書]]の場合、[[文書要素]]の[[名前空間]]によっては他の方法 (>>47、>>48)
で表示することにしても構いません [SRC[>>12]]。

[EG[
[34] 例えば[[フィード]]は、[[XML]] として [[DOM]] を表示するのではなく、
[[Webブラウザー]]組み込みの[[フィードビューアー]]により表示できます [SRC[>>12]]。
]EG]

;; [82] その場合、(少なくても仕様書のアルゴリズム上は) 作成されかけた
[[XML文書]]オブジェクトに[[著者]]がアクセスする方法はありません。

;; [118] 仕様書にはありませんが、理論上は [[abort a document]] を実行するべきかもしれません。
([[文書要素]]より前に [CODE(XML)@en[[[xml-stylesheet]]]] [[処理指令]]の [[fetch]]
が行われていたら、 [[abort a document]] により取り消されます。)

;; [171] [[IE]] は [CODE(MIME)@en[[[application/atom+xml]]]] や
[CODE(MIME)@en[[[application/rss+xml]]]] を[[フィードビューアー]]で表示するのに加え、
[CODE(MIME)@en[[[text/xml]]]] の時にバイト列を [[sniffing]] して[[フィード]]かどうか判定し、
[[フィードビューアー]]で表示します [SRC[>>170]]。 [[Firefox]]
も同様に [[sniffing]] を行います [SRC[>>172]]。厳密には [[HTML Standard]]
に沿った動作ではありません。
[REFS[
- [170] [CITE@en[Windows RSS Publisher's Guide (work-in-progress) - Microsoft RSS Blog - Site Home - MSDN Blogs]] ([TIME[2015-05-04 11:42:57 +09:00]] 版) <http://blogs.msdn.com/b/rssteam/archive/2005/08/02/publishersguide.aspx>
- [172] [CITE@en-US[XSL Transformations in Mozilla FAQ | MDN]] ([TIME[2014-03-22 05:56:30 +09:00]] 版) <https://developer.mozilla.org/en-US/docs/XSL_Transformations_in_Mozilla_FAQ>
]REFS]

[229] [CODE(XML)@en[[[xml-stylesheet]]]] により [[XSLT]]
[[スタイルシート]]が指定されているときは、 [[XSLT]] によって変換したものを
[[DOM]] として表示することになります。

;; これがどのように処理されるかはどこでも規定されていません。 [[フィードリーダー]]モードになることがあるのか、
[[unstyle document]] 表示もあるのか、どの時点で表示が切り替わるのか、
[[スクリプト]]から何にアクセスできるのかなど謎は多いです。

[EG[
[231] >>143 を [[Chrome]] は [[XSLT]] [[スタイルシート]]により表示しますが、
[[Firefox]] と [[IE]] は[[フィード]]として表示するようです。 [CODE(MIME)@en[[[text/xml]]]]
で、
[PRE(XML code)[
<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="http://blogs.technet.com/utility/feedstylesheets/rss.xsl" media="screen"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:slash="http://purl.org/rss/1.0/modules/slash/" xmlns:wfw="http://wellformedweb.org/CommentAPI/"><channel><title>日本のセキュリティチーム</title>
]PRE]
... から始まっています。

[REFS[
- [143] [CITE@en[日本のセキュリティチーム]] ([TIME[2015-11-02 17:00:31 +09:00]] 版) <http://blogs.technet.com/b/jpsecurity/rss.aspx>
]REFS]
]EG]

[173] [[CSS]] などのない [[XML文書]] ([[unstyle document]])は、
その[[木構造]]が表示されます。

;; これは [[unstyled document view]] と呼ばれる [[DOM]]
の特別な表示モードなので、非文書表示モードではありません。

[94] [[媒体]]、[[プラグイン]]、 >>33 により非 [[DOM]] 表示に切り替える場合には、
仕様書上は [[navigate]] による [[fetch]] はそのまま放置され、
改めて [CODE(HTMLe)@en[[[img]]]] [[要素]]などで [[fetch]] が発生することになっています。
実際には [[Webブラウザー]]の[[キャッシュ]]により、あるいは何らかの特別な仕組みにより、
[[navigate]] による [[fetch]] の結果あるいは経過が[[媒体]]の表示処理や[[プラグイン]]等に引き渡される可能性もあります。

@@ [[CSP]] [[enforce]] / [[monitor]]

* 閲覧文脈内の非文書表示

[47] [[閲覧文脈]]内であっても [[DOM]] を[[レンダリング]]するのではなく、
専用ビューアーやエラーメッセージなど特別なものを表示する場合があります。

;; [49] 仕様書では[[閲覧文脈]]内に表示することを“[RUBYB[行内]@en[inline]]”と言っています。

[59] [[fetch]] (相当) を行う前にこちらの処理方法に移行する場合と、
[[fetch]] 結果をこちらの方法で処理する場合があります。

[EG[
[23] 例えば [[URL scheme]] に対応していないエラーを表示部に示す場合や、
[[登録済みプロトコル取扱器]]を[[利用者]]に選択する画面を表示部に示す場合があります。
(選択した取り扱い器を実行する場合は、 [[navigate]] を改めて実行することになります。)
[SRC[>>12]]
]EG]

[EG[
[60] 例えば大多数の [CODE(URI)@en[[[about:]]]] [[URL]] のように [[fetch]]
ではアクセスできない特別な [[Webページ]]を表示させる場合が該当するかもしれません。

[131] [CODE(URI)@en[[[http:]]]] [[URL]] から[[リダイレクト]]で [CODE(URI)@en[[[about:]]]]
[[URL]] が示された場合や [CODE(URI)@en[[[http:]]]] ページの[[ハイパーリンク]]からの
[CODE(URI)@en[[[file:]]]] への [[navigate]] や[[フレーム]]による [[navigate]] のように、
特別なページの表示は文脈によって認められないこともあります。
>>174 も参照。
]EG]

[EG[
[39] 例えば内容を ([[DOM]] ではなく) 専用の方法で表示する場合、
[[MIME型]]に対応していないエラーを表示部に示す場合や、
[CODE(DOMm)@en[[[registerContentHandler]]]] で登録された取り扱い器を[[利用者]]に選択する画面を表示部に示す場合があります。 
(選択した取り扱い器を実行する場合は、 [[navigate]] を改めて実行することになります。)
]EG]

[EG[
[81] [[Webブラウザー]]と[[MUA]]が統合された製品で、それぞれが別の[[窓]]を開くのではなく、
[[閲覧文脈]]内に [[MUA]] 機能が表示されるような場合は、 [[MUA]]
機能の表示は本項に該当しそうです。
]EG]

[EG[
[92] かつては[[ネットワークエラー]]を[[ダイアログ]]で表示する [[Webブラウザー]]もありましたが、
現在では多くの [[Webブラウザー]]が行内表示を使っています。
]EG]

[EG[
[93] 本来の内容の代わりに [[Safe Browsing]] エラーが[[閲覧文脈]]内に表示されることもあります。
]EG]

[EG[
[130] 仕様書上明記はされていませんが、[[リダイレクト]]ループを検出したら[[ネットワークエラー]]として表示する必要があります。
]EG]

[EG[
[203] [[入れ子閲覧文脈]]の深さが限界を超えたら、エラーページを表示するべきかもしれません。
]EG]

[EG[
[394] [[Firefox]] は [[MIME型]] [CODE(MIME)@en[application/http-index-format]] の表示に対応しています。
[[FTP]] の[[ディレクトリー]]の表示に使われていますが、それ以外でも使うことができます。
]EG]

[83] 非 [[DOM]] の行内内容を[[閲覧文脈]]に表示する場合でも、[[文書]]の作成は
[[DOM]] の表示の場合と同じく行います (>>77)。

[84] [[DOM]] の構築の段階では、任意の[[DOM木]]を作成して構いません 
([CODE(DOMi)@en[[[Document]]]] のみ でも構いません)。いずれにしても
[[AppCache選択アルゴリズム]]を[[マニフェスト]]無しで実行しておかなければ[['''なりません''']]。
また完了時に [[stop parsing]] を実行しなければ[['''なりません''']] [SRC[>>12]]。

[390] [[ネットワークエラー]]の表示では、[[文書]]の[F[起源][文書の起源]]を[[不透明起源]]としなければ[MUST[なりません]]
[SRC[>>12]]。

[85] [[レンダリング]]は通常の規則で [[DOM]] を表示しても構いませんし、
特別な方法を使っても構いません [SRC[>>12]]。

[96] 仕様書上は [[navigate]] による [[fetch]] が行われた場合、そのまま放置されています。
実際には [[Webブラウザー]]の[[キャッシュ]]により、あるいは何らかの特別な仕組みにより、
[[navigate]] による [[fetch]] の結果あるいは経過が非 [[DOM]] 表示の処理へと引き渡される可能性もあります。

[307] 次のような [[URL scheme]] について[[非文書表示]]が使われています。
[FIG(short list)[
- [CODE(URI)@en[[[about:]]]] のほとんど
- [CODE(URI)@en[[[chrome:]]]] ([[Chrome]])
- [CODE(URI)@en[[[opera:]]]]
- [CODE(URI)@en[[[view-source:]]]]
]FIG]

[134] [[Webブラウザー]]によっては、[VAR[応答]]の[F[状態][状態符号]]が
[CODE[4[VAR[xx]]]] や [CODE[5[VAR[xx]]]] で[F[本体][応答本体]]が一定サイズ以下の時、
[[[F[本体][応答本体]]を[[文書]]として表示するかわりに、
[[Webブラウザー]]側のエラーを[[非文書表示]]することがあります。

[[Webブラウザー]]側としては、[[サーバー]]ソフトウェアから自動生成されたような
(しばしば[[ローカライズ]]されていない) 不親切な定形エラーメッセージを表示するくらいなら、
より[[利用者]]にわかりやすいエラーをかわりに表示したいということなのでしょう。
これを不服に思う[[著者]]や[[サーバー]]ソフトウェアの開発者も少なく無いようで、
そのような判定をされないように[F[本体][応答本体]]に余分な[[詰め]]データを付け足すことがあります。

[375] 通常の [[DOM]] ではなく[[非文書表示]]とするのは、実装上の都合の他に、
セキュリティー上の理由もある場合があります。例えば、
[[ネットワークエラー]]の詳細は[[プライバシー]]に関わる情報を含むことがありますから、
たとえ同じ[[起源]]の他の通常の[[文書]]の[[スクリプト]]であっても、
アクセスできるべきではなさそうです。 (実際には、状況に応じて、
単に[[非文書表示]]であるだけでなく、[[不透明起源]]を持つものと扱うのがより安全かもしれません。)

[376] 場合によってはそれ以上の制約が必要かもしれません。例えば[[閲覧文脈]]が開かれた後、
[[利用者]]がそこで [[Webブラウザー]]の設定ページを開いたら、
外部の[[スクリプト]]からその [CODE(JS)@en[location.href]] への値の設定は無視するべきかもしれませんし、
[CODE(DOMm)@en[postMessage]] も
(設定ページ内の[[スクリプト]]が無視するだけでなく、[[Webブラウザー]]レベルで) 
完全に無視するべきかもしれません。

* 履歴と素片識別子の処理

** ページ遷移が行われなかった場合

[163] [[素片識別子]]への [[navigate]] は、次のように行わなければ[['''なりません''']]
[SRC[>>12]]。

[FIG(steps)[
= [165] [VAR[[[navigate]] する[[閲覧文脈]]]]の[F[[[セッション履歴]]]]に、
新しい[[セッション履歴エントリーを挿入]]します。
[FIG(list members)[
[FIGCAPTION[
[292] [[セッション履歴エントリー]]
]FIGCAPTION]
:[F[[[URL]]]]:[VAR[新しい[[資源]]]]の [F[URL]]
:[F[[[文書]]]]:[VAR[[[navigate]] する[[閲覧文脈]]]]の[[活性文書]]
:[F[[[題名]]]]:未設定
:[F[[[スクロール復元モード]]]]: [VAR[[[navigate]] する[[閲覧文脈]]]]の[F[[[セッション履歴]]]]の[F[[[現在エントリー]]]]の[F[[[スクロール復元モード]]]]
:その他:[VAR[新しい[[資源]]]]と [VAR[[[navigate]] する[[閲覧文脈]]]]の現在の状態による値
]FIG]
= [168] 新しいエントリーへ[[履歴を探索]]します。 [VAR[[[non-blocking events]]]]
フラグを設定します。
= [402] [CODE[webNavigation]] API の [CODE[onReferenceFragmentUpdated]] を呼び出します。
[VAR[遷移型]]、[VAR[遷移修飾子群]]、現在時刻を引き渡します。 [SRC[仕様書なし]]
= [409] [VAR[新しい[[資源]]]]の [F[URL]] の[[既読化]]を行います。 [SRC[仕様書なし]]
= [169] 後片付け (>>109) に移ります。
]FIG]

;; [164] [[素片識別子へのスクロール]]は、[[履歴を探索]]する過程で行われます。

** ページ遷移が行われた場合

[95] [[閲覧文脈]]内に何らかの表示を行う場合には、ある程度処理が進んだ段階で
[DFN[[RUBYB[セッション履歴を新しいページで更新]@en[[[update the session history with the new page]]]]]]
[SRC[>>12]] が呼び出されます。

[97] これは、 [VAR[[[navigate]] する[[閲覧文脈]]]]の[[セッション履歴]]の[[現在エントリー]]の[[文書]]について、
次の通り処理する[[タスク]]を[[ネットワークタスク源]]で[[タスクキュー]]に追加しなければ[['''なりません''']] [SRC[>>12]]。

;; [99] [[navigate]] の[[引数]]である [VAR[[[navigate]] する[[閲覧文脈]]]]、[VAR[新しい[[資源]]]]、
[VAR[[[置換有効]]]]、[VAR[[[エントリー更新]]する[[エントリー]]]]と
[[navigate]] によって作成された[VAR[新しい[[文書]]]]を参照します。
また [[navigate]] の [VAR[[[mature]]]] フラグを設定します。

[FIG(steps)[
= [111] [VAR[[[文書]]]]について [[unload a document]] を実行します。 [VAR[recycle]] は[[偽]]とします。 [SRC[>>12]]
= [127] [VAR[取り消し]]フラグが設定されていれば、
== 後片付け (>>109) に移り、こちらはここで終わります。 [SRC[>>12]]
= [112] [VAR[[[エントリー更新]]する[[エントリー]]]]があるなら、
== [VAR[[[エントリー更新]]する[[エントリー]]]]の[[文書]]およびそれと同じ[[文書]]を参照する他の[[エントリー]]の[[文書]]を[VAR[新しい[[文書]]]]に変更します。 [SRC[>>12]]
== [VAR[[[エントリー更新]]する[[エントリー]]]]へ[[履歴を探索]]します。 [SRC[>>12]]
= [113] そうでないなら、
== [233] [VAR[[[navigate]] する[[閲覧文脈]]]]の[F[[[セッション履歴]]]]に新しい[[セッション履歴エントリーを挿入]]します [SRC[>>12]]。
[FIG(list members)[
[FIGCAPTION[
[290] [[セッション履歴エントリー]]
]FIGCAPTION]
:[F[[[URL]]]]:[[上書きURL]]か[VAR[新しい[[資源]]]]の [[URL]]
:[F[[[navigate]] の引数]]の[VAR[新しい[[資源]]]]の[F[[[応答]]]]:[VAR[新しい[[資源]]]]の[F[[[応答]]]] (あれば)
:[F[[[文書]]]]:[VAR[新しい[[文書]]]] [SRC[>>12]]
:[F[[[スクロール復元モード]]]]: [CODE[[[auto]]]] [SRC[>>12]]
:その他:関係する状態 [SRC[>>12]]
]FIG]
== [291] 新しいエントリーへ[[履歴を探索]]します。[VAR[[[置換有効]]]]フラグを引き渡します。 [SRC[>>12]]
= [114] [VAR[[[mature]]]] フラグを設定します。 [SRC[>>12]]
= [115] [VAR[[[navigate]] する[[閲覧文脈]]]]が[[入れ子閲覧文脈]]で
[F[[[delaying [CODE(DOMe)@en[load]] events mode]]]] フラグが設定されている場合は、 
これを削除します。 [SRC[>>12]]
]FIG]

;; [107] これは[VAR[新しい[[文書]]]]の[[レンダリングの開始]]のタイミングであり、
他の[[フレーム]]の[[スクリプト]]から[VAR[新しい[[文書]]]]にアクセスできるタイミングでもあります
([[履歴の探索]]内で、[[閲覧文脈]]の[[活性文書]]が新しいものに設定されます)。
本アルゴリズムは[VAR[新しい[[文書]]]]自体の[[スクリプト]] (あれば) よりも前に実行されます (>>106)。

;; [187] [VAR[新しい[[資源]]]]の [[URL]] が指定されない時もありますが
([CODE(JS)@en[[[window.open]]]])、その場合の[[セッション履歴エントリー]]がどうなるかは不明です。
[CODE(URI)@en[[[about:blank]]]] または [[Webブラウザー]]依存のエラーページの [[URL]]
でしょうか。

[100] 更に、[[利用者エージェント]]は、 [VAR[[[mature]]]] フラグの設定後で[VAR[新しい[[文書]]]]が[[構文解析器]]を有し、
[[stop parsing]] よりも前で適切と認められるタイミングが一度でもあれば、
[[素片識別子にスクロール]]することになっています。これは、
[[ネットワークタスク源]]の[[タスク]]として[[タスクキュー]]に追加しなければ[['''なりません''']]。
[SRC[>>12]]

;; [101] 仕様書上は [VAR[[[mature]]]] とした後に[[スピン]]することになっていますが、
[[セッション履歴を新しいページで更新]]自体も[[素片識別子にスクロール]]する操作も任意のタイミングで行える規定になっているため、
実質的に[[スピン]]でない形と等価と思われます。仕様書が[[スピン]]により記述しているのは、
「適切と認められるタイミング」を厳密に表現するためでしょう。

[89] [[素片識別子にスクロール]]に成功するか、適切なタイミングが無いと判断した時点で、
[[navigate]] としての処理は完了です [SRC[>>12]]。後片付け (>>109) に移ります。

** 媒体文書やプラグイン文書の場合

[159] [[媒体文書]]や[[プラグイン文書]]として表示される場合には、
[[素片識別子]]が付いた [[URL]] が [CODE(HTMLa)@en[[[src]]]] [[属性]]に設定されることになりますから、
その[[要素]]の処理の一部として[[素片識別子]]が適用されることがあります。

[EG[
[160] 例えば[[動画]]の[[素片識別子]]で [CODE[[[t=]]]] が指定されていれば、
その位置から再生されます。
]EG]

;; [161] 理論上は[[媒体文書]]や[[プラグイン文書]]における[[文書の示された部分]]へと[[素片識別子にスクロール]]されることになりますが、
実際には[[媒体文書]]や[[プラグイン文書]]に示された部分は存在しないでしょうから、
そちらでは何も起こらないと思われます。

* 閲覧文脈外の処理

[48] [[閲覧文脈]]に影響せずに新しい[[資源]]を処理する場合もあります。

[133] [VAR[取り消し]]されていれば、何もしません。[VAR[取り消し]]されていなければ、
次の通り何らかの処理を実行します。
[FIG(middle list)[
- 何もしない
- [[閲覧文脈]]以外にメッセージやエラーを表示
- [[ダウンロード]]
- [[証明書ダウンロード]]
- [[外部アプリケーション]]の起動
- 処理方法選択ダイアログの表示
]FIG]

;; [57] なお[[fetch]] (相当) を行う前にこちらの処理方法に移行する場合と、
[[fetch]] 結果をこちらの方法で処理する場合があります。
[[外部アプリケーション]]を起動する場合、前者なら [[URL]] を渡し、
後者なら [[fetch]] して得られたデータを渡すことになります。

[EG[
[29] 例えば [[fetch]] 前の時点で [[URL scheme]] に対応していないので無視する場合があります
[SRC[>>12]]。
]EG]

[EG[
[86] [[MUA]] が利用できない状態での [CODE(URI)@en[[[mailto:]]]] への [[navigate]] や、
特権を持たないページからの [CODE(URI)@en[[[about:]]]] や [CODE(URI)@en[[[chrome:]]]]
や [CODE(URI)@en[[[file:]]]] への [[navigate]] で何もせずに無視する実装があります。

;; [87] しかしそのような動作は不親切で好ましくないと思われます。
[CODE(URI)@en[[[mailto:]]]] へリンクするページは数多ありますが、
[[クリック]]しても何も起こらないのは何かが壊れているように見えます。
[CODE(URI)@en[[[mailto:]]]] などの場合は[[ヘルパーアプリケーション]]選択の[[ダイアログ]]を出すのが好ましいと思われます。
[CODE(URI)@en[[[about:]]]] などの場合は[[非文書表示]]によりエラーを出すのが好ましいと思われます。
>>174 も参照。
]EG]

[EG[
[58] [[fetch]] 前の時点で [[URL]] を[[外部アプリケーション]]に引き渡す場合
(例えば [CODE(URI)@en[[[mailto:]]]] [[URL]] を [[MUA]] に渡す場合 [SRC[>>12]]) があります。
]EG]

[EG[
[40] 例えば [[fetch]] 結果を[[外部アプリケーション]]によって処理したり、
未知の[[MIME型]]なので[[ダウンロード]]として処理したりします [SRC[>>12]]。

;; [56] 多くの [[Webブラウザー]]では、どう処理するか[[利用者]]に問い合わせる
(非モーダル) [[ダイアログ]]を表示します。

[EG[
[61] [[fetch]] した [[Word]] 文書を[[ワープロ]]アプリケーションに引き渡す場合があります
[SRC[>>12]]。
]EG]
]EG]

[EG[
[90] [[OS]] によっては、 ([CODE(URI)@en[[[http:]]]] [[URL]] も含め)
[[URL scheme]] や [[URL]] のパターンに対して処理する[[アプリケーション]]を登録できるものがあります。
その場合には、候補が1つならそれを起動したり、候補が複数なら候補リストを表示したりできます。
[[Webブラウザー]]自身が扱えるものなら、[[Webブラウザー]]か[[外部アプリケーション]]かも選択できたりします。

;; [91] [CODE(URI)@en[[[http:]]]] [[URL]] や [[HTML文書]]のすべてをそうした形で処理するのは、
[[Webブラウザー]]として実用的では無さそうです。一定期間選択結果を覚えておいたり、
同じ[[起源]]からの [[navigate]] なら無条件で [[Webブラウザー]]自身で処理することにしたりしないと、
頻繁に確認ダイアログを表示することになるかもしれません。
]EG]

[62] [[利用者エージェント]]は、[[外部アプリケーション]]に引き渡す場合は、
[[著者]]による対象ソフトウェアの悪用を防ぐよう努力する[['''べきです''']] [SRC[>>12]]。

[EG[
[63] 例えば、[VAR[文書]]の[F[起源][文書の起源]]が当該ソフトウェアを起動することを認められているかを[[利用者]]に確認させることができます [SRC[>>12]]。
]EG]

[64] 特に[[ポップアップ]]が認められない場合には、事前の[[利用者]]の確認無しで外部ソフトウェアを起動する[['''べきではありません''']] [SRC[>>12]]。

;; [67] [[外部アプリケーション]]の実行自体が[[ブラクラ]]となり得ます。
[[同じ起源]]や[[利用者]]により既に認められた[[起源]]であっても、
何度も重ねて起動することは抑制するべきでしょう。
また様々な異なる[[外部アプリケーション]]を次々と起動しようとすることも抑制するべきでしょう。

;; [80] ここでいう[[外部アプリケーション]]とは、実装方法によらず、[[閲覧文脈]]や[[ダウンロード]]など
[[Webブラウザー]]の機能以外を指すものと思われます。例えば [[Webブラウザー]]と [[MUA]]
が統合され同一[[プロセス]]で動作する製品があったとしても、
その [[MUA]] は[[外部アプリケーション]]と解釈するべきでしょう。
また[[ダウンロード]]や[[証明書ダウンロード]]のような [[Webブラウザー]]内の機能も、
[[ブラクラ]]化を防ぐなど類似した配慮が必要かもしれません。

[66] [[実行可能ファイル]]など、 [[fetch]] 完了後の実行には特に注意しなければならない場合もあります。

[331] [[ダウンロード]]に移行する場合、[[navigate]] 開始元の[[起源]]を処理に使います。
これが何なのかは不明瞭ですが、[VAR[始点文書]]の[F[起源][文書の起源]]が適切そうです。

[338] [[ダウンロード]]の際は、[VAR[提案ファイル名]]を引き渡します。

;; [[ダウンロード]]も参照。

[128] いずれにせよ、[[閲覧文脈]]外の処理を開始したら、 (その完了を待たずに)
[[navigate]] としての処理は完了です。その時点で後片付け (>>109) に移ります。

[239] 新しい[[閲覧文脈]]を作成して [[navigate]] する場合 ([[閲覧文脈の選択]]を参照。)
で、その [[navigate]] の結果が[[閲覧文脈]]外となった場合には、使われない[[閲覧文脈]]が残ることになります。
古い [[Webブラウザー]]では空白 ([CODE(URI)@en[[[about:blank]]]]) 
のままの[[タブ]]や[[窓]]が表示された状態でしたが、現在の
[[Webブラウザー]]では自動的に閉じられるのが普通です。

;; [240] [[Chrome]] では、そのような [CODE(JS)@en[[[window.open]]]] が返した
[CODE(DOMi)@en[[[Window]]]] [[オブジェクト]]は [CODE(JS)@en[[[window.open]]]]
直後時点では[[初期[CODE(URI)@en[about:blank]]文書]]ですが、 [[navigate]]
後には[[異なる起源]]にアクセスした時のような (ほとんど何の情報にもアクセスできない) 
状態になっているようです ([[同じ起源]]への [[navigate]] であっても)。 [TIME[2015-07-19T02:21:48.900Z]]

;; [241] 新しい[[閲覧文脈]]が作成されたとしても、それがどの時点で表示されるべきかは、
仕様としては決められていません。理論上は[[閲覧文脈の選択]]/[[閲覧文脈の作成]]時点ではまだ新しい[[窓]]や[[タブ]]は表示せず、
[[navigate]] により[[レンダリングの開始]]となった時点ではじめて表示する
([[閲覧文脈]]を使わないなら、一度も表示しない) こともできなくはありません。
ただしその間 ([[サーバー]]からの[[応答]]を待つため、[[ネットワーク]]や[[サーバー]]の状態に依存する時間)
[[利用者]]は新しい[[閲覧文脈]]を開いた操作が成功しているかどうか不安になるかもしれませんから、
何らかの表示上の配慮が必要かもしれません。

[391] [[Chrome]] は新しい [[URL scheme]] が完全に未知のものである時、
何もしないようです。 [TIME[2016-06-06T15:26:09.000Z]]

[393] [[Firefox]] は [[FTP]] への [[navigate]] で[[サーバー]]が予期せぬ[[返答]]を返した時、
それを[[モーダルダイアログ]]で表示します。 [TIME[2016-06-11T10:30:19.900Z]]

[406] 何らかの問題 (セキュリティー制限違反など) が原因で何もしないことを選択した場合は、
[CODE[webNavigation]] API の [CODE[onErrorOccurred]] を、
エラーの説明の文字列と現在時刻と共に実行します。 [SRC[仕様書なし]]

* 取扱器による処理

[206] [[登録済み内容取扱器]]や[[登録済みプロトコル取扱器]]で適用可能なものがあれば、
それが使われることがあります。
ただしどの条件で使われるかや、使われる場合にどのような [[navigate]]
が行われるかの詳細は、 [[HTML Standard]] では規定されていません。

[429] [VAR[URL]]と[VAR[閲覧文脈]]に関する[[navigate URL schemeの処理]]は、
次のようにします [SRC[>>12]]。
[FIG(steps)[
= [430] [VAR[URL]] が[VAR[閲覧文脈]]外で処理されるなら、そのようにします。
= [431] それ以外なら、 [VAR[URL]] を[VAR[閲覧文脈]]で[[非文書表示]]します。
]FIG]

[432] [[取扱器]]に委ねる場合は、新しい [[navigate]] を実行します [SRC[>>12]]。

[207] 多くの [[Webブラウザー]]は、 [[URL]] [VAR[URL]] の処理方法を次のように決定するようです。
[FIG(steps)[
= [342] [VAR[URL]] がセキュリティー上の制限 (>>174) に抵触するなら、それに従うこととし、
こちらはここで終わります。
= [343] [VAR[一覧]]を、空のリストに設定します。
= [344] [VAR[URL]] が[[Webブラウザー]]で扱える [[URL]] なら、
== [346] [VAR[一覧]]に、通常の [[navigate]] の継続の選択肢を追加します。
== [345] [VAR[URL]] の[F[scheme][URL scheme]] が [[network scheme]] なら、
=== [353] [[OS]] の[[プロトコル取扱器]]のうち、 [VAR[URL]]
を扱えるものの一覧を取得し、これを[VAR[一覧]]に追加します。
= [347] それ以外なら、
== [348] [[Webブラウザー]]に登録されている[[登録済みプロトコル取扱器]]や
[[OS]] の[[プロトコル取扱器]]のうち、 [VAR[URL]] の [F[scheme][URL scheme]]
を扱えるものの一覧を取得し、これを[VAR[一覧]]に追加します。
順序は、実装方法や利用者の設定に依存します。
= [349] 一覧が空の場合は、 [[URL scheme]] に対応していない旨のエラーを表すエラー文書を[[閲覧文脈]]に表示することとし、こちらはここで終わります。
= [352] 一覧の項目が1つだけで、それが通常の [[navigate]] の継続である場合、
[[navigate]] を継続することにし、こちらはここで終わります。
= [350] 実装や利用者の設定により既定の[[プロトコル取扱器]]を利用する場合は、
一覧の先頭の[[プロトコル取扱器]]を使うこととし、こちらはここで終わります。
= [351] 一覧を非モーダルな[[ダイアログ]]として表示することにします。
]FIG]

;; [[登録済みプロトコル取扱器]]も参照。

[EG[
[354] [[Windows]] では、 [[URL scheme]] を処理する[[アプリケーション]]を[[レジストリー]]に登録できます。
]EG]

[EG[
[355] [[Android]] では、[[アプリ]]が処理する [CODE(URI)@en[http:]] や
[CODE(URI)@en[https:]] の [[URL]] の[[接頭辞]]を登録できます。
]EG]

[356] [[network scheme]] の場合に [[OS]] の処理器を使うのは、
[VAR[[[navigate]] する[[閲覧文脈]]]]が[[入れ子閲覧文脈]]や[[補助閲覧文脈]]のとき不適切そうで、
抑制するべきだと思われます。

[209] 多くの [[Webブラウザー]]は、 [[MIME型]]依存の処理方法を次のように決定するようです。
[FIG(steps)[
= [[Webブラウザー]]が扱える [[sniffed MIME type]] なら、通常の [[navigate]] を行うこととし、
こちらはここで終わります。
= 
[FIG(list)[
- [213] [VAR[新しい[[資源]]]]の[F[要求]]の[F[メソッド][要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] の場合 [SRC[>>210]] に、
- [212] [[Webブラウザー]]に登録されている[[登録済み内容取扱器]]で、
- [211] [[応答]]の [[sniffed MIME type]] の [CODE[[VAR[type]]/[VAR[subtype]]]]
部分 ([[引数]]なし) と[[登録済み内容取扱器]]の[[MIME型]]が同じ [SRC[>>210]] で、
]FIG]
... や、 [[OS]] の[[内容取扱器]]のうち [[MIME型]]が[[応答]]の [[sniffed MIME type]] 
と一致するものの一覧を取得します。順序は、実装方法や利用者の設定に依存します。
= 一覧が空の場合は、[[ダウンロード]]として処理することとし、こちらはここで終わります。
= 実装や利用者の設定により既定の[[内容取扱器]]を利用する場合は、
一覧の先頭の[[内容取扱器]]を使うこととし、こちらはここで終わります。
= 一覧および「[[ダウンロード]]」の選択肢を非モーダルな[[ダイアログ]]として表示することにします。
]FIG]

;; [[登録済み内容取扱器]]も参照。

[436] [[登録済みプロトコル取扱器]]や[[登録済み内容取扱器]]は、
[VAR[新しい[[資源]]]]の[F[要求]]の[F[メソッド][要求メソッド]]が
[CODE(HTTP)@en[GET]] でなければ使えません。
多くの[[プラットフォーム]]の[[取扱器]]も、 [CODE(HTTP)@en[GET]]
しか扱えないと思われます。

[208] [[Chrome]] では、[[登録済みプロトコル取扱器]]への [[navigate]]
が行われたら、元の[[文書の番地]]が[[文書のreferrer]]になるようです。
[[Firefox]] では、[[文書のreferrer]]は設定されないようです。

;; 他の [[fetch]] や [[navigate]] の[[引数]]が引き継がれるのかどうかは不明です。

* 取り消し処理

[138] [[利用者エージェント]]は、[[利用者]]が ([[取り消し]]フラグが設定されていない)
[[navigate]] を[RUBYB[取り消し]@en[cancel]]する手段を提供しても構いません [SRC[>>12]]。
あるいは[[利用者]]が他の [[navigate]] を開始できるようにしても構いません [SRC[>>12]]。
その場合の取り消しの [VAR[reason]] は [[end-user abort]] と思われます。

[139] [[navigate]] は、他の [[navigate]] や
[[traverse the history by a delta]] により取り消しされることもあります。

[166] [[navigate]] は、 [CODE(JS)@en[[[window.stop]]]] により取り消されることがあります。

[123] [[navigate]] を取り消す場合は、次のように処理しなければ[['''なりません''']]
[SRC[>>12]]。取り消しは、[[引数]]として事由 [VAR[reason]] と共に行います。

;; [137] が、現時点で [[HTML Standard]] は [VAR[reason]] を規定していません。
基本的には [[end-user abort]] か [[fatal]] に当たると思われます。

[FIG(steps)[
= [124] [VAR[取り消し]]フラグを設定します。
= [125] [VAR[新しい[[資源]]]]の [[fetch]] を実行中なら、これを [[terminate]] します
[SRC[>>12]]。 [VAR[reason]] を引き渡します。
= [126] [VAR[新しい[[文書]]]]があれば、[[文書のabort]] を実行します [SRC[>>12]]。
= [405] [CODE[webNavigation]] API の [CODE[onErrorOccurred]] を、
取り消された旨の説明文字列と現在時刻と共に実行します。 [SRC[仕様書なし]]
]FIG]

;; [136] [[navigate]] が取り消しされても、 [[navigate]] が呼び出されている
[[unload a document]] を完了させたり、後片付け (>>109) を実行したりする必要があり、
直ちに [[navigate]] 処理が停止されるわけではありません。

;; [144] [[navigate]] の結果[[ダウンロード]]に移行した場合、その[[ダウンロード]]処理は最早
[[navigate]] の一部ではないので、他の [[navigate]] から取り消されはしません。

* navigate の停止

[109] [VAR[[[navigate]] する[[閲覧文脈]]]]が[[入れ子閲覧文脈]]で
[[delaying [CODE(DOMe)@en[load]] events mode]] フラグが設定された場合は、 
[[navigate]] の停止時にこれを削除しなければ[['''なりません''']]
[SRC[>>12]]。

;; 完全に実行して終了した場合も、途中で終了した場合や取り消された場合もこれが実行されます。

;; [110] 複数の [[navigate]] が同時に実行されることは (最初のチェック部分を除き)
ないはずなので、本フラグを設定する [[navigate]] は1つだけのはずですし、
本 [[navigate]] が設定していないのに他の [[navigate]] が設定していることもないはずです。

[230] [[HTML構文解析器]]が動作する場合にせよ、それ以外にせよ、
[[閲覧文脈]]内に何かを新たに表示した場合には、最終的に [[stops parsing]]
が呼び出されています。

[228] [CODE(HTMLe)@en[[[embed]]]] [[要素]]、
[CODE(HTMLe)@en[[[object]]]] [[要素]]から [[navigate]] が呼び出された場合、
[[資源]]の読み込みが完了したら、[[要素]]で
[CODE(DOMe)@en[[[load]]]] [[イベント]]を[[発火]]することになっています。
これは [[stops parsing]] の最終段階を表すと思われます。

;; [CODE(HTMLe)@en[[[embed]]]], [CODE(HTMLe)@en[[[object]]]], [[stops parsing]] 参照。

[400] [[文書]]の [CODE(DOMe)@en[DOMContentLoaded]] や [CODE(DOMe)@en[load]]
の[[イベント]]も、 [[stops parsing]] 内で[[発火]]されます。

* 進捗表示

[140] [[navigate]] が開始してから停止するまでの間、 [[Webブラウザー]]は何らかの形で
[[navigate]] 中であることやその進捗を表示するのが普通です。

;; [[busy indicator]] を参照。

@@ [205] [CODE(DOMi)@en[[[PerformanceNavigationTiming]]]]

[326] [[IE]] は、ページ遷移開始時に [[OS]] で設定した効果音を鳴らします。

;; 正確なタイミングがいつなのかはよくわかりません。[[リンク]]の[[クリック]]なのか、
その他の [[navigate]] でも発生するのか、どんな [[URL]] でも ([CODE(URI)@en[javascript:]]
や[[素片識別子]]でも) なのか、表示変更が決まった時点なのかよくわかりません。

* URL scheme による navigate 制限

[174] [[著者]]が発生させた [[navigate]] ([[スクリプト]]によるものの他、
[[利用者]]が[[ハイパーリンクを辿る]]ことにより発生したものを含みます。)
は、その前後の [[URL]] の [[URL scheme]] 等によって制限されることがあります。

[175] 制限される対象となる場合には、何も起こらなかったり、エラーが行内で表示されたりします。

[176] 制限されるのは、 [[navigate]] の呼び出し元 (?) の[[起源]]が特権を持たない場合で、
[VAR[新しい[[資源]]]]が特権を持つ場合です。ここでいう特権を持った[[起源]]の
[[URL]] とは、例えば
[FIG(list middle)[
- [[Webブラウザー]]の特別な機能を表す [[URL]]
-- ほとんどの [CODE(URI)@en[[[about:]]]] [[URL]]
-- [[Chrome]] の [CODE(URI)@en[[[chrome:]]]] [[URL]]
-- [[Opera]] の [CODE(URI)@en[[[opera:]]]] [[URL]]
-- [CODE(URI)@en[view-source:]] [[URL]]
- [[ブラウザー拡張]]のための [[URL]]
-- [[Firefox]] の [CODE(URI)@en[[[chrome:]]]] [[URL]]
-- 特権を持った[[起源]]を持つ [CODE(URI)@en[[[jar:]]]] [[URL]]
-- [CODE(URI)@en[[[chrome-extension:]]]] [[URL]]
- [[ローカルファイル]]を表す [[URL]]
-- [CODE(URI)@en[[[file:]]]]
]FIG]
... のようなものをいいます。特権を持つ [[URL]] から異なる[[起源]]で特権を持つ [[URL]]
の場合も、認められないかもしれません。

[EG[
[340] [CODE(URI)@en[https:]] から [CODE(URI)@en[file:]] への[[ハイパーリンク]]は、
悪用される危険性があるため、認められるべきではありません。
]EG]

[EG[
[341] [[ブラウザー拡張]]のページから他の[[ブラウザー拡張]]のページへの[[ハイパーリンク]]は、
好ましくないとして認められないかもしれません。
]EG]

[EG[
[373] [CODE(URI)@en[http:]] のページに[[Webブラウザー]]の設定ページを [CODE(HTMLe)@en[iframe]]
で埋め込めるのは、不適切でしょう。
]EG]

;; [242] [CODE(URI)@en[[[file:]]]] の取り扱いは[[セキュリティー]]上の問題もあるため明確に定めるべきように思われますが、
現時点ではそのような仕様書は存在していないようです。

;; [243] [[IE]] は [CODE(URI)@en[[[http:]]]] から [CODE(URI)@en[[[res:]]]]
への[[ハイパーリンク]]や[[フレーム]]による [[navigate]] を認めているようです。 [TIME[2015-07-19T03:40:49.200Z]]

[377] 特権を持つ [[URL]] から持たない [[URL]] への [[navigate]] は通常は認められますが、
特別な扱いが必要かもしれません。例えば [CODE(URI)@en[file:]] から
[CODE(URI)@en[https:]] への[[リンク]]は普通認められるべきと考えられますが、
[CODE(HTTP)@en[Referer:]] は送るべきでは無さそうです。

[339] 他にも [[URL]] 依存の制約があるかもしれません。
例えば、 [CODE(URI)@en[javascript:]] [[URL]] は[[著者]]が指定した[[閲覧文脈]]への
[[navigate]] のみ認められるべきで、[[利用者]]が新しい[[閲覧文脈]]を開いたり、
他の既存の[[閲覧文脈]]を選んだりできるべきではなさそうです。

;; [[ハイパーリンクの処理]]を参照。

[374] [CODE(URI)@en[https:]] に [CODE(URI)@en[http:]] を埋め込めないとの制限
([[Mixed Content]] 制約) や、 [CODE(HTTP)@en[X-Frame-Options:]]
による埋め込み制約は、本項の制約とはまた異なるものです。

* プライバシー

[218] [[navigate]] の結果は[[利用者エージェント]]や [[OS]] の実装や[[利用者]]の設定に依存することがあります。
これは [[fingerprinting vector]] です。
特に[[媒体文書]]、[[プラグイン文書]]、[[エラー文書]]の違いは[[スクリプト]]からも検出しやすいので[[利用者エージェント]]の実装者は注意するべきかもしれません。

[219] エラー文書の [[DOM]] に詳細なエラー情報を含めてしまうと、
不必要に[[著者]]に情報を流出させてしまうことがありますから、注意が必要です。

[EG[
[220] 例えばネットワークエラーを表すエラー文書で自ホストのネットワークインターフェイスの名前や利用状況などの情報を表示すると[[利用者]]に有用かもしれませんが、
[[DOM]] を通じて[[著者]]が取得できるのは好ましくありません。
]EG]

* 歴史

[1] [CITE@en[Web Applications 1.0 r5685     Make form submission via .submit(), and page navigation via location.href, when either is done before the page has completely loaded, result in a history replacement (like a redirect) rather than a regular load.]]
( ([TIME[2010-11-30 10:22:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=5684&to=5685>

[2] [CITE@en[Web Applications 1.0 r5686     Change pushState() and replaceState() so that they update the pending state object as well (otherwise, pushState vs pushState;back;forward would result in different state objects in the initial popostate which is just silly).]]
( ([TIME[2010-11-30 11:07:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=5685&to=5686>

[3] [CITE[''''''[''''''whatwg'''''']'''''' pushState and session history issues]]
( ([TIME[2010-11-30 23:35:29 +09:00]] 版))
<http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2010-November/029234.html>

[8] [CITE@en[Web Applications 1.0 r6630     Define navigating to video and audio resources]]
( ([TIME[2011-10-05 09:02:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=6629&to=6630>

[9] リンクのクリック時に [CODE(DOMa)@en[[[click]]]] で [CODE(HTMLe)@en[[[img]]]] を使って [[fetch]]
を行うと、 [[IE10]] ではアクセスが発生しますが、 [[Firefox]] と [[Chrome]] ではアクセスが来ません。
[CODE(DOMa)@en[[[mousedown]]]] だと [[Chrome]] はアクセスが来ますが、応答を受け取ったり受け取れなかったりするようです。
[[Chrome]] の場合 [[navigation]] によってアクセスが中断され、そのタイミングによって要求が送られたり送られなかったり、
応答を処理できたりできなかったりするようです。 [TIME[2013-07-04T03:10:59.800Z]]

[10] [CITE[''''''[''''''whatwg'''''']'''''' scrdoc and session history don't play along in the spec]]
( ([TIME[2013-07-13 11:50:26 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-July/040059.html>

[11] [CITE[''''''[''''''whatwg'''''']'''''' Avoiding synchronous iframe load]]
( ([TIME[2013-10-26 04:58:58 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-October/041281.html>

[4] [CITE[''''''[''''''whatwg'''''']'''''' Navigation and history traversal issues]]
( ([TIME[2012-09-19 01:33:19 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2012-September/037325.html>

[5] [CITE@en-US[Window Object 1.0]]
( ([TIME[2006-04-08 02:19:28 +09:00]] 版))
<http://www.w3.org/TR/Window/#dfn-navigate>

[6] [CITE@en[Web Applications 1.0 r8555     Be more explicit about handing off to external software during navigation.]]
( ([TIME[2014-03-20 07:01:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8554&to=8555>

[7] [CITE@en[Web Applications 1.0 r8799 Stop using the word 'asynchronously', and reduce usage of the word 'synchronous'.]]
( ([TIME[2014-09-20 08:19:00 +09:00]] 版))
<https://html5.org/r/8799>

[227] [CITE@ja[» 想定外のスキームと脆弱性 TECHSCORE BLOG]]
([TIME[2015-06-21 10:45:25 +09:00]] 版)
<http://www.techscore.com/blog/2015/04/25/scheme-security/>

[234] [CITE[URLスキーム・独自ディープリンク実装に代わる、Universal Links(iOS 9で導入)でより良いUXを実現 - Qiita]]
([TIME[2015-07-07 00:45:34 +09:00]] 版)
<http://qiita.com/mono0926/items/2bf651246714f20df626>

[269] [CITE@en[27653 – Navigation scope]]
([TIME[2015-09-03 16:18:43 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=27653#c6>

[270] [CITE@en[Integrate Fetch into HTML · whatwg/html@7c5555a]]
([TIME[2015-09-18 19:19:52 +09:00]] 版)
<https://github.com/whatwg/html/commit/7c5555a16f2920c02244c10756bb2f1a11e87a22>

[278] [CITE@en[Add 'HTTPS state' to settings objects · whatwg/html@6de5241]] ([TIME[2015-09-29 23:58:59 +09:00]] 版) <https://github.com/whatwg/html/commit/6de524157fcf341e10efb3eec634bcf7325e6ee4>

[217] [CITE@en[Fix #124: make more types follow text/plain navigate logic · whatwg/html@f94f3c4]] ([TIME[2015-10-01 00:49:49 +09:00]] 版) <https://github.com/whatwg/html/commit/f94f3c4595fbc5fecb747ef52f46cdc5f2b3feec>

[280] [CITE@en[Define additional request parameters for navigate · whatwg/html@80f052b]] ([TIME[2015-10-07 20:05:02 +09:00]] 版) <https://github.com/whatwg/html/commit/80f052b44f3842084221b1104d1fecb02228699a>

[281] [CITE@en[338621 – Feed View overrides XSLT stylesheet defined in XML document]]
([TIME[2015-10-09 21:44:39 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=338621>

[142] [CITE@en[Add and populate global object's "CSP list" · whatwg/html@479dfbf]] ([TIME[2015-11-06 23:10:54 +09:00]] 版) <https://github.com/whatwg/html/commit/479dfbf1ff68b746ed3f81cc7415165e3342709e>

[232] [CITE@en[Add scroll restoration preference to history traversal · whatwg/html@dd6a34e]] ([TIME[2015-11-17 21:03:22 +09:00]] 版) <https://github.com/whatwg/html/commit/dd6a34ec3c191ee1968a0fc8d174b4ce3b615916>

[299] [CITE@en[Remove the storage mutex due to lack of implementation · whatwg/html@1b918cf]] ([TIME[2015-12-16 14:38:10 +09:00]] 版) <https://github.com/whatwg/html/commit/1b918cf72fcbba011f83b92ab5d1f483fb1cafa3>

[300] [CITE@en[Rewrite global object initialization to delegate to ES · whatwg/html@cf0355d]]
([TIME[2015-12-16 18:43:00 +09:00]] 版)
<https://github.com/whatwg/html/commit/cf0355d7e0e229b98f7fbd51b8c7608010c787f5>

[303] [CITE@en[Rewrite script execution on top of ES · whatwg/html@4891d18]]
([TIME[2015-12-22 19:00:32 +09:00]] 版)
<https://github.com/whatwg/html/commit/4891d18aaf2df1d40aa61f467a5a10cfc19dd85d>

[308] [CITE@en[Remove <iframe seamless> · whatwg/html@1490eba]]
([TIME[2016-02-04 19:11:15 +09:00]] 版)
<https://github.com/whatwg/html/commit/1490eba4dba5ab476f0981443a86c01acae01311>

[309] [CITE@en[Remove <iframe seamless> · whatwg/html@1490eba]]
([TIME[2016-02-04 19:24:57 +09:00]] 版)
<https://github.com/whatwg/html/commit/1490eba4dba5ab476f0981443a86c01acae01311>

[311] [CITE@en[Replace sniffed MIME type with computed MIME type · whatwg/html@2f58d1e]]
([TIME[2016-02-10 22:05:02 +09:00]] 版)
<https://github.com/whatwg/html/commit/2f58d1eb6a5eab442a7d31716c7fed7f8eb3f16f>

[322] [CITE@en[Align with URL spec's terminology: "fragment identifier" => "fragment" · whatwg/html@472bd07]]
([TIME[2016-03-02 15:17:55 +09:00]] 版)
<https://github.com/whatwg/html/commit/472bd07726db580b97b9d775996e9d895cda8be0>

[323] [CITE@en[Define security around Window, WindowProxy, and Location properly · whatwg/html@acae3df]]
([TIME[2016-03-13 23:41:55 +09:00]] 版)
<https://github.com/whatwg/html/commit/acae3df652b382e9f4f1d1b4dc7e08e2b00df821>

[325] [CITE@en[Remove the origin aliasing concept · whatwg/html@438155d]]
([TIME[2016-03-23 22:37:47 +09:00]] 版)
<https://github.com/whatwg/html/commit/438155d2a2255aa5ea84ae390744d8a8662ebec2>

[332] [CITE@en[Define the origin of non-initial about:blank documents · whatwg/html@baad9fd]]
([TIME[2016-03-25 13:33:24 +09:00]] 版)
<https://github.com/whatwg/html/commit/baad9fd10e5a49c1c72fc89426ffa2a26e0b72e4>

[335] [CITE@en[Fix navigation to create a new realm and environment settings object · whatwg/html@862afa4]]
([TIME[2016-03-28 21:26:28 +09:00]] 版)
<https://github.com/whatwg/html/commit/862afa4d768cb01e9a020e0562bc465e7f8bacfe>

[305] [CITE@en[Define "server-based naming authority" in terms of URL · whatwg/html@da7b5ba]]
([TIME[2016-03-31 12:47:14 +09:00]] 版)
<https://github.com/whatwg/html/commit/da7b5baf5815754cc40387452ae41e989848032f>

[306] [CITE@en[Merge effective script origin into origin · whatwg/html@8a843f2]]
([TIME[2016-03-31 16:29:36 +09:00]] 版)
<https://github.com/whatwg/html/commit/8a843f2169a6864a3024c4329528dccb2051d275>

[357] [CITE@en[Detail how javascript: return values become response bodies · whatwg/html@9997cd9]]
([TIME[2016-04-27 16:25:13 +09:00]] 版)
<https://github.com/whatwg/html/commit/9997cd93c65a9f4a640a593c02f01c2c58924457>

[358] [CITE@en[Editorial: mark up the primary variables in the navigate algorithm · whatwg/html@c08c0a0]]
([TIME[2016-04-27 17:59:48 +09:00]] 版)
<https://github.com/whatwg/html/commit/c08c0a0d12cf8c4f12dee2593be10eb971e0eb65>

[359] [CITE@en[Make navigate use "in parallel" · whatwg/html@77b1e02]]
([TIME[2016-05-01 13:52:41 +09:00]] 版)
<https://github.com/whatwg/html/commit/77b1e021bcb9229c60fc90dc72bbb0e0d1cff7e4>

[360] [CITE@en[Assign document's origin during creation · whatwg/html@b94d600]]
([TIME[2016-05-01 14:29:11 +09:00]] 版)
<https://github.com/whatwg/html/commit/b94d600e0e4de5ddea2215078611d6dfd0800391>

[361] [CITE@en[Navigate cannot use a non-GET-non-POST method]]
( ([[annevk]]著, [TIME[2016-05-02 16:05:21 +09:00]]))
<https://github.com/whatwg/html/commit/5c67104e6825ee0fafac1b2dc8892f0d42566649>

[371] [CITE@en[Editorial: turn "exceptions enabled" into a flag]]
( ([[annevk]]著, [TIME[2016-05-02 16:13:36 +09:00]]))
<https://github.com/whatwg/html/commit/879edbfcb25586caec8df93f303a434a700a18bc>

[372] [CITE@en[Editorial: turn "exceptions enabled" into a flag]]
( ([[annevk]]著, [TIME[2016-05-02 16:13:36 +09:00]]))
<https://github.com/whatwg/html/commit/879edbfcb25586caec8df93f303a434a700a18bc>

[380] [CITE@en[Integrate with the Referrer Policy spec, part 2 of n]]
( ([[domenic]]著, [TIME[2016-05-18 01:52:35 +09:00]]))
<https://github.com/whatwg/html/commit/176e74243c649b709b9959b7d08b327290c2f403>

[381] [CITE@en[Navigate: use URL's equals concept to compare URLs]]
( ([[annevk]]著, [TIME[2016-05-30 21:02:46 +09:00]]))
<https://github.com/whatwg/html/commit/f3c2a307658b21dc129ec5b11368e16048238fb8>

[388] [CITE@en[Block redirects to non-HTTP schemes · Issue #309 · whatwg/fetch]]
( ([TIME[2016-05-31 16:24:00 +09:00]]))
<https://github.com/whatwg/fetch/issues/309>

[389] [CITE@en[Make navigate's resource handling more explicit]]
( ([[annevk]]著, [TIME[2016-06-02 00:55:39 +09:00]]))
<https://github.com/whatwg/html/commit/806bc62caaee78a696a6c929558a5b801cceeec4>

[129] [CITE@en[Define the document's referrer in terms of Fetch]]
( ([[annevk]]著, [TIME[2016-06-04 02:52:59 +09:00]]))
<https://github.com/whatwg/html/commit/148dcd7d8214433b80de92b19d27cc5de128f849>

[392] [CITE@en[Cleanup "create a new browsing context"]]
( ([[annevk]]著, [TIME[2016-06-10 02:54:12 +09:00]]))
<https://github.com/whatwg/html/commit/f139279fb116bbde5d5ee3d257d21778cd774144>

[395] [CITE@en['''['''''']''' (0) Placeholder for beforeunload/unload; interaction of document.o…]]
( ([[Hixie]]著, [TIME[2007-04-21 14:30:09 +09:00]]))
<https://github.com/whatwg/html/commit/c1994a485446ab0fbfb7048df10bb081947f6405>

[FIG(quote)[
[FIGCAPTION[
[396] [CITE@en-US[Chrome incompatibilities - Mozilla | MDN]]
( ([TIME[2016-06-14 10:15:04 +09:00]]))
<https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Chrome_incompatibilities>
]FIGCAPTION]

> In Firefox, you can't open (using tabs.create), or navigate to (using tabs.update) privileged URLs:
> chrome: URLs
> javascript: URLs
> data: URLs
> privileged about: URLs (for example, about:config, about:addons, about:debugging)

]FIG]


[FIG(quote)[
[FIGCAPTION[
[397] [CITE@en-US[Chrome incompatibilities - Mozilla | MDN]]
( ([TIME[2016-06-14 10:15:04 +09:00]]))
<https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Chrome_incompatibilities>
]FIGCAPTION]

> webNavigation
> Firefox does not support:
> onCreatedNavigationTarget
> onTabReplaced
> Filtering
> transition types and qualifiers until Firefox 48
> In Firefox, before Firefox 47,  onReferenceFragmentUpdated also triggers for pushState.

]FIG]

[418] [CITE@en[Define initial about:blank document better]]
( ([[annevk]]著, [TIME[2016-06-21 13:53:01 +09:00]]))
<https://github.com/whatwg/html/commit/8edc92d6e42878662c7f9f75a43352bd341ae01d>

[419] [CITE@en[Use fullscreen logic for initial about:blank documents too]]
( ([[annevk]]著, [TIME[2016-06-09 21:47:29 +09:00]]))
<https://github.com/whatwg/html/commit/c2a8d605e0115c80d1ccb4b15371ecaa56a33e30>

[252] [CITE[Plz Navigate: moving the navigation logic to the browser process - Google グループ]]
([TIME[2016-06-30 11:51:54 +09:00]])
<https://groups.google.com/a/chromium.org/forum/#!topic/chromium-dev/sOs05JfmPFw>

[420] [CITE@en[Issue 368813 - chromium - '''['''META''']''': Navigation network requests should be made by the browser process (aka PlzNavigate) - Monorail]]
([TIME[2016-06-30 11:52:31 +09:00]])
<https://bugs.chromium.org/p/chromium/issues/detail?id=368813>

[421] [CITE@en[Navigate: remove "gone async" and define redirect handling]]
([[annevk]]著, [TIME[2016-07-04 17:38:20 +09:00]])
<https://github.com/whatwg/html/commit/8b630f5e4fa2ec8b0999470d09490bffe6e9a1e3>

[433] [CITE@en[Navigate: narrow down requirements for fragment handling]]
([[annevk]]著, [TIME[2016-07-07 00:48:00 +09:00]])
<https://github.com/whatwg/html/commit/10379142cbb138a814d94e24f3e6b14c2439d614>

[FIG(quote)[
[FIGCAPTION[
[437] [CITE[【Swift】WKWebViewのリダイレクト先URL(URLスキーム)に応じて動作したい時にハマったこと - Qiita]]
([TIME[2016-08-03 11:06:34 +09:00]])
<https://qiita.com/seiya_orz/items/0ed195b79953ec607ea1>
]FIGCAPTION]

> didReceiveServerRedirectForProvisionalNavigationはデフォルトでは、http~とhttps~のみをリダイレクト対象として呼び出されるようでした。どのURLをリダイレクトとして扱うかのハンドリングをしている関数が、func webView(webView: WKWebView, decidePolicyForNavigationAction navigationAction: WKNavigationAction, decisionHandler: (WKNavigationActionPolicy) -> Void)です。

]FIG]


[438] [CITE@en[Add another navigation hook for 'form-action'.]]
([[mikewest]]著, [TIME[2016-08-02 21:40:31 +09:00]])
<https://github.com/w3c/webappsec-csp/commit/ad8c11702561db911baab316659de28de1cb00d0>

[439] [CITE@en[Upstream navigation hooks from CSP]]
([[mikewest]]著, [TIME[2016-08-18 17:01:55 +09:00]])
<https://github.com/whatwg/html/commit/2083b0053a059f692a0a95547ba9b6bd0c511094>