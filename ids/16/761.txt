* 仕様書

[REFS[
- [12] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#navigate>
]REFS]

* 文脈

[16] [[navigate]] は、[[仕様書]]で規定されている手順により ([[著者]]の指示により)
実行される場合もあれば、[[利用者エージェント]]依存の方法で ([[利用者]]の直接の指示により)
実行される場合もあります。

[EG[
[17] 前者の例として [CODE(JS)@en[[[location.href]]]] の設定が、
後者の例として[[アドレスバー]]からの [[URL]] の指定があります。
]EG]

[13] [[navigate]] を発生させる操作には、例えば次のものがあります。
[FIG(short list)[
- [[ハイパーリンクをたどる]]
- [[フォーム提出]]
- [CODE(JS)@en[[[window.open]]]]
- [CODE(JS)@en[[[location.assign]]]]
- [CODE(JS)@en[[[location.href]]]]
- [CODE(JS)@en[[[location.reload]]]]
- [[アドレスバー]]、[[メニュー]]、[[DnD]]、[[WebDriver]] 等からの [[URL]] の指定
- [[履歴]]の移動操作
- [[再読込]]操作
- [[栞]]の選択
- [[コマンドライン引数]]等の他の[[アプリケーション]]からの [[URL]] の指定
]FIG]

* 入力

[14] [[navigate]] は、ある[[閲覧文脈]]に関する操作です。

[21] [[navigate]] は、ある[[資源]]を入力とする操作です。
ここで[[資源]]は次のものによって表されます。
[FIG(short list)[
- [[URL]]
- [[要求メソッド]]
- [[フォーム提出アルゴリズム]]からの呼び出しか否か
- その他 [[fetch]] に必要な引数
- 場合によっては、 [[fetch]] の結果
]FIG]

[EG[
[24] [CODE(HTMLe)@en[[[object]]]] [[要素]]の処理では、[[資源]]の [[fetch]]
が終わってから [[navigate]] が呼び出されます。
]EG]

[15] [DFN[[RUBYB[原始閲覧文脈]@en[source browsing context]]]]は、
[[navigate]] の開始に責任を持つ[[閲覧文脈]]です [SRC[>>12]]。
[[原始閲覧文脈]]は、 [[navigate]] される[[閲覧文脈]]について
[[navigate]] を認められているか、いないかのいずれかです。

[20] [DFN[[RUBYB[明示的自己ナビゲーション上書き]@en[explicit self-navigation override]]]]
[SRC[>>12]] は、[[navigate]] する[[閲覧文脈]]の選択方法についてのフラグです。

[19] [DFN[[RUBYB[例外有効]@en[exceptions enabled]]]] [SRC[>>12]]
は、[[例外]]を投げるかどうかのフラグです。

[22] [DFN[[[reload-triggered navigation]]]] [SRC[>>12]]
は、[[再読込]]操作かどうかのフラグです。

* 処理

[18] [[利用者エージェント]]は、 [[navigate]] を次のように行わなければ[['''なりません''']]
[SRC[>>12]]。

[FIG(steps)[
= [[ストレージミューテックス]]を解放します。
= [[原始閲覧文脈]]が当該[[閲覧文脈]]を [[navigate]] することを認められていなければ、
== [[利用者]]の判断により次のいずれかを実行できても構いません。
ただし[[著者]]の[[砂箱化]]の要求を無視する場合もあり、危険かもしれません。
==- 新しい[[最上位閲覧文脈]]を開いて [[navigate]] することを[[利用者]]が選択したかのように扱います。
==- [[原始閲覧文脈]]の[[最上位閲覧文脈]]を [[navigate]] することを[[利用者]]が選択したかのように扱います。
== そうしない場合、
=== [[例外有効]]なら、 [CODE(DOMe)@en[[[SecurityError]]]] [[例外]]を投げます。
=== ここで停止します。
= 
[FIG(list)[
- [[原始閲覧文脈]]が [[navigate]] する[[閲覧文脈]]と同じで、
- [[seamless browsing context flag]] が設定されていて、
- [[navigate]] する[[閲覧文脈]]が[[明示的自己ナビゲーション上書き]]フラグ無しで選ばれたなら、
]FIG]
... [[seamless browsing context flag]] が設定されていない直近の[[祖先閲覧文脈]]を
[[navigate]] する[[閲覧文脈]]とします。
= 
[FIG(list)[
- [[原始閲覧文脈]]と [[navigate]] する[[閲覧文脈]]が同じで、
- [[navigate]] する[[閲覧文脈]]が他の [[navigate]] を実行中で、
- その [[navigate]] が [[unload a document]] を実行中で、
- その [[navigate]] の[[資源]]の [[URL]] の[[起源]]と本 [[navigate]] の[[資源]]の [[URL]]
の[[起源]]が[[同じ起源]]では''ない''なら、
]FIG]
... ここで停止します。
= [[traverse the history by a delta]] により[[タスクキュー]]に入れられた[[タスク]]が
[[navigate]] する[[閲覧文脈]]の[[活性文書]]について [[unload a document]] を走らせている場合、
ここで停止します。
= [[navigate]] する[[閲覧文脈]]の[[活性文書]]について [[prompt to unload a document]]
が走っている場合、ここで停止します。
= [VAR[gone async]] を[[偽]]に設定します。
= '''[[素片識別子]]''':
[FIG(list)[
- [[reload-triggered navigation]] でなく、
- 新しい[[資源]]の [[URL]] と [[navigate]] する[[閲覧文脈]]の[[活性文書]]の[[文書の番地]]
(を[[構文解析]]したもの) が[[素片識別子]]以外すべて同じで、
- 新しい[[資源]]に[[素片識別子]]があり ([[空文字列]]を含む。)、
- 新しい[[資源]]の[[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] なら、
]FIG]
... [[素片識別子にnavigate]]します。ここで停止します。
= [VAR[gone async]] が[[偽]]なら、
同じ[[閲覧文脈]]に関する既存の未 [[mature]] の [[navigate]] があれば、取り消します。
@@ そこから [[fetch]] が実行されていれば、それも取り消します。
更に[[文書]]オブジェクトの作成と[[文書オブジェクトを初期化]]が実行されていれば、
[[文書のabort]]を実行します。
= 新しい[[資源]]が[[閲覧文脈]]に影響しない仕組みを使うなら、
その仕組みを実行し、ここで停止します。
= [VAR[gone asnyc]] が[[偽]]なら、 [[prompt to unload a document]] を実行します。
== 実行中に本 [[navigate]] が取り消された場合でも、
[[prompt to unload a document]] は完了させなければなりません。
== [[refused to allow the document to be unloaded]] なら、ここで停止します。
= [VAR[gone async]] が[[偽]]なら、[[閲覧文脈]]の[[活性文書]]について[[文書のabort]]
を実行します。
= 新しい[[資源]]を[[行内]]で表示するなら、そのように処理し、ここで停止します。
[EG[
[23] 例えば [[URL scheme]] に対応していないエラーを表示部に示す場合や、
[CODE(DOMm)@en[[[registerProtocolHandler]]]] で登録された取り扱い器を[[利用者]]に選択する画面を表示部に示す場合があります。
(選択した取り扱い器を実行する場合は、 [[navigate]] を改めて実行することになります。)
]EG]
= [[navigate]] する[[閲覧文脈]]が[[入れ子閲覧文脈]]の場合は、これを
[[delaying [CODE(DOMe)@en[load]] events mode]] に追加します。
@@ 本 [[navigate]] が [[mature]] となるか、終了するかの最初の時点で、
[[delaying [CODE(DOMe)@en[load]] events mode]] から削除します。
= [[資源]]を [[fetch]] した結果がまだ無いなら、
== 新しい[[資源]]の [[URL scheme]] が [CODE(URI)@en[[[javascript:]]]] なら、
[CODE(URI)@en[[[javascript:]]]] の [[navigate]] を実行します。
結果として[[応答]]と[[文書の番地]]を得ます。
== 
[FIG(list)[
- 新しい[[資源]]の[[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- 新しい[[資源]]の [[URL]] と[[同じ起源]]の [[URL]] を持つ [[relevant application cache]]  があり、
- その [[AppCache]] [[エントリー]]のいずれかが新しい[[資源]]の [[URL]] を持ち、
- ただしその[[エントリー]]は [[foreign]] ではなく、
- その [[mode]] が [[fast]] であり、
- [[利用者エージェント]]が[[AppCache]]を使わないモードでなければ、
]FIG]
... [[最適AppCache]]からの新しい[[資源]]の [[fetch]]
を呼び出します。
==- [[フォーム提出アルゴリズム]]からの呼び出しなら、
呼び出し元の[[起源]]は[[始点閲覧文脈]]の[[活性文書]]の[[起源]]に (あれば) します。
== それ以外なら、 [[manual redirect flag]] 付きで新しい[[資源]]の [[fetch]] を呼び出します。
==- [[要求メソッド]]が非 [CODE(HTTP)@en[[[GET]]]] であるか、
[[フォーム提出アルゴリズム]]からの呼び出しなら、
呼び出し元の[[起源]]は[[始点閲覧文脈]]の[[活性文書]]の[[起源]]に (あれば) します。
==- それ以外で、 [[navigate]] する[[閲覧文脈]]が[[子供閲覧文脈]]なら、
呼び出し元の[[起源]]は [[navigate]] する[[閲覧文脈]]の[[閲覧文脈包含子]]の[[閲覧文脈適用範囲起源]]に (あれば) します。
= [VAR[gone async]] が[[偽]]なら、呼び出し元に戻します。続きの手順も[[非同期的]]に継続します。
= [VAR[gone async]] を[[真]]にします。
= [[fetch]] していれば、[[資源]]のバイトをいくらか利用できるようになるか、
空であると決定できるまで待ちます。この間、[[利用者]]が [[navigate]]
を取り消しできても構いませんし、他の [[navigate]] を開始できても構いません。
= '''Handle redirects''': [[fetch]] して[[リダイレクト]]が得られたなら、
== [[リダイレクト]]先の [[URL]] が元の[[資源]]の [[URL]] と[[同じ起源]]か、
[[要求メソッド]]が [CODE(HTTP)@en[[[POST]]]] か[[安全なメソッド]]なら、
[[リダイレクト]]先の[[資源]]に変更して[[素片識別子]]の段に戻ります。
==- ただし[[リダイレクト]]先の[[資源]]の [[URL]] に[[素片識別子]]がなく、
元の[[資源]]の [[URL]] に[[素片識別子]]があれば、[[リダイレクト]]先の[[資源]]の [[URL]]
にその[[素片識別子]]を付け足します。
== それ以外なら、
=== [[セキュリティー]]上の理由で [[navigate]] を停止したことを[[利用者]]に示しても構いません。
=== ここで停止します。
= '''Fallback in prefer-online mode''': 
[FIG(list)[
- [[資源]]を [[AppCache]] から [[fetch]] した場合で、
- 新しい[[資源]]の[[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- 新しい[[資源]]の [[URL]] と[[同じ起源]]の [[URL]] を持つ [[relevant application cache]]  があり、
- その [[AppCache]] [[エントリー]]のいずれかが新しい[[資源]]の [[URL]] を持ち、
- ただしその[[エントリー]]は [[foreign]] ではなく、
- その [[mode]] が [[prefer-online]] であり、
- [[利用者]]が [[navigate]] を停止させておらず、
- [[navigate]] が失敗 ([[DNS]] エラー、 [CODE(HTTP)[[[4xx]]]] や [CODE(HTTP)[[[5xx]]]]
など) であるなら、
]FIG]
== [[最適AppCache]]から新しい[[資源]]の [[URL]] で識別されるエントリーを得ます。
== そのエントリーが [[foreign]] でないなら、失敗したもののかわりに得られたエントリーを使います。
なおこの場合[[利用者]]に対して失敗したこととキャッシュを使うことを示して構いません。
= '''Fallback for fallback entries''':
[FIG(list)[
- [[資源]]を [[AppCache]] から [[fetch]] しなかった場合で、
- 新しい[[資源]]の[[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] で、
- 新しい[[資源]]の [[URL]] が [[relevant application cache]] の [[fallback namespace]]
に一致する場合で、
- その[[最適AppCache]]の [[online whitelist]] に新しい[[資源]]の [[URL]] と[[同じ起源]]の [[URL]] を持ち、新しい[[資源]]の [[URL]] の先頭と一致するようなエントリーが無く、
- [[利用者]]が [[navigate]] を停止させておらず、
- [[navigate]] が失敗 ([[DNS]] エラー、 [CODE(HTTP)[[[4xx]]]] や [CODE(HTTP)[[[5xx]]]]
など) であるなら、
]FIG]
== [[最適AppCache]]の [[fallback namespace]] に対する [[fallback resource]] を得ます。
== そのエントリーが [[foreign]] でないなら、失敗したもののかわりに得られたエントリーを使います。
なおこの場合[[利用者]]に対して失敗したことと [[fallback resource]]
を使うことを示して構いません。
= [26] '''Resource handling''': [[資源]]の[[MIME型]]以外のメタデータの指示により、
[[閲覧文脈]]に影響しない処理を行うべきなら、その処理を行い (>>25)、ここで停止します。
=
@@ ...
]FIG]

[25] [[fetch]] した[[資源]]の [[MIME型]]以外のメタデータの指示による[[閲覧文脈]]に影響しない処理を行う場合
(「resource handling」 >>26) には、次のような場合があります。
[FIG(list)[
- [[状態符号]] [CODE(HTTP)[[[204]]]] [SRC[>>12]]
- [[ネットワークエラー]]、[[TLS証明書]]エラー [SRC[>>12]]
- [CODE(HTTP)@en[[[Content-Disposition:]] [[attachment]]]] = [[ダウンロード]] [SRC[>>12]]
- [[状態符号]] [CODE(HTTP)[[[401]]]] で[[モーダルダイアログ]]を表示する場合
]FIG]

[27] ここで、[[利用者エージェント]]が認識できる [[challenge]] を含まない
[CODE(HTTP)[[[401]]]] [[応答]]は、 [CODE(HTTP)[[[200]]]] 同様に扱わなければ[['''なりません''']]
[SRC[>>12]]。

[28] [[利用者エージェント]]は [CODE(HTTP)[[[401]]]] [[応答]]で認識できる [[challenge]]
を含む場合であっても、[[応答]]を表示した上で、非[[モーダルダイアログ]]によって[[ログイン]]できるようにしても構いません [SRC[>>12]]。

* 歴史

[1] [CITE@en[Web Applications 1.0 r5685     Make form submission via .submit(), and page navigation via location.href, when either is done before the page has completely loaded, result in a history replacement (like a redirect) rather than a regular load.]]
( ([TIME[2010-11-30 10:22:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=5684&to=5685>

[2] [CITE@en[Web Applications 1.0 r5686     Change pushState() and replaceState() so that they update the pending state object as well (otherwise, pushState vs pushState;back;forward would result in different state objects in the initial popostate which is just silly).]]
( ([TIME[2010-11-30 11:07:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=5685&to=5686>

[3] [CITE[''''''[''''''whatwg'''''']'''''' pushState and session history issues]]
( ([TIME[2010-11-30 23:35:29 +09:00]] 版))
<http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2010-November/029234.html>

[8] [CITE@en[Web Applications 1.0 r6630     Define navigating to video and audio resources]]
( ([TIME[2011-10-05 09:02:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=6629&to=6630>

[9] リンクのクリック時に [CODE(DOMa)@en[[[click]]]] で [CODE(HTMLe)@en[[[img]]]] を使って [[fetch]]
を行うと、 [[IE10]] ではアクセスが発生しますが、 [[Firefox]] と [[Chrome]] ではアクセスが来ません。
[CODE(DOMa)@en[[[mousedown]]]] だと [[Chrome]] はアクセスが来ますが、応答を受け取ったり受け取れなかったりするようです。
[[Chrome]] の場合 [[navigation]] によってアクセスが中断され、そのタイミングによって要求が送られたり送られなかったり、
応答を処理できたりできなかったりするようです。 [TIME[2013-07-04T03:10:59.800Z]]

[10] [CITE[''''''[''''''whatwg'''''']'''''' scrdoc and session history don't play along in the spec]]
( ([TIME[2013-07-13 11:50:26 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-July/040059.html>

[11] [CITE[''''''[''''''whatwg'''''']'''''' Avoiding synchronous iframe load]]
( ([TIME[2013-10-26 04:58:58 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-October/041281.html>

[4] [CITE[''''''[''''''whatwg'''''']'''''' Navigation and history traversal issues]]
( ([TIME[2012-09-19 01:33:19 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2012-September/037325.html>

[5] [CITE@en-US[Window Object 1.0]]
( ([TIME[2006-04-08 02:19:28 +09:00]] 版))
<http://www.w3.org/TR/Window/#dfn-navigate>

[6] [CITE@en[Web Applications 1.0 r8555     Be more explicit about handing off to external software during navigation.]]
( ([TIME[2014-03-20 07:01:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8554&to=8555>

[7] [CITE@en[Web Applications 1.0 r8799 Stop using the word 'asynchronously', and reduce usage of the word 'synchronous'.]]
( ([TIME[2014-09-20 08:19:00 +09:00]] 版))
<https://html5.org/r/8799>