* 仕様書

[REFS[
- [2] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#security-and-privacy-considerations>
- [5] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dom-pushmanager-subscribe>
- [42] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dom-pushmanager-getsubscription>
]REFS]

* 処理

[6] 
[CODE[PushManager]] の
[DFN[[CODE[subscribe]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>5]]

[FIG(steps)[
= [12] [VAR[オプション群]]を、
第1引数を省略可能な
[CODE[PushSubscriptionOptionsInit]]
[[辞書]]として解釈した結果に設定します。
= [7] [VAR[約束]]を、
[[新しい約束]]に設定します。
= [8] [VAR[約束]]を返します。
]FIG]

[9] [[非同期的]]に、次のようにしなければ[MUST[なりません]]。
[SRC[>>5]]

[FIG(steps)[
= [10] [[現在設定群オブジェクト]]が [[secure context]] で''ない''場合、
== [11] 
[VAR[約束]]を、
[CODE[SecurityError]] [CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [13] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[CODE[null]]
で''ない''場合、
== [14] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[CODE[DOMString]] の場合、
=== [15] [VAR[バイト列]]を、
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
を
[[RFC 7515]]
[[base64url]]
復号した結果に設定します。
=== [16] 
[VAR[バイト列]]が[[失敗]]の場合、
==== [17] 
[VAR[約束]]を、
[CODE[InvalidCharacterError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
=== [18] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
を、
[VAR[バイト列]]の
[CODE[ArrayBuffer]]
に設定します。
== [19] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[[P-256 curve]]
上の妥当な点を表さ''ない''場合、
=== [20] 
[VAR[約束]]を、
[CODE[InvalidAccessError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [21] 
[[プッシュサービス]]が[[公開鍵]]を必須とする場合
[SEE[ [[プッシュサービス]] ]]
であって、
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[CODE[null]]
の場合、
== [22] 
[VAR[約束]]を、
[CODE[NotSupportedError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [23] [VAR[登録]]を、
[[文脈オブジェクト]]の[F[サービスワーカー登録]]に設定します。
= [24] 
[VAR[登録]]の[F[活性ワーカー]]が [CODE[null]] の場合、
== [25] 
[VAR[約束]]を、
[CODE[InvalidStateError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [26] [VAR[permission]] を、
[VAR[オプション群]]とこれが[[サービスワーカー]]からの呼び出しか否かについて、
[[permission]]
を尋ねた結果に設定します。
[SEE[ [[permission]] ]]
[[非同期的]]に待ちます。
= [27] 
[VAR[permission]]
が拒否の場合、
== [28] 
[VAR[約束]]を、
[CODE[NotAllowedError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [40] 
当該[[サービスワーカー]]が[[プッシュ購読]]を持つ場合、
== [29] 
[VAR[購読]]を、
当該[[サービスワーカー]]の[[プッシュ購読]]に設定します。
[[非同期的]]に待ちます。
[NOTE[
[35] 
[[仕様書]]に明記されていませんが、
[[プッシュサービス]]への [[fetch]]
が想定されているようです。
]NOTE]
== [30] 
[VAR[購読]]がエラーの場合、
=== [31] 
[VAR[約束]]を、
[CODE[AbortError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
=== [32] 
[VAR[購読]]の [F[[CODE[options]]]]
と[VAR[オプション群]]の[[属性]]を比較します。
[CODE[BufferSource]] は、等価性を比較します。
異なりがある場合、
==== [33] 
[VAR[約束]]を、
[CODE[InvalidStateError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
== [34] 
[VAR[約束]]を、
[VAR[購読]]で[[解決]]します。
= [41] それ以外の場合、
== [36] [VAR[購読]]を、
[VAR[オプション群]]について[[プッシュ購読を作成]]した結果に設定します。
[[非同期的]]に待ちます。
== [37] 
[VAR[購読]]がエラーの場合、
=== [38] 
[VAR[約束]]を、
[CODE[AbortError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
== [39] 
[VAR[約束]]を、
[VAR[購読]]で[[解決]]します。


]FIG]



-*-*-

[43] 
[CODE[PushManager]]
[[インターフェイス]]の
[DFN[[CODE[getSubscription]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>42]]

[FIG(steps)[
= [44] [VAR[約束]]を、
[[新しい約束]]に設定します。
= [45] [VAR[約束]]を返します。
]FIG]

[46] [[非同期的]]に、次のようにしなければ[MUST[なりません]]。
[SRC[>>42]]

[FIG(steps)[
= [47] 当該[[サービスワーカー]]が[[プッシュ購読]]を持つ場合、
== [50] 
[VAR[購読]]を、
当該[[サービスワーカー]]の[[プッシュ購読]]に設定します。
[[非同期的]]に待ちます。
[NOTE[
[51] 
[[仕様書]]に明記されていませんが、
[[プッシュサービス]]への [[fetch]]
が想定されているようです。
]NOTE]
== [52] 
[VAR[購読]]がエラーの場合、
=== [53] 
[VAR[約束]]を、
[CODE[AbortError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
== [54] 
[VAR[約束]]を、
[VAR[購読]]で[[解決]]します。
= [48] それ以外の場合、
== [49] [VAR[約束]]を、
[CODE[null]]
で[[解決]]します。
]FIG]



* 実装

[1] 
[[Chrome]] でなぜかこのメソッドの [[Promise]]
が解決されなくなることがあります。
なぜか全然応答しなくなり、固まっているようにみえます。
[[通知]]の許可を変更したり、リセットしたりしても解決しません。
[[Chrome]]
を再起動するとあっさり治ります。
[TIME[2019-09-30T06:54:07.400Z]]

* メモ