* 仕様書

[REFS[
- [2] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#security-and-privacy-considerations>
- [5] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dom-pushmanager-subscribe>
]REFS]

* 処理

[6] 
[CODE[PushManager]] の
[DFN[[CODE[subscribe]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>5]]

[FIG(steps)[
= [12] [VAR[オプション群]]を、
第1引数を省略可能な
[CODE[PushSubscriptionOptionsInit]]
[[辞書]]として解釈した結果に設定します。
= [7] [VAR[約束]]を、
[[新しい約束]]に設定します。
= [8] [VAR[約束]]を返します。
]FIG]

[9] [[非同期的]]に、次のようにしなければ[MUST[なりません]]。
[SRC[>>5]]

[FIG(steps)[
= [10] [[現在設定群オブジェクト]]が [[secure context]] で''ない''場合、
== [11] 
[VAR[約束]]を、
[CODE[SecurityError]] [CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
= [13] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[CODE[null]]
で''ない''場合、
== [14] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[CODE[DOMString]] の場合、
=== [15] [VAR[バイト列]]を、
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
を
[[base64url]]
復号した結果に設定します。
=== [16] 
[VAR[バイト列]]が[[失敗]]の場合、
==== [17] 
[VAR[約束]]を、
[CODE[InvalidCharacterError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
=== [18] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
を、
[VAR[バイト列]]の
[CODE[ArrayBuffer]]
に設定します。
== [19] 
[VAR[オプション群]]の
[F[[CODE[applicationServerKey]]]]
が
[[P-256 curve]]
上の妥当な点を表さ''ない''場合、
=== [20] 
[VAR[約束]]を、
[CODE[InvalidAccessError]]
[CODE[DOMException]]
で[[拒絶]]し、
ここで停止します。
=
@@



]FIG]


[3] [[利用者エージェント]]は、
[[利用者]]が
[[express permission]]
することなく [[Push API]]
の機能を [[Webアプリケーション]]に提供しては[MUST[なりません]]。
[CODE[subscribe]]
[[メソッド]]では、
[[利用者インターフェイス]]で [[permission]]
に同意を得るか、
以前の同意が有効でなければ[MUST[なりません]]。
同意済みかの判定には
[CODE[PushSubscriptionOptions]]
を考慮[MAY[できます]]。
[SRC[>>2]]

[4] 
現在の[[閲覧セッション]]を超えて有効な [[permission]]
は、[[失効]]可能でなければ[MUST[なりません]]。
[SRC[>>2]]
[SEE[ [[プッシュ購読]] ]]

* 実装

[1] 
[[Chrome]] でなぜかこのメソッドの [[Promise]]
が解決されなくなることがあります。
なぜか全然応答しなくなり、固まっているようにみえます。
[[通知]]の許可を変更したり、リセットしたりしても解決しません。
[[Chrome]]
を再起動するとあっさり治ります。
[TIME[2019-09-30T06:54:07.400Z]]

* メモ