* 種別

[FIG(short list)[ [8] [[文字]]を[[記号]]として[[バイト]]や[[文字]]を[[符号化]]する

- [[UTF-8符号化されたバイト列と文字列]]
- [[フォント依存符号化]]
- [[鍵盤符号化]]
- [[HZ]]
- [[UTF-7]]
- [[ISO/IEC 10646におけるエスケープシーケンス]]
- [[外字]]
- [4] [[点字]]
- [5] [[モールス符号]]
- [[翻字]]
- [[SERA]]
- [[EWTS]]
- [[mnem]]
- [[VIQR]]
- [[escape]]
- [[転送符号化]]
- [[文字としてのバイト]]


]FIG]


* Unicode の制御文字

[22] 
[[Unicode]] は[[制御文字]]や[[エスケープシーケンス]]に関係して[[上位層プロトコル]]という語を使っています。
[SEE[ [[ISO/IEC 10646におけるエスケープシーケンス]], [[制御文字]] ]]

[23] 
[[上位層プロトコル]]とは二階建て8ビット符号における第2層の[[8ビット符号]]に当たるものになります。


* 二階建ての8ビット符号

[1] 
[[フォント依存符号化]]で非常によくある形態は、

- [2] [[8ビット符号]] : [[バイト]]に対する[[文字]]を割り当ての[[集合]] (概念上の存在)
- [10] [[windows-1252]] : [[バイト]]と [[Unicode符号位置]]の対応関係の[[集合]]
- [7] [[文書形式]]として保存されるデータ : [[windows-1252]] の[[バイト]]の列であり、
[[Unicode符号位置]]の [[escape]] を含む
- [6] [[応用]]の保持する[[文書]]オブジェクト上の[[文字列]] : [[Unicode符号位置]]の列
- [3] [[フォント]] : [[Unicode符号位置]]に対する[[グリフ]]の[[集合]]

... で構成されます。

[11] 
[[8ビット符号]]が[[バイト]] [ [N[0]], [N[255]] ] と[[文字]]の[[写像]]であることは[[第一級]]の[[符号化文字集合]]と同じです。

[12] 
ところが[[第一級]]の[[8ビット符号]]の実装とは違って[[フォント依存符号化]]は[[応用]]や[[プラットフォーム]]が直接支援するものではないため、
他の[[第一級]]の[[8ビット符号]]で代用されます。ほとんどの場合はそれが
[[windows-1252]] 
です。ここでは [[windows-1252]] の[[符号化文字]]は重要ではなく、
それが[[バイト]]と [[Unicode符号位置]]の[[写像]]であることだけが意味を持ちます。

[13] 
実際に[[ファイル]]として保存される [[HTML]] や [[RTF]] などの[[文書形式]]のデータは、
[[windows-1252]] に従った[[バイト列]]で構成されており、必要に応じて[[文書形式]]によって定義される
[[Unicode符号位置]]を表す[[エスケープ]]表現を含むことがあります。

[14] 
[[応用]]の内部では、これらのデータは[[Unicode符号位置]]の列として保持されます ([[参照符号化モデル]])。
ただし、この [[Unicode符号位置]]はあくまで[[バイト]]の表現であり、
本来の [[Unicode文字]]の意味で使われているものではありません。

[15] 
[[応用]]は[[フォント]]を使って[[文字]]を表示します。[[フォント依存符号化]]の一般的な
[[TrueType]] [[フォント]]は、実際には[[8ビット符号]]ではなく、
[[Unicode符号位置]]から[[グリフ]]への[[写像]]の[[集合]] ([CODE[cmap]]) です。

[16] 
つまり[[フォント依存符号化]]は第一層として [[windows-1252]] 
が[[バイト]]と[[バイト]]たる[[Unicode文字]]の対応関係を定め、
第二層として当該符号が[[バイト]]たる[[Unicode文字]]と[[文字]]との対応関係を定める2階層の構造であり、
しかも第一層の結果はただの[[文字列]]ではなく[[文書形式]]に依存する構文や [[escape]]
を含んでいることがあります。

[EG[

[17] [[HTML]] では [[Latin1]] [[文字参照]]が使われていることがありますが、
本来の [[Latin1]] の[[文字]]ではなく、[[フォント]]がその[[符号位置]]に割り当てている[[文字]]を表します。

[18] 同様に [[RTF]] では [[windows-1252]] の[[文字]]を表す[[命令]]が使われていることがありますが、
本来の[[文字]]ではなく[[フォント]]の[[文字]]を表します。

]EG]

* 二階建ての多バイト符号

[19] 
二階建ての8ビット符号と同様の要領で[[多バイト符号]]が使われることがあります。

[20] 
[[8ビット符号]]の場合と違って第二層は [[EUC-CN]] や [[Big5]] や [[EUC-KR]] などの一般的な[[多バイト符号]]のことが多いです。

[21] 
[[欧米]]や[[東南アジア]]のような[[東アジア]]以外で[[20世紀]]末から[[21世紀]]初頭 ([[平成時代]]前半) 頃に使われた[[著述ソフトウェア]]
([[Webサイト]]提供サービス付属のものを含みます。) が生成した [[HTML文書]]でこの種のものがちらほら見られます。


* 上位層文字コードの container format としての文書形式

[24] 
[[フォント依存符号化]]では [[HTML]] ([CODE[font]]) や [[HTML]] + [[CSS]] ([CODE[font-family]])
や [[RTF]] や各種[[ワープロ]]の[[文書形式]]などが、
[[フォント名]]の指定を通して実質的な[[文字コード]]の切り替え機能を持った一種の
[[container format]] として使われます。

[25] 
[[フォント依存符号化]]が多く使われた地域や[[言語]]の[[文字コードの変換]]の実装では、
こうした形式が[[文字コード]]の種別と組み合わさった入出力の不可分の性質として扱われることがあります。
本来 [[HTML]] はただの[[テキストファイル]]ですが、
[[タグ]]等が[[文字コード]]の切り替え機能を持った複合的な構造として扱う必要があるのです。
[SEE[ [[文字コードの混在]] ]]

[26] 
特に重要になるのは、

- [27] [[ASCII文字]]と[[鍵盤符号化]]等の[[ASCII文字]]を差し替えた[[フォント依存符号化]]の[[文字]]が[[フォント]]切り替えによって混在することがある場合
- [28] 同じ [[windows-1252]] [[文字]]が[[フォント]]ごとに異なる[[文字]]を割り当てており、
それらを切り替えて1つの[[言語]]を表す場合
[SEE[ [[エチオピア文字の文字コード]], [[チベット文字の文字コード]] ]]
- [29] [[記号]]や[[外字]]のための[[フォント依存符号化]]の[[フォント]]を混ぜて使う場合
[SEE[ [[フォント依存符号化]], [[外字]] ]]
- [30] [[文書形式]]に依存する [[escape]] が [[windows-1252]] の[[代替表記]]であるかのように使われるが、
実際にはそうではない場合 (>>17, >>18)

のような状況を扱わなければならないことです。

[31] 
[[HTML]] + [[CSS]] のように外部ファイルに[[フォント]]情報が分離されていることもあるので、
注意が必要です。

;; [32] 
もし [[CSS]] が失われてしまって [[HTML]] のみが残っているとすると、
[[要素]]ごとに[[文字コードの判定]]を行って修復する必要が出てきます。


* 階層化されたデータにおける文字コードの判定

[33] 
[[文字コードの判定]]の操作は、

- [34] 階層化された最下層を判定すれば足る場合
- [35] 階層化された上層も含めて判定する必要がある場合
- [36] 階層化されたうちの上位層だけを判定する必要がある場合

... が考えられ、それぞれ実装手法や配慮するべき点が異なってきます。

** 最下層の判定

[37] 
最下層は [[windows-1251]], [[UTF-8]], [[Shift_JIS]] などと判定する必要があります。
[[HTTP]] [CODE[charset=""]] や [[HTML]] [CODE[<meta charset>]]
などで適切に指定されている場合は問題になりません。 [[RTF]] 
のように[[文書形式]]から確定できる場合も問題になりません。

;; [39] なお [CODE[x-user-defined]] も参照。

[38] 
問題は適切な[[文字コードの指定]]がないときで、[[頻度解析等の手法]]によって決める必要が出てきますが、
[[文字]]の出現頻度を使った通常の推定手法で [[windows-1252]] や [[Shift_JIS]]
だと判定するのは困難な場合が多いです。



* 関連

[9] 関連:
[[文字コード]],
[[字母]],
[[文字コードの変換]],
[[文字コードの判定]],
[[文字コードの修復]]

* メモ

