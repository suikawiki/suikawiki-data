[4] A [[client]] has a [F[PAC]], which is initially [[null]].
If the client is configured to use a [[PAC file]], it is set to an object
which represents the file.
Otherwise, if the client is configured to use one or more proxy servers,
it is set to a virtual [[PAC file]] which represents those proxy server configurations.

[1] To [DFN[establish a connection to the HTTP server]] of an [[URL record]] [VAR[url]]
from a client [VAR[client]], optionally with the [VAR[ws]] flag, run these steps:
[FIG(steps)[
= [2] If [VAR[client]]'s [F[PAC]] is not [[null]]:
== [3] Let [VAR[proxies]] be the result of [[running a PAC file][run a PAC file]] with 
[VAR[client]]'s [F[PAC]] and [VAR[url]].
= [6] Otherwise:
== [7] Let [VAR[proxies]] be a list whose only member
is ([CODE[direct]], [[null]], [[null]]).
= [10] For each [VAR[proxy]] in [VAR[proxies]], in order, run these substeps:
== [66] Set [VAR[request mode]] to ''default''.
== [12] Switch by [VAR[proxy]]'s [F[protocol]]:
[FIG(switch)[
: [CODE[direct]] :
[FIG(steps)[
= [58] Let [VAR[port]] be the [[effective port]] of [VAR[url]].
= [56] Let [VAR[addr]] be the result of [[name resolution]] of [VAR[url]]'s [F[host]].
= [14] If [VAR[addr]] is an [[error]]:
== [61] Set [VAR[connection]] to a [[failure]].
= [62] Otherwise:
== [44] If [VAR[ws]] flag is set, [[wait for other connections]]
with [VAR[addr]] and [VAR[url]]'s [F[port]].
== [31] Set [VAR[connection]] to the result of 
[[establishing a TCP connection][establish a TCP connection]]
to [VAR[addr]] and [VAR[port]].
]FIG]
: [CODE[http]] or [CODE[https]] :
[FIG(steps)[
= [43] If [VAR[ws]] flag is set, [[wait for other connections]]
with [VAR[url]]'s [F[host]] and [VAR[url]]'s [F[port]].
= [34] Let [VAR[port]] be [VAR[proxy]]'s [F[port]].
= [35] If [VAR[port]] is [[null]], set [VAR[port]] to [N[80]].
= [46] Let [VAR[addr]] be the result of [[name resolution]] of [VAR[proxy]]'s [F[host]].
= [47] If [VAR[addr]] is an [[error]]:
== [63] Set [VAR[connection]] to a [[failure]].
= [64] Otherwise:
== [36] Set [VAR[connection]] to the result of 
[[establishing a TCP connection][establish a TCP connection]]
to [VAR[addr]] and [VAR[port]].
= [54] If [VAR[connection]] is ''not'' a [[failure]] and
[VAR[proxy]]'s [F[protocol]] is [CODE[https]]:
== [55] Set [VAR[connection]] to the result of running the [[TLS steps]] for
[VAR[connection]] and [VAR[proxy]]'s [F[host]].
= [29] If [VAR[connection]] is ''not'' a [[failure]] and
[VAR[url]]'s [F[scheme][URL scheme]] is [CODE(URI)@en[https]]:
== [40] If [VAR[url]]'s [F[port]] is [[null]]:
=== [39] Let [VAR[target]] be [VAR[url]]'s [F[host]].
== [41] Otherwise:
=== [42] Let [VAR[target]] be [VAR[url]]'s [F[host]], followed by [CODE[:]],
followed by [VAR[url]]'s [F[port]], [[serialized][serialize an integer]].
== [52] Let [VAR[http]] be a new [[HTTP client][HTTP接続の処理]] whose
[F[transport]] is [VAR[connection]].
== [53] Set [VAR[connection]] to the result of
[[establishing an HTTP [CODE(HTTP)[CONNECT]] connection][下位層の接続]]
with [VAR[http]] and [VAR[target]].
@@ and proxy credentials
== [38] If [VAR[connection]] is a [[failure]] whose HTTP response's [F[status]] is
[CODE[409]]:
=== 
@@ Show proxy auth dialog
= [67] Otherwise:
== [68] Set [VAR[request mode]] to ''HTTP proxy''.
]FIG]
: [CODE[socks4]] :
@@
: [CODE[socks5]] :
@@
]FIG]
== [20] If [VAR[connection]] is not a [[failure]]:
=== [13] If [VAR[url]]'s [F[scheme][URL scheme]] is [CODE(URI)@en[https]]:
==== [37] Set [VAR[connection]] to the result of running the [[TLS steps]] for
[VAR[connection]] and [VAR[url]]'s [F[host]].
== [69] If [VAR[connection]] is not a [[failure]]:
=== [70] Set [VAR[connection]]'s [F[request mode]] to [VAR[request mode]].
=== [65] Return [VAR[connection]] and abort these steps.
= [9] Return a [[failure]].
]FIG]

[59] The [DFN[effective port]] of [VAR[url]] is the value returned by these steps:
[FIG(steps)[
= [33] Let [VAR[port]] be [VAR[url]]'s [F[port]].
= [18] If [VAR[port]] is [[null]]:
== [21] Set [VAR[port]] to the value determined by the [VAR[url]]'s [F[scheme][URL scheme]]:
[FIG(switch)[
: [CODE(URI)@en[ftp]] : [N[21]]
: [CODE(URI)@en[http]] : [N[80]]
: [CODE(URI)@en[https]] : [N[443]]
]FIG]
= [60] Return [VAR[port]].
]FIG]

[32] To [DFN[establish a TCP connection]] to [VAR[addr]] and [VAR[port]],
run these steps:
[FIG(steps)[
= [16] Let [VAR[connection]] be a [[TCP]] connection to [VAR[addr]] and [VAR[port]].
= [19] If [VAR[connection]] is ''not'' a [[failure]]:
== [24] Disable the [CODE[SO_OOBINLINE]] option of [VAR[connection]].
== [22] Enable the [CODE[SO_NODELAY]] option of [VAR[connection]].
== [27] Run the [[TCP keep alive steps]] for [VAR[connection]].
= [17] Return [VAR[connection]].
]FIG]

[30] The [DFN[TLS steps]] for [VAR[connection]] and [VAR[url]] is:
[FIG(steps)[
@@
]FIG]

@@
[5] To [DFN[run a PAC file]] with [VAR[pac]] and [VAR[url]], ...

[8] The steps to [[run a PAC file]] return zero or more [[proxy configurations][proxy configuration]].
A [DFN[proxy configuration]] is a tuple of ([DFN[protocol]], [DFN[host]], [DFN[port]]).

[11] The [[proxy configuration]]'s [F[protocol]] is one of:
[CODE[direct]],
[CODE[http]],
[CODE[https]],
[CODE[socks4]], and
[CODE[socks5]].

@@
[45] To [DFN[wait for other connections]] with [VAR[host]] and [VAR[port]],
run steps in [[WebSocket接続を得る]].

[48] The [DFN[name resolution]] of [VAR[host]] is to run these steps:
[FIG(steps)[
= [49] If [VAR[host]] is a [[domain]]:
== [15] Return the result of applying [[name resolution]] to [VAR[host]].
= [50] Otherwise:
== [51] Return [VAR[host]].
]FIG]

;; [57] These steps return an [[IPv4 address]], an [[IPv6 address]],
or an [[error]].

[28] The [DFN[TCP keep alive steps]] for [VAR[connection]] is a set of implementation
dependent steps.  An example of such steps is:
[FIG(steps)[
= [23] Enable the [CODE[SO_KEEPALIVE]] option of [VAR[connection]].
= [25] Set [CODE[TCP_KEEPIDLE]] option of [VAR[connection]] to 45 (seconds).
= [26] Set [CODE[TCP_KEEPINTVL]] option of [VAR[connection]] to 45 (seconds).
]FIG]