* 仕様書

[REFS[
- [11] [CITE@en[DOM Standard]] ([TIME[2016-04-22 01:14:08 +09:00]] 版) <https://dom.spec.whatwg.org/#shadow-tree-slots>
- [25] [CITE@en[DOM Standard]] ([TIME[2016-04-22 01:14:08 +09:00]] 版) <https://dom.spec.whatwg.org/#light-tree-slotables>
- [42] [CITE@en[DOM Standard]] ([TIME[2016-04-22 01:14:08 +09:00]] 版) <https://dom.spec.whatwg.org/#finding-slots-and-slotables>
- [73] [CITE@en[DOM Standard]] ([TIME[2016-04-22 01:14:08 +09:00]] 版) <https://dom.spec.whatwg.org/#assigning-slotables-and-slots>
]REFS]

* スロット

[13] [[スロット]]は、 [CODE(HTMLe)@en[slot]] [[要素]]です [SRC[>>11]]。

[12] [[影木]]は、[[スロット]]をいくつか持つことがあります [SRC[>>11]]。

[4] [DFN[[RUBYB[既定スロット]@en[default slot]]]]は、
[[影木]]中、[F[名前][スロット名]]が[[空文字列]]の[[スロット]]のうち[[木順]]で最初のものです
[SRC[>>11]]。

[14] [[スロット]]は、次の状態を持ちます。
[FIG(list members)[
: [DFN[[F[[RUBYB[[[名前][スロット名]]]@en[name]]]]]] :
[[既定値]]は、[[空文字列]]です。 [SRC[>>11]]
[CODE(HTMLa)@en[name][<slot name>]] [[属性値]]となります。
: [DFN[[F[[RUBYB[割り当て済み節点群]@en[assigned nodes]]]]]] :
[[スロット可能]]の[[リスト]]です。[[既定値]]は、空です。 [SRC[>>11]]
]FIG]

[15] [[属性変更手順群]]は、次のようなものです [SRC[>>11]]。
[FIG(steps)[
= [16] 次の条件のすべてを満たす場合:
[FIG(list)[
- [18] [VAR[要素]]が [CODE(HTMLe)@en[slot]]
- [17] [VAR[局所名]]が [CODE(HTMLa)@en[name][<slot name>]] で[VAR[名前空間]]が [[null]]
- [19] 次のいずれかではない:
-- [VAR[値]]が[VAR[古い値]]と等しい
-- [VAR[値]]が [[null]] で[VAR[古い値]]が[[空文字列]]
-- [VAR[値]]が[[空文字列]]で[VAR[古い値]]が [[null]]
]FIG]
== [20] [VAR[値]]が [[null]] や[[空文字列]]なら、
=== [21] [VAR[要素]]の[F[名前][スロット名]]を、[[空文字列]]に設定します。
== [22] それ以外なら、
=== [23] [VAR[要素]]の[F[名前][スロット名]]を、[VAR[値]]に設定します。
== [24] [VAR[要素]]の[F[木]]について、[[木のスロット可能群を割り当て]]します。
]FIG]

* スロット可能

[26] [DFN[[RUBYB[スロット可能]@en[slotable]]]]は、
[CODE(DOMi)@en[Element]] と [CODE(DOMi)@en[Text]] です [SRC[>>25]]。

[27] [[スロット]]も[[スロット可能]]です [SRC[>>25]]。

;; [41] [[スロット]]も[[スロット可能]]も共に同名の「[F[名前][スロット名]]」
を持ちますが、両者は別の内部状態と思われます。

[28] [[スロット可能]]は、次の状態を持ちます。
[FIG(list members)[
: [DFN[[F[[RUBYB[[[名前][スロット名]]]@en[name]]]]]] :
[[既定値]]は、[[空文字列]]です。 [SRC[>>25]]
[[要素]]では [CODE(HTMLa)@en[slot]] [[属性値]]となります。
[[テキスト節点]]では常に[[空文字列]]となります。
: [DFN[[F[[RUBYB[[[割り当て済みスロット]]]@en[assigned slot]]]]]] :
[[スロット]]または [[null]]。[[既定値]]は [[null]] です。 [SRC[>>25]]
: [DFN[[F[[RUBYB[[[割り当て済み]]]@en[assigned]]]]]] :
[F[割り当て済みスロット]]が [[null]] でないことをいいます [SRC[>>25]]。
]FIG]

[29] [[属性変更手順群]]は、次のようなものです [SRC[>>25]]。
[FIG(steps)[
= [30] 次の条件のすべてを満たす場合:
[FIG(list)[
- [31] [VAR[局所名]]が [CODE[slot]] で[VAR[名前空間]]が [[null]]
- [32] 次のいずれかではない:
-- [VAR[値]]が[VAR[古い値]]と等しい
-- [VAR[値]]が [[null]] で[VAR[古い値]]が[[空文字列]]
-- [VAR[値]]が[[空文字列]]で[VAR[古い値]]が [[null]]
]FIG]
== [33] [VAR[値]]が [[null]] や[[空文字列]]なら、
=== [34] [VAR[要素]]の[F[名前][スロット名]]を、[[空文字列]]に設定します。
== [35] それ以外なら、
=== [36] [VAR[要素]]の[F[名前][スロット名]]を、[VAR[値]]に設定します。
== [37] [VAR[要素]]が[F[割り当て済み][割り当て済みスロット]]なら、
=== [38] [VAR[要素]]の[F[割り当て済みスロット]]について、[[スロット可能の割り当て]]をします。
== [39] それ以外なら、
=== [40] [VAR[要素]]について[[スロットの割り当て]]をします。
]FIG]

* 探す

[43] [VAR[スロット可能]]、[VAR[開き]]フラグ ([[既定値]]は未設定)
について[DFN[[RUBYB[スロットを探す]@en[find a slot]]]]には、次のようにします [SRC[>>42]]。
[FIG(steps)[
= [44] 次のいずれかを満たすなら:
[FIG(list)[
- [55] [VAR[スロット可能]]の[F[親][parentNode]]が [[null]]
- [45] [VAR[スロット可能]]の[F[親][parentNode]]の[F[影根]]が [[null]]
- [46] [VAR[開き]]フラグが設定されていて、
[VAR[スロット可能]]の[F[親][parentNode]]の[F[影根]]の[F[モード][影根]]が [CODE[open]] ''以外''
- [47] [VAR[スロット可能]]の[F[親][parentNode]]の[F[影根]]の[F[木]]に、
[F[名前][スロット名]]が[VAR[スロット可能]]の[F[名前][スロット名]]である[[スロット]]がない
]FIG]
== [48] [[null]] を返します。
= [53] それ以外なら、
== [54] [VAR[スロット可能]]の[F[親][parentNode]]の[F[影根]]の[F[木]]の、
[F[名前][スロット名]]が[VAR[スロット可能]]の[F[名前][スロット名]]である最初の[[スロット]]を返します。
]FIG]

[49] [VAR[スロット]]について[DFN[[RUBYB[スロット可能群を探す]@en[find slotables]]]]には、
次のようにします [SRC[>>42]]。
[FIG(steps)[
= [50] [VAR[結果]]を、空のリストに設定します。
= [51] [VAR[スロット]]の[F[根]]が[[影根]]なら、
== [57] [VAR[スロット]]の[F[根]]の[F[ホスト][ホスト (DOM)]]の[[子供]]の[[スロット可能]][VAR[スロット可能]]について、[[木順]]に、
=== [59] [VAR[見つかったスロット]]を、[VAR[スロット可能]]について[[スロットを探す]]を実行した結果に設定します。
=== [60] [VAR[見つかったスロット]]が[VAR[スロット]]なら、
==== [61] [VAR[結果]]の末尾に[VAR[見つかったスロット]]を追加します。
= [62] [VAR[結果]]を返します。
]FIG]

[52] これはつまり、
[FIG(list)[
- [[影木]]外の[[スロット]]では、[[空]]になります。
- [[木順]]で前に同名の[[スロット]]があれば、[[空]]になります。
- [VAR[スロット]]の [CODE(HTMLa)@en[name][<slot name>]] [[属性]]が無指定または[[空文字列]]なら、
[F[ホスト][ホスト (DOM)]]の[[子要素]]で [CODE(HTMLa)@en[slot]] [[属性]]が無指定または[[空文字列]]のものと、
[[テキスト節点]]が[[木順]]で含まれます。
- [VAR[スロット]]の [CODE(HTMLa)@en[name][<slot name>]] [[属性]]が空でない[[文字列]]なら、
[F[ホスト][ホスト (DOM)]]の[[子要素]]で [CODE(HTMLa)@en[slot]] [[属性]]がそれと一致するものが[[木順]]で含まれます。
]FIG]

[56] [VAR[スロット]]について[DFN[[RUBYB[平坦化されたスロット可能群を探す]@en[find flattened slotables]]]]には、次のようにします [SRC[>>42]]。
[FIG(steps)[
= [58] [VAR[結果]]を、空のリストに設定します。
= [63] [VAR[スロット可能群]]を、[VAR[スロット]]について[[スロット可能群を探す]]を実行した結果に設定します。
= [64] [VAR[スロット可能群]]が空なら、
== [65] [VAR[スロット可能群]]に[VAR[スロット]]の[[子供]]の[[スロット可能]]を[[木順]]で追加します。
= [66] [VAR[スロット可能群]]の各[[節点]]について順に、
== [67] [VAR[節点]]が[[スロット]]なら、
=== [68] [VAR[結果]]の末尾に[VAR[節点]]について[[平坦化されたスロット可能群を探す]]を実行した結果に含まれるものを追加します。
== [69] それ以外なら、
=== [70] [VAR[結果]]の末尾に[VAR[節点]]を追加します。
= [71] [VAR[結果]]を返します。
]FIG]

[72] つまり[[スロット可能群を探す]]処理を更に拡張したもので、
最終結果に[[スロット]]がなくなるまで再帰的に処理すると共に、
[[スロット可能]]が見つからない時には[[スロット]]の[[子供]]をかわりに利用します。

* 割り当てる

[74] [VAR[スロット]]と[VAR[信号抑制フラグ]] (既定値は未設定) について[DFN[[RUBYB[スロット可能群を割り当て]@en[assign slotables]]]]するには、
次のようにします [SRC[>>73]]。
[FIG(steps)[
= [75] [VAR[スロット可能群]]を、[VAR[スロット]]について[[スロット可能群を探す]]を実行した結果に設定します。
= [76] [VAR[信号抑制フラグ]]が設定されておらず、
[VAR[スロット可能群]]と[VAR[スロット]]の[F[割り当て済み節点群]]が異なるなら、
== [77] [VAR[スロット]]について[[スロット変更を信号]]します。
== [78] [VAR[スロット]]の[F[割り当て済み節点群]]を、[VAR[スロット可能群]]に設定します。
= [79] [VAR[スロット可能群]]の各[VAR[スロット可能]]について、
== [80] [VAR[スロット可能]]の[F[割り当て済みスロット]]を、[VAR[スロット]]に設定します。
]FIG]

;; [90] [[属性変更手順群]] (>>29) と[[削除][削除 (DOM)]]から呼び出されます。
>>81 および >>84 からも呼び出されます。

[81] [VAR[木]]と[VAR[信号しないスロット群]] (既定値は空のリスト)
に関して[DFN[[RUBYB[木についてスロット可能群の割り当て]@en[assign slotables for a tree]]]]には、
次のようにします [SRC[>>73]]。
[FIG(steps)[
= [82] [VAR[木]]の各[[スロット]][VAR[スロット]]について、[[木順]]に、
== [83] [VAR[スロット]]について、[[スロット可能群の割り当て]]を実行します。
[VAR[信号抑制フラグ]]は、[VAR[スロット]]が[VAR[信号しないスロット群]]に含まれるか否かに設定します。
]FIG]

;; [89] [[属性変更手順群]] (>>15) の他、[[挿入]]や[[削除][削除 (DOM)]]から呼び出されます。

[84] [VAR[スロット可能]]について[DFN[[RUBYB[スロットの割り当て]@en[assign a slot]]]]は、
次のようにします [SRC[>>73]]。
[FIG(steps)[
= [85] [VAR[スロット]]を、[VAR[スロット可能]]について[[スロットを探す]]を実行した結果に設定します。
= [86] [VAR[スロット]]が [[null]] でなければ、
== [87] [VAR[スロット]]について[[スロット可能群の割り当て]]を実行します。
]FIG]

;; [88] [[属性変更手順群]] (>>29) の他、[[挿入]]から呼び出されることもあります。

* 歴史

[1] [CITE@en[Shadow: define slots and slotables · whatwg/dom@a2b04df]]
([TIME[2016-03-24 21:51:28 +09:00]] 版)
<https://github.com/whatwg/dom/commit/a2b04df51b4342d7617c128e80e5aa892889d2e0>

[2] [CITE@en[Shadow: define assignedSlot of Element and Text · whatwg/dom@b8e1ccf]]
([TIME[2016-03-24 21:54:25 +09:00]] 版)
<https://github.com/whatwg/dom/commit/b8e1ccf857b6ac483f708336dff4b7ee48393191>

[3] [CITE@en[Shadow: define superglobal slot content attribute · whatwg/dom@e3d8291]]
([TIME[2016-03-24 21:56:23 +09:00]] 版)
<https://github.com/whatwg/dom/commit/e3d82914676ad1e1bf590e1042636e60feddb6ae>

[5] [CITE@en[Editorial: mention that step="" conformance requirements are out of s… · whatwg/dom@e996bdc]]
([TIME[2016-03-24 22:00:10 +09:00]] 版)
<https://github.com/whatwg/dom/commit/e996bdc52ef951113d2a6edc43828ec2dba23e83>

[6] [CITE@en[The DOM Standard defines the class, id, and slot attributes · whatwg/html@36c9938]]
([TIME[2016-03-24 22:01:06 +09:00]] 版)
<https://github.com/whatwg/html/commit/36c9938b102fecadf6029a248f40aae83ea099d2>

[7] [CITE@en[Shadow: define slotchange event · whatwg/dom@81566a3]]
([TIME[2016-04-20 12:29:10 +09:00]] 版)
<https://github.com/whatwg/dom/commit/81566a31a393d6fc07332f92a2a5d551dc7c96bd>

[8] [CITE@en[Editorial: distributed -> flattened · whatwg/dom@e35b570]]
([TIME[2016-04-20 12:32:04 +09:00]] 版)
<https://github.com/whatwg/dom/commit/e35b5706252b99f69a836e82e6ae9ebc76cdb2c7>

[9] [CITE@en[Editorial: add "shadow host" and "assigned" as terms · whatwg/dom@8ae8749]]
([TIME[2016-04-21 12:47:20 +09:00]] 版)
<https://github.com/whatwg/dom/commit/8ae87496beb249925a3a72cf62aee9987e3620eb>

[10] [CITE@en[Shadow: <slot> is now defined in HTML · whatwg/dom@fdad8cb]]
([TIME[2016-04-22 17:45:48 +09:00]] 版)
<https://github.com/whatwg/dom/commit/fdad8cb90a78b399cd2bdf5a20c1960649697462>