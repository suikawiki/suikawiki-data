[4] [[スクリプト]]は、[[利用者]]または[[利用者エージェント]]により、
実行途中で中断されることがあります。

* 仕様書

[REFS[
- [49] '''[CITE@en-US-x-hixie[HTML Standard]] ([TIME[2014-04-03 03:44:44 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#killing-scripts>'''
- [21] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-02-24 02:49:49 +09:00]] 版) <https://html.spec.whatwg.org/#processing-model-10:abort-a-running-script-2>
- [14] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-02-24 02:49:49 +09:00]] 版) <https://html.spec.whatwg.org/#kill-a-worker>
- [26] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2017-06-01 07:29:23 +09:00]]) <https://html.spec.whatwg.org/#run-a-module-script>
]REFS]

* 資源制限

[52] [[利用者エージェント]]は、[[スクリプト]]に対して[[資源]]の制限を課して[['''構いません''']]。
例えば、[[CPU]] [[quota]]、[[メモリー]]の制限、合計実行時間の制限、[[帯域]]の制限などを課すことができます。 [SRC[>>49]]

[53] [[スクリプト]]が制限を超えた時は、 [CODE(DOMc)@en[[[QuotaExceededError]]]] [[例外]]を[[投げる]]か、
[[走っているスクリプトを中断]]するか、[[利用者]]に確認するか、[[スクリプト]]の実行に[RUBYB[[[絞り弁]]]@en[throttele]]を適用するかして[['''構いません''']]。
[SRC[>>49]]

[13] [[ワーカー]]は、そもそも時間がかかったり高い負荷が予想されたりする処理のためのものなので、
より緩い制約とするべきかもしれません。

[15] [[利用者エージェント]]は、[[ワーカー]]が制限に達したら、
[[ワーカーを殺す]]処理を実行して構いません [SRC[>>14]]。

;; [63] [[ハードウェア等の制約に関する条項]]も参照。

** スクリプト中断ダイアログ

[9] 多くの [[Webブラウザー]]は、資源制限に達した (あるいは達しそうな) ときに、
[[利用者]]にそのまま処理を継続するか、
[[走っているスクリプトの中断]]をするかの判断を求める
([[モーダル]]でない) [[ダイアログ]]を表示します。

[10] この[[ダイアログ]]は、[[利用者]]が指示を出すか、状況が解消したら、閉じられます。

[11] 処理に時間がかかったり、 [[CPU]] 資源を多く消費したりすることが予測される[[スクリプト]]の[[著者]]は、
[CODE[[[setTimeout]]]] などを使って処理を分割するのが普通です。
([[タスク]]ごとに実行される[[スクリプト]]の実行時間から[[ダイアログ]]を出すか判断しているので、
複数の[[タスク]]に分割できれば回避できます。)

[12] [[ダイアログ]]が出るほど長い時間を費やすような[[スクリプト]]は、
[[Web互換]]でないというほどではありませんが、 ([[ダイアログ]]で[[利用者]]を煩わせるという意味で、
あるいはそもそも負荷により[[利用者]]の操作を妨害するという意味で)
[[利用者]]に良い経験を提供できないものといえます。

[16] [[利用者エージェント]]は、[[利用者]]が[[ワーカーを殺す]]よう指示する手段を提供できます
[SRC[>>14]]。

* スクリプトの無効化

[51] [[閲覧文脈]]は[[スクリプトが有効]]、[[スクリプトが無効]]の状態を有しており、
[[利用者エージェント]]の対応状況、[[利用者]]の設定、[[著者]]の指定によってどちらであるかが決定します。
[[スクリプトが無効]]の場合、[[スクリプト]]が作成されなかったり、[[スクリプト]]の実行が実際の内容に関わらず
「何もしない」となったり (>>28) します。詳しくは[[スクリプトが無効]]の項をご覧ください。

[54] [[スクリプト]]の実行中に[[スクリプト]]が無効になったときは、ただちに[[スクリプト]]を終端する[['''べきです''']]
[SRC[>>49]]。

* 閲覧文脈、文書の中断

[19] [[利用者エージェント]]は、
[[閲覧文脈]]を閉じるに当たり[[スクリプトを無効]]とする手段を[[利用者]]に提供できます
[SRC[>>49]]。[[スクリプトが無効]]となると、実行中の[[スクリプト]]は中断されるので (>>54)、
言い換えると、[[閲覧文脈]]を閉じる時に実行中の[[スクリプト]]があっても停止させることができます。

[17] 明文規定はありませんが、
[[navigate]] によって現在の[[文書]]の表示を破棄する際に、
[[走っているスクリプトの実行中断]]が行われる可能性があります。

-*-*-

[31] 
[[プラットフォーム]] ([[OS]]) や[[Webブラウザー]]の仕様により、
スリープ状態や[[アプリ]]の切り替えなどで[[窓ごと破棄されたり][閲覧文脈を捨てる]]、
[[タイマーが中断][setInterval]]されたりすることがあります。

[32] 
いろいろな条件に左右されますし、観測しようとすることで挙動が変化する場合も想定されるので、
あくまで参考程度に。


[33] 
[[Android]] の [[Chrome]] で [CODE[setTimeout]]
で数秒おきにサーバーにデータを送信させ、
放置してスリープ状態になるのを待つと、
1回目の試行では約2分半後に停止しており復帰させると [[Chrome]] は停止していました。
2回目の試行では約4分後に停止しており復帰させると [[Chrome]] で当該ページが開いた状態で未実行だった
[CODE[setTimeout]] も実行されました。
[TIME[2020-04-15T02:39:53.000Z]]

[34] 
[[iPhone]] の [[Safari]] 
で同じように試すと、
スリープ直後に停止しており復帰させると [[Safari]]
で当該ページが開いた状態に復帰します。
[CODE[setTimeout]] のタイマーがスリープ時間分一気に進むのか、
[CODE[setTimeout]] で数秒待って送信して、の繰り返しが数回分一気に走ります。
(使っているのは [CODE[setInterval]] ではない。)
他の[[アプリ]]に切り替えている時、
[[Safari]] の他の[[タブ]]に切り替えている時も同じように動作します。
[TIME[2020-04-15T04:58:06.700Z]]


[35] 
[[Android]] の [[Chrome]] も [[iPhone]] の [[Safari]]
も、
[CODE[audio][<audio>]]
再生中は中断を回避できます。

[36] 
しかし [[Safari]] は他の[[アプリ]]次第でバックグラウンドでの再生が停止してしまいます。
[[Safari]] に切り替えると元の状態が復元されますが、再生停止されたものは戻らないようです。


* ワーカーの中断

[68] [[ワーカー]]については、[[ワーカーを殺す]]手順、
[[ワーカーを終端させる]]手順が規定されています。
両者は[[走っているスクリプトの実行中断]]を呼び出します。

;; それぞれの項を参照。

[18] [[ワーカーを終端させる]]手順は、 [CODE(DOMm)@en[[[terminate]]]]
[[メソッド]]によって[[ワーカー]]の作成元の[[スクリプト]]から呼び出されることがあります。

[23] [[サービスワーカーを終端させる]]手順も参照。

* 走っているスクリプトの実行中断

[5] [[JavaScript]] の [CODE[[[ScriptEvaluation]]]] 
([[古典スクリプトの実行]]から呼び出されます。) や
[CODE[[[Evaluation]]]]
([[モジュールスクリプトの実行]]から呼び出されます。)
は、[DFN[[RUBYB[[[走っているスクリプトの実行中断]]]@en[abort a running script]]]]
[SRC[>>49]] により、結果を返さずに途中で中断されることがあります。

[7] 中断された場合、[[JavaScript実行文脈スタック]]を空にします。
[CODE[[[finally]]]] があっても実行しません。 [SRC[>>49]]

[6] これは [[HTML Standard]] では規定されていますが、
[[JavaScript]] の仕様書では明文化されていません [SRC[>>49]]。

[20] [[コールバック関数の呼び出し]]や[[JavaScriptジョブの実行]]も、
同様に中断される可能性があります。

;; これはまだ明文化されていないようです (>>21 で言及はされていますが)。

[27] 
[[モジュールスクリプトの実行]]で [CODE[ModuleEvaluation]]
が[[走っているスクリプトの実行中断]]となった場合、
次の値を返します [SRC[>>26]]。

[FIG(list members)[ [28] [CODE[Completion]]
: [F(ss)[Type]] : [CODE[throw]]
: [F(ss)[Value]] : 新しい [CODE[QuotaExceededError]] [CODE(DOMi)@en[DOMException]]
: [F(ss)[Target]] : [[空]]
]FIG]

[8] [[Gecko]] ではこれは [CODE[[[catch]]]] できない
([CODE[[[finally]]]] も実行されない) 特別な[[例外]]として実装されているようです。

[24] 中断は [[handle fetch]] や [[Install]] に影響を与えることがあります。

* 歴史

[3] [[ブラクラ]]のような悪意ある[[スクリプト]]の濫用や、
悪意がなくても [[Webブラウザー]]や[[OS]]の動作を不安定にする
[[JavaScript]] [[アプリケーション]]から[[利用者]]を守るため、
00年代半ば頃から徐々に[[スクリプト]]の実行中断機能が [[Webブラウザー]]に実装されるようになってきました。

** HTML5

[58] [[スクリプト]]を実行途中で実行時間の長さなどを根拠に中断しても良いことは [[HTML5]]
で明文化されました。

** 2016年改訂

[2] 2016年2月には、更に明確化が行われました。

[1] [CITE@en[Fix #715: clarify how aborting a running script works · whatwg/html@6a48bfb]] ([TIME[2016-02-24 14:40:25 +09:00]] 版) <https://github.com/whatwg/html/commit/6a48bfbf1066034eab4786d62ba4017593c48430>

[FIG(quote)[
[FIGCAPTION[
[22] [CITE@ja[Web ビュー]]
([[Jwmsft]]著, [TIME[2017-01-20 14:47:14 +09:00]])
<https://msdn.microsoft.com/ja-jp/windows/uwp/controls-and-patterns/web-view>
]FIGCAPTION]

> スクリプトを実行中にアプリが応答しないような場合があったとします。 すると、Web ビューが JavaScript 実行中に LongRunningScriptDetected イベントが発生し、スクリプトを中断する機会を提供します。 スクリプトがどれくらいの時間、実行されているのかを見るには、WebViewLongRunningScriptDetectedEventArgs の ExecutionTime プロパティを確認します。 スクリプトを停止するには、イベント引数の StopPageScriptExecution プロパティを true に設定します。 停止されたスクリプトは、以降の Web ビューのナビゲーションでもう一度読み込まれるまで、実行されません。

]FIG]


[25] [CITE[The WHATWG Blog — HTML and shared memory]]
([TIME[2017-05-02 09:07:06 +09:00]])
<https://blog.whatwg.org/html-and-shared-memory>

[29] [CITE@en[Fix error cases of <script type=module>]]
([[domenic]]著, [TIME[2017-05-13 01:50:49 +09:00]])
<https://github.com/whatwg/html/commit/115763124a641e8814665c5014d28155f95ff441>

[30] [CITE@en[Improve module instantiation/evaluation, especially around errors]]
([[domenic]]著, [TIME[2017-08-04 05:13:45 +09:00]])
<https://github.com/whatwg/html/commit/2b408b65a11fe76b6588b744e0ae74d30ff29b43>