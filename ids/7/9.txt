

[CODE(WikiPage)[[[Refresh]]]] がごちゃごちゃしてきているので全面改訂しようと思って途中まで書いたのですけど、
忙しくて手が回らなくなったのでとりあえず放出。


* Refresh: 欄 (HTTP)

[1] [[HTTP]] の[[応答]]で使われる [DFN[[CODE(HTTP)[Refresh:]] 頭欄]]は、
[[WWWブラウザ]]で表示した頁を更新 (再読込み) することを指示します。

欄の内容には、再読込みするまでの秒数を指定します。
また、再読込みする [[URI]] を指定することもできます。
これを使うと、現在表示している頁とは異なる頁を一定秒数後に表示できます。

[n]
この欄は、 HTTP の頭欄として使用するほか、手軽な代替手段として、
[[HTML]] の [CODE(HTMLe)[[[meta]]]] 要素の [CODE(HTMLa)[[[http-equiv]]]]
属性の値を [CODE(HTTP)[Refresh]] として非常によく使われています。

[73] 仕様書:
- [[HTML 4.0]]
-- [CITE[[CODE(HTMLe)[META]] and HTTP headers]]
<IW:HTML4:"struct/global.html#h-7.4.4.2">
-- 単なる例示程度で、正式な規定ではありません。
-- HTML 4.01 では削除されています。
- [[HTML 4.01]]
-- [CITE[HTML 4 Changes]]
<IW:HTML4:"appendix/changes.html#h-A.1.1.5">

[[#comment]]


** 歴史

[n]
この欄は、 [[NN2]] で当時流行の[[プッシュ]]技術の初等的技法の一つとして導入され、
多くの実装がそれに続きました。しかし、公式な [[HTTP]] 仕様では一時は検討されたものの、
結局取込まれるにはいたっていません。また、 [[HTML 4.0]] の仕様書で例として取上げられました
[SRC[HTML 4.0 7.4.4.2]] が、
[[HTML 4.01]] ではその部分が削除されています [SRC[HTML 4.01 A.1.1.5]]
(鯖側で [CODE(HTTP)[[[Location]]:]] などにより[[再指向]]するのが好ましいとされています)。

このように [CODE(HTTP)[Refresh]] 欄は公式な仕様に含まれないものであり、
構文や意味の解釈に揺れがあります。また、 [CODE(HTTP)[Refresh]]
欄の提供する表示の自動更新という機能自体に、
使いやすさ・わかりやすさなどの面から好ましくないという意見が少なからずあります。

したがって、 [CODE(HTTP)[Refresh]] 欄はできるだけ使用せず、
どうしても使用する場合には技術的その他の問題が生じないように十分に注意する必要があります。

[[#comment]]


** 構文


*** 基本構文

[n]
[CODE(HTTP)[Refresh]] 欄についての参照するべき仕様書は、
提案者の [[Netscape]] による説明文 (>>[n]) です。
そこでは、実例と自然言語文によって [CODE(HTTP)[Refresh]]
の構文が説明されています。しかし、残念ながら [[BNF]]
などによる厳密な規定はありません。

Netscape の説明を素直に解釈して文法を推定すると、
次の [[ABNF]] 式で表せます。

- [CODE(ABNF)[[DFN[Refresh-body]] := refresh-after [url-param] ]]
- [CODE(ABNF)[[DFN[refresh-after]] := 1*[[DIGIT]]]]
- [CODE(ABNF)[[DFN[url-param]] := "; URL=" [[absoluteURL]] ]]

ここで、 [CODE(ABNF)[refresh-after]] は、再読込みするまでの秒数を表します。
零なら、読込み後すぐに読みなおします。

[CODE(ABNF)[url-param]] を指定すると、その [[URL]]
の文書を読込みます。省略した場合は、自分自身を読込みます。
なお、読込んだ新しい頁にも [CODE(HTTP)[Refresh]]
指定があれば、更に飛ばされることになります。

[CODE(HTTP)[URL]] の部分で大文字・小文字の区別がされるのか否かは明記されていません。
実際には大文字でも小文字でも NN は認識してくれますし、
多くの実装もそうでしょう。小文字で使っている文書も多々あります。

URL は、[[絶対URL]] と指定されています。
[[素片識別子]]には触れられていません。

[[#comment]]


*** 引数の構文

[n]
さて、 >>[n] の構文は仕様書にあることをそのまま表現したものですが、
実装や使用状況や他の HTTP プロトコル要素との整合性から、
少々修正していきましょう。

- [CODE(ABNF)[[DFN[Refresh-body]] := refresh-after [url-param] ]]
- [CODE(ABNF)[[DFN[refresh-after]] := [FWS] 1*DIGIT [FWS] ]]
- [CODE(ABNF)[[DFN[url-param]] := ";" [FWS] "URL" [FWS] "=" [FWS] url-param-value [FWS] ]]

まず、一般に[[空白]] ([CODE(ABNF)[[[FWS]]]]) 
を自由に入れられることになっているところはそのようにしてみました。

[CODE(HTTP)[URL]] 引数の値 ([CODE(ABNF)[url-param-value]])
ですが、これには少々問題があります。といいますのは、
Netscape の説明によると、ここには絶対 URI が入ります。
ところが、絶対 URI では [[scheme]] 名の後に必須の [CODE(URI)[:]]
をはじめとして、本来引数の値として生で来てはいけないはずの文字が含まれます。
そのような場合には、引用符でくくった [CODE(ABNF)[[[quoted-string]]]]
としなければならないのです。

ところが、引用符で括ることに対応していない実装が多々ありました。
(Netscape の仕様にはどこにもそんなことは書いてないですから、仕方ないですね。)
[[Cookie]] [WEAK[(こちらも Netscape の提案。)]] 
の引数の引用符にも同じ問題がありますが、
あちらは引用符なしで突っ走ってしまいました。ところが、
[CODE(HTTP)[URL]] ではそうもいきません。 URI では、
引数の区切子として使っている [CODE(URI)[;]] が正当な文字として使えます。
ということは、引用符で括らないと、少なくても [CODE(URI)[;]]
を使った URI で問題になります。
(Netscape Navigator 2 の時代にはほとんど問題はなかったのでしょうが、
現在は [CODE(ABNF)[[[query]]]] を [CODE(URI)[;]]
で区切る鯖側スクリプトの類が増えていますから、たまに問題が起こります。)
([CODE(HTTP)[Refresh]] 欄には [CODE(HTTP)[URL]] しか引数がないのですから、
割り切ってしまえばよいのですが... そのような実装がある一方で、
[CODE(HTTP)[;]] で URI は終わりとみなす実装もあります。)

現在では、主要な実装は引用符つきに対応しているようです。
しかし、 [CODE(ABNF)[quoted-string]] では [CODE(ABNF)[[[quoted-pair]]]]
が認められることになりますが、これまで対応している実装がどれだけあるかは未知数です。

[n]
[CODE(HTTP)[Refresh]] 欄は HTML の [CODE(HTMLe)[meta]]
要素でよく使われますが、その際に [CODE(HTMLa)[[[content]]]]
属性そのものの区切りは、たいてい二重引用符です。
そうすると、 [CODE(HTTP)[URL]] 引数の値の方の引用符は
[CODE(HTML)[&[[quot]];]] などと escape して書かないといけません。

そこで、アポストロフィを二重引用符の代わりに使う人がいるようです。
HTML の属性の引用符はそれでもよいのですが、 HTTP
の方はさすがにそれではまずいです。アポストロフィは [CODE(ABNF)[[[token]]]]
に使える文字なので。

[[#comment]]


*** URL 引数値

[n] [CODE(HTTP)[URL]] 引数の値は、 Netscape は絶対 URI
と説明しています。しかし、実際には、 NN を含めた多くの実装が[[相対URI]]
での指定に対応しています。また、[[素片識別子]]つきの [[URI参照]]一般に
(空の URI + 素片識別子、すなわち自分自身内での参照も含めて)
対応している実装が多いようです。


[76]
11
([[名無しさん]] [WEAK[2004-12-06 09:32:36 +00:00]])


[[#comment]]


** アクセス可能性・可用性

[74] [CODE(HTTP)[Refresh]] 機能は、ウェブ・サイトの移転のメッセージやある種の効果
(謎) を出すためにしばしば用いられます。しかし、 [CODE(HTTP)[Refresh]]
に対応していない [[UA]] もありますから、[[著者]]は、
[CODE(HTTP)[Refresh]] 付きの頁に飛び先の文書へ誘導する内容を含めるべきです
[SRC[HTML 4.0 7.4.4.2]]。

[75] [CODE(HTTP)[Refresh]] による自動移動機能は、
[[利用者]]が内容を十分確認する前にその意図に反して飛ばされてしまったり、
逆に[Q[自動的に飛びます]]のようなメッセージが記されているのに間隔が長過ぎてイライラしたり、
[[WWWブラウザ]]の機能 ([Q[戻る]]など) と折り合いが悪かったり、
兎角利用者に不快感を与える結果となりがちです。
このような問題は [CODE(HTTP)[Refresh]] 
の機能的限界と著者の洞察の不十分さに起因するものであり、
回避することは容易ではありません。

ですから、著者はできるだけ [CODE(HTTP)[Refresh]] の仕様を避け、
どうしても使用する場合には、
その文書の内容や更新するまでの秒数の設定に十分な配慮を払う必要があります。

[[#comment]]


** メモ

[[#comment]]


* メモ