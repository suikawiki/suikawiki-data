[88] [DFN[[CODE(HTTP)@en[[[Connection:]]]]]] [[ヘッダー]]は、
現在の[[HTTP接続]]に関する制御オプションを指定するものです [SRC[>>87]]。

* 仕様書

[REFS[
- [87] '''[CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-6.1>'''
- [83] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-2.6>
- [85] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-5.7>
]REFS]

* HTTP の版

[84] この[[ヘッダー]]は [[HTTP/1.1]] 仕様書で規定されていますが、すべての
[[HTTP/1.x]] に対して定義されています [SRC[>>83]]。 [[HTTP/1.1]]
に適合するかに関わらず、すべての [[HTTP/1.x]] の実装はこの[[ヘッダー]]を実装するべきです
[SRC[>>83]]。

* 文脈

[90] [[送信者]]は、 [CODE(HTTP)@en[[[Connection:]]]] 以外の[[ヘッダー]]を使って現在の[[接続]]についてのオプションを指定するときは、
その[[ヘッダー名]]を [CODE(HTTP)@en[[[Connection:]]]] [[ヘッダー]]に含めなければ[['''なりません''']]
[SRC[>>87]]。

[91] この[[ヘッダー]]は複数指定できます。

* 構文

[92] [[欄値]]は、1つ以上の接続オプションの[[リスト]] ([CODE[#]]) です。
接続オプションは、[[字句]]で、[[大文字・小文字不区別]]です。 [SRC[>>87]]

[FIG(railroad)[
= [[字句]]
= *
== [[OWS]]
== [CODE[[[,]]]]
== [[OWS]]
== [[字句]]
]FIG]

* 接続オプション

[96] [CODE(HTTP)@en[[[Connection:]]]] [[ヘッダー]]のリストの値である接続オプションは、
[[ヘッダー名]]と名前空間を共有しています。値を指定することで、
当該[[接続]]についてのオプションを指定することとなり、
同名の[[ヘッダー]]があればそれに関する更なるオプションとして扱われます。

[99] 接続オプションは、特に引数がない場合には、 [CODE(HTTP)@en[[[Connection:]]]]
[[ヘッダー]]にだけ現れて実際の[[ヘッダー]]が存在しないこともあります [SRC[>>87]]。

[100] 接続オプションが [CODE(HTTP)@en[[[Connection:]]]] [[ヘッダー]]に現れずに対応する[[ヘッダー]]だけがある場合、
その[[ヘッダー]]は誤って[[転送]]されてきたものかもしれず、
[[受信者]]が無視する[RUBYB[べき]@en[ought to]]です [SRC[>>87]]。

[101] 新しい接続オプションを定義しようとする仕様書の著者は、
既存の[[ヘッダー名]]を調査して、衝突しないように注意する[RUBYB[べき]@en[ought to]]です。
新しい接続オプションを定義すると、それと同じ[[ヘッダー名]]を別の目的に使うのはよくありませんから、
実質的に[[ヘッダー名]]を予約することとなります。 [SRC[>>87]]

[93] [[送信者]]は、[[payload]] の[[受信者]]すべてに向けた[[ヘッダー]]を
[CODE(HTTP)@en[[[Connection:]]]] に指定しては[['''なりません''']] [SRC[>>87]]。

[EG[
[94] 例えば [CODE(HTTP)@en[[[Cache-Control:]]]] は不適切です [SRC[>>87]]。
]EG]

;; [95] すべてのリストがほしいところですね。

[97] 次のような値が[[接続オプション]]として使われています。
,[[接続オプション]],[[ヘッダー]]
,[CODE(HTTP)[[[close]]]]	,×
,[CODE(HTTP)[[[Keep-Alive]]]]	,○
,[CODE(HTTP)[[[Meter]]]]	,○
,[CODE(HTTP)[[[TE]]]]	,○
,[CODE(HTTP)@en[[[Upgrade]]]],○

[4] [CODE(HTTP)@en[[[Upgrade:]]]] や [CODE(HTTP)[[[TE:]]]]
は、使用する場合必ず [CODE(HTTP)@en[[[Connection:]]]]
に指定しなければならないと規定されています。

;; [103] [CODE(HTTP)@en[[[Content-Length]]]] や [CODE(HTTP)[[[Transfer-Encoding]]]] や
[CODE(HTTP)@en[[[Trailer]]]] は、[[接続オプション]]として使われることはないようです。

* 処理モデル

[86] [[串]]や[[関門]]は、[CODE(HTTP)@en[[[Connection:]]]]
を実装しなければ[['''なりません''']] [SRC[>>85]]。

[89] [[串]]や[[関門]]は、[[メッセージ]]を[[転送]]する前に、
[CODE(HTTP)@en[[[Connection:]]]] に名前が指定されている[[ヘッダー]]と
[CODE(HTTP)@en[[[Connection:]]]] [[ヘッダー]]を削除するか、
[[メッセージ]]を[[転送]]する[[接続]]のオプションを示すものに置換するかしなければ[['''なりません''']] [SRC[>>87]]。

* 歴史

[FIG[
[FIGCAPTION[
[98]  RFC 2068・2616 (HTTP/1.1) 14.10 Connection
]FIGCAPTION]

> The Connection general-header field allows the sender to specify
options that are desired for that particular connection and MUST NOT
be communicated by proxies over further connections.

[CODE(HTTP)[Connection]] 一般頭欄によって、
送信者がその特定の接続における望まれる選択子を指定することが出来ます。
この頭欄は、串により更なる接続において通信しては'''なりません'''。

> The Connection header has the following grammar:

[CODE(HTTP)[Connection]] 頭は次の文法を持ちます :

>
- Connection = "Connection" ":" 1#(connection-token)
- connection-token  = token

> HTTP/1.1 proxies MUST parse the Connection header field before a
message is forwarded and, for each connection-token in this field,
remove any header field(s) from the message with the same name as the
connection-token. Connection options are signaled by the presence of
a connection-token in the Connection header field, not by any
corresponding additional header field(s), since the additional header
field may not be sent if there are no parameters associated with that
connection option.

HTTP/1.1 串は、メッセージが転送される前に [CODE(HTTP)[Connection]] 頭欄を解析しなければ'''ならず'''、
この欄中の各 [CODE(ABNF)[connection-token]] について、
[CODE(ABNF)[connection-token]] と同じ名前の全ての頭欄をメッセージから削除します。
接続選択子は、 [CODE(HTTP)[Connection]] 頭欄中の
[CODE(ABNF)[connection-token]] の出現により通知されます。
それに対応する追加の頭欄によってではありません。
その接続選択子に関連付けられた引数がないときに追加の頭欄は送信されないかもしれないからです。

[INS[

> Message headers listed in the Connection header MUST NOT include
end-to-end headers, such as Cache-Control.

[CODE(HTTP)[Connection]] 頭に列挙されたメッセージ頭並びは、
[CODE(HTTP)[[[Cache-Control]]]] などの末端対末端頭を含んでは'''なりません'''。
]INS]

> HTTP/1.1 defines the "close" connection option for the sender to
signal that the connection will be closed after completion of the
response. For example,

HTTP.1,1 は、その応答の完了後に接続を閉じることを送信者が通知する
[CODE(HTTP)[close]] 接続選択子を定義します。例えば、
要求頭欄並び中であれ応答頭欄並び中であれ、

>
- Connection: close

> in either the request or the response header fields indicates that
the connection [DEL[should not]] [INS[SHOULD NOT]] be considered `persistent' (section 8.1)
after the current request/response is complete.

は現在の要求・応答が完了した後に接続が「[[永続]]」
とみなされる'''べきではない'''ことを示します。

> HTTP/1.1 applications that do not support persistent connections MUST
include the "close" connection option in every message.

永続接続に対応していない HTTP/1.1 応用は各メッセージ中に [CODE(HTTP)[close]]
接続選択子を含めなければ'''なりません'''。

[INS[

> A system receiving an HTTP/1.0 (or lower-version) message that
includes a Connection header MUST, for each connection-token in this
field, remove and ignore any header field(s) from the message with
the same name as the connection-token. This protects against mistaken
forwarding of such header fields by pre-HTTP/1.1 proxies. See section 19.6.2.

[CODE(HTTP)[Connection]] 頭を含んだ
HTTP/1.0 (又はそれ以下の版) のメッセージを受信したシステムは、
この欄中の各 [CODE(ABNF)[connection-token]] について、メッセージ中の
[CODE(ABNF)[connection-token]] と同じ名前の全ての頭欄を削除・無視しなければ'''なりません'''。
これによってそれらの頭欄が HTTP/1.1 以前の串によって誤って転送されることを防ぎます。
]INS]
]FIG]

[REFS[
- [5] [CITE@en[RFC 2660 - The Secure HyperText Transfer Protocol]]
( ([TIME[2013-07-20 22:21:48 +09:00]] 版))
<http://tools.ietf.org/html/rfc2660#section-2.6.3.3>
]REFS]

* 関連

[102] [[接続]]、[[持続的接続]]の項も参照してください。

[1] [[串]]に関係して使われる同種の頭欄には、
- [CODE(HTTP)[[[Cneonction]]]]
- [CODE(HTTP)[[[Proxy-Connection]]]]
- [CODE(HTTP)[[[Xonnection]]]]
- [CODE(HTTP)[[[Xroxy-Connection]]]]

が見つかっています。

[2]
[CODE(HTTP)[[[HTTP-Connection]]]], [CODE(HTTP)[[[Nncoection]]]] も同類っぽ。

[3]
[CODE(HTTP)[[[Proxy-----------]]]] もそうかも。


[104] [CITE@en[RFC 3507 - Internet Content Adaptation Protocol (ICAP)]]
( ([TIME[2014-06-08 07:17:07 +09:00]] 版))
<http://tools.ietf.org/html/rfc3507#section-4.3.1>