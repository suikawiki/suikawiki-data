[1] [DFN[[CODE[Referer:]] 欄]]は、 [[HTTP]] 
などで使われる[[頭欄]]で、[[リンク]]先の[[資源]]を取り寄せる時に、
その参照元を示すために使います。

ここでは、各種プロトコルの [CODE[Referer:]] 欄について取り上げます。
他のプロトコルの Referer (又は相当) 機能についてや、 Referer
に関わる諸問題 (Referer 漏れなど) については [CODE(WikiPage)[[[Referer]]]]
を参照して下さい。

[4] >>1 とはいうものの、 [CODE[Referer:]] 欄と Referer 
一般に完全に切り離すのは不可能なので、まだ境界が曖昧な状態です。
適当にいじってください。

* 仕様書

[REFS[
- [65] [CITE@en[RFC 7231 - Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content]] ([TIME[2014-06-07 01:55:45 +09:00]] 版) <https://tools.ietf.org/html/rfc7231#section-5.5.2>
- [3] [CITE@en[Referrer Policy]] ([TIME[2016-05-21 07:45:08 +09:00]]) <https://w3c.github.io/webappsec-referrer-policy/#determine-requests-referrer>
]REFS]

* 意味

[66] [CODE(HTTP)@en[[[Referer:]]]] [[ヘッダー]]は、
[[対象URL]]の取得元である[[資源]]の [[URL]] を[[利用者エージェント]]が指定するものです
[SRC[>>65]]。

[81] [[対象URL]]を得たのが [[URL]] を持たないものからである場合
(例えば[[キーボード]]からの入力や[[栞]]からの選択である場合) には、
[CODE(HTTP)@en[[[Referer:]]]] を含めないか、
[CODE(URI)@en[[[about:blank]]]] を指定するかのいずれかとしなければ[['''なりません''']]
[SRC[>>65]]。

;; [82] 実際に [CODE(URI)@en[[[about:blank]]]] を送る[[利用者エージェント]]が現存するのかは不明です。

* 文脈

[75] [[利用者エージェント]]は[[要求]]に [CODE(HTTP)@en[[[Referer:]]]]
[[ヘッダー]]を指定することができます。

[76] しかしこの[[ヘッダー]]は必須ではありません。[[対象URL]]
が[[利用者]]の直接入力など他の[[資源]]以外に由来する場合や、
[[利用者]]の設定や[[著者]]の指定により [CODE(HTTP)@en[[[Referer:]]]]
[[ヘッダー]]を送信しないことになっている場合は、
この[[ヘッダー]]は送信されません。

* 構文

[67] 値は、 [[RFC 3986]] [CODE(ABNF)@en[[[absolute-URI]]]] または
[CODE(ABNF)@en[[[partial-URI]]]] とされています。ただし、
[[素片識別子]]と [[userinfo]] を使っては[['''なりません''']]。 [SRC[>>65]]

[FIG(railroad)[
= |
== [[絶対URL]]
== [[部分URL]]
]FIG]

* Referer: 欄の中身

[54]  [CODE(HTTP)[Referer]] URI として報告例のある scheme は、
:[CODE(URI)[[[http]]]]:[[HTTP]]
:[CODE(URI)[[[https]]]]:HTTP over [[SSL]]/[[TLS]]
:[CODE(URI)[[[news]]]]:[[Usenet]] ([SAMP(URI)[news://foo.example/]])
:[CODE(URI)[[[about]]]]:[SAMP(URI)[[[about:blank]]]] (一時の Classic Mozilla の不具合らしい。)
:[CODE(URI)[[[file]]]]:Local file
:[CODE(URI)[[[webster]]]]:[SAMP(URI)[Webster://Internal/StatusPage]]
:[CODE(URI)[[[xxxx]]]]:串による書き換え

こんなものかな。 [CODE(URI)[[[gopher]]]] とか [CODE(URI)[[[ftp]]]] とかもあってもよさそうだけど、確認されていますか?

[84] 普通の一般目的[[利用者エージェント]]は、 [CODE(URI)@en[[[data:]]]] や
[CODE(URI)@en[[[file:]]]] の [[URL]] は [CODE(HTTP)@en[[[Referer:]]]]
で送りません。 [SRC[>>65]]

** 相対 URI

[48]  >>28 によればこの欄の値は相対 URI でも良いみたいですが、
そういうのは見たことがないですね。
絶対 URI にした方がいい気がします。

SuikaWiki の Referer plugin も相対 URI には実は対応していなかった気が。

[55]  一部の版の [[IE]] や一部の[[検索円陣]]索引付け器が相対 URI
で [CODE(HTTP)[Referer:]] を送ってくるそうです。

それから、一部の腐った索引付け器は
[SAMP(URI)[www.example.com/]] のような相対 URI もどきを送りつけるそうです。


** 素片識別子

[47]  ''Bug 179400 - URI fragment present in HTTP Referer'' <http://bugzilla.mozilla.org/show_bug.cgi?id=179400>

Mozilla では、最近 (2002年末) まで Referer URI に[[素片識別子]]もつけて送ってしまうという不具合がありました。 (HTTP RFC ははっきり禁止しています >>28。)

多分他にも素片識別子を送る UA は少なくないと想像されます。

** ロボットの身元申告

[49]  特に昔の[[ロボット]]なんかは、
その身元を表す文書がある [[URI]]
を [CODE(HTTP)[Referer:]] 欄で送ってくることがありました。

身元を表明するという意味ではよい心がけですが、
本来の使い方からそれており好ましいことではありません。
幸い最近はそういうのは減っているようです。

[50]  [[なつみかん]]なんかは設定項目がわざわざあって、
アンテナの結果表示 URI を指定するようにと指導されていました。
リンクを広義に解釈すれば必ずしも間違いとも言い切れませんが、
なんだかなあという気はしました。

これも >>49 の仲間といえます。

[51] なお、身元申告には本来 [CODE(HTTP)[[[From]]:]] 欄を使うのがよいとされています。
実際、最近のロボットは [CODE(HTTP)[From:]] 欄に連絡先メイル・アドレスを入れてきます。
但し、 [CODE(HTTP)[From:]] 欄の中身はあくまでメイル・アドレスでして、
参照して欲しい URI 参照を入れることは残念ながらできません。

ですから、身元申告文書の URI 参照を入れる標準の頭欄で最も適切なのは
[CODE(HTTP)[[[User-Agent]]:]] 欄です。 (しかし、単なる文字列の一部でしかないので機械処理ができない諸刃の剣。素人は [CODE(HTTP)[User-Agent:]] 欄に入れるときには[[注釈]]にしないといけないことにも注意されたし。)

* 要求の参照元の決定

[5] [VAR[要求]]について [DFN[Determine [VAR[request]]’s Referrer]]
は、次のようにします [SRC[>>3]]。

[FIG(steps)[
= [9] [VAR[方針]]を、[VAr[要求]]の[F[参照元ポリシー]]に設定します。
= [10] [VAR[設定群]]を、[VAR[要求]]の[F[クライアント][要求クライアント]]に設定します。
= [23] [VAR[文書]]を、 [[null]] に設定します。
= [11] [VAR[要求]]の[F[参照元]]が [[URL]] なら、
== [12] [VAR[参照元源]]を、[VAR[要求]]の[F[参照元]]に設定します。
= [13] それ以外なら、
== [14] [VAR[設定群]]の[F[大域オブジェクト]]が [CODE(DOMi)@en[Window]] なら、
=== [15] [VAR[文書]]を、[VAR[設定群]]の[F[有責閲覧文脈]]の[F[活性文書]]に設定します。
== [16] [VAR[設定群]]の[F[大域オブジェクト]]が [CODE(DOMi)@en[WorkerGlobalScope]] なら、
@@
=== [17] [VAR[源]]を、[[現職設定群オブジェクト]]の[F[API参照元源]]に設定します。
=== [18] [VAR[源]]が [[URL]] なら、
==== [19] [VAR[参照元源]]を、[VAR[源]]に設定します。
=== [20] それ以外なら、
==== [22] [VAR[文書]]を、[VAR[源]]に設定します。
= [24] [VAR[文書]]が [[null]] でなければ、
== [26] [VAR[文書]]の[F[起源][文書の起源]]が[[不透明起源]]なら、
=== [30] [[null]] を返し、ここで停止します。
== [31] [VAR[文書]]が[F[[[[CODE(HTMLe)@en[iframe]] [CODE(HTMLa)@en[srcdoc]]文書]]]]である間、繰り返し、
=== [27] [VAR[文書]]を、[VAR[文書]]の[F[閲覧文脈]]の[F[閲覧文脈包含子]]の[F[節点文書]]に設定します。
=== [32] [VAR[参照元源]]を、[VAR[文書]]の[F[URL][文書の番地]]に設定します。
= [33] [VAR[参照元URL]]を、[VAR[参照元源]]に [[Strip url for use as a referrer]]
を適用した結果に設定します。
= [34] [VAR[参照元起源]]を、[VAR[参照元源]]に [[Strip url for use as a referrer]]
を適用した結果に設定します。このとき[VAR[起源のみ]]フラグを[[真]]に設定します。
= [37] [VAR[方針]]が [CODE[no-referrer-when-downgrade]] または[[空文字列]] なら、
== [38] 
[FIG(list)[
- [39] [VAR[設定群]]が [[null]] でない
- [41] [VAR[設定群]]が[[TLS保護]]されている
- [42] [VAR[要求]]の[F[現在URL]]が [[a priori authenticated URL]] で''ない''
]FIG]
... のすべてを満たす場合、
=== [44] [[null]] を返し、ここで停止します。
== [57] それ以外なら、
=== [58] [VAR[参照元URL]]を返し、ここで停止します。
= [35] 次の表に従って値を返します。
[FIG(table)[
:policy: [VAR[方針]]

:policy: [CODE[no-referrer]]
:same-origin: [[null]]
:cross-origin: [[null]]

:policy: [CODE[origin][Referrer Policy]]
:same-origin: [VAR[参照元起源]]
:cross-origin: [VAR[参照元起源]]

:policy: [CODE[unsafe-url]]
:same-origin: [VAR[参照元URL]]
:cross-origin: [VAR[参照元URL]]

:policy: [CODE[same-origin][Referrer Policy]]
:same-origin: [VAR[参照元URL]]
:cross-origin: [[null]]

:policy: [CODE[origin-when-cross-origin]]
:cross-origin: [VAR[参照元起源]]
:same-origin: [VAR[参照元URL]]
]FIG]
]FIG]

;; [6] [[Fetch]] から呼び出されます。
ただし [CODE@en[rel=noreferrer]] の時は呼び出されません。

* 処理

[EG[
[68] [CODE(HTTP)@en[[[Referer:]]]] [[ヘッダー]]は、例えば次のような用途に使うことができます
[SRC[>>65]]。
[FIG(list)[
- [69] [[逆リンク]]の生成
-- [71] 解析
-- [72] 記録
-- [73] キャッシュ最適化
- [70] 他のサイトからの[[リンク]]の拒否
- [74] [[CSRF]] 対策
]FIG]
]EG]

[86] 外行きの[[要求]]の [CODE(HTTP)@en[[[Referer:]]]] [[ヘッダー]]をすべて除去する[[中間器]]もあることが知られています。
しかしそれによって [CODE(HTTP)@en[[[Referer:]]]] [[ヘッダー]]による [[CSRF]]
対策を[[鯖]]が行えなくなりますから、より[[利用者]]を危険に晒すことになりかねません。 [SRC[>>65]]

[87] [[中間器]]や[[利用者エージェント]]が情報漏洩を防止したいときは、
内部[[ドメイン名]]を[RUBYB[ペンネーム]@en[pseudonym]]に置き換えたり、
[[path]] や [[query]] を削除したりするなどの変更に留める[RUBYB[べき]@en[ought to]]です。 [SRC[>>65]]

[88] [[中間器]]は、 [CODE(HTTP)@en[[[Referer:]]]] [[ヘッダー]]の値の
[[URL scheme]] や [[host]] が[[要求対象]]と同じ時は、これを編集したり、
削除したりする[['''べきではありません''']] [SRC[>>65]]。

* プライバシー

[83] [CODE(HTTP)@en[[[Referer:]]]] によって要求の文脈や[[閲覧]]の履歴を晒すことによってプライバシー上の問題が生じるかもしれません。
例えば [[URL]] にはアカウント名など個人情報が含まれるかもしれませんし、
[[防火壁]]内などの秘密の[[資源]]の [[URL]] かもしれません。 [SRC[>>65]]

[85] [[安全なプロトコル]]で受け取った[[資源]]は [CODE(HTTP)@en[[[Referer:]]]]
[[ヘッダー]]で送信しては[['''なりません''']] [SRC[>>65]]。

* 歴史

[FIG(quote)[
[FIGCAPTION[
[77] RFC 1945 (HTTP/1.0) 10.13; RFC 2068 (HTTP/1.1) 14.37; RFC 2616 (HTTP/1.1) 14.36 Referer
]FIGCAPTION]

The Referer[INS[ [sic] ]] request-header field allows the client to specify,
for the server's benefit, the address (URI) of the resource from which
the Request-URI was obtained[DEL[.]] [INS[(the "referrer", although the header field is misspelled.)]] [DEL[This]] [INS[The Referer request-header]] allows a server to generate lists of back-links
to resources for interest, logging, optimized caching, etc.
It also allows obsolete or mistyped links to be traced for maintenance.
The Referer field [DEL[must not]] [INS[MUST NOT]] be sent if the Request-URI was obtained from a source
that does not have its own URI, such as input from the user keyboard.

[25] [CODE(HTTP)[Referer]] [おっと!] 
[[要求頭欄によりクライアントはサーバーの益がために]]
Request-URI を得た資源のアドレス ([[URI]]) (「referrer」。
頭欄は綴りが間違っていますが。) を指定することが出来ます。 Referer
要求頭によりサーバーは興味, 記録, キャッシュ最適化その他の目的で資源への逆リンクの一覧を生成出来ます。
維持管理で廃止された又は綴りの間違ったリンクを追跡することも出来ます。
Referer 欄は Request-URI が URI を持たない資源, 
例えば利用者の鍵盤からの入力から得たものである時には送っては'''いけません'''。

>
- Referer        = "Referer" ":" ( absoluteURI | relativeURI )

> Example:
- Referer: http://www.w3.org/hypertext/DataSources/Overview.html

> If [DEL[a partial URI is given]] [INS[the field value is a [DEL[partial]] [INS[relative]] URI]], it [DEL[should]] [INS[SHOULD]] be interpreted relative to the
Request-URI. The URI [DEL[must not]] [INS[MUST NOT]] include a fragment. [INS[[INS[{2616}]] See section 15.1.3 for security considerations.]]

[28] 欄値が相対 URI の場合、これは Request-URI (要求 URI) 
との関係であると解釈される''べき''ものです。 URI は[[素片]] (fragment) 
を含んでいては'''なりません'''。安全性についての第15.1.3節も参照して下さい。

[DEL[

> [INS[{1945,2068}]] Note: Because the source of a link may be private information or
may reveal an otherwise private information source, it is strongly
recommended that the user be able to select whether or not the
Referer field is sent. For example, a browser client could have a
toggle switch for browsing openly/anonymously, which would
respectively enable/disable the sending of Referer and From information.

[INS[

注: この部分は RFC 2616 では 5.1.3 に移動しました。
]INS]
]DEL]

[INS[

注: 注記のない修正は、 RFC 1945 → RFC 2068 の変更点。
]INS]
]FIG]

[FIG(quote)[
[FIGCAPTION[
[78] RFC 1945 (HTTP/1.0) 12.4; RFC 2068 (HTTP/1.1) 15.4; RFC 2616 (HTTP/1.1) 15.1.2 (抜粋)
]FIGCAPTION]

> The Referer [DEL[field]] [INS[[INS[{2616}]] header]] allows reading patterns to be studied and reverse
links drawn. Although it can be very useful, its power can be abused
if user details are not separated from the information contained in
the Referer. Even when the personal information has been removed, the
Referer [DEL[field may]] [INS[[INS[{2616}]] header might]] indicate a private document's URI whose
publication would be inappropriate.

[CODE(HTTP)[Referer]] 頭は、読解パターンを学習することや、
[[逆リンク]]を描くことを可能にします。これは非常に有用でありますが、
利用者の詳細が [CODE(HTTP)[Referer]] に含まれる情報から分離されていなければ、
その力は濫用され得ます。個人情報が削除されるとしても、
[CODE(HTTP)[Referer]] 頭は公表が不適切である私的な文書の URI
を示しているかもしれません。


** RFC 2616 (HTTP/1.1) 15.1.3 (抜粋)

> Because the source of a link might be private information or might
reveal an otherwise private information source, it is strongly
recommended that the user be able to select whether or not the
Referer field is sent. For example, a browser client could have a
toggle switch for browsing openly/anonymously, which would
respectively enable/disable the sending of Referer and From information.

リンクの始点が私的な情報であったり、本来私的な情報源を晒すことになったりするかもしれませんから、
[CODE(HTTP)[Referer]] 欄を送るかどうかを利用者が選択できるようにすることを強く推奨します。
例えば、ブラウザ・クライアントでは、公開で閲覧するか匿名で閲覧するかの切替器を用意して、
[CODE(HTTP)[Referer]] や [CODE(HTTP)[[[From]]]] の情報の送信を有効にするか無効にするか指定するようにできます。

> Clients SHOULD NOT include a Referer header field in a (non-secure)
HTTP request if the referring page was transferred with a secure protocol.

クライアントは、参照している頁が安全なプロトコルで転送されたものであれば、 
(安全でない) HTTP 要求で [CODE(HTTP)[Referer]] 頭欄を含める'''べきではありません'''。
]FIG]

[FIG(quote)[
[FIGCAPTION[
[79] RTSP/1.0 (RFC 2326 12.30 Referer)
]FIGCAPTION]

> See [H14.37]. The URL refers to that of the presentation description,
typically retrieved via HTTP.

[21] [H14.37] 参照。 [[URL]] は、 (典型的には HTTP を介して取り出した) 
[[表現記述]]のものを参照します。
]FIG]

* 実装

[43] [[Mozilla]] では、 View->Page Info->General->Referring URL に Referer
として送られた URI が出ます。

[53]  [[Apache]] の log では、既定では、 [SAMP["[VAR[http://www.example.com/]]"]] のように記録されますが、
[CODE(HTTP)[Referer:]] 欄自体が送られてこなかったときには
[SAMP["-"]] になります。
空 (または空白だけ) の [CODE(HTTP)[Referer:]] 欄が送られてきたときには、
[SAMP[""]] になります。
[CODE(HTTP)[Referer: -]] が送られてきたら、
[SAMP["-"]] になりました。


** Referer を送らないには?

[2] Referer リクエストヘッダの除去 <http://www.st.ryukoku.ac.jp/~kjm/security/memo/referer.html>

[8] 2002-11-04 (月) 13:45 ''[[Name_Not_Found]]'' [[InternetExplorer]] で現時点で Referer をつけない方法はありません。代わりに >>7 のような串を使うのが良いでしょう。

[29] >>8 少々面倒ですが、リンクを[RUBY[鼠] [マウス]]で[RUBY[引っ張っ] [ドラッグし]]て、「アドレス」欄などに[RUBY[落と] [ドロップ]]したら
Referer は送られません。

この方法は[[Mozilla]] でも、タブの上に drag & drop とかすれば使えます。普段は Referer を送るけど、特定の場合には送らないというのに便利。

[40] [WEAK[2002-12-25 11:53]] ''>>36'': でも Mozilla 1.2.1 でそれやったら残ったことがあった。残らないこともあった。変だなあ


*** Proxy などによる削除

[7] Referer は privacy に関わる情報であることから、
これを削除する機能を持った[[串]]があります。
(本来は情報を送る [[UA]] 側で利用者が制御できるのがあるべき姿でしょうが、
そうでない UA が実際には多いですから。)

[36] しかし、ただ削除するだけなら何ら問題はないのですが、削除して代わりに
"Blocked by Proxy-name" のような文字列を挿入するものがあります。
これは[[規格違反]]であることは明らかですから、串作者はこうした文字列を入れては'''なりません'''。利用者もそのような製品はできるだけ使わず、
代替製品があればそちらを使用することが望ましいでしょう。

挿入されるいかれた文字列の例:
- [45] [SAMP(HTTP)[Field blocked by Outpost (http://www.agnitum.com)]]
- [46] [SAMP(HTTP)[Removed by Outpost <http://www.agnitum.com/>]] >>45 の方が新しい版??

[52]  [SAMP(URI)[xxxx:++++++++++++++++++++++++++++++++++++++++++++++++++++++++++]]
のように、伏字にして送ってくる糞 privacy 保護ソフトウェアがあります。

参考:
- ''Referrers Xxxx:++++++++++++++++++'' <http://www.webmasterworld.com/forum39/980.htm>
- ''xxxx:+++/ in referer logs - analog/report magic'' <http://www.webmasterworld.com/forum39/1642.htm>
- ''Get Rid Of The Turkeys Who Use'' <http://www.webmasterworld.com/forum23/2040-3-15.htm>

[SAMP(HTTP)[Blocked by [VAR[...]] ([VAR[www.example.com]])]] てなのもあるそうです。

[56]  [SAMP(HTTP)[Blocked by Norton]]

こんなところでまでわざわざ自己主張しなくたってねぇ。 ([[無Refererさん]])

* 関連

[80] [[Referer]] の制御や、 [[HTTP]] 以外については、
[[Referrer]] の項を参照してください。

* メモ

[62]
この WikiPage の referer 記録、これまた香ばしいのがたくさんきてますねぇ。
他の一般の WikiPage にはあまりないようですけど、
こういう referer spam ってまさか手動でやってるのでしょうか。 ([[Referer]] の頁もなぜか多いです。) 暇な人もいるものですねぇ。
([[名無しさん]] [WEAK[2004-11-06 01:07:14 +00:00]])

[63]
[SAMP(HTTP)[Referer: <!--#exec cmd="ls"-->]]
のようなものが送られてくることがあります。
[CODE(HTTP)[[[Referer]]]] を記録していて、
その結果が [[HTML]] [[ファイル]]に出力されて、
その[[ファイル]]で [[SSI]] が有効になっているのに、
[[HTML]] 化時の[[逃避]]が行われていない、
なんていう一昔前にあちこちで起こっていそうな光景
[WEAK[(今はしらん。)]] を想像しているのでしょうね。

[SAMP[ls]] だからよいもの、 [[Apache]]
が [CODE[[[root]]]] で動いている上に [SAMP[[[rm]] -fr /]]
だった日には[AA[(w]]。

([[名無しさん]] [sage] [WEAK[2005-06-03 11:40:21 +00:00]])

[64] [CITE[Fix referrer. Inline source origin and referrer source. https://www.w3.o... · 1898f6f · whatwg/xhr]]
( ([TIME[2014-01-08 07:30:04 +09:00]] 版))
<https://github.com/whatwg/xhr/commit/1898f6f8981e8f926dc42392c07137eeedf7094b>

[89] [CITE@en[RFC 3507 - Internet Content Adaptation Protocol (ICAP)]]
( ([TIME[2014-06-08 07:17:07 +09:00]] 版))
<http://tools.ietf.org/html/rfc3507#page-14>

[90] [CITE[The Platform for Privacy Preferences 1.0 (P3P1.0) Specification]]
( ([TIME[2002-04-16 22:03:48 +09:00]] 版))
<http://www.w3.org/TR/P3P/#safezone>

[91] [CITE[The Platform for Privacy Preferences 1.0 (P3P1.0) Specification]]
( ([TIME[2002-04-16 22:03:48 +09:00]] 版))
<http://www.w3.org/TR/P3P/#other_http_info>