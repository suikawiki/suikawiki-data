* 仕様書

[REFS[
- [83] [CITE@en[RFC 7231 - Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content]] ([TIME[2014-06-07 01:55:45 +09:00]] 版) <https://tools.ietf.org/html/rfc7231#section-5.5.3>
- [29] [CITE@en[RFC 7231 - Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content]] ([TIME[2014-08-07 05:54:02 +09:00]] 版) <https://tools.ietf.org/html/rfc7231#section-9.6>
- [119] [CITE@en-US[Fetch Standard]] ([TIME[2016-03-31 16:33:52 +09:00]] 版) <https://fetch.spec.whatwg.org/#default-user-agent-value>
]REFS]

* 意味

[106] [CODE(HTTP)@en[[[User-Agent:]]]] や [CODE(JS)@en[[[navigator.userAgent]]]]
は、次のような目的で用いられています。
[FIG(list)[
- [107] [[利用者エージェント]]に基づく[[内容折衝]]
-- [112] [[利用者エージェント]]の実装する機能や不具合の状況による分岐
-- [111] [[ダウンロード]]ページ等における[[ダウンロード]]対象や説明文の差し替え
-- [114] 有害な[[利用者エージェント]]からのアクセスの遮断
- [113] [[クライアント]]のアクセス環境の調査
-- [108] [[利用者]]の環境に関する統計的情報の取得 (いわゆる[[アクセス解析]])
-- [110] 正しくない挙動や[[サーバー]]に害を与える[[利用者エージェント]]の特定
-- [109] [[Webアプリケーション]]の[[お問い合わせ]]フォーム等における[[利用者]]の環境の情報の取得
]FIG]

[120] [DFN[[RUBYB[既定[CODE(HTTP)@en[User-Agent]]値]@en[default `[CODE[User-Agent]]` value]]]]は、
[CODE(HTTP)@en[User-Agent:]] [[ヘッダー]]に使う[[利用者エージェント]]定義の値です
[SRC[>>119]]。
この値は [[HTTP-network-or-cache fetch]] で [CODE(HTTP)@en[User-Agent:]]
[[ヘッダー]]に設定されるほか、 [CODE(JS)@en[navigator.userAgent]] でも使われます。

* 利用者エージェント値の命名規則

- [20] Mozilla での UA 名の指針
-- [32] '''user-agent string'''
--- <http://www.mozilla.org/build/revised-user-agent-strings.html> (原文)
--- <http://jt.mozilla.gr.jp/build/revised-user-agent-strings.html> (和訳)
- [21] ''J-Sky Web/技術資料 ユーザーエージェントについて''
<http://www.dp.j-phone.com/jsky/user.html>
- [22] ''iモード対応HTMLの考え方'' <http://www.nttdocomo.co.jp/mc-user/i/tag/s2.html>
- [23] ''NTT東日本:Lモード'' <http://www.ntt-east.co.jp/Lmode/06_contents/02_tsukuri.html> から入手できる技術条件説明書 <http://www.ntt-east.co.jp/Lmode/06_contents/pdf/cp_gijutsu2_2.exe>
- [24] [[Monazilla]] <http://members.jcom.home.ne.jp/monazilla/document/oyster_subjecttxt.html>
- [25] [[DOLIB]] 1.00 <http://kage.monazilla.org/system_DOLIB100.html>
- [60] [[au]] ''技術情報'' <http://www.au.kddi.com/ezfactory/tec/spec/4_4.html>

[64]
[CITE[端末属性通知プロトコルの標準提案]] ([TIME[2002-09-05 20:59:22 +09:00]] 版) <http://www.mcf.to/eia/news/0909protocol.html>

;; [26] [CODE[User-Agent:]] も参照。

** アプリ内ブラウザーの利用者エージェント名

[126] [[アプリ内ブラウザー]]を参照。

* User-Agent: 欄詐称問題

[36] HTTP 要求頭欄の User-Agent: では、伝統的に [[Mozilla]] を名乗る人達が多いです。

- [37] User-Agent: Mozilla/4.0 (compatible; ・・・)

のように [CODE[compatible]] と名乗るのはまだ良い方で、 Mozilla と区別出来ない
UA を送りつける UA もいます。

[28] >>36 最近でも使われてるブラウザーでいうと、 [[BBB]] が [CODE[Mozilla/2]]
を名乗るけど [CODE[compatible]] を含めないとか。

[38] かつて Mozilla が市場独占に近い状態だった (ほんとか?) 頃に、
UA: を見て Mozilla と非 Mozilla で処理を分けていたサーバーが少なくなかったんで、
非 Mozilla UA がこれに対抗するため Mozilla を名乗ったという伝説が
ありますが、真偽は定かじゃありません。知ってたら教えて下さい。

[39] ReGet とか IRIA とか wget とかの download 専門家達は一部サーバー管理者から
迫害されているので、 UA: を見て締め出されていて、それに対抗するために
詐称機能 (というか、 UA: を自由に設定できる機能) があります。
昔は既定値が Mozilla とかだったりすることも少なくなかったみたいですが、
最近はちゃんと自分の名前を名乗ってるっぽいです。

- [41] ちなみに、 [[WinIE]]1 はちゃんと ''Microsoft Internet Explorer'' と名乗っていました。 Mozilla compatible と詐称するようになったのは 2 からです。
- [42] ''Mac関連ネタを凄い勢いで翻訳スレ2'' <http://pc.2ch.net/test/read.cgi/mac/1035938842/347-351> [[Safari]] の [[Gecko]] 詐称についての開発者の釈明 (の和訳) あり

** Q&A コーナー

[1] ブラウザレポートに出てくる
Netscape (compatible)
ってのは、NN互換の他のブラウザってことなのかな。
それとも、 NNそのものなわけ?

で結局、これはIE5-6,NN6並に
CSSを認識してくれるブラウザなのかと問いたい。

[2] >>1 どんな report なのかわかりませんが、その元になっている
[[HTTP]] の [[User-Agent:欄]]の情報は、みんなそろって [[Mozilla]]
を名乗るという悪しき伝統がありまして、既知の情報から推定した
細かい条件をチェックして、ほんとに Mozilla/[[Netscape]]
なのか、それとも IE なのか、はたまた(以下略)を推測するんです。
(IE とかは、いちおう compatible という文字を入れてるので
区別できるんですが、中には本家 Mozilla と全く区別がつかない
奴もいるとか。)

[3] というわけで、 compatible を名乗るんだから互換性が
あるとみなして送りつけてやったらどうですか? としか言いようが
ありませぬ。

たとえば「Mozilla/2.0 (compatible; Ask Jeeves)」
だったら自称 Mozilla (Netscape Navigator) 2.0 互換ですので、
(もし相手にするのなら) それ相応の応答 (新機能! の[[フレーム]]
とか、[[プラグイン]] (たしか [[Windoze]] 版のみ実装。)とか、
[[Java]] とか [[JavaScript]] (旧称 [[LiveScript]]) とかを使ったもの。)
を返すのがいいのではないでしょうか:-)

[4] >>2-3 てことは、
「おかしなブラウザ使ってるオタク野郎」と見なしていいでしょうか。
もしくは、おかしなブラウザしか使えないあほ組織のPCとか。

[5] >>4 [[ブラウザ]]じゃない、[[検索円陣]]とかの [[UA]] の可能性もあります。

** その他メモ

- [40] [WEAK[2002-12-27 09:29]] ''[[Mozilla]]'': [[User-Agent:欄]]から詐称部門を引越しして、元の内容は Q&A コーナーとしますた。今後 UA 詐称問題は (Mozilla に限らず) こちらで扱いましょう。

[43]
[CITE@ja[CaminoのUA文字列 - Torisugari の日記]] ([CODE[2007-06-22 02:44:08 +09:00]] 版) <http://slashdot.jp/~Torisugari/journal/407122?from=rss>
([[名無しさん]] [WEAK[2007-06-24 07:21:01 +00:00]])

[44]
[CITE@ja[ウィルスバスター(トレンドマイクロ)からのアクセス - えむもじら]] ([CODE[2007-08-05 18:01:24 +09:00]] 版) <http://level.s69.xrea.com/mozilla/index.cgi?id=20070805_VirusBuster>
([[名無しさん]] [WEAK[2007-08-06 12:07:49 +00:00]])

[45]
[CITE@en[Browser Sniffing History in the Chrome UA String]] ([[Henri Sivonen]] 著, [TIME[2008-09-09 00:47:11 +09:00]] 版) <http://hsivonen.iki.fi/chrome-ua/>
([[名無しさん]])

[19] 文字列に [CODE[[[iPhone]]]] が入っているかどうかで、[[スマートフォン版]]かどうかを切り替えるサイトが存在します。

* UA sniffing

[FIG(short list)[ [18] [[UA sniffing]] 手法
- [CODE(HTTP)@en[User-Agent]] 検査
- [CODE(DOMi)@en[Navigator]] 検査
- [[CSS hack]]
- [[条件付注釈]]
]FIG]

[50] 実際のところ、規格違反の文字列を使う例や詐称により実際の情報が注釈内に押し込まれている例が多すぎることから、仕様に基づいた parser を作って前半(名前)・後半(版)を見て処理を云々というのは現実的でなく、そうした処理をする多くの実装 ([[CGI]] script やサーバーなど。) は[[正規表現]]を使って処理しています。確かにこれが最も現実的な方法でしょう。

[57] ''ブラウザ判別では"Gecko"を調べてください - Web標準普及プロジェクト'' <http://www.mozilla.gr.jp/standards/webtips1005.html>

[58] [[RFC2936]] HTTP MIME 型取扱器判別


* 利用者エージェント名の一覧

[20] [[HTTP]] で [[User-Agent:欄]]に実際に使われている名前についての
情報源:
- [21] <http://www.dais.is.tohoku.ac.jp/logs/agentgripes.html>
- [22] <IW:YukiWiki:UserAgent>
- [23] <http://inhand.jp/index.cgi?action=viewnews&id=99>
- [5] [[WikiUserAgentList]]
- [6] '':: 偽られたUA ::'' <http://pc3.2ch.net/test/read.cgi/hp/1015925179/>
- [7] ''あなたの User-Agent 教えてください'' <http://pc.2ch.net/test/read.cgi/php/990173593/>
- [8] ''User-Agent統計'' <http://www2.startshop.co.jp/~68user/cgi-bin/view-browser.cgi>
- [9] ''偽装UAを熱烈に募集し、まとめてみたページ''' <http://members.tripod.co.jp/g_ua/>'''''
- [10] [[NN]] 1.22 = [CODE[Mozilla/1.22 (Windows; I; 32bit)]]

[11] HTTP じゃないですけど、最近の [[Mew]] はこんなのをつけるらしいです。

[PRE[
 User-Agent: Mew/3.1.53 Emacs/21.2.93 (i386-mingw-nt4.0.1381) Mule/5.0
  =?iso-2022-jp?B?KBskQjgtTFobKEIp?= Meadow/1.99 Alpha4
  =?iso-2022-jp?B?KBskQkU0GyhCKQ==?=
]PRE]

設定次第, かもしれません。 Kazu さんのは従来通り [[X-Mailer:]] だし。

で、この例のように [[encoded-word]] を生で使っていると、例えば [CODE(ABNF)["="]]
は [[tspecials]] ですから、 [[HTTP]] や [[usefor-article]]
の構文に照らして不当です。

もっとも、現時点で[[電子メイル]]における [CODE[User-Agent:]]
欄の定義は存在しない以上, 非構造欄だとか, そうでなくても [CODE(ABNF)[tspecials]]
も使えるんだとか, そういう主張はできなくもないですが。

- [12] ''Comments on AgentGripes'' <http://web.archive.org/web/20011019120517/http://www.dais.is.tohoku.ac.jp/logs/comment.html#reqheaader>
- [13] UA じゃなくて [[Server:]] の方ですが、 [[Zope]] の例: [CODE(HTTP)[Server: Zope/(Zope 2.5.1 (source release, python 2.1, linux2), python 2.1.3, freebsd4) ZServer/1.1b1]]。面白い例でしょ? 文法違反だけど。
- [14] なんと、 <IW:Google:"UserAgent 一覧"> (日本語) で[WEAK[<IW:YukiWiki:UserAgent> を6位に抑えて]] 3位! 
- [31] [TIME[2003-08-29 11:48:17 +00:00]] ''>>14'': ほんとだ! すごいじゃん。内容ないのに(w
- [16] ''WWW Agents List'' <http://www.kmc.gr.jp/~ranran/tips/www-agents.html>

- [43] '''Some Gripes on User-Agent'''
<http://www.dais.is.tohoku.ac.jp/logs/agentgripes.html> [[UA]] の実例が一杯。

[63]
[CITE@en[The ELinks Manual]] ([[Petr Baudis, Jonas Fonseca Madsen, Miciah Dashiel Butler Masters]] 著, [CODE[2007-03-18 16:03:15 +09:00]] 版) <http://elinks.or.cz/documentation/manual.html#useragent>

* プライバシー

[17] [[利用者エージェントの識別]]情報は、 [[fingerprinting vector]] です。

* セキュリティー

[91] [CODE(HTTP)@en[[[User-Agent:]]]] の値は [[fingerprinting]]
に使われることがあり [SRC[>>83]]、注意が必要です。


[15] Security や privacy を理由に、 UA: 欄や 
[[Server]]が送られることに懸念を示す人がいます。

確かに個々の場合において問題が発生する可能性はあるでしょう。
(例えば UA: 欄に特定の文字列が入っていたら攻撃する人がいるとか。)

しかし一般論として、例えばこれらの情報を送らないことで安全性が向上するということはありません。

[16] >>15 わざわざソースから削って出力させなくするような人もいるらしいですが、安全性の向上を狙っているならはっきり言って無駄なことです。

[30] [[RFC 7231]] はソフトウェアの情報を示すことによって既知の[[セキュリティーホール]]を攻撃される危険性があるとしつつも、
実際にはソフトウェアの版に関わらず攻撃される虞があることをも指摘しています
[SRC[>>29]]。

* 歴史

[27] [CODE[User-Agent:]], [CODE[Navigator]] の歴史の項も参照。








