[5] 
[DFN[JWE]] ([DFN[JSON Web Encryption]])
は、
[[暗号化]]したデータを交換できる
[[JSON応用]]です。

[6] 
[[JWS]] 等で構成される [[JOSE]] 規格シリーズの1つです。

* 仕様書

[REFS[
-
[1] [CITE@en[[[RFC 7516]] - JSON Web Encryption (JWE)]]
([TIME[2015-05-20 09:55:47 +09:00]] 版)
<https://tools.ietf.org/html/rfc7516>
-- [3] 移転確認 [TIME[2022-11-23T02:40:26.800Z]]
-- [4] [CITE@en[[[RFC 7516]] - JSON Web Encryption (JWE)]], [TIME[2022-11-23T02:40:19.000Z]] <https://datatracker.ietf.org/doc/html/rfc7516>
--- [7] 
[CITE@en[[[RFC 7516]] - JSON Web Encryption (JWE)]], [TIME[2022-11-23T02:52:15.000Z]] <https://datatracker.ietf.org/doc/html/rfc7516#section-2>
--- [17] 
[CITE@en[[[RFC 7516]] - JSON Web Encryption (JWE)]], [TIME[2022-11-23T05:48:17.000Z]] <https://datatracker.ietf.org/doc/html/rfc7516#section-3>
--- [33] 
[CITE@en[[[RFC 7516]] - JSON Web Encryption (JWE)]], [TIME[2022-11-23T09:33:56.000Z]] <https://datatracker.ietf.org/doc/html/rfc7516#section-5>




]REFS]

* 暗号化

[16] [[JWA]] を使います。

[FIG(short list)[ [9] [[JWE]] の[[暗号化]]用語
- [[JWE]]
- [[AEAD]]
- [[AAD]]
- [[認証タグ]]
- [[CEK]]
- [[JWE被暗号化鍵]]
- [[JWE初期化ベクトル]]
- [[JWE AAD]]
- [[JWE暗号文]]
- [[JWE認証タグ]]
- [[鍵管理モード]]
]FIG]

* データモデル


[8] 
[DFN[JSON Web Encryption]] ([DFN[JWE]])
は、
[[暗号化]]され[[一貫性保護]]された[[メッセージ]]を表現する[[データ構造]]です。
[SRC[>>7]]

[18] 
1つの [[JWE]] は、
次により構成されます。
[SRC[>>17]]

[FIG(list members)[ [19] [[JWE]]

: [[JOSEヘッダー]] : 
次の[[合同]]です。
[FIG(list members)[

: [DFN[[RUBYB[JWE被保護ヘッダー][JWE Protected Header]]]] :
[[被認証暗号化]]操作によって[[一貫性保護]]された[[ヘッダー引数]]群を含む
[[JSONオブジェクト]]です。
当該[[ヘッダー引数]]群は、 [[JWE]] のすべての[[受信者]]に適用されます。
[[JWE簡潔直列化]]においては、
[[JOSEヘッダー]]全体で構成されます。
[[JWE JSON直列化]]においては、
[[JOSEヘッダー]]の構成要素の1つです。
[SRC[>>7]]
: [DFN[[RUBYN[JWE被共有非被保護ヘッダー][JWE Shared Unprotected Header]]]] :
[[JWE]] のすべての[[受信者]]に適用される[[ヘッダー引数]]群であって[[一貫性保護]]されないものを含む
[[JSONオブジェクト]]です。
[[JWE JSON直列化]]にのみ出現できます。
[SRC[>>7]]
: [DFN[[RUBYB[JWE受信者毎非被保護ヘッダー][JWE Per-Recipient Unprotected Header]]]] :
[[JWE]] の単独の[[受信者]]に適用される[[ヘッダー引数]]群を含む
[[JSONオブジェクト]]です。
当該[[ヘッダー引数]]群は[[一貫性保護]]されません。
[[JWE JSON直列化]]にのみ出現できます。
[SRC[>>7]]


]FIG]
: [[JWE被暗号化鍵]] :
: [[JWE初期化ベクトル]] :
: [[JWE AAD]] :
: [[JWE暗号文]] :
: [[JWE認証タグ]] :

]FIG]


[10] 
[[平文]]の[[機密性]]と[[一貫性]]、
並びに[[JWE被保護ヘッダー]]と [[JWE AAD]] の[[一貫性]]を保証するため、
[[被認証暗号化]]を使います。
[SRC[>>17]]



* 直列化

[20] [[JWE]] は、 [[RFC 7159]] [[JSON]] データや [[base64url]]
を使って記述されます。 [[JSON]] は、その定めるところにより、
値の前後に[[空白]]を挿入できます。 [SEE[ [[JSON]] ]]
[SRC[>>17]]




** JWE 簡潔直列化

[14] 
[DFN[[RUBYB[JWE簡潔直列化][JWE Compact Serialization]]]]は、
[[JWE]]
の簡潔で [[URL]] 安全な文字列としての表現です。
[SRC[>>7]]

[11] 
[[JWE簡潔直列化]]では、
[[JWE共有非被保護ヘッダー]]や
[[JWE受信者毎非被保護ヘッダー]]は、
利用できません。
[SRC[>>7, >>17]]

;; [12] 従って[[JOSEヘッダー]] = [[JWE被保護ヘッダー]]です。
[SRC[>>17]]


[13] 
[[JWE簡潔直列化]]は、 次のものを順に[[連結]]したものです。
[SRC[>>17]]

= [21] [[RFC 7515]] [CODE[BASE64URL]] ([[RFC 3629]] [CODE[UTF8]] ([[JWE被保護ヘッダー]]))
= [22] [CODE[.][FULL STOP]]
= [23] [[RFC 7515]] [CODE[BASE64URL]] ([[JWE被暗号化鍵]])
= [24] [CODE[.][FULL STOP]]
= [25] [[RFC 7515]] [CODE[BASE64URL]] ([[JWE初期化ベクトル]])
= [26] [CODE[.][FULL STOP]]
= [27] [[RFC 7515]] [CODE[BASE64URL]] ([[JWE暗号文]])
= [28] [CODE[.][FULL STOP]]
= [29] [[RFC 7515]] [CODE[BASE64URL]] ([[JWE認証タグ]])


** JWE JSON 直列化

[15] 
[DFN[[RUBYB[JWE JSON直列化][JWE JSON Serialization]]]]は、
[[JWE]] の [[JSONオブジェクト]]としての[[直列化]]です。 
[[JWE JSON直列化]]では複数の[RUBYB[当事者][parties]]に対して同じ内容を暗号化できます。
[SRC[>>7]]

[32] 
[[JWS JSON直列化]]は、
次のような
[[JSONオブジェクト]]により表現します。
[SRC[>>17]]

[FIG(list members)[ [31] [[JWS JSON直列化]]

: [DFN[[CODE[protected]]]] : 
[[RFC 7515]] [CODE[BASE64URL]] ([[RFC 3629]] [CODE[UTF8]] ([[JWE被保護ヘッダー]]))
: [DFN[[CODE[unprotected]]]] : 
[[JWE共有非被保護ヘッダー]]
: [DFN[[CODE[header]]]] :
[[JWE受信者毎非被保護ヘッダー]]
: [CODE[encrypted_key]] :
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE被暗号化鍵]])
: [CODE[iv]] :
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE初期化ベクトル]])
: [CODE[ciphertext]] :
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE暗号文]])
: [CODE[tag]] :
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE認証タグ]])
: [CODE[aad]] :
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE AAD]])


]FIG]

[30] 
[[JWE JSON直列化]]では、
[[JWE被保護ヘッダー]]、
[[JWE共有非被保護ヘッダー]]、
[[JWE受信者毎非被保護ヘッダー]]のうち
1つ[[以上]]は[MUST[必須]]です。
[SRC[>>17]]


* 処理

[34] 
[[メッセージ]]の[[暗号化]]は、次のようにします。
[SRC[>>33]]

- [60] 
[VAR[平文]]を、
[[平文]]とします。
- [52] 
[VAR[受信者リスト]]は、
1つ[[以上]]の[[メッセージ]]の[[受信者]]の[[リスト]]とします。
[[JWE簡潔直列化]]ではちょうど1つの[[受信者]]の[[リスト]]でなければなりません。

[FIG(steps)[

= [53] 
[VAR[受信者リスト]]中の各[[受信者]][VAR[受信者]]について、
[[順に][for each]]、
== [35] 
[VAR[算法]]を、 [CODE[alg]] で指定された[[算法]]
([[CEK]] 値の決定に使う[[算法]]) に設定します。
== [36] 
[VAR[鍵管理モード]]を、
[VAR[算法]]により[[鍵管理モード]]を決定した結果に設定します。
== [37] 
[VAR[鍵管理モード]]が[[鍵包み]]、
[[鍵暗号化]]、
[[鍵包み付き鍵合意]]の場合、
=== [38] 
[[無作為]]に [[CEK]] 値を生成します。
[[無作為]]値の生成については [[RFC 4086]] を参照。
[[CEK]] は、
[[内容暗号化算法]]が要求する長さと等しくなければ[MUST[なりません]]。
== [39] 
[VAR[鍵管理モード]]が[[直接鍵合意]]、
[[鍵包み付き鍵合意]]の場合、
=== [40] 
[RUBYB[合意された鍵][agreed upon key]]を計算すべく[[鍵合意算法]]を実行します。
=== [41] 
[VAR[鍵管理モード]]が[[直接鍵合意]]の場合、
==== [42] 
[[CEK]] を得られた値に設定します。
=== [43] 
[VAR[鍵管理モード]]が[[鍵包み付き鍵合意]]の場合、
==== [44] 
得られた値は [[CEK]] を包むのに使われます。
== [45] 
[VAR[鍵管理モード]]が[[鍵包み]]、
[[鍵暗号化]]、
[[鍵包み付き鍵合意]]の場合、
=== [46] 
[VAR[[[JWE被暗号化鍵]]]]を、
[[CEK]] を[VAR[受信者]]に対して[[暗号化]]した結果に設定します。
== [47] 
[VAR[鍵管理モード]]が[[直接鍵合意]],
[[直接暗号化]]の場合、
=== [48] 
[VAR[[[JWE被暗号化鍵]]]]を、
[[空オクテット列]]に設定します。
== [49] 
[VAR[鍵管理モード]]が[[直接暗号化]]の場合、
=== [50] 
[[CEK]] を共有[[対称鍵]]に設定します。
== [51] 
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE被暗号化鍵]])
を計算します。
= [54] 
[VAR[[[JWE初期化ベクトル]]]]を、[[空オクテット列]]に設定します。
= [55] 
[[内容暗号化算法]]が[[初期化ベクトル]]を必要とする場合、
== [56] 
[VAR[[[JWE初期化ベクトル]]]]を、
[[内容暗号化算法]]で適切な大きさの[[無作為]]の
[[JWE初期化ベクトル]]を生成した結果に設定します。
= [57] 
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE初期化ベクトル]])
を計算します。
= [58] 
[CODE[zip]] が指定されている場合、
== [59] [VAR[M]]を、[VAR[平文]]を [CODE[zip]] 
で指定された[[算法]]で[[圧縮]]した結果に設定します。
= [62] 
それ以外の場合、
== [63] 
[VAR[M]] を、[VAR[平文]]に設定します。
= [61] 
必要な場合、
== [69] 
[VAR[[[JWE被保護ヘッダー]]]]を、
適切な[[ヘッダー引数]]を含んだ[[JOSEヘッダー]]に設定します。
== [64] 
[VAR[符号化被保護ヘッダー]]の値を、
[[RFC 7515]] [CODE[BASE64URL]] ([[RFC 3629]] [CODE[UTF8]] ([[JWE被保護ヘッダー]]))
を計算した結果に設定します。
= [70] 
それ以外の場合、
== [71] 
[VAR[符号化被保護ヘッダー]]の値を、
[[空文字列]]に設定します。
= [65] 
必要な場合、
== [67] 
[VAR[[[JWE被共有非被保護ヘッダー]]]]を、
適切な[[ヘッダー引数]]を含んだ[[JOSEヘッダー]]に設定します。
= [66] 
必要な場合、
== [68] 
[VAR[[[JWE受信者毎非被保護ヘッダー]]]]を、
適切な[[ヘッダー引数]]を含んだ[[JOSEヘッダー]]に設定します。
= [72] 
[[JWE AAD]] がある場合、
== [75] 
[VAR[値]]を、
次の[[文字列を順に連結][文字列連結]]した結果に設定します。
--- [VAR[符号化被保護ヘッダー]]
--- [CODE[.][FULL STOP]]
--- [[RFC 7515]] [CODE[BASE64URL]] ([[JWE AAD]])
= [76] 
それ以外の場合、
== [77] 
[VAR[値]]を、
[VAR[符号化被保護ヘッダー]]に設定します。
= [73] 
[VAR[[[AAD]]暗号化引数]]を、
[VAR[値]]を
[[RFC 20]] [[ASCII]]
で[[符号化]]した結果に設定します。
= [74] 
[VAR[[[JWE暗号文]]]]と[VAR[[[JWE認証タグ]]]]を、
[VAR[M]],
[[CEK]],
[VAR[[[JWK初期化ベクトル]]]],
[VAR[[[AAD]]暗号化引数]]について、
指定された[[内容暗号化算法]]で[[暗号化]]した結果に設定します。
= [78] 
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE暗号文]])
を計算します。
= [79] 
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE認証タグ]])
を計算します。
= [80] 
[[JWD AAD]] が指定された場合、
== [81] 
[[RFC 7515]] [CODE[BASE64URL]] ([[JWE AAD]])
を計算します。
= [82] 
ここまでで得られた値を使って[[直列化]]します。

]FIG]

* 歴史

[2] 
[DFN[RFC 7516]]
は、
[TIME[西暦2015年5月][2015-05]]に
[[IETF]]
[[標準化過程RFC]] 
([[提案標準]])
として出版されました。
[SRC[>>1]]



* メモ