
* 仕様書

[REFS[
- [1] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-5>
]REFS]

* 構文

[8] [[フレーム]]は、次のような構造です [SRC[>>1]]。
[FIG(packet)[
:width:32

=1 [[FIN]]
=1 [[RSV1]]
=1 [[RSV2]]
=1 [[RSV3]]
=4 [[opcode]]
=1 [[マスク]]
=23 [[payload長]]
=32 [[マスクキー]]
=32... [[Payload Data]]
]FIG]

[FIG(list members)[
[FIGCAPTION[
[[フレーム]]
]FIGCAPTION]

:[DFN[[CODE[[[FIN]]]]]]:
[[メッセージ]]の最後の[RUBYB[断片]@en[fragment]]であるかどうかを示します。
[CODE[[[0]]]] は最後でないこと、 [CODE[[[1]]]] は最後であることを表します。
:[DFN[[CODE[[[RSV1]]]]]]:
[[拡張]]により規定される場合を除き、 [CODE[[[0]]]] でなければ[['''なりません''']]。
:[DFN[[CODE[[[RSV2]]]]]]:
[[拡張]]により規定される場合を除き、 [CODE[[[0]]]] でなければ[['''なりません''']]。
:[DFN[[CODE[[[RSV3]]]]]]:
[[拡張]]により規定される場合を除き、 [CODE[[[0]]]] でなければ[['''なりません''']]。
:[DFN[[CODE[[[opcode]]]]]]:
[[payload data]] の解釈を規定するものです。
:[DFN[[RUBYB[マスク]@en[mask]]]] ([DFN[[CODE[[[frame-masking-key]]]]]]):
[[payload data]] が[[マスク]]されるかどうかを示します。
[CODE[[[1]]]] は[[マスク]]されていること、[CODE[[[0]]]] は[[マスク]]されていないことを示します。
:[DFN[[RUBYB[payload長]@en[payload length]]]]:
[[payload data]] の長さを[[バイト]]単位で示します。
次のうち、最短の形を使わなければ[['''なりません''']]。
[FIG(list)[
- [15] [CODE[0]]-[CODE[125]] なら、これが [[payload長]]です。
- [16] [CODE[126]] なら、次の2バイトが[[payload長]]の[[16ビット符号無し整数]]
([[ネットワークバイト順]]) です。
- [17] [CODE[127]] なら、次の8バイトが[[payload長]]の[[64ビット符号無し整数]]
([[ネットワークバイト順]]) です。
ただし[[最上位ビット]]は [CODE[0]] でなければ[['''なりません''']]。
]FIG]
:[DFN[[RUBYB[[[マスクキー]]]@en[masking key]]]] ([DFN[[CODE[[[frame-masking-key]]]]]]):
[[マスク]]する際に使う32ビットの値です。[[マスク]]ビットが [CODE[[[1]]]]
であれば、本欄が存在します。 [CODE[[[0]]]] なら、存在しません。
:[DFN[[RUBYB[拡張データ]@en[extension data]]]]:
[[拡張]]により規定された長さと用途のデータです。[[拡張]]がなければ長さ0です。
:[DFN[[RUBYB[応用データ]@en[application data]]]]:
任意の[[応用]]のデータです。
]FIG]

[18] [DFN[[RUBYB[payloadデータ]@en[payload data]]]]は、
[[拡張データ]]と[[応用データ]]を指します [SRC[>>1]]。

[9] 次のような[[フレーム]]を受信したら、
[[WebSocket接続失敗]]としなければ[['''なりません''']] [SRC[>>1]]。
[FIG(list)[
- [10] [CODE[[[RSV1]]]] が非 [CODE[[[0]]]] 値であり、[[拡張]]のいずれの規定にも拠っていない場合
- [11] [CODE[[[RSV2]]]] が非 [CODE[[[0]]]] 値であり、[[拡張]]のいずれの規定にも拠っていない場合
- [12] [CODE[[[RSV3]]]] が非 [CODE[[[0]]]] 値であり、[[拡張]]のいずれの規定にも拠っていない場合
- [13] 未知の [CODE[[[opcode]]]] の場合
]FIG]

* opcode

[14] [[opcode]] には、次のものがあります [SRC[>>1]]。
[FIG(list)[
- [CODE[[[0]]]] - [[継続フレーム]]
- [CODE[[[1]]]] - [[テキストフレーム]]
- [CODE[[[2]]]] - [[バイナリーフレーム]]
- [CODE[[[3]]]] - 非制御フレームに予約
- [CODE[[[4]]]] - 非制御フレームに予約
- [CODE[[[5]]]] - 非制御フレームに予約
- [CODE[[[6]]]] - 非制御フレームに予約
- [CODE[[[7]]]] - 非制御フレームに予約
- [CODE[[[8]]]] - 接続を閉じる
- [CODE[[[9]]]] - [[ping]]
- [CODE[[[A]]]] - [[pong]]
- [CODE[[[B]]]] - 制御フレームに予約
- [CODE[[[C]]]] - 制御フレームに予約
- [CODE[[[D]]]] - 制御フレームに予約
- [CODE[[[E]]]] - 制御フレームに予約
- [CODE[[[F]]]] - 制御フレームに予約
]FIG]

* マスク

[19] [[フレーム]]は、[DFN[[RUBYB[[[マスク]]]@en[mask]]]]する場合と[[マスク]]しない場合があります。

[20] [[マスク]]した[[フレーム]]は、[[マスク]]欄の値が [CODE[[[1]]]] でなければ[['''なりません''']]
[SRC[>>1]]。

[21] [RUBYB[マスクキー]@en[masking key]]は、[[クライアント]]が[[無作為]]に選択した32ビット値です。
[[マスクキー]]は、[[マスク]]した[[フレーム]]内の[[マスクキー]]欄に示されます。 [SRC[>>1]]

[2] [[クライアント]]は、[[サーバー]]に送信するすべての[[フレーム]]を[[マスク]]しなければ[['''なりません''']] [SRC[>>1]]。

[5] [[サーバー]]は、[[クライアント]]に[[マスク]]した[[フレーム]]を送信しては[['''なりません''']]
[SRC[>>1]]。

[23] [[マスク]]する際に新鮮な値を[[マスクキー]]として選ばなければ[['''なりません''']] [SRC[>>1]]。
[[マスクキー]]は予測不能である必要がありますから、
強い[[エントロピー]]源から得なければ[['''なりません''']] [SRC[>>1]]。
前の[[フレーム]]から以後の[[フレーム]]の[[マスクキー]]を容易に予測できては[['''なりません''']]
[SRC[>>1]]。

;; [3] これは、[[プロキシ]]等の[[中間器]]の混乱を防ぐため、また[[セキュリティー]]のために必要な措置です
[SRC[>>1]]。

;; [22] [[RFC 4086]] に強い[[エントロピー]]源についての議論があります [SRC[>>1]]。

[24] [[マスク]]の適用と復元は、どちらも次の手順により行います [SRC[>>1]]。

[FIG(steps)[
= [25] 入力データの各[[オクテット]]について、
== [26] 出力の[[オクテット]] [VAR[i]] は、入力のオクテット [VAR[i]] と[[マスクデータ]]のオクテット [VAR[i]] [[mod]] 4 の [[XOR]] とします。
]FIG]

[4] [[サーバー]]は、[[マスク]]されていない[[フレーム]]を受信したら、
[[接続]]を閉じなければ[['''なりません''']] [SRC[>>1]]。
この場合[[サーバー]]は [CODE(HTTP)@en[[[Close]]]] [[フレーム]]を[[状態符号]]
[CODE(HTTP)[[[1002]]]] で送信して構いません [SRC[>>1]]。

[6] [[クライアント]]は、[[マスク]]された[[フレーム]]を受信したら、
[[接続]]を閉じなければ[['''なりません''']] [SRC[>>1]]。
この場合[[クライアント]]は [CODE(HTTP)@en[[[Close]]]] [[フレーム]]を[[状態符号]]
[CODE(HTTP)[[[1002]]]] で送信して構いません [SRC[>>1]]。

* データフレーム

[7] [[クライアント]]も[[サーバー]]も、[[WebSocket接続の確立]]の後、
[CODE(HTTP)[[[Close]]]] [[フレーム]]を送信するまで、任意の時機に[[データフレーム]]を送信できます
[SRC[>>1]]。