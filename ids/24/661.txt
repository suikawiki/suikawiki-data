[8] [[閲覧文脈の作成]]は、[[窓]]を開くなどの[[利用者]]の操作により、
あるいは [CODE(HTMLe)@en[[[iframe]]]] [[要素]]の挿入などの[[スクリプト]]の操作により、
行われます。

* 仕様書

[REFS[
- [1] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#creating-a-new-browsing-context>
]REFS]

* 文脈

[9] 次の場面で[[閲覧文脈の作成]]が呼び出されます。
[FIG(list)[
- [[フレーム]]の[[文書への挿入]] [SRC[[[HTML Standard]]]]
- [[the rules for choosing a browsing context given a browsing context name]] 
で新たに[[閲覧文脈]]を開く場合 [SRC[[[HTML Standard]]]]
- [CODE(DOMm)@en[[[showModalDialog]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[object]]]] [[要素]]で[[閲覧文脈]]を使う場合
- [CODE(HTMLe)@en[[[embed]]]] [[要素]]で[[閲覧文脈]]を使う場合
- 新しい[[窓]]や[[タブ]]を開いた場合
]FIG]

* 処理

[2] [DFN[[RUBYB[新しい閲覧文脈の作成]@en[create a new browsing context]]]]は、
次のようにしなければ[['''なりません''']] [SRC[>>1]]。
[[作成子閲覧文脈]]が指定されて作成されることがあります。
[FIG(steps)[
= [DFN[[RUBYB[初期「[CODE(URI)@en[about:blank]]」[[文書]]]@en[initial "[CODE(URI)@en[about:blank]]" document]]]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[文書]]
]FIGCAPTION]
:[[文書の番地]]:[CODE(URI)@en[[[about:blank]]]]
:[[HTML文書]]:[[真]]
:[[文字符号化]]:[[UTF-8]]
:[[ready for post-load tasks]]:[[真]]
:[[completely loaded]]:[[真]]
:[[作成子[CODE(DOMi)@en[Document]]]]:[[作成子閲覧文脈]] (あれば) の[[活性文書]]
:[[文書のreferrer]]:[[作成子[CODE(DOMi)@en[Document]]]] (あれば) の[[文書の番地]]
:[[文書の起源]]:[[作成子[CODE(DOMi)@en[Document]]]]があれば、その[[文書の起源]]の[[別名]]。
なければ[[大域的に固有な識別子]]。
:[[実効スクリプト起源]]:[[作成子[CODE(DOMi)@en[Document]]]]があれば、その[[実効スクリプト起源]]の[[別名]]。
なければ[[文書の起源]]の[[別名]]。
:[[子供節点]]:[CODE(HTMLe)@en[[[html]]]] [[要素]]。その[[子供]]は
[CODE(HTMLe)@en[[[head]]]] [[要素]]と [CODE(HTMLe)@en[[[body]]]] [[要素]]
(いずれも[[空]])。
]FIG]
= 新しい [CODE(DOMi)@en[[[Window]]]] を作成し、新しく作成した[[文書]]と関連付けます。
= [[閲覧文脈]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[閲覧文脈]]
]FIGCAPTION]
:[[セッション履歴]]:
[FIG(list members)[
[FIGCAPTION[
[[セッション履歴エントリー]]
]FIGCAPTION]
:[[文書]]:新しく作成した[[文書]]
:[[作成子閲覧文脈]]:指定された[[閲覧文脈]] (あれば)
]FIG]
]FIG]
= 新しく作成した[[文書]]について [[implement the sandboxing]] を実行します。
]FIG]

;; [3] [[文書のreferrer]] と [[CSP]] などの [CODE[[[referrer]]]] の指定との関係は不明瞭です。

[10] [CODE(DOMi)@en[[[Window]]]] は[[大域オブジェクト]]ですから、
付随して[[環境設定群オブジェクト]]、 [[JavaScript]] 実行環境、
[[Web IDL]] [[インターフェイスオブジェクト]]なども作られます。
この [CODE(DOMi)@en[[[Window]]]] は、 [[navigate]] により次の[[文書]]に再利用されることがあります。

;; [[文書オブジェクトの初期化]]参照。

* 最初の [CODE(JS)@en[about:blank]] 文書

[4] [[閲覧文脈の作成]]時に作成される[[文書]]は、仕様書中では
「[[閲覧文脈]]作成時に追加された [CODE(URI)@en[[[about:blank]]]] [[文書]]」、
「初期『[CODE(URI)@en[about:blank]]』文書」などと呼ばれます。

[21] [[閲覧文脈]]作成時に[[セッション履歴]]に追加された
[CODE(URI)@en[[[about:blank]]]] [[文書]]は、次の場面で特別に扱われます。
[FIG(short list)[
- [[文書オブジェクトの初期化]]
- [CODE(JS)@en[[[location.assign]]]]
- [CODE(JS)@en[[[document.open]]]]
- [CODE(JS)@en[[[window.open]]]]
- [[フレーム]]
]FIG]

[5] 初期文書かどうかは、[[置換有効]]で [[navigate]] するかどうかの判断に使われます。
つまり初期文書は当該[[閲覧文脈]]で [[navigate]] が最初に発生した時に[[セッション履歴]]から削除されることになります。

[6] この判断は初期文書かどうか否かで行うので、[[スクリプト]]により内容を操作しているか否かは影響しません。 (ただし [CODE(JS)@en[[[document.open]]]] や
[CODE(DOMm)@en[[[pushState]]]] で[[セッション履歴エントリー]]が新たに追加されていれば、
初期文書が唯一の[[セッション履歴エントリー]]であるとの条件を満たさなくなります。)

[7] [CODE(DOMm)@en[[[replaceState]]]] や [CODE(JS)@en[[[document.open]]]]
で[[セッション履歴エントリー]]が置換された場合で [[URL]]
が [CODE(URI)@en[[[about:blank]]]] でなくなった場合、
あるいは [CODE(URI)@en[[[about:blank]]]] のままで[[セッション履歴エントリー]]が置き換わった場合にどう影響するのかは明確ではありません。
[[初期「[CODE(URI)@en[about:blank]]」文書]]であるかどうかの判断が[[文書]]に於けるものか[[セッション履歴エントリー]]に於けるものかで変わってきます。