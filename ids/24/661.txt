[8] [[閲覧文脈の作成]]は、[[窓]]を開くなどの[[利用者]]の操作により、
あるいは [CODE(HTMLe)@en[[[iframe]]]] [[要素]]の挿入などの[[スクリプト]]の操作により、
行われます。

* 仕様書

[REFS[
- [1] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#creating-a-new-browsing-context>'''
- [19] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#attr-iframe-sandbox>
- [25] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#the-sessionstorage-attribute>
- [29] [CITE@en[Upgrade Insecure Requests]] ([TIME[2015-10-07 03:24:10 +09:00]] 版) <https://w3c.github.io/webappsec-upgrade-insecure-requests/#nesting>
]REFS]

* 文脈

[9] 次の場面で[[閲覧文脈の作成]]が呼び出されます。
[FIG(list)[
- 新しい[[窓]]や[[タブ]]を開いた場合
- [[閲覧文脈の選択]]
-- [[the rules for choosing a browsing context given a browsing context name]] 
で新たに[[閲覧文脈]]を開く場合 [SRC[[[HTML Standard]]]]
-- [[ハイパーリンクをたどる]]際に新しい[[閲覧文脈]]を使う場合
-- [[フォームの提出]]で新しい[[閲覧文脈]]を使う場合
-- [CODE(JS)@en[[[window.open]]]] で新しい[[閲覧文脈]]を使う場合
- [[フレーム]]の[[文書への挿入]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[object]]]] [[要素]]で[[閲覧文脈]]を使う場合
- [CODE(HTMLe)@en[[[embed]]]] [[要素]]で[[閲覧文脈]]を使う場合
- [DEL[[CODE(DOMm)@en[[[showModalDialog]]]] [SRC[[[HTML Standard]]]]]]
]FIG]

* 処理

[2] [DFN[[RUBYB[新しい閲覧文脈の作成]@en[create a new browsing context]]]] [SRC[>>1]] は、
次のようにしなければ[['''なりません''']]。
なお作成時には[[閲覧文脈]][VAR[作成子閲覧文脈]]を指定できます。
[FIG(steps)[
= [35] [VAR[作成子文書]]を、[VAR[作成子閲覧文脈]]があればその[F[[[活性文書]]]]、
なければ null に設定します。
= [15] [VAR[文書]]を、新しい[DFN[[RUBYB[初期「[CODE(URI)@en[about:blank]]」[[文書]]]@en[initial "[CODE(URI)@en[about:blank]]" document]]]]に設定します [SRC[>>1]]。
[FIG(list members)[
[FIGCAPTION[
[[文書]]
]FIGCAPTION]
:[[文書の番地]]:[CODE(URI)@en[[[about:blank]]]]
:[[HTML文書]]:[[真]]
:[[文字符号化]]:[[UTF-8]]
:[[ready for post-load tasks]]:[[真]]
:[[completely loaded]]:[[真]]
:[[子供節点]]:[CODE(HTMLe)@en[[[html]]]] [[要素]]。その[[子供]]は
[CODE(HTMLe)@en[[[head]]]] [[要素]]と [CODE(HTMLe)@en[[[body]]]] [[要素]]
(いずれも[[空]])。
]FIG]
= [37] [VAR[作成子文書]]が null なら [SRC[>>1]]、
== [41] [VAR[起源]]を、新しい[[大域的に固有な識別子]]に設定します。
== [39] [VAR[文書]]の[F[[[文書の起源]]]]を、[VAR[起源]]に設定します。
== [40] [VAR[文書]]の[F[[[実効スクリプト起源]]]]を、[VAR[起源]]の[[別名]]に設定します。
= [38] そうでなければ [SRC[>>1]]、
== [42] [VAR[文書]]の[F[[[文書のreferrer]]]]を、[VAR[作成子文書]]の[[文書の番地]]に設定します。
== [43] [VAR[文書]]の[F[[[文書の起源]]]]を、[VAR[作成子文書]]の[F[[[文書の起源]]]]の[[別名]]に設定します。
== [44] [VAR[文書]]の[F[[[実効スクリプト起源]]]]を、[VAR[作成子文書]]の[F[[[実効スクリプト資源]]]]の[[別名]]に設定します。
= [18] [VAR[文書]]について[[砂箱化の実装]]を行います [SRC[>>1]]。
= [17] [[閲覧文脈]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[閲覧文脈]]
]FIGCAPTION]
:入れ子か最上位か:呼び出し元の指定によります。
:[[auxiliary browsing context]] か:呼び出し元の指定によります。
:[[セッション履歴]]:
[FIG(list members)[
[FIGCAPTION[
[45] [[セッション履歴エントリー]]
]FIGCAPTION]
:[F[[[文書]]]]: [VAR[文書]] [SRC[>>1]]
]FIG]
:[F[[[作成子閲覧文脈]]]]: [VAR[作成子閲覧文脈]] [SRC[>>1]]
:[F[[[作成子[CODE(DOMi)@en[Document]]]]]]: [VAR[作成子文書]]
:[[[CODE(HTMLe)@en[iframe]] sandboxing flag set]]:
[CODE(HTMLa)@en[[[sandbox]]]] [[属性]]と [CODE(HTMLa)@en[[[allowfullscreen]]]]
[[属性]]を [[parse the sandboxing directive]]
して得た [[sandboxing flag set]] ([CODE(HTMLe)@en[[[iframe]]]] [[入れ子閲覧文脈]]の場合) 
[SRC[>>19]]。
]FIG]
= [16] 新しい [CODE(DOMi)@en[[[Window]]]] を作成し、[VAR[文書]]と関連付けます [SRC[>>1]]。
= [22] [[最上位閲覧文脈]]の場合、
== [23] 既存の[[閲覧文脈]]の[RUBYB[複製]@en[clone]]の場合は、
[[セッションストレージ領域]]群は元の[[閲覧文脈]]のものの複製とします。
(以後別物と考えます。) [SRC[>>25]]
== [24] 関係する[[文書]]が指定されている場合、
その[[文書の起源]]の[[セッションストレージ領域]]群は元の[[閲覧文脈]]のものの複製とします。
(以後別物と考えます。) [SRC[>>25]]
= [30] [[入れ子閲覧文脈]]の場合、 [SRC[>>29]]
== [31] [[閲覧文脈]]の [[embedding document]] の[[非保安要求ポリシー]]が「格上げする」なら、
=== [32] [[閲覧文脈]]の[[非保安要求ポリシー]]を、「格上げする」に設定します。
=== [33] [[閲覧文脈]]の [[embedding document]] の[[非保安navigate格上げ集合]]の各値について、
[[閲覧文脈]]の[[非保安navigate格上げ集合]]に追加します。
]FIG]

;; [3] [[文書のreferrer]] と [[CSP]] などの [CODE[[[referrer]]]] の指定との関係は不明瞭です。

;; [26] [[閲覧文脈]]の複製というのが具体的にどのような操作なのかは不明です。
そのような [[API]] は無さそうですが、そのような[[利用者]]の操作を実装している
[[Webブラウザー]]があるのかは不明です。

;; [27] 新しい[[閲覧文脈]]に関係する[[文書]]については、[[閲覧文脈の選択]]を参照。
([[閲覧文脈の選択]]によらない場合でも、理論上は [[Webブラウザー]]依存の方法
([[UI]]) から新しい[[閲覧文脈]]を作成した場合で該当することはあるかもしれません。)

;; [20] [[閲覧文脈]]の作成後、 (本作成手順の呼び出し元で) [[閲覧文脈名]]が設定されることになります。

[10] [CODE(DOMi)@en[[[Window]]]] は[[大域オブジェクト]]ですから、
付随して[[環境設定群オブジェクト]]、 [[JavaScript]] 実行環境、
[[Web IDL]] [[インターフェイスオブジェクト]]なども作られます。
この [CODE(DOMi)@en[[[Window]]]] は、 [[navigate]] により次の[[文書]]に再利用されることがあります。

;; [[文書オブジェクトの初期化]]参照。

[11] 本項の初期化手順の後に、[[閲覧文脈]]が使われる各文脈に依存した次の処理が 
(必要なら) 行われます。

[12] [[Webブラウザー]]で新たな[[タブ]]を開いたことによる[[閲覧文脈]]の作成の場合には、
<about:newtab> などの [[Webブラウザー]]依存の初期ページや、
[[利用者]]の設定した[[ホームページ]]へと[[置換有効]]で [[navigate]] されます。

[13] 外部アプリケーションから [[Webブラウザー]]に [[URL]]
を指定して起動 (あるいは[[プロセス間通信]]により [[URL]] を開くことを指示)
した場合には、その [[URL]] へと[[置換有効]]で [[navigate]] されます。

[14] [[お気に入り]]や閲覧[[履歴]]などの [[Webブラウザー]]依存の[[利用者インターフェイス]]を通して
[[URL]] を指定して新しい[[閲覧履歴]]が開かれた場合には、
その [[URL]] へと[[置換有効]]で [[navigate]] されます。

[28] 作成した[[閲覧文脈]]がいつ[[利用者]]に表示されるかは、作成される場面や[[利用者エージェント]]の設計方針により異なります。
[[入れ子閲覧文脈]]の場合は、次の[[レンダリングの更新]]の時点と思われます。
[[最上位閲覧文脈]]の場合は、ただちに表示されるのが普通と思われますが、
敢えてそうしないこともあるかもしれません ([[navigate]] 参照)。

;; [[閲覧文脈の作成]]の呼び出し元で、[[閲覧文脈]]の表示サイズなどの設定が行われることがあります。
[CODE(JS)@en[[[window.open]]]] や[[閲覧文脈の選択]]を参照。

[36] [[閲覧文脈]]は、[DFN[[F[[RUBYB[作成子閲覧文脈]@en[creator browsing context]]]]]]と[DFN[[F[[RUBYB[作成子[CODE(DOM)@en[Document]]]@en[creator [CODE(DOM)@en[Document]]]]]]]]を持ちます。
これらは[[閲覧文脈の作成]]時に (あれば) 設定されます。

* 最初の [CODE(JS)@en[about:blank]] 文書

[4] [[閲覧文脈の作成]]時に作成される[[文書]]は、仕様書中では
「[[閲覧文脈]]作成時に追加された [CODE(URI)@en[[[about:blank]]]] [[文書]]」、
「初期『[CODE(URI)@en[about:blank]]』文書」などと呼ばれます。

[21] [[閲覧文脈]]作成時に[[セッション履歴]]に追加された
[CODE(URI)@en[[[about:blank]]]] [[文書]]は、次の場面で特別に扱われます。
[FIG(short list)[
- [[文書オブジェクトの初期化]]
- [CODE(JS)@en[[[location.assign]]]]
- [CODE(JS)@en[[[document.open]]]]
- [CODE(JS)@en[[[window.open]]]]
- [[フレーム]]
- [CODE(JS)@en[[[history.length]]]]
]FIG]

[5] 初期文書かどうかは、[[置換有効]]で [[navigate]] するかどうかの判断に使われます。
つまり初期文書は当該[[閲覧文脈]]で [[navigate]] が最初に発生した時に[[セッション履歴]]から削除されることになります。

[6] この判断は初期文書かどうか否かで行うので、[[スクリプト]]により内容を操作しているか否かは影響しません。 (ただし [CODE(JS)@en[[[document.open]]]] や
[CODE(DOMm)@en[[[pushState]]]] で[[セッション履歴エントリー]]が新たに追加されていれば、
初期文書が唯一の[[セッション履歴エントリー]]であるとの条件を満たさなくなります。)

[7] [CODE(DOMm)@en[[[replaceState]]]] や [CODE(JS)@en[[[document.open]]]]
で[[セッション履歴エントリー]]が置換された場合で [[URL]]
が [CODE(URI)@en[[[about:blank]]]] でなくなった場合、
あるいは [CODE(URI)@en[[[about:blank]]]] のままで[[セッション履歴エントリー]]が置き換わった場合にどう影響するのかは明確ではありません。
[[初期「[CODE(URI)@en[about:blank]]」文書]]であるかどうかの判断が[[文書]]に於けるものか[[セッション履歴エントリー]]に於けるものかで変わってきます。

* 歴史

[34] [CITE@en[Refactor browsing context creation · whatwg/html@357f649]]
([TIME[2015-12-16 16:04:28 +09:00]] 版)
<https://github.com/whatwg/html/commit/357f649a2fda01b0ae07c3d7643d3123d29a5538>