[2] [DFN[[[stops parsing]]]] は、[[構文解析]]が完了して[[文書]]の準備が完了した際の操作です。

* 仕様書

[REFS[
- [1] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#stop-parsing>
]REFS]

* 処理

[4] [[stops parsing]] は、まず次のようにしなければ[['''なりません''']] [SRC[>>1]]。
[FIG(steps)[
= [5] [[現在文書準備度]]を、 [CODE[[[interactive]]]] に設定します。
= [6] [[挿入点]]を、[[未定義]]に設定します。
= [7] [[開いている要素のスタック]]の[[節点]]をすべて [[pop]] します。
]FIG]

;; [8] [[挿入点]]が未定義になると、以後の [CODE(JS)@en[[[document.write]]]]
は [CODE(JS)@en[[[document.open]]]] を伴うようになります。

;; [9] [[開いている要素のスタック]]から[[節点]]を [[pop]] すると、
副作用で何らかの動作が行われることがあります。[[開いている要素のスタック]]を参照。

[10] 次に、 [[list of scripts that will execute when the document has finished parsing]]
の処理を行います。

;; これは、 [CODE(HTMLa)@en[[[defer]]]] [[属性]]が適用される [CODE(HTMLe)@en[[[script]]]] 
[[要素]]の実行です。

[12] リストが空なら、ただちに次に進まなければ[['''なりません''']] [SRC[>>1]]。

[13] そうでなければ、リストの最初の[[スクリプト]]について、
現在の[[タスク]]と同じ[[タスク源]]の新しい[[タスク]]を追加して、
現在の[[タスク]]は終了しなければ[['''なりません''']] [SRC[>>1]]。
ただし[[タスク]]の追加は、
[FIG(list)[
- [[スクリプト]]の [["ready to be parser-executed" flag]] が設定され、
- [[文書]]が [[has no style sheet that is blocking scripts]] 状態となった
]FIG]
... 時に行わなければ[['''なりません''']] [SRC[>>1]]。

;; これは、 [CODE(HTMLa)@en[[[src]]]] [[属性]]で指定された[[スクリプト]]の取得が終わり、
[[外部スタイルシート]]の読み込みも終わった時を意味しています。

[14] 追加された[[タスク]]は、当該[[スクリプトブロックの実行]]を行ってから、
[[スクリプト]]をリストから削除し、 >>10 に戻るというものです [SRC[>>1]]。

@@...

;; [11] [[HTML Standard]] は [[stops parsing]] を[[イベントループのスピン]]を使って記述していますが、
次の性質から、ここで示したように[[スピン]]を使わないで説明できます。
[FIG(list)[
- [[スピン]]を使った場合と使わないここで示した説明の違いは、
[[大域スクリプト片付けジョブ]]と[[マイクロタスク]]の実行のタイミングと、
[[ストレージミューテックスの解放]]のタイミングです。
- [[構文解析器]]以外の[[タスク]]等がこれらを追加していた場合には、
[[イベントループ]]等により [[stops parsing]] の[[タスク]]より前に実行されているはずです。
- [[スクリプト]]がこれらを追加していた場合には、
[[コールバックを走らせた後の片付け]]により[[スクリプト]]実行直後に実行されているはずです。
[[イベントループ]]が[[ストレージミューテックス]]を取得していた場合も、
ここで解放されているはずです。
- 残るのは、[[構文解析器]]の [[DOM]] 操作により[[マイクロタスク]]が追加されていた場合のみです。
- [[スピン]]を使わない説明の場合、現在の[[タスク]]が停止され[[イベントループ]]に戻ると、
次に[[イベントループ]]によって[[マイクロタスク]]が実行されることになります。
これは結局[[スピン]]の場合と同じです。
]FIG]

* 関連

[3] [[stops parsing]] のかわりに [[abort a parser]] が実行される場合もあります。