* 仕様書

[REFS[
- [50] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-2.2>
- [48] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-3.2>
- [51] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-4.1>
- [52] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-5.1>
- [2] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-5.3>
- [34] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-6.3>
- [59] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-10.5>
- [46] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-10.8>
]REFS]

* 意味

[6] [[エンドポイント]]は、送信能力が限られる時に送信する[[ストリーム]]を選ぶために[[優先度]]を使うことができます。 [SRC[>>2]]

[5] [[エンドポイント]]は、[[優先度]]付けにより、
[[peer]] が[[並行]]する[[ストリーム]]の中で本[[ストリーム]]に[[資源]]を割り当てる際にどの程度優先するべきかを表明できます。 [SRC[>>2]]

[8] 明示的に[[優先度]]を設定すると、[[優先度]]付けの入力として使われますが、
他の[[ストリーム]]に対する相対的な[[ストリーム]]の転送処理順序を保証するわけではありません。
[[優先度]]の表明は提案に過ぎません。 [SRC[>>2]]

[47] なお[[優先度]]の使い方は、[[fingerprinting vector]] です [SRC[>>46]]。

* 設定

[3] [[クライアント]]は、[[ストリーム]]を開く [COCDE[[[HEADERS]]]]
[[フレーム]]に優先度情報を含めることで、新しい[[ストリーム]]に[[優先度]]を設定できます
[SRC[>>2]]。

[4] [CODE[[[PRIORITY]]]] [[フレーム]]を送信することで、[[ストリーム]]の[[優先度]]を変更できます。
[[依存性]]を設定することにより、当該[[ストリーム]]が指定された[[ストリーム]]の[[依存ストリーム]]となります。 [SRC[>>2]]

[9] [[優先度]]情報はメッセージから省略することができ、
既定値 ([[重み]] 16) が使われます [SRC[>>2]]。

* 依存性

[10] [[ストリーム]]には、他の[[ストリーム]]への[RUBYB[[[依存性]]]@en[dependency]]を明示的に指定できます。
[[依存性]]を含めることは、 ([[依存ストリーム]]にではなく) 指定された[[ストリーム]]へと[[資源]]を割り当てたいことを表明します。 [SRC[>>2]]

[11] 他の[[ストリーム]]に依存しない[[ストリーム]]は、[[ストリーム]] [CODE[0x0]]
に依存するものとします。[[重み]] 16 が割り当てられます。
[[ストリーム]] [CODE[0x0]] は[[依存性]]の[[木]]の[[根]]となります。
[SRC[>>2]]

[33] [[pushed stream]] は、初期状態では関連付けられた[[ストリーム]]に依存します。
[[重み]] 16 が割り当てられます。 [SRC[>>2]]

[12] 他の[[ストリーム]]に依存する[[ストリーム]]は、[DFN[[RUBYB[依存ストリーム]@en[dependent stream]]]]です。
他の[[ストリーム]]に依存されている[[ストリーム]]は、
[DFN[[RUBYB[[[親ストリーム]]]@en[parent stream]]]]です。 [SRC[>>2]]

[14] ある[[ストリーム]]が他の[[ストリーム]]に[[依存性]]を割り当てると、
元の[[ストリーム]]が他の[[ストリーム]]の[[親ストリーム]]となります。 [SRC[>>2]]

[16] [[依存性]]の挿入時に[RUBYB[排他的]@en[exclusive]]フラグを設定すると、
その[[ストリーム]]が[[親ストリーム]]の唯一の[[依存ストリーム]]となり、
元の[[依存ストリーム]]は (あれば) 挿入された[[ストリーム]]の[[依存ストリーム]]となります。
[SRC[>>2]]

[15] 同じ[[親ストリーム]]を持つ[[依存ストリーム]]は、
互いに順序を持ちません。 [SRC[>>2]]

[13] [[木]]に属さない[[ストリーム]] ([[idle]] 状態の[[ストリーム]]など)
は、[[既定優先度]] ([[重み]] 16) となります [SRC[>>2]]。

[7] [[親ストリーム]]が[RUBYB[再優先度付け]@en[reprioritize]]されると、
[[依存ストリーム]]も[[親ストリーム]]と共に移動します [SRC[>>2]]。

[18] [[ストリーム]]が自身に依存することはできず、
[[ストリームエラー]] [CODE[[[PROTOCOL_ERROR]]]] としなければ[['''なりません''']]。
[SRC[>>2]]

[19] 祖先の[[ストリーム]]を[[依存ストリーム]]に依存させる場合は、
まずその祖先[[ストリーム]]の[[依存ストリーム]]をその祖先[[ストリーム]]の[[親ストリーム]]へと移動してから、
その祖先[[ストリーム]]の移動を行います。
[[依存性]]の移動を行っても、[[重み]]は変わりません。 [SRC[>>2]]

[49] [CODE(HTTP)@en[[[Upgrade: h2c]]]] により作成される[[ストリーム識別子]]
[CODE[[[1]]]] の[[ストリーム]]は、[[既定優先度]]が割り当てられます [SRC[>>48]]。

* 資源の割り当て

[17] [[依存性]]木における[[依存ストリーム]]には、
その[[親ストリーム]]や[[祖先]]のすべてが閉じられるか、
それ以上の進捗ができなくなったかの場合に限り、
[[資源]]を割り当てる[['''べきです''']] [SRC[>>2]]。

* 重み

[20] [[依存ストリーム]]は、 1 [[以上]] 256 [[以下]]の[[整数]]の[DFN[[RUBYB[重み]@en[weight]]]]が割り当てられます [SRC[>>2]]。 

[21] 同じ[[親ストリーム]]を持つ[[ストリーム]]には、
[[重み]]の比率によって[[資源]]を割り当てる[['''べきです''']] [SRC[>>2]]。

* 削除

[22] [[ストリーム]]が[[依存性]]の[[木]]から削除されると、
[[依存性]]を移動して[[依存ストリーム]]は削除される[[ストリーム]]の[[親ストリーム]]の[[依存ストリーム]]となります。
[[依存性]]の[[重み]]は、削除される[[ストリーム]]の[[重み]]を各[[依存ストリーム]]の[[重み]]で分配した値とします。 [SRC[>>2]]

;; [23] これによって[[優先度]]の情報はいくらか失われることになります。
例えばある[[ストリーム]]の[[依存ストリーム]]間で[[資源]]を共有していた状態でそのいずれかの[[依存ストリーム]]が閉じられると、
開いた[[資源]]はその[[親ストリーム]]の他の[[依存ストリーム]]に割り当てられることになります。
しかし[[親ストリーム]]が変わっていると違った形で再分配されることになります。 [SRC[>>2]]

[24] [[依存性]]で指定された[[ストリーム]]に[[優先度]]が関連付けられていない場合は、
[[既定優先度]] ([[重み]] 16) を割り当てます [SRC[>>2]]。

;; [25] これは意図とは異なるかもしれませんから、好ましくない[[優先度]]付けとなるかもしれません [SRC[>>2]]。

[26] これらの問題を防ぐため、閉じた[[ストリーム]]の[[優先度]]の状態を一定期間保持し続ける[['''べきです''']]。
[SRC[>>2]]

[27] [[idle]] や [[closed]] の状態の[[ストリーム]]にも[[優先度]]を割り当てたり他の[[ストリーム]]の[[親ストリーム]]としたりできますから、
これを[[依存性]]の[[木]]の中で[[ストリーム]]をまとめる[[節点]]を作り、
[[優先度]]を柔軟に表現するために使うことができます。 [SRC[>>2, >>34]]

[28] こうした [CODE[[[SETTINGS_MAX_CONCURRENT_STREAMS]]]] 制限に含まれない[[ストリーム]]の[[優先度]]情報を多数保持するのは大変かもしれませんから、
[[優先度]]を保持する量は制限しても構いません。保持する量は[[負荷]]に依存するかもしれません。 [SRC[>>2]]

;; [29] 極端な場合には、活性の[[ストリーム]]や予約されている[[ストリーム]]の[[優先度]]も捨てることもできます。 [SRC[>>2]]

[30] しかし制限する場合、最低でも [CODE[[[SETTINGS_MAX_CONCURRENT_STREAMS]]]]
分の[[ストリーム]]の状態は保持する[['''べきです''']] [SRC[>>2]]。

[31] 活性の[[ストリーム]]の状態は、保持するよう試みる[['''べきです''']] [SRC[>>2]]。

[32] 閉じた[[ストリーム]]の[[優先度]]を保持している場合は、
[CODE[[[PRIORITY]]]] [[フレーム]]を受信したら、
[[依存ストリーム]]の[[優先度]]を変更する[['''べきです''']] [SRC[>>2]]。

* [CODE(HTTP)@en[PRIORITY]] フレーム

** 意味

[35] [CODE[[[PRIORITY]]]] [[フレーム]] ([[フレーム型]] [CODE[[[0x2]]]])
は、[[ストリーム]]の[[優先度]]について[[送信者]]が[[ヒント]]を示すものです。 [SRC[>>34]]

** 構文

[42] 常に[[ストリーム識別子]]を指定しなければなりません [SRC[>>34]]。
[CODE[[[0x0]]]] を指定することはできません。

[41] [[フラグ]]はありません [SRC[>>34]]。0 でなければ[['''なりません''']] [SRC[>>51]]。
[[受信者]]は無視しなければ[['''なりません''']] [SRC[>>51]]。

[FIG(packet)[
:width:8

= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
]FIG]

[37] [[payload]] は次の欄で構成されます。

[38] [[E]] は、[[ストリーム依存性]]が[[排他的]]かどうかを示す1ビットの[[フラグ]]です
[SRC[>>34]]。

[39] [RUBYB[ストリーム依存性]@en[stream dependency]]は、
この[[ストリーム]]が依存する[[ストリーム]]を表す31ビット[[ストリーム識別子]]
([[ネットワークバイト順]] [SRC[>>50]]) です [SRC[>>34]]。

[40] [RUBYB[重み]@en[weight]]は、[[ストリーム]]の[[優先度]]の[[重み]]を表す[[符号無し]]8ビット[[整数]]です。
1 [[以上]] 256 [[以下]]の値から1引いたものです。 [SRC[>>34]]

[FIG(packet)[
:width:32

= 1 E
= 31 ストリーム依存性
= 8 重み
]FIG]

** 文脈

[36] [[idle]] や [[closed]] を含め、任意の状態の[[ストリーム]]で送信できます [SRC[>>34, >>52]]。

;; [44] ただし [[header block]] 送信の途中には送信できません [SRC[>>34]]。

** 処理

[43] [[受信者]]は、[[ストリーム識別子]]が [CODE[[[0x0]]]] なら、
[[接続エラー]] [CODE[[[PROTOCOL_ERROR]]]] としなければ[['''なりません''']] [SRC[>>34]]。

[45] [[受信者]]は、[[payload]] の長さが 5 以外なら、
[[ストリームエラー]] [CODE[[[FRAME_SIZE_ERROR]]]] としなければ[['''なりません''']]
[SRC[>>34]]。

[53] [[half-closed (local)]] でも受信するかもしれません [SRC[>>52]]。

[58] [CODE[[[PRIORITY]]]] [[フレーム]]は、無駄な処理をさせるために濫用できます。
[[エンドポイント]]は利用状況を監視して制限する[['''べきです''']]。
[[接続エラー]] [CODE[[[ENHANCE_YOUR_CALM]]]] としても構いません。 [SRC[>>59]]

* 歴史

[REFS[
- [1] [CITE@en[Say something rather vague about priority to at least acknowledge it … · whatwg/fetch@600ccb7]]
([TIME[2015-05-11 11:23:34 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/600ccb7e4279a2c795cbba1c93edc53f8a14db03>
]REFS]