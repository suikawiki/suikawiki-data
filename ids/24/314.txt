* 仕様書

[REFS[
- [1] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-4>
]REFS]

* クライアントの動作

[2] [[クライアント]]は、[DFN[[RUBYB[WebSocket接続の確立]@en[Establish a WebSocket Connection]]]]で、
次のようにします [SRC[>>1]]。

[8] この手順は、入力として [[URL]] を受け取ります。

[7] この手順は、[DFN[[RUBYB[WebSocket接続失敗]@en[Fail the WebSocket Connection]]]] [SRC[>>1]]
を返すことがあります。

[FIG(steps)[
= 入力として与えられた [[URL]] を [CODE(URI)@en[[[ws:]]]]/[CODE(URI)@en[[[wss:]]]] [[URL]]
として解釈し、[[ホスト]]、[[ポート]]、[[資源名]]、[[「保安」]]フラグを得ます。
= 前項が失敗したら、[[WebSocket接続失敗]]を返し、停止します。
= 他の接続を待ちます (>>3)。
= [[プロキシ]]を使うかどうかを決定します。[[ホスト]]、[[ポート]]、[[資源名]]、[[「保安」]]フラグを使います。
= [[プロキシ]]を使う場合は、
== 当該[[ホスト]]、[[ポート]]への [[TCP接続]]を開くよう[[プロキシ]]に接続して要求する[['''べき''']]です。
= そうでない場合は、
== 当該[[ホスト]]、[[ポート]]への [[TCP接続]]を開く[['''べきです''']]。
= [[TCP接続]]を開くのに失敗したり、[[プロキシ]]がエラーを返したりした時は、
[[WebSocket接続失敗]]を返し、停止します。
= [[「保安」]]フラグが設定されていれば、
== [[RFC 2818]] [[HTTPS]] の方法で [[TLS handshake]] を行います。[[SNI]] を使わなければ[['''なりません''']]。
== 失敗したら、[[WebSocket接続失敗]]を返し、停止します。
]FIG]

[3] 他の接続を待つ場合は、次のようにしなければ[['''なりません''']] [SRC[>>1]]。
[FIG(steps)[
= [[ホスト]]から、 [[IPアドレス]]を得ます。
= [[ホスト]]から[[IPアドレス]]を得られない場合 (例えば[[名前解決]]を[[プロキシ]]に委ねている場合)、
== [VAR[host]] を、[[ホスト]]に設定します。
== [VAR[n]] を、十分小さな値とする[['''べきです''']]。例えば開いている[[タブ]]数を考慮して決めます。
= それ以外の場合、
== [VAR[host]] を、[[IPアドレス]]に設定します。
== [VAR[n]] を、1 に設定します。
= 同じ [VAR[host]] と[[ポート]]への[[WebSocket接続]]があるか調べます。
= その数が [VAR[n]] [[未満]]となるまで、待ちます。
]FIG]

;; [4] この制限は、[[著者]]が多数の [[WebSocket接続]]を開いて [[DoS攻撃]]することを難しくするためのものです
[SRC[>>1]]。

[6] [[プロキシ自動設定スクリプト]]に渡す [[URL]] は、
[[ホスト]]、[[ポート]]、[[資源名]]、[[「保安」]]フラグ ([CODE(URI)@en[[[ws:]]]] or [CODE(URI)@en[[[wss:]]]])
から構築します [SRC[>>1]]。

[5] [[WebSocket]] 用の[[プロキシ]]の設定を設けていない場合は、
[[SOCKS5]]、[[HTTPS]] 用、[[HTTP]] 用の優先順で[[プロキシ]]を選択することが[RUBYB[推奨]@en[encourage]]されています [SRC[>>1]]。

[9] [[TLS]] を使う場合 [[SNI]] が必須とされていますが、[[ホスト]]が [[IPアドレス]]で指定された時どうしなければならないのかは不明です。
