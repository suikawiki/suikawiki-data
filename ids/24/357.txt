[25] [DFN[[CODE(HTTP)@en[[[RST_STREAM]]]]]] [[フレーム]]は、
[[ストリームエラー]]その他の理由で[[ストリーム]]を終了させることを表します。

* 仕様書

[REFS[
- [17] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-2.2>
- [18] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-4.1>
- [19] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-5.1>
- [13] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-5.4.2>
- [1] '''[CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-6.4>'''
- [27] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-8.3>
- [36] [CITE@en-US[Fetch Standard]] ([TIME[2016-03-25 18:55:45 +09:00]] 版) <https://fetch.spec.whatwg.org/#concept-http-fetch>
]REFS]

* 意味

[2] [CODE[[[RST_STREAM]]]] [[フレーム]] ([[フレーム型]] [CODE[[[0x3]]]])
は、[[ストリーム]]を直ちに終わらせるものです [SRC[>>1]]。

[35] [CODE[[[END_STREAM]]]] [[フラグ]]とは違って、異常終了を表します。
おおよそいつでも送信できます。

* 構文

[8] [[ストリーム識別子]]を指定しなければ[['''なりません''']] [SRC[>>1]]。
[CODE[[[0x0]]]] は指定できません。

;; [30] [[接続]]を閉じるときは [CODE(HTTP)@en[[[GOAWAY]]]] [[フレーム]]を使います。

[6] [[フラグ]]はありません [SRC[>>1]]。 0 でなければ[['''なりません''']] [SRC[>>18]]。
[[受信者]]は無視しなければ[['''なりません''']] [SRC[>>18]]。

[FIG(packet)[
:width:8

= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
= 1 0
]FIG]

[4] [[payload]] は、次の欄を含みます。
[FIG(list members)[
:[5] [RUBYB[[[誤り符号]]]@en[Error Code]]:
[[符号無し]]32ビット[[整数]]
([[ネットワークバイト順]] [SRC[>>17]]) で[[誤り符号]]を表します [SRC[>>1]]。
[[誤り符号]]は、[[ストリーム]]を終わらせる理由を表します [SRC[>>1]]。
]FIG]

[FIG(packet)[
:width:32

= 32 誤り符号
]FIG]

* 文脈

[3] [CODE[[[RST_STREAM]]]] [[フレーム]]は、[[ストリームエラー]]の際に送信されます [SRC[>>13]]。

[10] [[idle]] 状態の[[ストリーム]]に送信しては[['''なりません''']] [SRC[>>1, >>19]]。
その他の状態の[[ストリーム]]で送信できます。ほとんどいつでも送信できますが、
(他の[[ストリーム]]も含めて) [CODE[[[CONTINUATION]]]] [[フレーム]]が送られるべき位置で送ることはできません。

[14] 受信した [CODE[[[RST_STREAM]]]] [[フレーム]]に対して
[CODE[[[RST_STREAM]]]] [[フレーム]]を送信しては[['''なりません''']] [SRC[>>13]]。

[20] [[reserved (local)]] 状態の[[ストリーム]]について、
予約解除のために使うことができます [SRC[>>19]]。

[15] [[フロー制御]]の都合で送信されることがります。

[16] [[クライアント]]からの[[要求]]の送信途中で[[サーバー]]がもう[[要求]]の続きは不要であることを示すために
[CODE[[[RST_STREAM]]]] を送信することができます。

;; [[HTTP応答]]を参照。

[26] [[サーバープッシュ]]が不要と示すために、 [CODE(HTTP)@en[[[RST_STREAM]]]]
を送信することができます。

;; [[サーバープッシュ]]を参照。

[22] [CODE[[[RST_STREAM]]]] [[フレーム]]を送信した直後は、通常の [[closed]]
状態とは異なり、一部の[[フレーム]]を部分的にのみ処理したり、無視したりします [SRC[>>19]]。
いずれにせよ、受信する準備をしておかなければ[['''なりません''']] [SRC[>>13]]。

[24] [CODE(HTTP)@en[[[RST_STREAM]]]] [[フレーム]]を複数回送信する[['''べきではありません''']]。
ただし [[closed]] になった後 1[[RTT]] を経過しても[[フレーム]]を受信し続ける場合を除きます。
[SRC[>>13]]

;; [[ストリーム]]の状態遷移の項を参照。

[28] [CODE(HTTP)@en[[[CONNECT]]]] では、[[TCP]] [CODE[[[RST]]]] などのエラーに相当します。

;; [CODE(HTTP)@en[[[CONNECT]]]] 参照。

[37] [CODE(HTTP)[303]] を除く [[HTTPリダイレクト]]の受領直後に[[クライアント]]が
[CODE(HTTP)[RST_STREAM]] を送信することが[RUBYB[推奨]@en[encourage]]されています [SRC[>>36]]。

* 処理

[9] [[受信者]]は、[[ストリーム識別子]]が [CODE[[[0x0]]]] なら、
[[接続エラー]] [CODE[[[PROTOCOL_ERROR]]]] としなければ[['''なりません''']] [SRC[>>1]]。

[34] [[ストリーム]]の状態遷移の項も参照。

[11] [[受信者]]は、[[ストリーム]]が [[idle]] 状態なら、
[[接続エラー]] [CODE[[[PROTOCOL_ERROR]]]] としなければ[['''なりません''']] [SRC[>>1]]。

[33] [[Chrome]] も [[Firefox]] も、未使用 ([[idle]]) の[[ストリーム]]の
[CODE[[[RST_STREAM]]]] を受信しても、エラーとはしません。 [TIME[2015-10-10T11:58:17.300Z]]

[31] [[Firefox]] は [CODE[[[HEADERS]]]] より前に [CODE[[[RST_STREAM]]]]
を受信したら[[接続エラー]] [CODE[[[PROTOCOL_ERROR]]]] とするようです。
([[Chrome]] は何も送信しません。) 自身が [CODE[[[HEADERS]]]]
を送信したら [[open]] 状態になっているはずなので、[[接続エラー]]とするのは不審です。
[TIME[2015-10-10T11:42:35.00Z]]

[12] [[受信者]]は、[[payload]] の長さが 4 以外なら、
[[接続エラー]] [CODE[[[FRAME_SIZE_ERROR]]]] としなければ[['''なりません''']] [SRC[>>1]]。

[7] 指定された[[ストリーム]]を [[closed]] 状態へと移行させます [SRC[>>19]]。
[[受信者]]は、以後 [CODE[[[PRIORITY]]]] 以外の[[フレーム]]を送信しては[['''なりません''']]
[SRC[>>1]]。しかし[[送信者]]はなおも受信する準備をしなければ[['''なりません''']]
[SRC[>>1]]。

[32] [CODE[[[END_HEADERS]]]] より後で [CODE[[[END_STREAM]]]] より前に
[CODE[[[RST_STREAM]]]] を受信すると、[[Firefox]] も [[Chrome]]
も[[ネットワークエラー]]とします。その [CODE[[[RST_STREAM]]]]
やそれ以後の同じ[[ストリーム]]の[[フレーム]]は無視するようです。 [TIME[2015-10-10T11:53:35.600Z]]

[23] [[closed]] 状態で受信した [CODE(HTTP)@en[[[RST_STREAM]]]] は、
状況によって無視したり、エラーとしたりします [SRC[>>19]]。

* 関連

[29] [[TCP]] の [CODE[[[RST]]]] や [[TLS]] の [[error alert]] と役割が似ています。

* 歴史

[21] [CITE@en[Allow user agents to transmit RST_STREAM upon seeing a redirect · whatwg/fetch@af0dc92]]
([TIME[2016-03-26 11:55:58 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/af0dc923f7636751996a9762309904511725a1a7>