[1] 本項で言う[DFN[下位層の接続]]とは、 [[TCP]] の[[接続]]やそれに類するものを言います。
[[信頼性]]のある[[全二重]]の[[バイト列]]の[[輸送路]]です。

* プロトコル

[2] 次のような具体的な[[プロトコル]]があります。
[FIG(short list)[
- [[TCP]]
- [[TLS]]
- [[HTTP/1.x]] [CODE(HTTP)@en[[[CONNECT]]]]
- [[HTTP/2]] [CODE(HTTP)@en[[[CONNECT]]]]
- [[SOCKS]]
- [[Unix domain socket]]
]FIG]

* 状態と API

[3] [[接続]]の端点は、次の状態を持ちます。
[FIG(list members)[
:送信閉じ済みフラグ:初期状態では未設定。
:受信閉じ済みフラグ:初期状態では未設定。
]FIG]

[4] [[接続]]の端点は、[[アプリケーション]]に対して次の通知を行います。
[FIG(list)[
- [[バイト]]の受信の通知
- 正常終了の受信の通知
- 異常終了の通知
- 送信するものが無くなったことの通知
]FIG]

[5] [[バイト]]の受信の通知は、[[バイト]]の値と、[[緊急データ]]フラグを持ちます。
[[緊急データ]]フラグの既定値は、未設定です。

[14] 異常終了の通知は、リセットフラグが設定されることがあります。既定値は未設定です。

[6] [[アプリケーション]]は、[[接続]]の端点に次の指示を行えます。
[FIG(list)[
- [[バイト]]の送信の指示
- 正常終了の送信の指示
- 異常終了の送信の指示
- 受信終了の指示
]FIG]

[7] [[バイト]]の送信の指示は、[[バイト]]の値と、[[緊急データ]]か否かのフラグを[[引数]]として受け取ります。

* TCP の場合

[8] [[TCP]] の[[セグメント]]を受信したら、次のようにします。
[FIG(steps)[
= [CODE[[[RST]]]] フラグが設定されていれば、
== 送信閉じ済みフラグが設定されていなければ、
=== 送信閉じ済みフラグを設定します。
== 受信閉じ済みフラグが設定されていなければ、
=== 受信閉じ済みフラグを設定します。
=== 異常終了の通知を行います。リセットフラグを設定します。
= 受信閉じ済みフラグが設定されていなければ、
== データの各[[バイト]]について、順に、
=== [[バイト]]の受信の通知を行います。当該[[バイト]]の値を渡します。
[[緊急ポインター]]が本[[バイト]]を指していれば、[[緊急データ]]フラグも設定します。
= [CODE[[[FIN]]]] フラグが設定されていれば、
== 受信閉じ済みフラグが設定されていなければ、
=== 受信閉じ済みフラグを設定します。
=== 正常終了の受信の通知を行います。
]FIG]

[9] [[タイムアウト]]その他の理由で[[接続]]が利用できないことを検知したら、
次のようにします。
[FIG(steps)[
= 送信閉じ済みフラグが設定されていなければ、
== 送信閉じ済みフラグを設定します。
= 受信閉じ済みフラグが設定されていなければ、
== 受信閉じ済みフラグを設定します。
== 異常終了の通知を行います。
]FIG]

[10] [[バイト]]送信の指示があれば、次のようにします。
[FIG(steps)[
= 送信閉じ済みフラグが設定されていれば、
== エラーを返し、停止します。
= [[緊急データ]]フラグが設定されていれば、
== 指定された[[バイト]]をデータとして含み、[[緊急ポインター]]が当該[[バイト]]を指す[[セグメント]]を送信することにします。
= それ以外なら、
== 指定された[[バイト]]をデータとして含む[[セグメント]]を送信することにします。
]FIG]

;; [11] 実際の送信時には、前後の[[バイト]]とまとめた[[セグメント]]で送信されたり、
必要に応じて[[再送]]されたりします。

[12] 正常終了の送信の指示があれば、次のようにします。
[FIG(steps)[
= 送信閉じ済みフラグが設定されていなければ、
== 送信閉じ済みフラグを設定します。
== [CODE[[[FIN]]]] フラグが設定された[[セグメント]]を送信することにします。
]FIG]

[13] 異常終了の送信の指示があれば、次のようにします。
[FIG(steps)[
= 送信閉じ済みフラグと受信閉じ済みフラグの一方または両方が未設定なら、
== [CODE[[[RST]]]] フラグが設定された[[セグメント]]を送信することにします。
= 送信閉じ済みフラグが設定されていなければ、
== 送信閉じ済みフラグを設定します。
= 受信閉じ済みフラグが設定されていなければ、
== 受信閉じ済みフラグを設定します。
== 異常終了の通知を行います。
]FIG]

@@ 受信終了の指示

@@ 送るものがなくなった通知

* TLS の場合

[15] 異常終了が通知されたら、異常終了を通知します。

* HTTP [CODE(HTTP)@en[CONNECT]] の場合

[16] 異常終了が通知されたら、異常終了を通知します。