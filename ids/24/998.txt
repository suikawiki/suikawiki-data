[1] 本項で言う[DFN[下位層の接続]]とは、 [[TCP]] の[[接続]]やそれに類するものを言います。
[[信頼性]]のある[[全二重]]の[[バイナリー]]の[[輸送路]]です。

* プロトコル

[2] 次のような具体的な[[プロトコル]]があります。
[FIG(short list)[
- [[TCP]]
- [[TLS]]
- [[HTTP/1.x]] [CODE(HTTP)@en[[[CONNECT]]]]
- [[HTTP/2]] [CODE(HTTP)@en[[[CONNECT]]]]
- [[SOCKS]]
- [[Unix domain socket]]
]FIG]

* 状態と API

[3] [[接続]]の端点は、次の状態を持ちます。
[FIG(list members)[
:送信閉じ済みフラグ:初期状態では未設定。
:受信閉じ済みフラグ:初期状態では未設定。
]FIG]

[4] [[接続]]の端点は、[[アプリケーション]]に対して次の通知を行います。
[FIG(list)[
- [[バイト]]の受信の通知
- 正常終了の受信の通知
- 異常終了の受信の通知
]FIG]

[5] [[バイト]]の受信の通知は、[[バイト]]の値と、[[緊急データ]]か否かのフラグを[[アプリケーション]]に渡します。

[6] [[アプリケーション]]は、[[接続]]の端点に次の指示を行えます。
[FIG(list)[
- [[バイト]]の送信の指示
- 正常終了の送信の指示
- 異常終了の送信の指示
]FIG]

[7] [[バイト]]の送信の指示は、[[バイト]]の値と、[[緊急データ]]か否かのフラグを[[引数]]として受け取ります。

* TCP の場合

[8] [[TCP]] の[[セグメント]]を受信したら、次のようにします。
[FIG(steps)[
= [CODE[[[RST]]]] フラグが設定されていれば、
== 送信閉じ済みフラグが設定されていなければ、
=== 送信閉じ済みフラグを設定します。
== 受信閉じ済みフラグが設定されていなければ、
=== 受信閉じ済みフラグを設定します。
== 異常終了の受信の通知を行います。
= データの各[[バイト]]について、順に、
== [[バイト]]の受信の通知を行います。当該[[バイト]]の値を渡します。
[[緊急ポインター]]が本[[バイト]]を指していれば、[[緊急データ]]フラグも設定します。
= [CODE[[[FIN]]]] フラグが設定されていれば、
== 受信閉じ済みフラグが設定されていなければ、
=== 受信閉じ済みフラグを設定します。
=== 正常終了の受信の通知を行います。
]FIG]