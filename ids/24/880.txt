* 仕様書

[REFS[
- [2] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#sharedworker>
]REFS]

* 状態

[1] [CODE(DOMi)@en[[[EventTarget]]]] の状態に加えて、次の状態があります。
[FIG(list members)[
:関連付けられた[[ワーカー]]:
:[CODE(DOMa)@en[[[port]]]]:
]FIG]

* 構築子

[3] [[構築子]]は、次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [4] 必須の [CODE(DOMi)@en[[[DOMString]]]] と省略可能な [CODE(DOMi)@en[[[DOMString]]]]
の2つの[[引数]]が指定されたものと解釈します。
= [15] 第2引数が指定されていなければ、[[空文字列]]とします。
= [5] [[利用者エージェント]]の方針次第で [CODE(DOMe)@en[[[SecurityError]]]]
[[例外]]を[[投げ]]て停止して構いません。
= [6] 第1引数の[[URLの解決]]を行います [SRC[>>2]]。
([[入口設定群オブジェクト]]の[[API基底URL]]を使うと思われますが、明記されていません。)
= [7] 失敗なら、[CODE(DOMe)@en[[[SyntaxError]]]] [[例外]]を[[投げ]]て停止します。
= [8] [[URL scheme]] が [CODE(URI)@en[[[data:]]]] 以外で [[URLの起源]]が[[現職設定群オブジェクト]]の[[起源]]と[[同じ起源]]でないなら、
== [9] [CODE(DOMe)@en[[[SecurityError]]]] [[例外]]を[[投げ]]て停止します。
= [10] [[現職設定群オブジェクト]]から [[relevant [CODE(DOMi)@en[Document]] objects to add]]
を得ます。
= [12] [CODE(DOMi)@en[[[SharedWorker]]]] を作成します。
= [13] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[[所有者]]は[[現職設定群オブジェクト]]とします。
= [14] [CODE(DOMi)@en[[[SharedWorker]]]] の [CODE(DOMa)@en[[[port]]]] を、この
[CODE(DOMi)@en[[[MessagePort]]]] に設定します。
= [11] [[原子的]]に:
== [16] 
[FIG(list)[
- [58] 次のいずれかの場合で:
-- [17] 第2引数が非[[空文字列]]で、次のような [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] がある
--- [19] [[closing flag]] が[[偽]]で、
--- [20] [CODE(DOMa)@en[[[name]]]] が第2引数と等しく、
--- [21] それが[[大域オブジェクト]]である[[環境設定群オブジェクト]]の[[起源]]が、
第1引数を[[解決]]して得た [[URLの起源]]と[[同じ起源]]
-- [24] 第2引数が[[空文字列]]で、次のような [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] がある
--- [26] [[closing flag]] が[[偽]]で、
--- [27] [CODE(DOMa)@en[[[name]]]] が第2引数と等しく、
--- [28] [CODE(DOMa)@en[[[location]]]] の [[URL]] が第1引数を[[解決]]して得た[[絶対URL]]
と完全に等しい
- [30] [[利用者エージェント]]がその [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
を[[現職設定群オブジェクト]]の[[スクリプト]]がアクセスしないよう設定されている
(例えば開発モード) 場合で''ない''なら、
]FIG]
=== [33] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] の [CODE(DOMa)@en[[[location]]]] 
の [[URL]] が第1引数を[[解決]]して得た[[絶対URL]] と完全に等しく''ない''なら、
==== [34] [CODE(DOMe)@en[[[URLMismatchError]]]] [[例外]]を[[投げ]]、停止します。
=== [22] 見つかった [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] を使います。
=== [36] [CODE(DOMi)@en[[[SharedWorker]]]] と [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
を関連付けます。
=== [37] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[[所有者]]は、 [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] が[[大域オブジェクト]]である[[環境設定群オブジェクト]]とします。
=== [38] 2つの [CODE(DOMi)@en[[[MessagePort]]]] を [[entangle]] します。
=== [55] 完了の処理を行います (>>56)。
=== [44] [CODE(DOMi)@en[[[SharedWorker]]]] を返し、ここで停止します。
== [32] それ以外なら、
=== [45] 新しい [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] を作成します。
=== [46] [[ワーカー環境設定群オブジェクトを設定]]し、 [[環境設定群オブジェクト]]を得ます。
[[解決]]して得られた [[URL]] と作成した [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] を使います。
=== [47] [CODE(DOMi)@en[[[SharedWorker]]]] と [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
を関連付けます。
=== [48] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] の [CODE(DOMa)@en[[[name]]]]
を、第2引数に設定します。
=== [49] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[[所有者]]は、[[環境設定群オブジェクト]]とします。
=== [50] 2つの [CODE(DOMi)@en[[[MessagePort]]]] を [[entangle]] します。
= [51] [CODE(DOMi)@en[[[SharedWorker]]]] を返します。
]FIG]

[52] 新たに [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] を作成した場合、
更に[[並列に]]次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [53] 完了の処理を行います (>>56)。
= [54] [[解決]]して得られた [[URL]] と先程作成した[[環境設定群オブジェクト]]、 
[[現職設定群オブジェクト]]の [[referrer source]] を使って、 [[run a worker]] を実行します。
]FIG]

[56] 完了の処理とは、次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [39] [[イベント]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[イベント]]
]FIGCAPTION]
:[[インターフェイス]]:[CODE(DOMi)@en[[[MessageEvent]]]]
:[[イベント型]]:[CODE(DOMe)@en[[[connect]]]]
:[[対象]]:[CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
:[[trusted]]:[[真]]
:[[bubbles]]:[[偽]]
:[[取消可能]]:[[偽]]
:[CODE(DOMa)@en[[[data]]]]:[[空文字列]]
:[CODE(DOMa)@en[[[ports]]]]:後から作成した [CODE(DOMi)@en[[[MessagePort]]]]
のみの [[read only array]]
:[CODE(DOMa)@en[[[source]]]]:後から作成した [CODE(DOMi)@en[[[MessagePort]]]]
:[[既定動作]]:なし
]FIG]
= [40] [[タスクをキューに追加]]します。
[FIG(list members)[
[FIGCAPTION[
[[タスク]]
]FIGCAPTION]
:[[タスク源]]:[[DOM操作タスク源]]
:操作:
[FIG(steps)[
= [57] 作成した[[イベント]]を[[dispatch]]します。
]FIG]
]FIG]
= [41] 先程得た[[文書]]群を、 [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
の[[ワーカーの[CODE(DOMi)@en[Document]]群]]に追加します。
= [42] [[現職設定群オブジェクト]]の[[大域オブジェクト]]が
[CODE(DOMi)@en[[[WorkerGlobalScope]]]] なら、
== [43] [[現職設定群オブジェクト]]の[[大域オブジェクト]]の[[ワーカーのワーカー群]]に
[CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] を追加します。
]FIG]
