* 仕様書

[REFS[
- [2] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#sharedworker>'''
- [23] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-11-04 19:30:07 +09:00]] 版) <https://html.spec.whatwg.org/#concept-sharedworkerglobalscope-name>
- [35] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-11-04 19:30:07 +09:00]] 版) <https://html.spec.whatwg.org/#dom-sharedworkerglobalscope-name>
]REFS]

* 状態

[1] [CODE(DOMi)@en[[[SharedWorker]]]] には、
[CODE(DOMi)@en[[[EventTarget]]]] の状態に加えて、次の状態があります。
[FIG(list members)[
:関連付けられた[[ワーカー]]:
:[CODE(DOMa)@en[[[port]]]]:
]FIG]

[18] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] の状態は、
[CODE(DOMi)@en[[[WorkerGlobalScope]]]] 参照。

* 名前

[25] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] は、
[DFN[[F[[RUBYB[[[名前]]]@en[name]]]]]]を持ちます [SRC[>>23]]。
これは [CODE(DOMi)@en[[[SharedWorker]]]] [[構築子]]で[[共有ワーカー]]を作成した時に指定された名前を表します
[SRC[>>35]]。

[59] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] [[オブジェクト]]の
[DFN[[CODE(DOMa)@en[[[name]]]]]] [[IDL属性]]は、
[F[[[名前]]]]を返さなければ[['''なりません''']] [SRC[>>35]]。

* 構築子

[3] [[構築子]]は、次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [4] 必須の [CODE(DOMi)@en[[[DOMString]]]] と省略可能な [CODE(DOMi)@en[[[DOMString]]]]
(既定値は[[空文字列]]。) の2つの[[引数]]が指定されたものと解釈します。
= [5] [[利用者エージェント]]の方針次第で [CODE(DOMe)@en[[[SecurityError]]]]
[[例外]]を[[投げ]]て停止して構いません。
= [6] [VAR[URL]]を、第1引数の[[URLの解決]]の結果とします [SRC[>>2]]。
([[入口設定群オブジェクト]]の[[API基底URL]]を使うと思われますが、明記されていません。)
= [7] [VAR[URL]]が失敗なら、
== [21] [CODE(DOMe)@en[[[SyntaxError]]]] [[例外]]を[[投げ]]て停止します。
= [10] [[現職設定群オブジェクト]]から [[relevant [CODE(DOMi)@en[Document]] objects to add]]
を得ます。
= [12] [CODE(DOMi)@en[[[SharedWorker]]]] を作成します。
= [13] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[F[[[所有者]]]]は[[現職設定群オブジェクト]]とします。
= [14] [CODE(DOMi)@en[[[SharedWorker]]]] の [CODE(DOMa)@en[[[port]]]] を、この
[CODE(DOMi)@en[[[MessagePort]]]] に設定します。
= [11] [[原子的]]に:
== [16] 
[FIG(list)[
- [17] 次のような [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] があり、
-- [19] [F[[[closing flag]]]] が[[偽]]で、
-- [20] [F[[[ワーカーの名前]]]]が第2引数と等しく、
-- [28] [F[[[構築子URL]]]]が第1引数を[[解決]]して得た[[絶対URL]]と完全に等しい
- [30] [[利用者エージェント]]がその [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]]
を[[現職設定群オブジェクト]]の[[スクリプト]]がアクセスしないよう設定されている
(例えば開発モード) 場合で''ない''なら、
]FIG]
=== [22] [VAR[大域オブジェクト]]を、見つかった [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] に設定します。
=== [36] [CODE(DOMi)@en[[[SharedWorker]]]] と[VAR[大域オブジェクト]]を関連付けます。
=== [37] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[F[[[所有者]]]]は、[VAR[大域オブジェクト]]が[F[[[大域オブジェクト]]]]である[[環境設定群オブジェクト]]とします。
=== [38] 2つの [CODE(DOMi)@en[[[MessagePort]]]] を [[entangle]] します。
=== [55] 完了の処理を行います (>>56)。
=== [44] [CODE(DOMi)@en[[[SharedWorker]]]] を返し、ここで停止します。
== [32] それ以外なら、
=== [45] [VAR[大域オブジェクト]]を、
新しい [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] に設定します。
=== [46] [VAR[[[環境設定群オブジェクト]]]]を、
[VAR[大域オブジェクト]]について[[ワーカー環境設定群オブジェクトを設定]]した結果とします。
=== [47] [CODE(DOMi)@en[[[SharedWorker]]]] と[VAR[大域オブジェクト]]を関連付けます。
=== [15] [VAR[大域オブジェクト]]の[F[[[構築子URL]]]]を、[VAR[[[URL]]]] に設定します。
=== [48] [VAR[大域オブジェクト]]の[F[[[ワーカーの名前]]]]を、第2引数の値に設定します。
=== [49] [CODE(DOMi)@en[[[MessagePort]]]] を作成します。
[F[[[所有者]]]]は、[[環境設定群オブジェクト]]とします。
=== [50] 2つの [CODE(DOMi)@en[[[MessagePort]]]] を [[entangle]] します。
= [51] [CODE(DOMi)@en[[[SharedWorker]]]] を返します。
]FIG]

[29] [CODE(DOMi)@en[[[SharedWorkerGlobalScope]]]] は、
[DFN[[F[[RUBYB[[[構築子URL]]]@en[constructor url]]]]]]を持ちます [SRC[>>23]]。
これは以後の[[構築子]]呼び出し時の比較のために用いられます。

;; 通常は[[ワーカーのURL]]と一致しますが、[[リダイレクト]]等により異なる値となるかしれません。

[52] 新たに[VAR[大域オブジェクト]]を作成した場合、
更に[[並列に]]次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [53] 完了の処理を行います (>>56)。
= [54] [VAR[[[URL]]]] と[VAR[[[環境設定群オブジェクト]]]]を使い、 
[[現職設定群オブジェクト]]の[F[[[作成URL]]]]を [[referrer]] として、
[[run a worker]] を実行します。
]FIG]

[56] 完了の処理とは、次のようにしなければ[['''なりません''']] [SRC[>>2]]。
[FIG(steps)[
= [39] [[イベント]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[イベント]]
]FIGCAPTION]
:[[インターフェイス]]:[CODE(DOMi)@en[[[MessageEvent]]]]
:[[イベント型]]:[CODE(DOMe)@en[[[connect]]]]
:[[対象]]: [VAR[大域オブジェクト]]
:[[trusted]]:[[真]]
:[[bubbles]]:[[偽]]
:[[取消可能]]:[[偽]]
:[CODE(DOMa)@en[[[data]]]]:[[空文字列]]
:[CODE(DOMa)@en[[[ports]]]]:後から作成した [CODE(DOMi)@en[[[MessagePort]]]]
のみの [[read only array]]
:[CODE(DOMa)@en[[[source]]]]:後から作成した [CODE(DOMi)@en[[[MessagePort]]]]
:[[既定動作]]:なし
]FIG]
= [40] [[タスクをキューに追加]]します。
[FIG(list members)[
[FIGCAPTION[
[[タスク]]
]FIGCAPTION]
:[[タスク源]]:[[DOM操作タスク源]]
:操作:
[FIG(steps)[
= [57] 作成した[[イベント]]を[[dispatch]]します。
]FIG]
]FIG]
= [41] 先程得た[[文書]]群を、[VAR[大域オブジェクト]]の[F[[[ワーカーの[CODE(DOMi)@en[Document]]群]]]]に追加します。
= [42] [[現職設定群オブジェクト]]の[F[[[大域オブジェクト]]]]が
[CODE(DOMi)@en[[[WorkerGlobalScope]]]] なら、
== [43] [[現職設定群オブジェクト]]の[F[[[大域オブジェクト]]]]の[F[[[ワーカーのワーカー群]]]]に[VAR[大域オブジェクト]]を追加します。
]FIG]

* 歴史

[31] [CITE@en[Give workers a base URL and clean up shared workers · whatwg/html@b620471]] ([TIME[2015-11-06 20:41:00 +09:00]] 版) <https://github.com/whatwg/html/commit/b620471ff823e8e6507b077cf0785a530762f5e3>

[60] [CITE@en[Make shared workers always key on constructor url and name · whatwg/html@b261d16]] ([TIME[2015-11-06 22:29:32 +09:00]] 版) <https://github.com/whatwg/html/commit/b261d162b451a646d5597689f0b831a722a19182>

[8] [CITE@en[Fix #337: perform origin checks for workers in Fetch · whatwg/html@e86b2e4]] ([TIME[2015-11-19 16:22:56 +09:00]] 版) <https://github.com/whatwg/html/commit/e86b2e4b8fdef45404c61c1a85c40da7edf8b561>