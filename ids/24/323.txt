* 仕様書

[REFS[
- [1] '''[CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-5.5.2>'''
- [7] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#ping-and-pong-frames>
]REFS]

* 構文

[2] [CODE[[[opcode]]]] は、 [CODE[[[0x9]]]] です [SRC[>>1]]。
[[Pingフレーム]]は、[[制御フレーム]]です。

[3] [[応用データ]]を含めて構いません [SRC[>>1]]。
[[応用データ]]は特に規定がなく、任意のバイト列で良いようです。
ただし[[制御フレーム]]の長さ制限から、125バイト以下でなければなりません。

* 文脈

[5] [[WebSocket接続の確立]]の後、任意の時機に送信できます [SRC[>>1]]。

;; [6] [[keepalive]] としても、相手がまだ反応するか検証する手段としても使えます [SRC[>>1]]。

[8] [[利用者エージェント]]は、必要に応じて ([[NAT]] に[[接続]]を保持させるため、
[[接続]]の切断を検出するためなどの目的で) [[Pingフレーム]]を送信して構いません [SRC[>>7]]。
しかし[[サーバー]]を助ける目的で送信しては[['''なりません''']] [SRC[>>7]]。

;; [[サーバー]]は必要があるなら自身で適宜送信するべきです。

;; [9] これは [[fingerprinting vector]] かもしれません。

[16] [[Chrome]] も [[Firefox]] も、(少なくても数時間以内には)
[[Pingフレーム]]や[[Pongフレーム]]を自発的に送信することはないようです。
[TIME[2015-08-17T02:36:51.100Z]]

;; [17] [[Firefox]] は送信・設定できるようにしたようですが [SRC[>>12]]、
その後 [[TCP keep alive]] が実装されたことで使われなくなったと思われます。

* 処理

[4] [[Pingフレーム]]を受信したら、既に [[[CODE[Close]]フレーム]]を受信した場合を除き、
[[[CODE[Pong]]フレーム]]を送信しなければ[['''なりません''']]。
これはできるだけすぐに送信する[['''べきです''']]。 [SRC[>>1]]
[[応用データ]]を返送しなければなりません。
複数受信した場合は、最後のものにのみ返信することとしても構いません。

[11] [[Chrome]] も [[Firefox]] も、すべてに順に返信しているように見えます。 [TIME[2015-08-16T14:59:12.400Z]]

* 関連

[10] [[HTTP/2]] では [CODE[[[PING]]]] [[フレーム]] ([CODE[[[ACK]]]] 未設定)
に相当します。


[12] [CITE@en[855906 – Set pingInterval on websocket]]
([TIME[2015-08-17 00:37:36 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=855906>

[13] [CITE@en[849364 – Provide per-websocket way to enable keepalive pings]]
([TIME[2015-08-17 00:38:16 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=849364>

[14] [CITE@en[894879 – SimplePush: Adaptive ping for WebSocket]]
([TIME[2015-08-17 00:39:40 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=894879>

[15] [CITE@en[13104 – Enable keepalive on WebSocket API]]
([TIME[2015-08-17 01:02:33 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=13104>

[FIG(quote)[
[FIGCAPTION[
[18] [CITE[Bitfinex API Reference]]
([TIME[2016-05-12 07:24:33 +09:00]])
<http://docs.bitfinex.com/#info-messages>
]FIGCAPTION]

> Ping/Pong
> // request
> {
>    "event":"ping"
> }
> // response
> {
>    "event":"pong"
> }
> Use ping message to test your connection to the websocket server.

]FIG]


[FIG(quote)[
[FIGCAPTION[
[19] [CITE[Bitfinex API Reference]]
([TIME[2016-05-12 07:24:33 +09:00]])
<http://docs.bitfinex.com/#heartbeating>
]FIGCAPTION]

> Heartbeating
> '''['''"<Chan Id>", "hb"''']'''
> If there is no new message in the channel for 1 second, Websocket server will send you an heartbeat message in this format.

]FIG]
