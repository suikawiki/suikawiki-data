* 仕様書

[REFS[
- [36] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#apis-for-creating-and-navigating-browsing-contexts-by-name:close-a-browsing-context>
- [22] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#close-a-browsing-context>
- [1] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#a-browsing-context-is-discarded>
- [49] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-02-24 02:49:49 +09:00]] 版) <https://html.spec.whatwg.org/#killing-scripts>
]REFS]

* [CODE(DOMi)@en[Window]] インターフェイス [CODE(DOMm)@en[close]] メソッド

[37] [CODE(DOMi)@en[[[Window]]]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[[[close]]]]]] [[メソッド]]は、
条件が満たされた場合に[[文脈オブジェクト]]の[[閲覧文脈を閉じる]]ものでなければ[['''なりません''']]
[SRC[>>36]]。

[38] [[閲覧文脈を閉じる]]ことができるのは、次の条件を''すべて''満たす場合です [SRC[>>36]]。
[FIG(list)[
- [39] [[文脈オブジェクト]]の[[閲覧文脈]]が [[script-closable]] である
- [40] [[現職設定群オブジェクト]]の[[有責閲覧文脈]]が[[文脈オブジェクト]]の[[閲覧文脈]]と [[familiar with]] 関係にある
- [41] [[現職設定群オブジェクト]]の[[有責閲覧文脈]]が[[文脈オブジェクト]]の[[閲覧文脈]]と [[allowed to navigate]] 関係にある
]FIG]

[42] [[閲覧文脈]]が [DFN[[[script-closable]]]] なのは、次の条件の''いずれか''を満たす場合です [SRC[>>36]]。
[FIG(list)[
= [43] [[スクリプト]]が作成した [[auxiliary browsing context]] である
= [44] [[セッション履歴]]に[[文書]]が1つしか含まれない[[最上位閲覧文脈]]である
]FIG]

;; [45] 複数の[[セッション履歴エントリー]]が同じ[[文書]]と関連付けられることがありますから、
2つ目の条件と[[セッション履歴エントリー]]の個数は関係ありません。

* 閉じる

[23] [DFN[[RUBYB[閲覧文脈を閉じる]@en[close a browsing context]]]]時は、
次のようにしなければ[['''なりません''']]。
[FIG(steps)[
= [24] [[活性文書]]について [[prompt to unload a document]] を実行します [SRC[>>22]]。
= [25] [[refused to allow the document to be unloaded]] が返されたら、ここで停止します [SRC[>>22]]。
= [26] [[活性文書]]について [[unload a document]] を実行します。 [VAR[recycle]] は[[偽]]とします [SRC[>>22]]。
= [27] [[利用者インターフェイス]]から[[閲覧文脈]]を削除します [SRC[>>22]]。
= [28] [[閲覧文脈を捨てる]]処理を実行します [SRC[>>22]]。
= [35] 本[[閲覧文脈]]が [CODE(DOMm)@en[[[showModalDialog]]]] により開かれたものなら、
そちらの処理が再開され、 [CODE(DOMa)@en[[[returnValue]]]] が引き渡されます。
]FIG]

[29] [[利用者エージェント]]は、[[利用者]]が[[最上位閲覧文脈]]を閉じられるようにする[['''べきです''']] [SRC[>>22]]。

;; [30] 通常の [[Webブラウザー]]には、終了や[[タブ]]を閉じる機能があります。

;; [31] [[閲覧文脈を捨てる]]機能 (>>3) も提供されるかもしれません。

[50] [[利用者エージェント]]は、[[閲覧文脈]]を閉じる際に[[スクリプトを無効]]にすることができます
[SRC[>>49]]。

;; [[スクリプトが無効]]、[[走っているスクリプトの実行中断]]も参照。

[34] [CODE(JS)@en[[[window.close]]]] は[[閲覧文脈を閉じる]]ことがあります。

* 捨てる

[2] [DFN[[RUBYB[閲覧文脈が捨てられる]@en[discard a browsing context]]]]時は、
次のようにしなければ[['''なりません''']]。
[FIG(steps)[
= [7] [[利用者エージェント]]から[[閲覧文脈]]への[[強い参照]]があれば、破棄します [SRC[>>1]]。
= [8] [[閲覧文脈]]の[[セッション履歴]]の全[[セッション履歴エントリー]]について、
== [9] [[セッション履歴エントリー]]の[[文書]]について、[[文書を捨てる]]処理を実行します [SRC[>>1]]。
= [10] [[閲覧文脈]]の捨てられたフラグを[[真]]にします。
]FIG]

[12] [[閲覧文脈]]が捨てられた後も、その[[閲覧文脈]]を指した [CODE(DOMi)@en[[[Window]]]]
[[オブジェクト]] (を指した [CODE(DOMi)@en[[[WindowProxy]]]] [[オブジェクト]])
は残っているかもしれません。

[11] [[閲覧文脈]]の捨てられたフラグは、 [CODE(JS)@en[[[window.closed]]]]
から参照されます。初期値は[[偽]]です。

[6] [CODE(HTMLe)@en[[[iframe]]]] [[要素]]や [CODE(HTMLe)@en[[[frame]]]]
[[要素]]が[[文書から削除]]されたら、
その[[入れ子閲覧文脈]]があれば、[[閲覧文脈を捨てる]]処理をしなければ[['''なりません''']]。

[14] [[文書を捨てる]]と、[[閲覧文脈を捨てる]]処理が呼び出されることがあります。

[13] [[閲覧文脈を閉じる]]と、[[閲覧文脈を捨てる]]処理が呼び出されます。

[3] [[利用者エージェント]]は、いつでも (特に[[利用者]]の指示があった場合には)
[[最上位閲覧文脈]]を捨てて構いません [SRC[>>1]]。

[EG[
[4] 例えば[[利用者]]が1つ[[以上]]の[[最上位閲覧文脈]]を持つ[[窓]]を強制的に閉じた場合が該当します
[SRC[>>1]]。
]EG]

;; [32] [[閲覧文脈を閉じる]]機能 (>>29) も提供されるかもしれません。
通常終了はそちらの方が適切と考えられます。

[5] [[最上位閲覧文脈]]以外の[[閲覧文脈]]は、 [CODE(DOMi)@en[[[WindowProxy]]]]
が[[ごみ収集]]の対象となった時、捨てなければ[['''なりません''']] [SRC[>>1]]。

;; [33] [[閲覧文脈]]が捨てられるのは、いずれも[[閲覧文脈]]が[[レンダリング]]されなくなった後です。
(>>3 の[[利用者エージェント]]が“いつでも”捨てられるのは例外ですが、
普通は[[レンダリング]]された状態のまま捨てることは無いはずです。)

* [CODE(DOMi)@en[Window]] インターフェイス [CODE(DOMa)@en[closed]] 属性

[46] [CODE(DOMi)@en[[[Window]]]] [[インターフェイス]]の
[DFN[[CODE(DOMa)@en[[[closed]]]]]] [[IDL属性]]は、
[[閲覧文脈]]が捨てられたかどうかを表します。

[47] [CODE(DOMa)@en[[[closed]]]] [[属性]]は、
[[文脈オブジェクト]]の[[閲覧文脈]]の捨てられたフラグの値 ([CODE(IDL)@en[[[boolean]]]])
を返さなければなりません [SRC[>>36]]。

* 歴史

[48] [CODE(JS)@en[[[window.close]]]] はかつてはどんな[[窓]]でも閉じられた気がしますが、
乱用を防ぐために[[スクリプト]]が開いた[[最上位閲覧文脈]]しか閉じられないようになりました。

[19] [CITE@en[Web Applications 1.0 r7127     Make it ok to window.close() a browsing context that has never been (re)navigated.]]
( ([TIME[2012-06-09 06:50:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7126&to=7127>

[20] [CITE[''''''[''''''whatwg'''''']'''''' window.close() and user-initiated <a target=_blank>]]
( ([TIME[2012-06-09 07:22:28 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2012-June/036333.html>

[15] [CITE@en[Web Applications 1.0 r7393     Better define window.close() and how to close tabs.]]
( ([TIME[2012-09-24 08:25:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7392&to=7393>

[18] [CITE@en[Web Applications 1.0 r7977     Define window.close; update the list of members exposed cross-origin on Window to match reality]]
( ([TIME[2013-06-15 03:28:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7976&to=7977>

[16] [CITE@en[Web Applications 1.0 r7984     Sandboxing: prevent pages from closing their top-level browsing context (unless they can navigate it, in which case, whatever)]]
( ([TIME[2013-06-18 09:24:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7983&to=7984>

[21] [CITE@en[Web Applications 1.0 r8047     Change how window.close() decides what you can close to make more sense.]]
( ([TIME[2013-07-10 07:45:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8046&to=8047>

[17] [CITE@en[Web Applications 1.0 r8622 Doesn't make much sense to window.close() an iframe...]]
( ([TIME[2014-05-09 05:44:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8621&to=8622>

[51] [CITE@en[document handling: error on serialising window of discarded browsing …]]
([[andreastt]]著, [TIME[2016-07-19 23:48:04 +09:00]])
<https://github.com/w3c/webdriver/commit/5f1fbbb03e2b7b2458ee5da88b4f3dc32be06bd6>