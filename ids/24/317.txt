* 仕様書

[REFS[
- [1] [CITE@en[RFC 6455 - The WebSocket Protocol]]
([TIME[2015-03-11 20:42:50 +09:00]] 版)
<http://tools.ietf.org/html/rfc6455#section-4.3>
- [2] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-9>
]REFS]

* ハンドシェイク

[50] [[WebSocket接続の確立]]時に[[クライアント]]と[[サーバー]]で折衝することで、
[DFN[[RUBYB[拡張]@en[extension]]]]を使うことができます。

[3] [[クライアント]]は [CODE(HTTP)@en[[[Sec-WebSocket-Extensions:]]]]
[[ヘッダー]]で[[拡張]]を指定することで、[[拡張]]を使うことを要求できます。
[[サーバー]]は [CODE(HTTP)@en[[[Sec-WebSocket-Extensions:]]]]
[[ヘッダー]]で[[拡張]]を指定することで、[[拡張]]を使うことに合意することを示せます。

;; [4] [[WebSocket接続の確立]]を参照。

[11] [[クライアント]]は、[[サーバー]]が同意しない限り[[拡張]]を使っては[['''なりません''']]
[SRC[>>2]]。

[5] 本[[ヘッダー]]の値は、1つ[[以上]]の[[拡張]]の指定の[[リスト (HTTP)]] ([CODE(HTTP)[#]])
です [SRC[>>2]]。

[FIG(railroad)[
= [[拡張]]の指定
= *
== [[OWS]]
== [CODE(HTTP)[[[,]]]]
== [[OWS]]
== [[拡張]]の指定
]FIG]

[6] [[拡張]]の指定は、[[拡張]]の[[字句]]の後に0個以上の[[引数]]を続けたものです。
[[引数]]の前には [CODE(HTTP)[[[;]]]] が必要です。 [SRC[>>2]]
暗示的な[[空白]] [SRC[>>2]] により、 [CODE(HTTP)[[[;]]]]
の前後には [[OWS]] が認められると推測されます。

[9] [[字句]]は、登録されたものでなければ[['''なりません''']] [SRC[>>2]]。

[FIG(railroad)[
= [[字句]]
= *
== [[OWS]]
== [CODE(HTTP)[[[;]]]]
== [[OWS]]
== [[引数]]
]FIG]

[7] [[引数]]は、[[字句]]の後に [CODE(HTTP)[[[=]]]] があり、
その後に[[字句]]か[[引用文字列]]が来るものです。ただし [CODE(HTTP)[[[=]]]]
以後は省略できます。また[[引用文字列]]の場合は、 [[unescape]]
して[[字句]]となる値でなければ[['''なりません''']]。 [SRC[>>2]]
暗示的な[[空白]] [SRC[>>2]] により、 [CODE(HTTP)[[[;]]]]
の前後には [[BWS]] が認められると推測されます。

[10] [[引数]]は、当該[[拡張]]で定義されたものでなければ[['''なりません''']] [SRC[>>2]]。

[FIG(railroad)[
= [[字句]]
= ?
== [CODE(HTTP)[[[=]]]]
== |
=== [[字句]]
=== [[引用文字列]]
]FIG]

[8] 本[[ヘッダー]]は、複数指定できます [SRC[>>2]]。

[12] [[拡張]]の指定の順序は、意味を持ちます。[[拡張]]同士の関係は、
特に規定がある場合は、それによります。そうでない場合、
[[クライアント]]が先に指定したものが優先度の高いものです。
[[サーバー]]が指定した順序が実際の適用順となり、データに対して先に指定したものから順に[[拡張]]依存の操作を適用していったことを表します。 [SRC[>>2]]

* フレーム

[52] 拡張は、次の[[プロトコル要素]]を使うことができます [SRC[>>49]]。
[FIG(list short)[
- [CODE[[[opcode]]]] [CODE[[[0x3]]]]-[CODE[[[0x7]]]], [CODE[[[0xB]]]]-[CODE[[[0xF]]]]
- [CODE[[[RSV1]]]]
- [CODE[[[RSV2]]]]
- [CODE[[[RSV3]]]]
- [[拡張データ]]
]FIG]

[13] [[拡張データ]]については、 [[WebSocketフレーム]]を参照。

* メモ

[43] [[拡張]]のせいで不必要にプロトコルが複雑になっている気がしますが...
