* 仕様書

[REFS[
- [1] [CITE@en[RFC 6455 - The WebSocket Protocol]]
([TIME[2015-03-11 20:42:50 +09:00]] 版)
<http://tools.ietf.org/html/rfc6455#section-4.3>
- [2] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-9>
- [14] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-11.3.2>
- [15] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-11.4>
- [16] [CITE[RFC Errata Report]] ([TIME[2015-05-16 22:22:53 +09:00]] 版) <http://www.rfc-editor.org/errata_search.php?rfc=6455>
- [17] [CITE[WebSocket Protocol Registries]] ([TIME[2015-03-06 13:09:47 +09:00]] 版) <https://www.iana.org/assignments/websocket/websocket.xml#extension-name>
- [33] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#dom-websocket-extensions>
]REFS]

* ハンドシェイク

[50] [[WebSocket接続の確立]]時に[[クライアント]]と[[サーバー]]で折衝することで、
[DFN[[RUBYB[拡張]@en[extension]]]]を使うことができます。

[3] [[クライアント]]は [CODE(HTTP)@en[[[Sec-WebSocket-Extensions:]]]]
[[ヘッダー]]で[[拡張]]を指定することで、[[拡張]]を使うことを要求できます。
[[サーバー]]は [CODE(HTTP)@en[[[Sec-WebSocket-Extensions:]]]]
[[ヘッダー]]で[[拡張]]を指定することで、[[拡張]]を使うことに合意することを示せます。

;; [4] [[WebSocket接続の確立]]を参照。

;; [36] この[[ヘッダー]]は、 [[fingerprinting vector]] です。

[11] [[クライアント]]は、[[サーバー]]が[[応答]]で同意しない限り[[拡張]]を使っては[['''なりません''']]
[SRC[>>2]]。

[5] 本[[ヘッダー]]の値は、1つ[[以上]]の[[拡張]]の指定の[[リスト (HTTP)]] ([CODE(HTTP)[#]])
です [SRC[>>2]]。

[FIG(railroad)[
= [[拡張]]の指定
= *
== [[OWS]]
== [CODE(HTTP)[[[,]]]]
== [[OWS]]
== [[拡張]]の指定
]FIG]

[6] [[拡張]]の指定は、[[拡張]]の[[字句]]の後に0個以上の[[引数]]を続けたものです。
[[引数]]の前には [CODE(HTTP)[[[;]]]] が必要です。 [SRC[>>2]]
暗示的な[[空白]] [SRC[>>2]] により、 [CODE(HTTP)[[[;]]]]
の前後には [[OWS]] が認められると推測されます。

[9] [[字句]]は、[[IANA登録簿]] [SRC[>>15, >>17]]
に登録されたものでなければ[['''なりません''']] [SRC[>>2]]。

[FIG(railroad)[
= [[字句]]
= *
== [[OWS]]
== [CODE(HTTP)[[[;]]]]
== [[OWS]]
== [[引数]]
]FIG]

[7] [[引数]]は、[[字句]]の後に [CODE(HTTP)[[[=]]]] があり、
その後に[[字句]]か[[引用文字列]]が来るものです。ただし [CODE(HTTP)[[[=]]]]
以後は省略できます。また[[引用文字列]]の場合は、 [[unescape]]
して[[字句]]となる値でなければ[['''なりません''']]。 [SRC[>>2]]
暗示的な[[空白]] [SRC[>>2]] により、 [CODE(HTTP)[[[;]]]]
の前後には [[BWS]] が認められると推測されます。

[10] [[引数]]は、当該[[拡張]]で定義されたものでなければ[['''なりません''']] [SRC[>>2]]。

[FIG(railroad)[
= [[字句]]
= ?
== [CODE(HTTP)[[[=]]]]
== |
=== [[字句]]
=== [[引用文字列]]
]FIG]

[8] 本[[ヘッダー]]は、[[要求]]では複数指定できます [SRC[>>2, >>14]]。
[[応答]]で複数使っては[['''なりません''']] [SRC[>>14]] と規定がありますが、
他の部分と矛盾しているとし、使っても良いと訂正 [SRC[>>16]] されています。。

[12] [[拡張]]の指定の順序は、意味を持ちます。[[拡張]]同士の関係は、
特に規定がある場合は、それによります。そうでない場合、
[[クライアント]]が先に指定したものが優先度の高いものです。
[[サーバー]]が指定した順序が実際の適用順となり、データに対して先に指定したものから順に[[拡張]]依存の操作を適用していったことを表します。 [SRC[>>2]]

* フレーム

[52] 拡張は、次の[[プロトコル要素]]を使うことができます [SRC[>>49]]。
[FIG(list short)[
- [CODE[[[opcode]]]] [CODE[[[0x3]]]]-[CODE[[[0x7]]]], [CODE[[[0xB]]]]-[CODE[[[0xF]]]]
- [CODE[[[RSV1]]]]
- [CODE[[[RSV2]]]]
- [CODE[[[RSV3]]]]
- [[拡張データ]]
]FIG]

[13] [[拡張データ]]については、 [[WebSocketフレーム]]を参照。

* [CODE(DOMi)@en[WebSocket]] インターフェイス [CODE(DOMa)@en[extensions]] 属性

[34] [CODE(DOMi)@en[[[WebSocket]]]] [[インターフェイス]]の
[DFN[[CODE(DOMa)@en[[[extensions]]]]]] [[IDL属性]]は、
利用されている[[拡張]]について返すものです。

[35] この[[属性]]は、内部的に保持している値を返さなければ[['''なりません''']] [SRC[>>33]]。
値は、[[WebIDL接続の確立]]の過程で設定されます。

* 拡張の一覧

[18] 現時点で [[IANA]] に登録されている[[拡張]]はありません。 [TIME[2015-05-16T13:32:07.700Z]]

[23] [[DEFLATE]] [[圧縮]]のための [DFN[[CODE[[[x-webkit-deflate-frame]]]]]]
が実装されていました [SRC[>>20]]。

[24] その改訂版である [DFN[[CODE[[[permessage-deflate]]]]]] [SRC[>>46]]
が実装されています [SRC[>>25, >>22]]。

[EG[
[29] [[Chrome]] は次のような[[ヘッダー]]を送るようです。
[PRE(HTTP code)[
Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits, x-webkit-deflate-frame
]PRE]
]EG]

;; [39] [[Chrome]] は現在は次のような[[ヘッダー]]を送るようです。 [TIME[2015-08-04T13:50:07.700Z]]
[PRE(HTTP code)[
Sec-WebSocket-Extensions:permessage-deflate; client_max_window_bits
]PRE]

;; [40] [[Firefox]] は [CODE(HTTP)@en[Sec-WebSocket-Extensions: permessage-deflate]]
を送るようです。 [TIME[2015-08-08T13:30:24.300Z]]

[REFS[
- [46] [CITE@en[draft-ietf-hybi-permessage-compression-27 - Compression Extensions for WebSocket]] ([TIME[2015-08-07 04:09:59 +09:00]] 版) <https://tools.ietf.org/html/draft-ietf-hybi-permessage-compression-27>
- [19] [CITE@en[draft-tyoshino-hybi-permessage-compression-00 - WebSocket Per-message Compression]] ([TIME[2015-04-24 04:35:38 +09:00]] 版) <https://tools.ietf.org/html/draft-tyoshino-hybi-permessage-compression-00>
- [28] [CITE@en[draft-ietf-hybi-permessage-compression-21 - Compression Extensions for WebSocket]] ([TIME[2015-05-16 12:31:55 +09:00]] 版) <https://tools.ietf.org/html/draft-ietf-hybi-permessage-compression-21>
- [20] [CITE@en[Bug 77522 – Adding WebSocket per-frame DEFLATE extension]] ([TIME[2015-05-16 23:06:15 +09:00]] 版) <https://bugs.webkit.org/show_bug.cgi?id=77522>
- [21] [CITE@en[Bug 115504 – '''['''WebSocket''']''' Remove x-webkit-deflate-frame extension support]] ([TIME[2015-05-16 23:06:43 +09:00]] 版) <https://bugs.webkit.org/show_bug.cgi?id=115504>
- [25] [CITE[Issue 280910 - chromium - Implement permessage-deflate extension for the new WebSocket implementation - An open-source project to help move the web forward. - Google Project Hosting]] ([TIME[2015-05-16 23:13:31 +09:00]] 版) <https://code.google.com/p/chromium/issues/detail?id=280910>
- [26] [CITE[Intent to Implement: PerMessageDeflate extension on WebSocket - Google Groups]] ([TIME[2015-05-16 23:14:11 +09:00]] 版) <https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/ZboxIILY2fo>
- [27] [CITE[Intent to ship: WebSocket permessage-deflate extension - Google Groups]] ([TIME[2015-05-16 23:14:47 +09:00]] 版) <https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/-B4uhxryIG4>
- [22] [CITE@en[792831 – Implement WebSocket compression extension]] ([TIME[2015-05-16 23:07:17 +09:00]] 版) <https://bugzilla.mozilla.org/show_bug.cgi?id=792831>
- [32] [CITE@en[Web Applications 1.0 r6330  WebSocket: Disallow this controversial extension rather than require it.]]
([TIME[2011-07-28 05:37:00 +09:00]] 版)
<https://html5.org/r/6330>
]REFS]

[31] 他に[[多重化]]のための拡張が提案されていました [SRC[>>30]]。

[REFS[
- [30] [CITE@en[draft-ietf-hybi-websocket-multiplexing-11 - A Multiplexing Extension for WebSockets]] ([TIME[2015-04-24 04:12:04 +09:00]] 版) <https://tools.ietf.org/html/draft-ietf-hybi-websocket-multiplexing-11>
]REFS]

;; [38] >>37 に [[JSON]] 形式の一覧データファイルがあります。
[REFS[
- [37] [CITE@en[data-web-defs/http-frames.txt at master · manakai/data-web-defs]] ([TIME[2015-05-28 00:33:14 +09:00]] 版) <https://github.com/manakai/data-web-defs/blob/master/doc/http-frames.txt>
]REFS]

* メモ

[43] [[拡張]]のせいで不必要にプロトコルが複雑になっている気がしますが...

[41] [CITE[WebSocket permessage-deflate in Chrome with no context takeover - Stack Overflow]]
([TIME[2015-08-22 20:41:42 +09:00]] 版)
<http://stackoverflow.com/questions/22169036/websocket-permessage-deflate-in-chrome-with-no-context-takeover>

[42] [CITE[Intent to Implement: PerMessageDeflate extension on WebSocket - Google グループ]]
([TIME[2015-08-22 20:43:55 +09:00]] 版)
<https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/ZboxIILY2fo>

[44] [CITE[Issue 163882 - chromium - WebSocket permessage-deflate: Improve compress/no-compress decision - An open-source project to help move the web forward. - Google Project Hosting]]
([TIME[2015-08-22 20:50:45 +09:00]] 版)
<https://code.google.com/p/chromium/issues/detail?id=163882>

[45] [CITE[Re: ''''''[''''''hybi'''''']'''''' Closing the hybi working group]]
([TIME[2014-10-07 09:20:18 +09:00]] 版)
<http://www.ietf.org/mail-archive/web/hybi/current/msg10527.html>

[47] [CITE[''''''[''''''hybi'''''']'''''' Discontinuation of mux standardizaton in favor of WS/HTTP/2.0]]
([TIME[2014-01-21 16:50:12 +09:00]] 版)
<http://www.ietf.org/mail-archive/web/hybi/current/msg10266.html>