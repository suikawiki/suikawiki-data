* 仕様書

[REFS[
- [1] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-5.5.1>
- [12] [CITE@en[RFC 6455 - The WebSocket Protocol]] ([TIME[2015-03-11 20:42:50 +09:00]] 版) <http://tools.ietf.org/html/rfc6455#section-7>
]REFS]

* 構文

[2] [[opcode]] は、 [CODE[0x8]] です [SRC[>>1]]。
[CODE[[[Close]]]] [[フレーム]]は、[[制御フレーム]]です。

[3] 閉じる理由を示す[RUBYB[[[本体]]]@en[body]] ([[応用データ]]) を含んで構いません [SRC[>>1]]。

[4] 本体がある場合、最初の2バイトは[[ネットワークバイト順]]の2バイト[[符号無し整数]]でなければ[['''なりません''']]。
この[[整数]]は、[[状態符号]]でなければ[['''なりません''']]。 [SRC[>>1]]

[5] 本体は更に [[UTF-8]] 符号化されたデータを含めることができます。
その解釈は [[WebSocket]] 仕様書では規定されておらず、[[人間可読]]である必要もありませんが、
[[デバッグ]]などに有用かもしれません。[[クライアント]]はこれを[[末端利用者]]に示しては[['''なりません''']]。
[SRC[>>1]]

;; [22] この部分は「[DFN[[[close reason]]]]」[SRC[>>12]] と呼ばれています。

* 文脈

[10] 次の各項を参照。
[FIG(list)[
- [[WebSocketフレーム]]
]FIG]

;; [11] [[WebSocket接続の確立]]の途中での切断では、 [CODE[[[Close]]]]
[[フレーム]]は使いません。

* 状態符号

[30] [DFN[[RUBYB[WebSocket接続閉じ符号]@en[The WebSocket Connection Close Code]]]]は、
[[応用]]が最初に受信した [[[CODE[Close]]フレーム]]に含まれていた[[状態符号]]です。
当該[[フレーム]]が[[状態符号]]を含まない時は、 [CODE[[[1005]]]] です。
そのような[[フレーム]]が無いまま [[The WebSocket Connection is Closed]]
となった場合は、 [CODE[[[1006]]]] です。 [SRC[>>12]]

[31] [[サーバー]]と[[クライアント]]はそれぞれ[[状態符号]]を送ったり送らなかったりしますが、
両者の認識する[[WebSocket接続閉じ符号]]は同じかもしれませんし、違うかもしれません。

[32] [DFN[[RUBYB[WebSocket接続閉じ理由]@en[The WebSocket Connection Close Reason]]]]は、
[[応用]]が最初に受信した [[[CODE[Close]]フレーム]]に含まれていた閉じる理由
([[UTF-8]] として[[復号]]した[[文字列]]) です。そのようなものが無ければ、
[[空文字列]]です。 [SRC[>>12]]

* 処理

[6] [[応用]]は、 [CODE[[[Close]]]] [[フレーム]]より後に[[データフレーム]]を送っては[['''なりません''']]
[SRC[>>1]]。

[7] [[応用]]は、 [CODE[[[Close]]]] [[フレーム]]を受信した場合で、自身が前に送っていない場合は、
[CODE[[[Close]]]] [[フレーム]]を返送しなければ[['''なりません''']] [SRC[>>1]]。
これはできるだけすぐに行う[['''べきです''']]が、
現在のメッセージをすべて送り終えるまで遅延させても構いません [SRC[>>1]]。
返送する場合は、受信した[[状態符号]]をそのまま返すのが普通です [SRC[>>1]]。

;; [8] もっとも、 [CODE[[[Close]]]] が送られたということは、
その相手がそれ以後受信したデータを処理する保証はありません [SRC[>>1]]。

[9] [CODE[[[Close]]]] の送受信の後、[[WebSocket接続]]は閉じられたものとし、
[[TCP接続]]も閉じなければ[['''なりません''']]。[[サーバー]]は、
直ちに閉じなければ[['''なりません''']]。[[クライアント]]は、
[[サーバー]]が閉じるのを待つ[['''べき''']]ですが、いつでも (適当な[[タイムアウト]]時間後などに)
閉じて構いません。 [SRC[>>1]]

* 閉じ handshake

[20] [DFN[[[Start the WebSocket Closing Handshake]]]] とは、
次のようにしなければ[['''なりません''']] [SRC[>>12]]。
[FIG(steps)[
= [21] [[フレーム]]を送信します。
[FIG(list members)[
[FIGCAPTION[
[[フレーム]]
]FIGCAPTION]
:[CODE[[[opcode]]]]:[CODE[[[Close]]]]
:[[状態符号]]:指定された値
:[[close reason]]:あれば、指定された値
]FIG]
= [24] [[WebSocket接続]]の状態を [CODE[[[CLOSING]]]] とします。
= [23] [[[CODE[Close]]フレーム]]を受信し(てい)たら、
[[WebSocket接続を閉じる]][['''べき''']]です。
]FIG]

[25] [[[CODE[Close]]フレーム]]を受信したら、
[[WebSocket接続]]の状態を [CODE[[[CLOSING]]]] とします [SRC[>>12]]。

[26] [[WebSocket接続]]の状態が [CODE[[[CLOSING]]]] となる時、
[DFN[[[The WebSocket Closing Handshake is Started]]]] といいます [SRC[>>12]]。

* 接続を閉じる

[13] [DFN[[RUBYB[WebSocket接続を閉じる]@en[Close the WebSocket Connection]]]]時には、
下位[[TCP接続]]を閉じます [SRC[>>12]]。[[サーバー]]は、直ちに [[TCP]]
を閉じる[['''べきです''']] [SRC[>>12]]。[[クライアント]]は、
[[サーバー]]から [[TCP]] が閉じられるのを待つ[['''べきです''']] [SRC[>>12]]。

[14] [[TCP接続]]と[[TLSセッション]]を綺麗に閉じる方法を使い、
受信したかもしれない[[バイト]]は捨てる[['''べきです''']] [SRC[>>12]]。

[16] 最も通常な場合には、まず ([[クライアント]]からではなく)
[[サーバー]]から [[TCP接続]]を閉じる[['''べきです''']] [SRC[>>12]]。

;; [17] そうすることで、[[クライアント]]ではなく[[サーバー]]の [[TCP]]
が [CODE[[[TIME_WAIT]]]] 状態となります。 [CODE[[[TIME_WAIT]]]] 状態である
[[最大セグメント寿命]]の2倍 (2[[MSL]]) の間は改めて[[接続]]を開くことができませんが、
[[サーバー]]側ならより大きな[[シーケンス番号]]の [CODE[[[SYN]]]] を送信すれば直ちに[[接続]]を開けるので問題となりません。 [SRC[>>12]]

[EG[
[19] 例えば [[socket]] API では、
まず [CODE[[[SHUT_WR]]]] を指定して [CODE[[[shutdown]]]] を呼び出し、
[CODE[[[0]]]] が返されるまで [CODE[[[recv]]]] を呼び出し、
最後に [CODE[[[close]]]] を呼ぶことでこれを実装できます [SRC[>>12]]。
]EG]

[15] 攻撃されている時など、必要に応じて他の方法で閉じても構いません [SRC[>>12]]。

[18] 十分な時間[[サーバー]]から [[TCP]] Close を受信しない場合などには[[クライアント]]から
[[TCP]] を閉じて構いません [SRC[>>12]]。

[27] [[TCP接続]]が閉じられた時、
[DFN[[[The WebSocket Connection is Closed]]]] といいます [SRC[>>12]]。
この時、 [[WebSocket接続]]の状態は [CODE[[[CLOSED]]]] となります [SRC[>>12]]。

;; [29] [[WebSocket接続]]が確立できなかった時も、
[[The WebSocket Connection is Closed]] といいます。 [[cleanly]] ではありません。 [SRC[>>12]]

[28] [[WebSocket接続]]の閉じ handshake が完了してから [[TCP接続]]が閉じられたなら、
「[DFN[[[cleanly]]]]」に閉じられたといいます [SRC[>>12]]。
そうでなければ [[cleanly]] ではありません。