;; [6] [[FTP]]、[CODE(URI)@en[ftp:]]、[[HTTP接続の処理]]もあわせて参照。

[1] [CODE(URI)@en[ftp:]] [[URL record]] [VAR[URL]] と、
[[利用者名]]と[[合言葉]]の組 [VAR[credentials]] と、
ブラウザー [VAR[UA]] について、次のようにします。

[FIG(steps)[
= [VAR[ホスト]]を、[F[URL]] の[F[ホスト]]に設定します。
= [VAR[利用者名]]を、 [[null]] に設定します。
= [VAR[合言葉]]を、 [[null]] に設定します。
= [VAR[credentials]] が [[null]] でなければ、
== [VAR[UA]] が [[IE]] で [VAR[credentials]] が[[匿名]]なら、
=== [VAR[利用者名]]を [CODE[Anonymous]] に設定します。
=== [VAR[合言葉]]を [CODE[ieuser@microsoft.com]] に設定します。
== それ以外なら、
=== [VAR[利用者名]]を、 [VAR[credentials]] の[F[利用者名]]に設定します。
=== [VAR[合言葉]]を、 [VAR[credentials]] の[F[合言葉]]に設定します。
= それ以外で、 [VAR[URL]] の[F[利用者名]]が[[空文字列]]でなければ、
== [VAR[利用者名]]を、[VAR[URL]] の[F[利用者名]]に設定します。
== [VAR[合言葉]]を、 [VAR[URL]] の[F[合言葉]]に設定します。
= それ以外なら、
== [VAR[利用者名]]を、 [CODE[anonymous]] に設定します。
== [VAR[合言葉]]を、 [VAR[UA]] により次の値に設定します。
[FIG(switch)[
: [[Firefox]] : [CODE[mozilla@example.com]]
: [[Chrome]] : [CODE[chrome@example.com]]
: [[IE]] : [CODE[User@]]
]FIG]
= [VAR[型]]を、 [CODE[I]] に設定します。
= [VAR[パス接頭辞]]を、[[空文字列]]に設定します。
= [VAR[パス]]を、 [VAR[URL]] の[F[パス]]に設定します。
= [VAR[パス]]に [CODE[;]] が含まれるなら、
== [VAR[引数]]を、[VAR[パス]]のうち、 [CODE[;]] とそれ以降に設定します。
[VAR[UA]] が [[Chrome]] なら最後の [CODE[;]] 以降、それ以外なら最初の [CODE[;]]
以降とします。
== [VAR[パス]]から[VAR[引数]]を削除します。
= [VAR[種別]]を、不明に設定します。
== [VAR[UA]] が [[Firefox]] なら、
=== [VAR[URL]] の[F[パス]]を、 [VAR[パス]]に設定します。
=== [VAR[URL]] への[[リダイレクト]]を返し、ここで停止します。
== [VAR[UA]] が [[Chrome]] なら、
=== [VAR[引数]]が [CODE[;type=a]] なら、
==== [VAR[型]]を、 [CODE[A]] に設定します。
==== [VAR[種別]]を、[[ファイル]]に設定します。
=== それ以外で、 [VAR[引数]]が [CODE[;type=i]] なら、
==== [VAR[型]]を、 [CODE[I]] に設定します。
==== [VAR[種別]]を、[[ファイル]]に設定します。
=== それ以外で、 [VAR[引数]]が [CODE[;type=d]] なら、
==== [VAR[種別]]を、[[ディレクトリー]]に設定します。
== [VAR[UA]] が [[IE]] なら、
=== [VAR[引数]]が [CODE[;type=A]] から始まる ([[ASCII大文字・小文字不区別]]) なら、
==== [VAR[型]]を、[CODE[A]] に設定します。
=== それ以外で、[VAR[引数]]が [CODE[;type=I]] から始まる ([[ASCII大文字・小文字不区別]]) なら、
==== [VAR[型]]を、[CODE[I]] に設定します。
=== それ以外なら、
==== [[ネットワークエラー]]を返し、ここで停止します。
= [VAR[パス]]から、先頭の [CODE[/]] を除去します。
= 再利用できる接続がなければ、接続を確立します。
= [VAR[UA]] が [[IE]] か [[Firefox]] なら、
== 命令を送信します。 [CODE[TYPE]]、[VAR[型]]を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
=== 異常終了とし、ここで停止します。
= [VAR[UA]] が [[Firefox]] なら、
== [VAR[パス引数]]を、[VAR[パス]]に設定します。
= それ以外で、[VAR[UA]] が [[IE]] なら、
== [VAR[パス引数]]を、[CODE[/]] と[VAR[パス]]を連結したものに設定します。
= それ以外で、[VAR[UA]] が [[Chrome]] なら、
== [VAR[パス引数]]を、[VAR[パス接頭辞]]に[VAR[パス]]を連結したものに設定します。
= [VAR[パス引数]]を、[VAR[パス引数]]を[[パーセント復号]]した[[バイト列]]に設定します。
= [VAR[ファイルパス引数]]を、[VAR[パス引数]]に設定します。
= [VAR[ファイルパス引数]]の末尾が [CODE[/]] なら、これを削除します。
= [VAR[UA]] が [[Chrome]] なら、
== [VAR[種別]]が[[ディレクトリー]]以外なら、
=== 命令を送信します。 [CODE[SIZE]]、[VAR[ファイルパス引数]]を引数とします。
=== [VAR[返答]]を、返答の取得の結果に設定します。
=== [VAR[返答]]の[F[符号]]が [CODE[550]] 以外なら、
==== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]]、[CODE[2]]、[CODE[3]]、[CODE[4]] のいずれでもないか、
[VAR[返答]]の[F[残り]]が [[ASCII数字]]列でないなら、
===== 異常終了とし、ここで停止します。
== [VAR[種別]]が[[ファイル]]以外なら、
=== 命令を送信します。 [CODE[CWD]]、[VAR[パス引数]]を引数とします。
=== [VAR[返答]]を、返答の取得の結果に設定します。
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] なら、
==== [VAR[種別]]を、[[ディレクトリー]]に設定します。
=== それ以外で、[VAR[返答]]の[F[符号]]が [CODE[451]] か [CODE[550]] なら、
==== [VAR[種別]]が[[ディレクトリー]]なら、
===== 異常終了とし、ここで停止します。
==== それ以外なら、
===== [VAR[種別]]を、[[ファイル]]に設定します。
=== それ以外で、[VAR[返答]]の[F[符号]]の先頭が [CODE[5]] 以外なら、
==== 異常終了とし、ここで停止します。
= [VAR[UA]] が [[Chrome]] で [[IPv6]] なら、
==
@@
= それ以外なら、
== 命令を送信します。 [CODE[PASV]]、[[null]] を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== 
[FIG(list)[
- [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外
- [VAR[UA]] が [[IE]] で、[VAR[返答]]の[F[符号]]が [CODE[227]] 以外
- [VAR[UA]] の規則により[VAR[返答]]の[F[残り]]を構文解析できない場合
-- [VAR[UA]] により構文解析方法は異なるが、
[CODE[\([0-9]+,[0-9]+,[0-9]+,[0-9]+,[0-9]+,[0-9]+\)]] が含まれかつそれより前に [CODE[(]]
が含まれないかつどこにも改行を含まないなら、構文解析できる
--
@@ [[Firefox]] は、括弧が無くても認識します。また、接続先が [[IPv6アドレス]]なら、
このパターンのかわりに、 [[IPv6]] 用の構文を認識します。
]FIG]
... のいずれかを満たすなら、
=== 異常終了とし、ここで停止します。
== [VAR[UA]] が [[IE]] なら、
=== [VAR[IPアドレス]]を、得られた最初の4つの十進数が表す [[IPv4アドレス]]に設定します。
=== [VAR[IPアドレス]]が接続先の [[IPアドレス]]と異なるなら、
==== 異常終了とし、ここで停止します。
== [VAR[ポート]]を、得られた最後の2つの十進数が表す[[ポート]]に設定します。
== 
@@ [[Chrome]] では[VAR[ポート]]が1024[[未満]]か [[port blocking]] 対象なら、
異常終了とし、ここで停止します。
== [VAR[データ接続]]を、[VAR[ホスト]]と[VAR[ポート]]へ[[TCP接続]]を確立した結果に設定します。
[VAR[UA]] が [[Chrome]] なら、結果を待ちます。それ以外なら、[[並列に]]行います。
[VAR[データ接続]]が得られた時、失敗なら、異常終了とし、ここで停止します。
= [VAR[種別]]が[[ファイル]]か不明なら、
== [VAR[UA]] が [[Firefox]] か [[IE]] なら、
=== 命令を送信します。 [CODE[SIZE]]、[VAR[ファイルパス引数]]を引数とします。
===
@@ [[Firefox]] では、結果は進捗表示などのファイルサイズとして使われます。
== [VAR[UA]] が [[Firefox]] なら、
=== 命令を送信します。 [CODE[MDTM]]、[VAR[ファイルパス引数]]を引数とします。
=== 
@@
== 命令を送信します。 [CODE[RETR]]、[VAR[ファイルパス引数]]を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[UA]] が [[Firefox]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] なら、
==== 何かを待ち続けます。
=== それ以外で、[VAR[返答]]の[F[符号]]の先頭が [CODE[1]] 以外なら、
====
@@ [CODE[421]], [CODE[425]], [CODE[426]] なら、異常終了します。
==== [VAR[種別]]を、非ファイルに設定します。
=== それ以外なら、
==== [VAR[データ接続]]から受信したデータを返し、ここで停止します。
以後返答を受信したら、[VAR[返信]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
[[ネットワークエラー]]として扱います。
== [VAR[UA]] が [[IE]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] か [CODE[2]] 以外なら、
==== [VAR[種別]]を、非ファイルに設定します。
=== それ以外なら、
==== [VAR[データ接続]]から受信したデータを返し、ここで停止します。
== [VAR[UA]] が [[Chrome]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] か [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
=== それ以外なら、
==== [VAR[データ接続]]から受信したデータを返し、ここで停止します。
= [VAR[種別]]が[[ファイル]]でないなら、
== [VAR[UA]] が [[Firefox]] なら、
=== 命令を送信します。 [CODE[CWD]] と[VAR[ファイルパス引数]]に [CODE[/]] を連結したものを引数とします。
=== [VAR[返答]]を、返答の取得の結果に設定します。
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
== [VAR[UA]] が [[IE]] なら、
=== 命令を送信します。 [CODE[CWD]] と[VAR[パス引数]]を引数とします。
=== [VAR[返答]]を、返答の取得の結果に設定します。
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
===
@@@
== [VAR[UA]] が [[Chrome]] なら、
=== 命令を送信します。 [CODE[LIST]] と [CODE[-l]] を引数とします。
@@ [[VMS]] なら、 [CODE[-l]] ではなく [CODE[*.*;0]] を指定します。
== それ以外なら、
=== 命令を送信します。 [CODE[LIST]] と [[null]] を引数とします。
===
@@ [[Firefox]] で [[VMS]] なら、 [CODE[*.*;0]] を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[UA]] が [[Firefox]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] なら、
==== 何かを待ち続けます。
=== それ以外で、[VAR[返答]]の[F[符号]]の先頭が [CODE[1]] 以外なら、
==== 異常終了とし、ここで停止します。
=== それ以外なら、
==== [VAR[種別]]がファイル以外なら、
===== [VAR[URL]] の[F[パス]]を、[VAR[パス]]に [CODE[/]] を連結したものに設定します。
===== [VAR[URL]] への[[リダイレクト]]を返し、ここで停止します。
==== それ以外なら、
===== [VAR[データ接続]]から受信したデータを [CODE(MIME)@en[application/http-index-format]]
に変換したものを返し、ここで停止します。
[CODE(HTTP)@en[Content-Type]] を、 [CODE(MIME)@en[application/http-index-format]]
に設定します。
応答の[F[状態]]を [CODE[200]]、[F[理由句]]を [CODE[OK]] に設定します。
以後返答を受信したら、[VAR[返信]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
[[ネットワークエラー]]として扱います。
== [VAR[UA]] が [[IE]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] か [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
=== それ以外なら、
==== [VAR[種別]]がファイル以外なら、
===== [VAR[URL]] の[F[パス]]を、[VAR[パス]]に [CODE[/]] と[VAR[引数]]を連結したものに設定します。
===== [VAR[URL]] について再帰的に本アルゴリズムを実行します。 (同じ接続を再利用します。)
その結果を返し、ここで停止します。
==== それ以外なら、
===== [VAR[データ接続]]から受信したデータを返し、ここで停止します。
[[FTP]] [[ディレクトリー]]一覧としてレンダリングします。
[VAR[パス]]の末尾が [CODE[/]] でない場合、 [CODE[/]] を付加したものを[[ディレクトリー]]の[[パス]]とみなします。
以後返答を受信し、その[F[符号]]の先頭が [CODE[2]] 以外なら、
[[ネットワークエラー]]として扱います。
== [VAR[UA]] が [[Chrome]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] か [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
=== それ以外なら、
==== [VAR[データ接続]]から受信したデータを返し、ここで停止します。
[VAR[URL]] の[F[クエリー]]が [CODE[raw]] なら、テキストとしてレンダリングします。
それ以外なら、 [[FTP]] [[ディレクトリー]]一覧としてレンダリングします。
応答の[F[状態]]を [CODE[0]]、[F[理由句]]を[[空文字列]]に設定します。
= [VAR[UA]] が [[Chrome]] なら、
== [CODE[QUIT]]
== ここで停止します。
]FIG]

[7] 異常終了とするとは、次のようにします。
[FIG(steps)[
= [VAR[UA]] が [[Chrome]] なら、
== 命令を送信します。 [CODE[QUIT]]、[[null]] を引数とします。
= 接続を閉じます。
= [[ネットワークエラー]]を返します。
]FIG]

[2] 返答の取得は、次のようにします。
[FIG(steps)[
= [VAR[改行]]を、[VAR[UA]] が [[Chrome]] なら [CODE[0x0D]] [CODE[0x0A]]、
それ以外なら省略可能な [CODE[0x0D]] と必須の [CODE[0x0A]] に設定します。
= 接続から[VAR[改行]]に一致するバイト列が送られるのを待ちます。
= [VAR[行]]を、[VAR[改行]]に最初に一致する直前までに設定します。
= 接続のうち[VAR[改行]]に最初に一致する部分までを既読として除去します。
= [VAR[行]]が3つの[[ASCII数字]]の後に [CODE[-]] から始まるなら、
==
@@
==- 次の行の「残り」と、改行を区切りに連結します。
==- 「符号」は、
==-- IE なら、最後のものを採用します。
==-- Firefox なら、最初のものを採用します。
==-- Chrome なら、異なる返答は無視します。
= [VAR[行]]が3つの[[ASCII数字]]の後に [CODE[0x20]] から始まるなら、
== [VAR[UA]] が [[Chrome]] でないか、先頭の[[ASCII数字]]が [1, 5] の範囲内なら、
=== [VAR[返答]]を、返答とします。
=== [VAR[返答]]の[F[符号]]を、[VAR[行]]の先頭の3つの[[ASCII数字]]の列とします。
=== [VAR[返答]]の[F[残り]]を、[VAR[行]]の [CODE[0x20]] の直後より後すべてとします。
=== [VAR[返答]]を返します。
= 最初に戻ります。
=
@@ [VAR[UA]] が [[Chrome]] で、[CODE[RETR]] と [CODE[LIST]] 以外で2つ目の[[返答]]を受信したら、
異常終了として、ここで停止します。
]FIG]

[3] 接続の確立は、次のようにします。
[FIG(steps)[
= [VAR[ポート]]を、[VAR[URL]] の[F[ポート]]に設定します。
= [VAR[ポート]]が [[null]] なら、
== [VAR[ポート]]を、 [N[21]] に設定します。
= [VAR[接続]]を、[VAR[ホスト]]と[VAR[ポート]]に[[TCP接続]]を確立した結果に設定します。
= [VAR[接続]]が失敗なら、
== [[ネットワークエラー]]を返し、ここで停止します。
= [VAR[返答]]を、返答の取得の結果に設定します。
= [VAR[UA]] が [[IE]] で、 [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
== [CODE[401]] [[応答]]を返し、ここで停止します。
=
@@ [[Firefox]] は [CODE[421]] や [CODE[521]] なら異常終了とします。
= [[命令]]を送信します。[CODE[USER]]、[VAR[利用者名]]を[[UTF-8符号化]]した結果を引数とします。
= [VAR[返答]]を、返答の取得の結果に設定します。
= [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] なら、
== [VAR[UA]] が [[IE]] なら、
=== [CODE[401]] [[応答]]を返し、ここで停止します。
== [VAR[UA]] が [[Chrome]] なら、
=== 命令を送信します。 [CODE[QUIT]]、[[null]] を引数とします。
== ここで停止します。
= それ以外で、[VAR[返答]]の[F[符号]]の先頭が [CODE[4]] か [CODE[5]] なら、
== [VAR[UA]] が [[IE]] なら、
=== [[ネットワークエラー]]を返し、ここで停止します。
== [VAR[UA]] が [[Chrome]] なら、
=== 命令を送信します。 [CODE[QUIT]]、[[null]] を引数とします。
== [CODE[401]] [[応答]]を返し、ここで停止します。
= それ以外で、[VAR[返答]]の[F[符号]]の先頭が [CODE[3]] なら、
== [VAR[合言葉]]が [[null]] なら、
=== [VAR[UA]] が [[Firefox]] なら、
==== [VAR[合言葉]]を、モーダルダイアログの結果に設定します。
==== [VAR[合言葉]]が [[null]] なら、
===== 接続を閉じて、ここで停止します。
=== [VAR[UA]] が [[Chrome]] なら、
==== [VAR[合言葉]]を、 [[空文字列]]に設定します。
== [[命令]]を送信します。 [CODE[PASS]]、[VAR[合言葉]]を[[UTF-8符号化]]した結果を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[返答]]の[F[符号]]の先頭が [CODE[1]] か [CODE[3]] で [VAR[UA]] が [[Chrome]] なら、
=== 異常終了とし、ここで停止します。
== [VAR[返答]]の[F[符号]]の先頭が [CODE[3]] で [VAR[UA]] が [[Firefox]] なら、
=== 命令を送信します。 [CODE[ACCT]]、[CODE[noaccount]] を引数とします。
===
@@@
== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
=== [CODE[401]] [[応答]]を返し、ここで停止します。
=
@@ [[Chrome]] は [CODE[USER]] や [CODE[PASS]] で切断され[VAR[利用者名]]が
[CODE[anonymous]] なら、 [CODE[401]] 応答を返します。
= [VAR[UA]] が [[Firefox]] か [[Chrome]] なら、
== 命令を送信します。 [CODE[SYST]]、[[null]] を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[返答]]の[F[符号]]の先頭が  [CODE[2]] でも [CODE[5]] でもないなら、
=== [VAR[UA]] が [[Chrome]] なら、
==== 異常終了とし、ここで停止します。
=== [VAR[UA]] が [[Firefox]] なら、
==== [CODE[401]] [[応答]]を返します。
==== ここで停止します。
==
@@ [[Chrome]] と [[Firefox]] は結果が [[VMS]] ならパスの区切り文字を [[VMS]] 風に変換して送信します。
判定条件は微妙に違っています。
= [VAR[UA]] が [[Firefox]] なら、
== 命令を送信します。 [CODE[FEAT]]、[[null]] を引数とします。
==
@@
= [VAR[UA]] が [[Firefox]] か [[Chrome]] なら、
== 命令を送信します。 [CODE[PWD]]、[[null]] を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[UA]] が [[Chrome]] なら、
=== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
==== 異常終了とし、ここで停止します。
=== それ以外なら、
==== [VAR[パス接頭辞]]を、[VAR[返答]]の[F[残り]]に設定します。
====
@@ ただし[F[残り]]の先頭が [CODE["]] なら、次の [CODE["]] の直前までとします。
また改行があれば、その前までとします。
==== [VAR[パス接頭辞]]が空なら、異常終了とし、ここで停止します。
==== [VAR[パス接頭辞]]の末尾に [CODE[/]] がなければ、追加します。
==
@@ [[Firefox]] は接続を再利用するかどうかの判定に使っています。
またソースコード上は[VAR[パス引数]]の決定にも関与しているようですが、
外部から観測できません。
= [VAR[UA]] が [[Firefox]] なら、
== 命令を送信します。 [CODE[TYPE]]、[VAR[型]]を引数とします。
== [VAR[返答]]を、返答の取得の結果に設定します。
== [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
=== 異常終了とし、ここで停止します。
]FIG]
