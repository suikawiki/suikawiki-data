[1] [CODE(URI)@en[ftp:]] [[URL record]] [VAR[URL]] と、
[[利用者名]]と[[合言葉]]の組 [VAR[credentials]] と、
ブラウザー [VAR[UA]] について、次のようにします。

[FIG(steps)[
= [VAR[利用者名]]を、 [[null]] に設定します。
= [VAR[合言葉]]を、 [[null]] に設定します。
= [VAR[credentials]] が [[null]] でなければ、
== [VAR[利用者名]]を、 [VAR[credentials]] の[F[利用者名]]に設定します。
== [VAR[合言葉]]を、 [VAR[credentials]] の[F[合言葉]]に設定します。
= それ以外なら、
== [VAR[URL]] の[F[利用者名]]が[[空文字列]]でなければ、
=== [VAR[利用者名]]を、[VAR[URL]] の[F[利用者名]]に設定します。
== [VAR[URL]] の[F[合言葉]]が [[null]] でなければ、
=== [VAR[合言葉]]を、 [VAR[URL]] の[F[合言葉]]に設定します。
= [VAR[型]]を、 [CODE[I]] に設定します。
= [VAR[パス]]を、 [VAR[URL]] の[F[パス]]に設定します。
= [VAR[パス]]に [CODE[;]] が含まれるなら、
== [VAR[引数]]を、[VAR[パス]]のうち、 [CODE[;]] とそれ以降に設定します。
== [VAR[パス]]から[VAR[引数]]を削除します。
== [VAR[UA]] が [[Firefox]] なら、
=== [VAR[URL]] の[F[パス]]を、 [VAR[パス]]に設定します。
=== [VAR[URL]] への[[リダイレクト]]を返し、ここで停止します。
== [VAR[UA]] が [[IE]] なら、
=== [VAR[引数]]が [CODE[;type=A]] から始まる ([[ASCII大文字・小文字不区別]]) なら、
==== [VAR[型]]を、[CODE[A]] に設定します。
=== それ以外で、[VAR[引数]]が [CODE[;type=I]] から始まる ([[ASCII大文字・小文字不区別]]) なら、
==== [VAR[型]]を、[CODE[I]] に設定します。
=== それ以外なら、
==== [[ネットワークエラー]]を返し、ここで停止します。
= [VAR[返答]]を、返答の取得の結果に設定します。
= [VAR[UA]] が [[IE]] で、 [VAR[返答]]の[F[符号]]の先頭が [CODE[2]] 以外なら、
== [CODE[401]] [[応答]]を返し、ここで停止します。
= [[命令]]を送信します。[CODE[USER]]、[VAR[利用者名]]を[[UTF-8符号化]]した結果を引数とします。
=
@@
= [VAR[合言葉]]が [[null]] なら、
== [VAR[UA]] が [[Firefox]] なら、
=== [VAR[合言葉]]を、モーダルダイアログの結果に設定します。
=== [VAR[合言葉]]が [[null]] なら、
==== 接続を閉じて、ここで停止します。
== [VAR[UA]] が [[Chrome]] なら、
=== [VAR[合言葉]]を、 [[空文字列]]に設定します。
= [[命令]]を送信します。 [CODE[PASS]]、[VAR[合言葉]]を[[UTF-8符号化]]した結果を引数とします。
=
@@





]FIG]

[2] 返答の取得は、次のようにします。
[FIG(steps)[
= [VAR[改行]]を、[VAR[UA]] が [[Chrome]] なら [CODE[0x0D]] [CODE[0x0A]]、
それ以外なら省略可能な [CODE[0x0D]] と必須の [CODE[0x0A]] に設定します。
= 接続から[VAR[改行]]に一致するバイト列が送られるのを待ちます。
= [VAR[行]]を、[VAR[改行]]に最初に一致する直前までに設定します。
= 接続のうち[VAR[改行]]に最初に一致する部分までを既読として除去します。
= [VAR[行]]が3つの[[ASCII数字]]の後に [CODE[0x20]] から始まるなら、
== [VAR[返答]]を、返答とします。
== [VAR[返答]]の[F[符号]]を、[VAR[行]]の先頭の3つの[[ASCII数字]]の列とします。
== [VAR[返答]]の[F[残り]]を、[VAR[行]]の [CODE[0x20]] の直後より後すべてとします。
== [VAR[返答]]を返します。
= 最初に戻ります。
]FIG]
