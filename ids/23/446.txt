* 仕様書

[REFS[
- [3] '''[CITE@en[RFC 5849 - The OAuth 1.0 Protocol]] ([TIME[2014-12-28 14:19:21 +09:00]] 版) <http://tools.ietf.org/html/rfc5849#section-2.2>'''
- [21] [CITE@en[RFC 5849 - The OAuth 1.0 Protocol]] ([TIME[2014-12-28 14:19:21 +09:00]] 版) <http://tools.ietf.org/html/rfc5849#section-4.15>
- [1] '''[CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-3.1>'''
- [36] [CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-4.1.1>
- [41] [CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-4.1.2.1>
- [44] [CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-4.2.1>
- [33] [CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-4.2.2>
- [48] [CITE@en[RFC 6749 - The OAuth 2.0 Authorization Framework]] ([TIME[2014-12-15 14:15:35 +09:00]] 版) <http://tools.ietf.org/html/rfc6749#section-10>
]REFS]

* OAuth 1.0 資源所有者認可

[5] [[OAuth 1.0]] [[クライアント]]は[[鯖]]に[[トークンcredentials]]を要求するに先立ち、
[[鯖]]に対してアクセス要求を[RUBYB[[[認可]]]@en[authorize]]するよう[[利用者]]に求めなければ[['''なりません''']] [SRC[>>3]]。
この手順を[DFN[[RUBYB[[[資源所有者認可]]]@en[resource owner authorization]]]]といいます。

[6] [[クライアント]]は、何らかの方法で[[鯖]]が[[広告]]した[[資源所有者認可]]の[[エンドポイント]]の
[[URL]] を次の通り編集しつつ[[要求URL]] としなければ[['''なりません''']]。
[[クライアント]]はその[[要求URL]]を[[HTTPリダイレクト]]その他の方法で[[資源所有者]]の[[利用者エージェント]]にアクセスさせます。
この時使う[[要求メソッド]]は [CODE(HTTP)@en[[[GET]]]] でなければ[['''なりません''']]。 [SRC[>>3]]

[7] その [[URL]] の [[query]] に [CODE(URI)@en[[[oauth_token]]]] [[引数]]を追加します。
[CODE(URI)@en[[[oauth_token]]]] [[引数]]は、[[一時credentials要求]]で[[鯖]]から[[クライアント]]に提供された[[一時credentials]]の[[識別子]]
([CODE(HTTP)@en[[[oauth_token]]]] [[引数]]の値) とします。
ただし、[[鯖]]は[[資源所有者]]に他の方法で[[一時credentials]]の識別子を示させる方法を用意しているなら、
この[[引数]]を省略可能にできます。 [SRC[>>3]]

[8] [[鯖]]は、その他の[[引数]]も規定しても構いません [SRC[>>3]]。

[9] [[資源所有者認可]]で[[保安輸送路]]を使うか否かは[[鯖]]に任されていて、
[[OAuth]] としては規定されていません [SRC[>>3]]。 

[10] [[鯖]]はまず[[要求所有者]]の [[identity]] を[RUBYB[検証]@en[verify]]しなければ[['''なりません''']]。
その後認可要求をどう処理するかは[[鯖]]に委ねられています。 [SRC[>>3]]

;; [16] 一般的には、[[鯖]]はまず[[資源所有者]]がその[[Webアプリケーション]]における[[アカウント]]で[[ログイン]]状態にあるか
([[Cookie認証]]等で) 確認し、必要なら[[ログイン]]処理を行います。
次に[[一時credentials]]から調べた [[OAuth]] [[クライアント]]についての登録情報や、
(あれば) その[[Webアプリケーション]]における可能な操作の範囲 (いわゆる [[scope]])
など判断に必要な情報を表示し、[[資源所有者]]に対して[[認可]]するか否かの選択を求めます。
([[ログイン]]していない場合、[[ログイン]]と[[認可]]を同時に確認する実装もあります。)

;; [18] 既に一部の [[scope]] について[[認可]]していて、更に追加の [[scope]]
の[[認可]]を求められている場合に差分だけ表示して確認を求める実装もあります。
また新たに要求された [[scope]] をすべて[[認可]]済みの時に、
確認を省略して直ちに [[HTTPリダイレクト]]する実装もあります [SRC[>>21]]。
ただしその場合は[[セキュリティー]]的に問題ないか、[[鯖]]も[[資源所有者]]側の実装者も十分検討する必要があります。
特に[[クライアントcredentials]]が流出している場合には、
[[資源所有者]]が気づかないうちに[[トークンcredentials]]を与えてしまうことになるので危険です
[SRC[>>21]]。無確認で[[リダイレクト]]するのは特定の限定された [[scope]]
のみとするなど、配慮が必要です [SRC[>>21]]。

[53] [[鯖]]は [[CSRF]] 対策が必要です。

[12] [[鯖]]は、[[資源所有者]]が[[認可]]すると判断したら、
[[一時credentials要求]]の [CODE(URI)@en[[[oauth_callback]]]] [[引数]]、
あるいはその他の手段で指定された[[コールバックURL]]があれば、
[[資源所有者]]をそこに[[リダイレクト]]します。 [SRC[>>3]]

[13] [[コールバックURL]] の [[query]] には次の[[引数]]を追加しなければ[['''なりません''']] [SRC[>>3]]。
既に [[query]] があるなら、末尾に追加しなければ[['''なりません''']] [SRC[>>3]]。
[FIG(list members)[
[FIGCAPTION[
[[URL query]]
]FIGCAPTION]
:[14] [CODE(URI)@en[[[oauth_token]]]]:[[クライアント]]から受信した[[一時credentials]]の[[識別子]] [SRC[>>3]]。
:[15] [CODE(URI)@en[[[oauth_verifier]]]]:[RUBYB[[[検証符号]]]@en[verification code]] [SRC[>>3]]。
]FIG]

;; [20] [[コールバックURL]] は不適切な値が指定されるかもしれません。
[CODE(URI)@en[[[oauth_callback]]]] を参照してください。

[17] [[鯖]]は、[[クライアント]]が[[コールバックURL]] が提供しなかった場合には、
[[検証符号]]を表示し、[[資源所有者]]に対して手動で[[クライアント]]に入力するよう指示する[['''べきです''']] [SRC[>>3]]。

* OAuth 2.0 認可エンドポイント

[2] [[OAuth 2.0]] [[認可鯖]]の[[認可エンドポイント]]は、
[[資源所有者]]から[[認可承諾]]を得るために使うものです。
[[認可符号承諾型]]と[[暗示的承諾型]]で使います。 [SRC[>>1]]

** 認可エンドポイントへの要求

[22] [[クライアント]]が[[認可エンドポイント]]の位置を知る方法は [[OAuth]]
仕様の範囲外ですが、通常は[[サービス]]の[[ドキュメント]]により示されます [SRC[>>1]]。

[24] [[認可エンドポイント]]では [[TLS]] を使わなければ[['''なりません''']] [SRC[>>1, >>48]]。
[[クライアント]]は [[RFC 6125]] により[[認可鯖]]の[[TLS証明書]]を検証し[[鯖]]の
[[identity]] を[[認証]]しなければ[['''なりません''']] [SRC[>>48]]。

[23] [[認可エンドポイント]]の [[URL]] には [CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
形式の [[query]] を含めても構いません。[[素片識別子]]を含んでは[['''なりません''']]。
[[query]] が含まれる場合には、[[引数]]を追加する場合には元の [[query]]
を残して追加しなければ[['''なりません''']]。 [SRC[>>1]]

[37] [[認可符号]]または[[アクセストークン]]を取得するために[[資源所有者]]を[[リダイレクト]]する [[URL]]
の構築時には、[[引数]]を [[URL query]] に [CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
形式で指定します [SRC[>>36, >>44]]。次の[[引数]]があります。
[FIG(list members)[
[FIGCAPTION[
[[URL query]] ([CODE(MIME)@en[[[application/x-www-form-urlencoded]]]])
]FIGCAPTION]
:[CODE(URI)@en[[[response_type]]]]:[[認可符号]]の取得なら [CODE(URI)@en[[[code]]]]、
[[アクセストークン]]の取得なら [CODE(URI)@en[[[token]]]] でなければ[['''なりません''']]
[SRC[>>36, >>44]]。
:[CODE(URI)@en[[[client_id]]]]:[[クライアント識別子]]を指定しなければ[['''なりません''']]
[SRC[>>36, >>44]]。
:[CODE(URI)@en[[[redirect_uri]]]]:[[リダイレクトURL]]を指定できます [SRC[>>36, >>44]]。
:[CODE(URI)@en[[[scope]]]]:[[適用範囲]]を指定できます [SRC[>>36, >>44]]。
:[CODE(URI)@en[[[state]]]]:局所状態を表す値を指定する[['''べきです''']] [SRC[>>36, >>44]]。
]FIG]

[31] [[クライアント]]は、[[要求]]の [CODE(URI)@en[[[response_type]]]]
[[引数]]で [CODE(URI)@en[[[code]]]] ([[認可符号承諾型]]) か
[CODE(URI)@en[[[token]]]] ([[暗示的承諾型]]) か拡張の[[承諾型]]を表す値のいずれかを指定しなければ[['''なりません''']] [SRC[>>1]]。

[29] [[要求]]の[[引数]]は、複数指定しては[['''なりません''']] [SRC[>>1]]。

[25] [[認可鯖]]は、[[認可エンドポイント]]において [CODE(HTTP)@en[[[GET]]]]
[[要求メソッド]]に対応しなければ[['''なりません''']]。 [CODE(HTTP)@en[[[POST]]]]
[[要求メソッド]]に対応しても構いません。 [SRC[>>1]]

** 認可エンドポイントでの処理

[4] [[認可鯖]]は、まず[[資源所有者]]を[[認証]]
([[identity]] を[RUBYB[検証]@en[verify]]) しなければ[['''なりません''']] [SRC[>>1, >>36]]。
[[認可鯖]]が[[資源所有者]]を[[認証]]する方法は、 [[OAuth]]
仕様の範囲外で、[[利用者名]]と[[合言葉]]による[[ログイン]]であれ、
[[セッションクッキー]]であれ、任意の方法を使うことができます [SRC[>>1]]。

[52] [[認可エンドポイント]]では [[CSRF]] 対策を行わなければ[['''なりません''']] [SRC[>>48]]。

[32] [[認可鯖]]は、 [CODE(URI)@en[[[response_type]]]] [[引数]]が指定されていない時や理解できない時は、
[[誤り]]を返さなければ[['''なりません''']] [SRC[>>1]]。

[35] [[認可鯖]]はすべての[[必須]]の[[引数]]が指定されており、[[妥当]]であることを確認します。
[SRC[>>36, >>44]]

[26] [[要求]]の[[引数]]で値のないものは、指定されなかったものとして扱わなければ[['''なりません''']] [SRC[>>1]]。

;; [27] 値がないというのは、 [CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
で [CODE[[[=]]]] が含まれない組のことでしょうか? [[空文字列]]と区別されるということでしょうか?

[28] [[認可鯖]]は、認識できない[[引数]]を無視しなければ[['''なりません''']] [SRC[>>1]]。

[38] [[認可鯖]]は、[[資源所有者]]に尋ねるなり、その他何らかの手段を使うなりして、
[[資源所有者]]から[[認可]]するかの決定を得ます [SRC[>>36, >>44]]。

** リダイレクトエンドポイントへのリダイレクト

[34] [[認可鯖]]は、[[資源所有者]]がアクセス要求を承諾したら、
[[資源所有者]]を[[クライアント]] (の[[リダイレクトエンドポイント]])
へと[[リダイレクト]]により戻します [SRC[>>1, >>36, >>44]]。

[39] [[認可符号]]を求められている場合で[[資源所有者]]の[[認可]]が得られた場合には、
[[リダイレクトURL]]の [[query]] には
[CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
形式で次の[[引数]]を追加します [SRC[>>36]]。
[FIG(list members)[
[FIGCAPTION[
[[URL query]] ([CODE(MIME)@en[[[application/x-www-form-urlencoded]]]])
]FIGCAPTION]
:[CODE(URI)@en[[[code]]]]:[[認可鯖]]が生成した[[認可符号]]を指定しなければ[['''なりません''']]。
:[CODE(URI)@en[[[state]]]]:[[クライアント]]が[[認可]]の要求に [CODE(URI)@en[[[state]]]]
[[引数]]を指定していれば、まったく同じ値を指定しなければ[['''なりません''']]。
]FIG]

[45] [[アクセストークン]]を求められている場合で[[資源所有者]]の[[認可]]が得られた場合には、
[[リダイレクトURL]]の[[素片識別子]]には
[CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
形式で次の[[引数]]を追加します [SRC[>>33]]。
[FIG(list members)[
[FIGCAPTION[
[[素片識別子]] ([CODE(MIME)@en[[[application/x-www-form-urlencoded]]]])
]FIGCAPTION]
:[CODE(URI)@en[[[access_token]]]]:[[認可鯖]]が発行した[[アクセストークン]]を指定しなければ[['''なりません''']] [SRC[>>33]]。
:[CODE(URI)@en[[[token_type]]]]:発行した[[トークン]]の種類を指定しなければ[['''なりません''']]
[SRC[>>33]]。
:[CODE(URI)@en[[[expires_in]]]]:[[アクセストークン]]の[[寿命]]を[[秒]]単位で指定する[['''べきです''']] [SRC[>>33]]。
:[CODE(URI)@en[[[scope]]]]:[[クライアント]]が要求した[[適用範囲]]と[[アクセストークン]]の[[適用範囲]]が異なるなら、指定しなければ[['''なりません''']]。同じ場合も指定できます。 [SRC[>>33]]
:[CODE(URI)@en[[[state]]]]:[[クライアント]]が[[認可]]の要求に [CODE(URI)@en[[[state]]]]
[[引数]]を指定していれば、まったく同じ値を指定しなければ[['''なりません''']] [SRC[>>33]]。
]FIG]

;; [46] この場合[[更新トークン]]を発行しては[['''なりません''']] [SRC[>>33]]。

[43] [[資源所有者]]がアクセス要求を拒んだ場合や[[リダイレクトURL]]の欠如や非妥当ではない点で[[要求]]に問題がある場合には、
[[認可符号]]を求められているなら[[リダイレクトURL]]の [[query]]、
[[アクセストークン]]を求められているなら[[リダイレクトURL]] の[[素片識別子]]に
[CODE(MIME)@en[[[application/x-www-form-urlencoded]]]]
形式で次の[[引数]]を追加します [SRC[>>41, >>33]]。
[FIG(list members)[
[FIGCAPTION[
[[URL query]]/[[素片識別子]] ([CODE(MIME)@en[[[application/x-www-form-urlencoded]]]])
]FIGCAPTION]
:[CODE(URI)@en[[[error]]]]:[[誤り符号]]を指定しなければ[['''なりません''']]。
:[CODE(URI)@en[[[error_description]]]]:[[人間可読]]な[[誤り]]の説明を指定して構いません。
:[CODE(URI)@en[[[error_uri]]]]:[[人間可読]]な[[誤り]]の説明を含む[[Webページ]]の [[URL]]
を指定して構いません。
:[CODE(URI)@en[[[state]]]]:[[クライアント]]が[[認可]]の要求に [CODE(URI)@en[[[state]]]]
[[引数]]を指定していれば、まったく同じ値を指定しなければ[['''なりません''']]。
]FIG]

[30] [[応答]]の[[引数]]は、複数指定しては[['''なりません''']] [SRC[>>1]]。

;; [40] [[リダイレクトエンドポイント]]、[[認可符号]]も参照。

[42] [[リダイレクトURL]]が指定されていない場合、[[非妥当]]な場合、一致しない場合や、
[[クライアント識別子]]が指定されない場合や[[非妥当]]な場合には、
[[資源所有者]]に[[誤り]]を知らせる[['''べき''']]であり、
自動的に[[非妥当]]な[[リダイレクトURL]]に[[リダイレクト]]しては[['''なりません''']]。
[SRC[>>1, >>41, >>33]]

;; [51] [[OAuth 1.0]] の [CODE(URI)@en[[[oauth_callback]]=[[oob]]]]
に相当する仕組みは用意されていません。他の[[承諾型]]を使うなどするべきです。

* 資源所有者に対する認可の確認画面

[11] 要求されたアクセスを[[認可]]するかどうか [[OAuth 1.0]]
[[鯖]]が[[資源所有者]]に尋ねるときには、
[[一時credentials]]と[[クライアント]]の [[identity]]
との関連付けに基づき、アクセスを要求している[[クライアント]]についての情報を表示する[['''べきです''']]。
表示に際しては、その情報が[RUBYB[検証]@en[verify]]されたものかどうか示す[['''べきです''']]。
[SRC[>>3]]

[50] [[OAuth 2.0]] [[認可鯖]]は、[[資源所有者]]の[[認証]]を明示的に行った上で、
[[クライアント]]や要求されている[[認可]]の[[適用範囲]]や[[寿命]]についての情報を[[資源所有者]]に提供する[['''べきです''']]。
現在の[[クライアント]]に照らしてその情報を確認し[[認可]]するかどうかを判断するのは[[資源所有者]]の責任です。 [SRC[>>48]]

;; [[トークンエンドポイント]]の[[クライアント認証]]の項も参照。

[49] [[OAuth 2.0]] [[認可鯖]]は、繰り返される[[認可]]の要求について、
[[クライアント認証]]が行われる場合やその他の手段で本来の[[クライアント]]から求められていると確認できる場合を除き、
(明示的に[[資源所有者]]が操作せずに) 自動的に処理する[['''べきではありません''']] [SRC[>>48]]。

[19] この確認画面は[[クリックジャッキング]]対策が必要です。
また[[Webブラウザー]]以外で表示したり、[[アドレスバー]]を隠したりするのは[[フィッシング]]の疑いを拭い去れないため、避けるべきと考えられています。

[47] [[ネイティブアプリケーション]]は埋め込み[[ブラウザー]]
([[アプリ内ブラウザー]]) ではなく外部の[[ブラウザー]]を使う[['''べきです''']] [SRC[>>48]]。
