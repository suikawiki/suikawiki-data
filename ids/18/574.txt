[2] [DFN[[RUBYB[タスクキュー]@en[task queue]]]]は、[[イベントループ]]における[[タスク]]の[[順序付き]]の[[リスト]]
([[キュー]]) です。
[[Webブラウザー]]内に常にいくつか存在します。

* 仕様書

[REFS[
- [9] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2016-12-06 07:17:59 +09:00]]) <https://html.spec.whatwg.org/#event-loops>
-- [1] '''[CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#task-queue>'''
-- [19] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#the-event-loop>
-- [10] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2016-12-06 07:17:59 +09:00]]) <https://html.spec.whatwg.org/#worker-event-loop>
-- [44] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#task-source>
-- [45] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2013-02-09 02:07:40 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#unshipped-port-message-queue>
- [78] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2016-12-06 07:17:59 +09:00]]) <https://html.spec.whatwg.org/#parsing-main-incdata>
]REFS]

* 意味

[4] [[タスクキュー]]は、[[タスク]]の[[キュー]]です [SRC[>>1]]。
0個以上の[[タスク]]を入れたり出したりできます。
[[キュー]]ですから原則として [[FIFO]] ですが、それ以外の特別な操作もあります。

[5] 一つの[[タスク]]が複数の[[タスクキュー]]に同時に含まれることはありません。

* 文脈

[18] [[イベントループ]]は、1つ[[以上]]の[DFN[[F[タスクキュー群]]]]を持ちます [SRC[>>1]]。

[31] [[イベントループ]]がいくつ[[タスクキュー]]を持つかは、[[実装依存]]です。

[EG[
[12] 例えば、[[マウス操作]]その他の[[利用者]]の操作 ([[利用者対話タスク源]])
の[[タスクキュー]]と、それ以外の[[タスクキュー]]とで2つ用意し、
[[利用者]]の操作の[[タスクキュー]]を優先的に処理する、という戦略を採ることができます。
[SRC[>>1]]
]EG]

[32] ある[[イベントループ]]で、
ある[[タスク源]]から来た[[タスク]]をどの[[タスクキュー]]に追加するかは、
[[実装依存]]の方法で固定しなければ[MUST[なりません]] [SRC[>>1]] (>>3)。

[84] 実装戦略によっては実行時に[[タスクキュー]]が増減するかもしれませんが、
同じ[[タスク源]]の[[タスク]]は同じ[[タスクキュー]]に入れなければならないという原則は歪められません。

;;
[7] 同じく[[タスク]]の[[キュー]]であっても、
[FIG(list middle)[
- [[セッション履歴探索キュー]]
- [[マイクロタスクキュー]]
- [[ポートメッセージキュー]]
- [[未出荷済みポートメッセージキュー]]
- [[pending application cache download process tasks]]
]FIG]
... は定義上[[タスクキュー]]とは異なるものです。
([[タスクキュー]]は[[データ型]]ではなく、[[イベントループ]]のフィールド名と捉えるべきもののようです。)


* タスク源

[46] 各[[タスク]]は、何らかの[DFN[[RUBYB[タスク源]@en[task source]]]]から[RUBYB[来る]@en[come]]ものと定義されます
[SRC[>>44]]。

[61] [[タスクキュー]]は[[タスク源]]によって分けられており、
同じ[[タスク源]]の[[タスク]]同士の実行順序は[[タスクキュー]]への追加順序となることが保証されます。

[62] [[タスク源]]は、追加時に[[タスクキュー]]の決定に使われる他、
何らかの理由で[[タスクキュー]]から[[タスク]]を削除する条件として使われることもあります。

[49] [[タスク源]]としては次のものがあります。
[FIG(list middle)[
- [[DOM操作タスク源]]
- [[利用者対話タスク源]]
- [[ネットワーク処理タスク源]]
- [[履歴探索タスク源]]
- [[媒体要素イベントタスク源]]
- [[画布blob直列化タスク源]]
- [[画布更新タスク源]]
- [[タイマー・タスク源]]
- [[遠隔イベント・タスク源]]
- [[WebSocketタスク源]]
- [[ポートメッセージキュー]]
- [[未出荷済みポートメッセージキュー]]
- [[[CODE(DOMi)@en[XMLHttpRequest]]タスク源]]
- [[[CODE(DOMi)@en[FileReader]]タスク源]]
- [[データベース・アクセス・タスク源]]
- [[埋め込みタスク源]]
- [[WebGLタスク源]]
- [[マイクロタスクタスク源]]
- [[フォント読み込みタスク源]]
- [[application life-cycle task source]]

[HISTORY[
- [[投稿済みメッセージタスク源]]
- [[雛形タスク源]]
- [[[CODE(DOMi)@en[FileSaver]]タスク源]]
- [[装置タスク源]]
- [[[CODE(DOMi)@en[PendingOp]]タスク源]]
]HISTORY]
]FIG]

[53] [[タスク源]]の一覧は >>54 にあります。

[REFS[
- [54] [CITE[data-web-defs/data/browsers.json at master · manakai/data-web-defs]] ([TIME[2014-04-09 13:08:57 +09:00]] 版) <https://github.com/manakai/data-web-defs/blob/master/data/browsers.json>
]REFS]



[50] ほとんどの[[タスク源]]は[[イベントループ]]に1つずつ存在していますが、
[[ポートメッセージキュー]]は[[著者]]が [CODE(DOMi)@en[[[MessagePort]]]]
[[オブジェクト]]を作成することによって任意個作成されます。
[[媒体要素イベントタスク源]]と
[[[CODE(DOMi)@en[XMLHttpRequest]]タスク源]] もオブジェクトごとに存在します。
[[[CODE(DOMi)@en[FileReader]]タスク源]]、[[[CODE(DOMi)@en[FileSaver]]タスク源]]もオブジェクトごとに存在するようです。

[51] [[未出荷済みポートメッセージキュー]]は[RUBYB[仮想]@en[virtual]]タスク源 [SRC[>>54]]
であり、その[[タスク]]は[[ポートメッセージキュー]]にも[[未出荷済みポートメッセージキュー]]にも属するという特殊な状態になっています。
[[未出荷済みポートメッセージキュー]]は[[イベントループ]]ごとに1つだけあります [SRC[>>45]]。

;; [52] 転送していない [CODE(DOMi)@en[[[MessagePort]]]] では必ず同じ順序で[[タスク]]が実行されることを保証し、
転送してしまった [CODE(DOMi)@en[[[MessagePort]]]] では任意の実行順序となることを認めるためにこのような複雑な構造になっています。

;; [88] 同じ[[タスク源]]なら同じ[[タスクキュー]]を使うとの制約から、
[[未出荷済みポートメッセージキュー]]に入る[[タスク]]は ([[ポートメッセージキュー]]に関わらず)
同じ[[タスクキュー]]に入るものとしなければなりません。[[出荷]]済みの[[ポートメッセージキュー]]にはこの制約はありません。

** マイクロタスクとの関係

[58] [[マイクロタスク]]の[[タスク源]]はすべて[[マイクロタスクタスク源]]と定義されています。

[59] [[マイクロタスク]]には[[タスクキュー]]とは別の[[マイクロタスクキュー]]が存在しています。
これは[[マイクロタスク源]]の[[タスク]] ([[マイクロタスク]]) を実行する[[タスクキュー]]とは別のものです。

* タスクキューの構造

[83] [[仕様書]]上、[[タスクキュー]]は[[タスク]]の[[順序付きリスト]]であるとしか説明されていません。
しかし、[[タスクキュー]]上の[[タスク]]には、[F[タスク源]]、[F[文書]]、[F[fetch]]
という情報が関連付けられていて、これが[[タスクキュー]]が関わる色々な演算で重要な役目を持ちます。

[85] [[タスクキュー]]は、[F[タスク源]]、[F[文書]]、[F[fetch]] という情報を持った[[タスク]]の[[キュー]]であるが、
通常の[[キュー]]とは異なる特殊な[[演算]]も持つ、と解釈することもできますし、
[F[タスク源]]、[F[文書]]、[F[fetch]] をキーとする[[タスク]]のリスト
([DFN[タスクキュー部分リスト]]) をいくつか重ね合わせて[[キュー]]として捉えたものが[[タスクキュー]]である、
と解釈することもできそうです。

[86] [[ポートメッセージキュー]]は、[[タスクキュー部分リスト]]の一種であると解せます。

;; [[ポートメッセージキュー]]も参照。

[87] [[未出荷済みポートメッセージキュー]]は、いくつかの[[ポートメッセージキュー]]を束ねたものです。

[65] [[タスクキュー部分リスト]]は、[F[状態]]を持ちます (>>66)。

* 追加

[11] [[仕様書]]の[[アルゴリズム]]上で新たな[[タスク]]の実行を予約する操作を、
[DFN[[RUBYB[[[タスクをキューに追加]]]@en[queue a task]]]] [SRC[>>1]] といいます。

[43] [[タスク]]は、その処理に関係する[[イベントループ]]に追加されます。
[[Webブラウザー]]が複数の[[イベントループ]]を持つ場合、
処理対象の[[文書]]や[[ワーカー]]を担当している[[イベントループ]]の[[タスクキュー]]に追加されることになります。

[3] [[タスク]]は、その出自である[[タスク源]]によって決まる[[タスクキュー]]に追加されます。
[[イベントループ]]が複数の[[タスクキュー]]を持つ場合、
同じ[[タスク源]]からの[[タスク]]は必ず同じ[[タスクキュー]]に追加され、
相互の順序は保持されますが、
異なる[[タスク源]]からの[[タスク]]は異なる[[タスクキュー]]に追加されるかもしれないため、
順序は保証されません。


[37] [[タスクをキューに追加]]する処理は、次の引数を受け取ります。
[FIG(list members)[
: [VAR[イベントループ]] : 
[[タスクをキューに追加]]する処理を現に実行している[[イベントループ]]。
: [VAR[処理]] : 
[[アルゴリズム]]と一連の[[引数]]の値。
: [VAR[タスク源]] :
[[タスク源]]。
: [VAR[文脈]] : 
[[要素]]、[[閲覧文脈]]、[[スクリプト]]のいずれか。
[[タスクをキューに追加]]の呼び出し元を意味しています。
: [VAR[fetch]] :
[[fetch]] または [CODE[null]]。 [[fetch]] から[[タスクをキューに追加]]する場合には、
その [[fetch]] の[[実現値]]となります。既定値は [CODE[null]]。
]FIG]

[38] 次のようにしなければ[MUST[なりません]]。
[FIG(steps)[
= [14] [VAR[文脈]]の[F[設定群オブジェクト]]の[F[大域オブジェクト]]が
[CODE(DOMi)@en[WorkerGlobalScope]] で、
[VAR[文脈]]の[F[設定群オブジェクト]]の[F[大域オブジェクト]]の[F[閉じ中]]が[[真]]なら、
== [68] ここで停止します。 [SRC[>>10]]
= [42] [VAR[文書]]を、[VAR[文脈]]により、次の値に設定します [SRC[>>1]]。
[FIG(switch)[
: [[要素]] : [VAR[文脈]]の[F[節点文書]]
: [[閲覧文脈]] : [VAR[文脈]]の[F[活性文書]]
: [[スクリプト]] : [VAR[文脈]]の[F[設定群オブジェクト]]の[F[有責文書]]
]FIG]
= [39] [VAR[タスク]]を、[[タスク]]に設定します。
[FIG(list members)[ [40] [[タスク]]
: [F[処理]] : [VAR[処理]]
: [F[[[triggered by user activation]] その他のフラグ群]] :
[VAR[イベントループ]]の[F[現在走っているタスク]]が [CODE[null]] でなければ、
[VAR[イベントループ]]の[F[現在走っているタスク]]の
[F[[[triggered by user activation]] その他のフラグ群]]
: [F[タスク源]] : [VAR[タスク源]]
: [F[文書]] : [VAR[文書]]
: [F[fetch]] : [VAR[fetch]]
]FIG]
= [13] [VAR[タスクキュー]]を、
[VAR[イベントループ]]の[F[タスクキュー群]]の[[タスクキュー]]のいずれかを[VAR[タスク源]]に基づく[[実装依存]]の方法で選択した結果に設定します。
= [41] [VAR[タスク]]を[VAR[タスクキュー]]の末尾に追加します。
]FIG]

[35] [[タスクをキューに追加]]する操作は、色々な処理から呼び出されます。

[36] この他、[[ポートメッセージキュー]]の操作
([CODE(DOMm)@en[postMessage]] や [F(ss)[Transfer]]) で[[タスク]]が[[ポートメッセージキュー]]に追加されることがあります。

* 存在

[28] [CODE(DOMi)@en[[[EventSource]]]], [CODE(DOMi)@en[[[MessagePort]]]] の[[ごみ収集]]のタイミングは、
[[タスク]]が[[タスク・キュー]]に残っているかによって決まります。

;; [29] これは[[タスク]]から [CODE(DOMi)@en[[[EventSource]]]], 
[CODE(DOMi)@en[[[MessagePort]]]] へ[[強い参照]]があると解釈できるかもしれません。

;; [30] [[XHR]] は逆に[[ごみ収集]]によって[[タスク]]を破棄します。

[8] [[the [CODE(HTMLe)@en[embed]] element setup steps]] は、
同[[要素]]に関する[[タスク]]が他に追加されている場合、何も実行しません。
(実行中かどうかではなく追加されたかどうかの検査です。)
この検査は自[[タスク]]のみならず、そこから追加された他の[[タスクキュー]]からも行われます。

* 取得

[15] [[タスクキュー]]は [[FIFO]] っぽいもので、基本的には最古のものから取得 (実行)、
削除されます。しかし条件を満たさない[[タスク]]は[[イベントループ]]に無視されることになっていますから、
厳密には [[FIFO]] とは言えません。

[20] [VAR[イベントループ]]について[DFN[タスクキューからタスクを選択]]するには、
次のようにしなければ[MUST[なりません]]。
[FIG(steps)[
= [70] [VAR[タスクキュー]]を、
[VAR[イベントループ]]の[F[タスクキュー群]]の[[タスクキュー]]のいずれかを[VAR[タスク源]]に基づく[[実装依存]]の方法で選択した結果に設定します。
[SRC[>>9]]
= [72] [VAR[タスクキュー]]に含まれる[VAR[タスク]]について、順に、
== [73] [VAR[タスク]]の属する[[タスクキュー部分リスト]]の[F[状態]]が有効なら、
=== [74] [VAR[タスク]]を返し、ここで停止します。
== [75] それ以外なら、
=== [76] [CODE[null]] を返し、ここで停止します。
= [77] [CODE[null]] を返します。
]FIG]

[21] 同じ[[タスクキュー]]の[[タスク]]は、無視 (遅延) されるものを除き、
実行順序が保証されています。異なる[[タスクキュー]]の[[タスク]]同士がどの順序で実行されるかは、
[[実装依存]]です。

[69] この辺の処理は、[[プラットフォーム]]の影響を受けることもあるでしょうし、
あるいは何を優先的に実行するかは[[実装の品質]]の問題であって (>>12)
[[Webブラウザー事業者]]が工夫して競合するべき点でもあるでしょうから、
仕様としてはあまり具体的に規定せず、かなり自由度を持たせているようです。
何をどのような順序で処理するかが[[相互運用性]]にあまり影響しないということもあります。

[EG[
[79] [[WebSocketメッセージ受信]]における[[タスク]]の実行では、
[[タスク]]の実行に必要な [[I/O]] 
処理を待つ間他の[[タスクキュー]]を実行するような効率化が推奨されています。

;; [[WebSocketメッセージ受信]]参照。
]EG]

[48] なお、[[タスク]]は[[イベントループ]]による実行後に[[タスクキュー]]から削除されます。

-*-*-

[66] [[タスクキュー部分リスト]]は、[F[状態]]を持ちます。その値は有効か無効のいずれかです。
既定値は有効です。

[67] [F[文書]]が [CODE[null]] でなく、[F[文書]]が[[完全に活性]]でない [SRC[>>9]]
ような[[タスクキュー部分リスト]]の[F[状態]]は、無効とします。

;; [47] 従って、[[履歴]]移動により非表示状態になった[[文書]]の[[タスク]]は、
実行されません。しかし捨てられたわけではないので、再び表示状態に戻れば実行されます。

[34] [[ポートメッセージキュー]]は、有効か無効かのいずれかの[F[状態]]を持ちます。
既定値は無効です。

;; [[仕様書]]上は、[[ポートメッセージキュー]]は無効である間[[イベントループ]]から無視されると規定されています。
[[ポートメッセージキュー]]参照。

-*-*-

[80] [[HTML構文解析器]]の [CODE(HTMLe)@en[script]] [[要素]]の[[終了タグ]]の処理は、
[DFN[[RUBYB[字句化器をブロック]@en[block the tokenizer]]]]する場合があります。これは、
[DFN[[RUBYB[字句化器をブロック解除]@en[unblock the tokenizer]]]]するまでの間、
当該[[字句化器]]を実行することになる[[タスク]]を[[イベントループ]]が実行しないものと説明されています
[SRC[>>78]]。

[71] なぜかこれは[[構文解析器]]の動作の規定で説明されるだけで、
[[イベントループ]]側の[[アルゴリズム]]には組み込まれていません。
そのため[[仕様書]]の意図する正確な動作は不明です。
しかし、[[構文解析器]]自体が正常に動作することや他の挙動との整合性、
実際の [[Webブラウザー]]の動作との一貫性を考慮すると、
[[イベントループ]]が単一の[[タスクキュー]]しか持たない場合であってもそのような[[タスク]]の後に続く一切の[[タスク]]を実行できないとは考えにくく、
[[完全に活性]]でない[[タスク]]と同様、ブロック解除されるまで無視されると解釈するのが妥当そうです。

[82] なお、このような挙動を引き起こした[[HTML構文解析器]]によってブロックされる、
[[字句化器]]を実行することになる[[タスク]]、というのは、
[[navigate]] によって実行される [[fetch]] の [[process response]] や
[[process response end-of-body]] の処理を行う[[ネットワークタスク源]]の[[タスク]]です。

[81] ということは、字句化器をブロックするとは、
([F[タスク源]] = [[ネットワークタスク源]], [F[文書]] = [[HTML構文解析器]]の[F[文書]],
[F[fetch]] = その[[構文解析器][HTML構文解析器]]と対になる [[fetch]])
の[[タスクキュー部分リスト]]の[F[状態]]を[[無効]]に設定する、と言い換えられることになります。

* 削除

[22] [[タスク]]は実行される際に[[キュー]]から削除されますが、それ以外にも削除されることがあります。
[FIG(list)[
- [23] 特定の [CODE(DOMi)@en[[[Document]]]] に関連付けられた[[タスク]]がすべて削除されることがあります。
-- [CODE(JS)@en[[[window.open]]]]
-- [[discard a [CODE(DOMi)@en[Document]]]]
- [24] 特定の[[タスク源]]の[[タスク]]がすべて削除されることがあります。
-- [[media element load algorithm]]
-- [CODE(DOMi)@en[[[FileReader]]]] の [CODE(DOMm)@en[[[abort]]]]
-- [CODE(DOMi)@en[[[FileSaver]]]] の [CODE(DOMm)@en[[[abort]]]]
- [27] 特定の[[文書族]]・[[タスク源]]の[[タスク]]がすべて削除されることがあります。
-- [CODE(JS)@en[[[window.open]]]]
-- [[セッション履歴エントリーの挿入]]
-- [[素片識別子へのnavigate]]
- [26] 特定のものに関する [[fetch]] [[算法]]が生成した[[タスク]]がすべて削除されることがあります。
-- [[update the image data]]
-- [[媒体要素]]
-- [[text track]]
-- [[abort a document]]
-- [[XHR]] の[[ごみ収集]]
- [25] すべての[[タスク]]が削除されることがあります。
-- [CODE(DOMi)@en[[[WorkerGlobalScope]]]] の [CODE(DOMm)@en[[[close]]]]
-- [[kill a worker]]
- [33] 特定の[[タスク]]が削除されることがあります。
-- [[planned navigation]]
]FIG]

[17] [[ポートメッセージキュー]]においては、[[タスク]]が (関連付けられた[F[文書]]を書き換えつつ)
他の[[ポートメッセージキュー]]へと移動されることがあります。

;; [[ポートメッセージキュー]]、[CODE(DOMi)@en[MessagePort]] 参照。

* イベント順との関係

[55] [[DOM3イベント]]は[[イベント]]同士の関係を[[イベント順]]により規定しています。
[[DOM3イベント]]は[[イベント・ループ]]や[[タスク]]という概念を使っておらず、
この[[イベント順]]は適宜[[タスク源]]として使うことによって[[イベント・ループ]]と互換性がある形で実装できる、
としています。

[REFS[
- [56] [CITE@en-US[Document Object Model (DOM) Level 3 Events Specification]] ([TIME[2012-03-21 00:00:37 +09:00]] 版) <http://dev.w3.org/2006/webapi/DOM-Level-3-Events/html/DOM3-Events.html#event-order-and-loops>
]REFS]

;; [57] 具体的にどう対応付けるのかは説明を読んでもあんまりよくわかりません。 [[HTML]]
は[[マウス]]も[[鍵盤]]も同じ[[利用者対話タスク源]]で扱っていますが、
[[DOM3イベント]]は独立してるからそれぞれ別の[[タスク源]]だ、とか言っていますし、
[[焦点]]の変更など独立した操作がそれぞれ[[タスク源]]だ、とか訳のわからないことも言ってます。

* 歴史

[REFS[
- [6] [CITE@en[Web Applications 1.0 r2074 Define event loops, task queues, etc; Make 'fetching' use this mechanism (everything will in due course); Fix some cross-references around 'interactive content'.]]
([TIME[2008-08-16 09:52:00 +09:00]] 版)
<https://html5.org/r/2074>
- [60] [CITE[IRC logs: freenode / #whatwg / 20100824]]
([TIME[2010-09-02 21:15:06 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20100824>
- [16] [CITE@en[Web Applications 1.0 r7992     Make <form> submission more like reality.]] ([TIME[2013-06-20 06:37:00 +09:00]] 版) <http://html5.org/tools/web-apps-tracker?from=7991&to=7992>
- [19] [CITE@en[Fix #19: Remove majority of "DOM Event Architecture" section · w3c/uievents@6cb42db]]
([TIME[2016-03-08 18:11:43 +09:00]] 版)
<https://github.com/w3c/uievents/commit/6cb42db4054c5502d28c3f53c6ae64da5e475747>
]REFS]

