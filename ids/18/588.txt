* 仕様書

[REFS[
- [14] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2016-12-05 14:51:53 +09:00]]) <https://html.spec.whatwg.org/#message-ports>
-- [1] '''[CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#port-message-queue>'''
-- [2] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2013-02-09 02:07:40 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#unshipped-port-message-queue>
]REFS]

* 状態

[11] [[ポートメッセージキュー]]は、[[タスク源]] [SRC[>>1]] であり、
[[キュー]]です。

[12] 加えて、[F[状態][ポートメッセージキューの状態]]を持ちます。
初期状態では[RUBYB[[[無効]]]@en[disabled]]です [SRC[>>1]]。
一旦これを[RUBYB[[[有効]]]@en[enabled]]にすると、[[無効]]には戻せません [SRC[>>1]]。

* 文脈

[13] [CODE(DOMi)@en[MessagePort]] が[F[ポートメッセージキュー]]を持ちます。

* 処理

[15] [CODE(DOMi)@en[MessagePort]] [VAR[ポート]]の[F[ポートメッセージキュー]]の有効化は、
次のようにしなければ[MUST[なりません]] [SRC[>>14]]。
[FIG(steps)[
= [18] [VAR[イベントループ]]を、[VAR[ポート]]の[F[所有者][MessagePort]]の[F[有責イベントループ]]に設定します。
= [16] [VAR[イベントループ]]の[F[[[タスク源]]群]]に、
[VAR[ポート]]の[F[ポートメッセージキュー]]を追加します。
= [17] [VAR[ポート]]の[F[ポートメッセージキュー]]の[F[状態][ポートメッセージキューの状態]]を[[有効]]に設定します。
]FIG]

[19] その他の操作は[[タスクキュー]]、[[タスク源]]を参照。

[20] [CODE(DOMi)@en[MessagePort]] も参照。

* 歴史

[REFS[
- [21] [CITE@en['''['''''']''' (0) Simplify message ports: use queueing instead of transient 'act…]] ([[Hixie]]著, [TIME[2008-08-06 16:24:38 +09:00]]) <https://github.com/whatwg/html/commit/ebefa1c712950ea904e2e4877caa13db8b1d9104>
]REFS]

[22] [[ポートメッセージキュー]]はここで導入されました。
open と closed の2つの状態を持っていました。
この時同時に追加された [CODE[start]] [[メソッド]]を呼び出すか、
[CODE[onmessage]] [[IDL属性]]に値を設定するかのいずれかにより、
closed から open へと遷移することとされていました。

[REFS[
- [7] [CITE@en[Web Applications 1.0 r2085 Further work on the event loop front. (WebSockets, postMessage, MessagePorts, setTimeout)]]
([TIME[2008-08-19 18:30:00 +09:00]] 版)
<https://html5.org/r/2085>
- [24] [CITE@en['''['''gwr''']''' (2) MessagePorts shouldn't be GCed even when their queue is clo…]] ([[Hixie]]著, [TIME[2008-10-21 19:24:55 +09:00]]) <https://github.com/whatwg/html/commit/7c0d06509cbfc808e06aac3b4ae8edafbf0a771c>
- [8] [CITE@en[Web Applications 1.0 r2531    Simplify the way messages in ports are handled when the destination's document is not available.]]
([TIME[2008-12-16 10:01:00 +09:00]] 版)
<https://html5.org/r/2531>
- [9] [CITE@en[Web Applications 1.0 r2912 Implicitly open the port message queue of dedicated workers. (Before, they would never actually receive messages, oops...)]]
([TIME[2009-03-26 08:08:00 +09:00]] 版)
<https://html5.org/r/2912>
- [10] [CITE@en[Web Applications 1.0 r6384 Give more explanation about how workers work.]]
([TIME[2011-08-09 05:10:00 +09:00]] 版)
<https://html5.org/r/6384>
- [3] [CITE@en[Web Applications 1.0 r7669     Make MessagePort objects synchronised until they are posted through another port.]] ([TIME[2013-01-30 05:59:00 +09:00]] 版) <http://html5.org/tools/web-apps-tracker?from=7668&to=7669>
- [6] [CITE@en[Web Applications 1.0 r8153  Disabled port message queues shouldn't have their messages dispatched when they're still unshipped, nor should they stall the entire message queueing mechanism.]]
([TIME[2013-08-27 02:59:00 +09:00]] 版)
<https://html5.org/r/8153>
- [5] [CITE@en[Web Applications 1.0 r8154 Reorganise the stuff about port message queues to be clearer.]]
([TIME[2013-08-27 03:02:00 +09:00]] 版)
<https://html5.org/r/8154>
- [23] [CITE@en['''['''giow''']''' (0) Make sure subsequent owners of an ill-fated port's friend …]] ([[Hixie]]著, [TIME[2013-12-12 04:51:50 +09:00]]) <https://github.com/whatwg/html/commit/3d29c3388dd70a93f4d1704f6f3ba5a32a7dd20e>
- [4] [CITE@en[Web Applications 1.0 r8864 Fix the mess I made of port message queues. I'm pretty sure originally they weren't task sources and I corrupted them at some point to be that without changing what I was putting in them. Anyway at this point it's easier just to say that they're real task sources and thus have tasks, even if those tasks have to now be a little more complicated than ideal.]]
([TIME[2014-11-27 09:29:00 +09:00]] 版)
<https://html5.org/r/8864>
]REFS]


