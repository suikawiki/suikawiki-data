* 仕様書

[REFS[
- [14] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2016-12-05 14:51:53 +09:00]]) <https://html.spec.whatwg.org/#message-ports>
-- [1] '''[CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-03-28 21:58:58 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#port-message-queue>'''
-- [2] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2013-02-09 02:07:40 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#unshipped-port-message-queue>
]REFS]

* 状態

[11] [[ポートメッセージキュー]]は、[[タスク源]] [SRC[>>1]] であり、
[[キュー]]です。

[12] 加えて、[F[状態][ポートメッセージキューの状態]]を持ちます。
初期状態では[RUBYB[[[無効]]]@en[disabled]]です [SRC[>>1]]。
一旦これを[RUBYB[[[有効]]]@en[enabled]]にすると、[[無効]]には戻せません [SRC[>>1]]。

* 文脈

[13] [CODE(DOMi)@en[MessagePort]] が[F[ポートメッセージキュー]]を持ちます。

* 処理

[15] [CODE(DOMi)@en[MessagePort]] [VAR[ポート]]の[F[ポートメッセージキュー]]の有効化は、
次のようにしなければ[MUST[なりません]] [SRC[>>14]]。
[FIG(steps)[
= [18] [VAR[イベントループ]]を、[VAR[ポート]]の[F[所有者][MessagePort]]の[F[有責イベントループ]]に設定します。
= [16] [VAR[イベントループ]]の[F[[[タスク源]]群]]に、
[VAR[ポート]]の[F[ポートメッセージキュー]]を追加します。
= [17] [VAR[ポート]]の[F[ポートメッセージキュー]]の[F[状態][ポートメッセージキューの状態]]を[[有効]]に設定します。
]FIG]

* 歴史

[REFS[
- [3] [CITE@en[Web Applications 1.0 r7669     Make MessagePort objects synchronised until they are posted through another port.]] ([TIME[2013-01-30 05:59:00 +09:00]] 版) <http://html5.org/tools/web-apps-tracker?from=7668&to=7669>
]REFS]


[4] [CITE@en[Web Applications 1.0 r8864 Fix the mess I made of port message queues. I'm pretty sure originally they weren't task sources and I corrupted them at some point to be that without changing what I was putting in them. Anyway at this point it's easier just to say that they're real task sources and thus have tasks, even if those tasks have to now be a little more complicated than ideal.]]
( ([TIME[2014-11-27 09:29:00 +09:00]] 版))
<https://html5.org/r/8864>

[5] [CITE@en[Web Applications 1.0 r8154 Reorganise the stuff about port message queues to be clearer.]]
( ([TIME[2013-08-27 03:02:00 +09:00]] 版))
<https://html5.org/r/8154>

[6] [CITE@en[Web Applications 1.0 r8153  Disabled port message queues shouldn't have their messages dispatched when they're still unshipped, nor should they stall the entire message queueing mechanism.]]
( ([TIME[2013-08-27 02:59:00 +09:00]] 版))
<https://html5.org/r/8153>

[7] [CITE@en[Web Applications 1.0 r2085 Further work on the event loop front. (WebSockets, postMessage, MessagePorts, setTimeout)]]
( ([TIME[2008-08-19 18:30:00 +09:00]] 版))
<https://html5.org/r/2085>

[8] [CITE@en[Web Applications 1.0 r2531    Simplify the way messages in ports are handled when the destination's document is not available.]]
( ([TIME[2008-12-16 10:01:00 +09:00]] 版))
<https://html5.org/r/2531>

[9] [CITE@en[Web Applications 1.0 r2912 Implicitly open the port message queue of dedicated workers. (Before, they would never actually receive messages, oops...)]]
( ([TIME[2009-03-26 08:08:00 +09:00]] 版))
<https://html5.org/r/2912>

[10] [CITE@en[Web Applications 1.0 r6384 Give more explanation about how workers work.]]
( ([TIME[2011-08-09 05:10:00 +09:00]] 版))
<https://html5.org/r/6384>