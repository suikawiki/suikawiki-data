[10] [DFN[[CODE(HTTP)@en[[[Meter:]]]]]] [[ヘッダー]]は、
[[起源鯖]]から[[串]]に対して[[応答]]回数の計測に関する指示を行ったり、
[[串]]から[[起源鯖]]に対して計測結果を報告したりするものです。

* 仕様書

[REFS[
- [2] [CITE@en[RFC 2227 - Simple Hit-Metering and Usage-Limiting for HTTP]]
( ([TIME[2011-12-18 04:36:26 +09:00]] 版))
<http://tools.ietf.org/html/rfc2227>
]REFS]

* 意味

[3] [CODE(HTTP)@en[[[Meter:]]]] は、[[キャッシュ]]によって[[利用者エージェント]]からのアクセスの情報が[[鯖]]に伝わらないことを防ぐため[[キャッシュ]]を無効化する [[cache-busting]]
がしばしば行われている [SRC[>>2]] として、その必要性を低めるための代替となる仕組みとして提案されました。

;; ただしすべての [[cache-busting]] を置き換えることを目的とするものではない [SRC[>>2]]
とされています。

[6] [CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]は、
[[起源鯖]]が[[串]]を通じて配信された回数を十分正確に取得する「hit-metering」や、
[[串]]が[[再検証]]なしに[[再利用]]できる回数を指定する「usage-limiting」
を実現します [SRC[>>2]]。

* 構文

[18] [CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]の値は、0個以上の[[指令]]の[[リスト]]
([CODE(HTTP)[#]]) です [SRC[>>2]]。

[FIG(railroad)[
= ?
== [[指令]]
== *
=== [[OWS]]
=== [CODE(HTTP)[[[,]]]]
=== [[OWS]]
=== [[指令]]
]FIG]

* 空のヘッダー

[21] [[要求]]において値が指定されない場合、 [CODE(HTTP)@en[[[will-report-and-limit]]]]
が指定されたのと等価です [SRC[>>2]]。

[34] [[応答]]において値が指定されない場合、 [CODE(HTTP)@en[[[do-report]]]]
が指定されたのと等価です [SRC[>>2]]。

;; [36] [[空文字列]]の[[ヘッダー]]と非[[空文字列]]の[[ヘッダー]]が同時に別々に指定された時にも >>21 や >>34 が適用されるのかは明記されていませんが、
字面通り解釈すると適用されることになります。複数の同名の[[ヘッダー]]は
[CODE(HTTP)[[[,]]]] 区切りで連結しても同じ意味を表すことになっていますから、
[[空文字列]]の[[ヘッダー]]と[[空文字列]]でない[[ヘッダー]]が連結されることもあります。
とすると[[ヘッダー]]の値である[[リスト]]に[[空文字列]]の要素が含まれている時も
>>21 や >>34 のように解釈するべきなのでしょうか?

[22] 更に、 [CODE(HTTP)@en[[[Connection:]] [[Meter]]]] によって
[CODE(HTTP)@en[[[Meter:]]]] ([[空文字列]])
が暗示され、 [CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]は省略できます [SRC[>>2]]。

[35] [CODE(HTTP)@en[[[dont-report]]]] を含まない [CODE(HTTP)@en[[[Meter:]]]]
[[ヘッダー]]は、 [CODE(HTTP)@en[[[do-report]]]] が指定されたとみなします [SRC[>>2]]。

* 文脈

[20] [[串]]は計測や制限に対応していることを示すために [CODE(HTTP)@en[[[Meter:]]]]
[[ヘッダー]]を送信できます。どちらにも対応しない[[串]]は、
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を送信しては[['''なりません''']] [SRC[>>2]]。

[37] [[鯖]]は[[要求]]に [CODE(HTTP)@en[[[Meter]]]] が含まれており、
計測や制限を[[下流]]に委ねたい場合に、 [CODE(HTTP)@en[[[Meter:]]]]
[[ヘッダー]]を送信できます。

[11] [CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を含む[[メッセージ]]は、
[CODE(HTTP)@en[[[Connection:]] [[meter]]]] を含まなければ[['''なりません''']] [SRC[>>2]]。
[CODE(HTTP)@en[[[Meter:]]]] の値が[[空文字列]]になるときは、
[CODE(HTTP)@en[[[Connection:]] [[meter]]]] のみ指定して
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]自体は省略できます。

[12] [CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]は、
[[プロトコルの版]]が [[HTTP/1.1]] [[未満]]の[[メッセージ]]に含めては[['''なりません''']]
[SRC[>>2]]。

[19] この[[ヘッダー]]は複数指定できます [SRC[>>2]]。

* 計測部分木

[8] [[起源鯖]]を[[根]]とし、[[起源鯖]]からの[[応答]]の[[転送]]経路上にあって
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]による計測に対応した[[串]]によって構成される[[木]]のことを[DFN[[RUBYB[計測部分木]@en[metering subtree]]]]
[SRC[>>2]] といいます。

[9] [[起源鯖]]と[[利用者エージェント]]の間には、 [CODE(HTTP)@en[[[Meter:]]]]
[[ヘッダー]]に対応しない[[串]]や、対応しているものの[[上流]]に対応しない[[串]]が存在しているため対応できない[[串]]があるかもしれません。
[[計測部分木]]は、そのような[[串]]も含めた配送経路全体で構成される[[木]]の[[部分木]]となります。

* 指令

** 串の機能を示す指令

[25] [[串]]は[[鯖]]に[[要求]]を送信する際に、次の[[指令]]を送信することができます [SRC[>>2]]。

[26] [DFN[[CODE(HTTP)@en[[[will-report-and-limit]]]]]] は、
利用報告を送信する意思があり、利用制限にも従うつもりであることを表します [SRC[>>2]]。

[27] [DFN[[CODE(HTTP)@en[[[wont-report]]]]]] は、
利用制限に従う意志はあるが利用報告は送信しないことを表します [SRC[>>2]]。

[28] [DFN[[CODE(HTTP)@en[[[wont-limit]]]]]] は、
利用制限には従わないが利用報告は返すつもりであることを表します [SRC[>>2]]。

** 計測の指示と利用の制限

[29] [[鯖]]は[[串]]に[[応答]]を送信する際に、次の[[指令]]を送信することができます [SRC[>>2]]。

[30] [DFN[[CODE(HTTP)@en[[[do-report]]]]]] が指定された場合、[[串]]は[[鯖]]に利用報告を送信しなければ[['''なりません''']] [SRC[>>2]]。

[31] [DFN[[CODE(HTTP)@en[[[dont-report]]]]]] が指定された場合、
[[串]]は[[鯖]]に利用報告を送信する[['''べきではありません''']] [SRC[>>2]]。

[32] [CODE(HTTP)@en[[DFN[[[timeout]]]]=[VAR[[[delta-seconds]]]]]] 
が指定された場合、[[応答]]が作成されてから指定された[[時間]]が経過した時までに計測結果が
0 でなければ、[[串]]は[[鯖]]に利用報告を送信しなければ[['''なりません''']] [SRC[>>2]]。
[CODE(HTTP)@en[[[timeout]]]] は [CODE(HTTP)@en[[[do-report]]]]
を暗示しています [SRC[>>2]]。

[38] [CODE(HTTP)@en[[DFN[[[max-uses]]]]=...]] は、
[[応答]]を「利用」する回数の[[上限]]を指定します。この数には当該[[応答]]の直後の[[転送]]は含めません。
[SRC[>>2]]

;; [41] [[キャッシュ]]が「先読み」のために[[要求]]して [CODE(HTTP)@en[[[max-uses]]]]
が返された場合でも、次の最初の実際の[[クライアント]]からの[[要求]]にその[[キャッシュ項目]]を使って返した時は回数に含まれません [SRC[>>1]]。

[39] [CODE(HTTP)@en[[DFN[[[max-reuses]]]]=...]] は、
[[応答]]を「再利用」する回数の[[上限]]を指定します。
[SRC[>>2]]

* 処理モデル

[4] [CODE(HTTP)@en[[[Meter:]]]] は[[串]]または[[起源鯖]]に対するものです [SRC[>>2]]。
[[利用者エージェント]]には適用されません。

[13] [[プロトコルの版]]が [[HTTP/1.1]] [[未満]]の[[クライアント]]から送信された
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を受け入れては[['''なりません''']] [SRC[>>2]]。

;; [14] これは、[CODE(HTTP)@en[[[Connection:]]]] を正しく処理できない [[HTTP/1.0]]
[[串]]があるためです [SRC[>>2]]。 

** 起源鯖の処理

[23] [[起源鯖]]は、[[要求]]に [CODE(HTTP)@en[[[Meter]]]] が指定されている時、
[[下流]]に計測や制限を委ねるかどうか決定できます。委ねない場合
(や [CODE(HTTP)@en[[[Meter]]]] を実装しない場合) はただ単に 
[CODE(HTTP)@en[[[Meter]]]] を無視して構いません [SRC[>>2]]。

[33] 委ねる場合には、計測や制限を指示する[[指令]]を指定した
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を[[応答]]に含めます [SRC[>>2]]。

** 串の処理

[5] [[串]]は [CODE(HTTP)@en[[[Meter:]]]] を実装しても構いませんが、
実装しなくても構いません [SRC[>>2]]。
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を[[転送]]する[[串]]は、
[[RFC 2227]] に従わなければ[['''なりません''']] [SRC[>>2]]。

;; [7] [[起源鯖]]は [CODE(HTTP)@en[[[Connection:]] [[Meter]]]] 
と指定しなければなりませんから、未対応の[[串]]は [CODE(HTTP)@en[[[Connection:]]]]
[[ヘッダー]]の規定に従い [CODE(HTTP)@en[[[Meter:]]]]
[[ヘッダー]]を[[転送]]時に削除します。

[24] [[串]]は計測や制限を行える時は、[[要求]]にその旨を含めます (>>20)。

[40] [[串]]は[[上流]]からの[[応答]]で指定された「利用」や「再利用」
を使い果たした時には[[キャッシュ項目]]を[[応答]]に含めて返す前に[[再検証]]しなければ[['''なりません''']]。
なお利用報告を送ることを求められている場合には、この[[再検証]]を使って送る[['''べきです''']]。
[SRC[>>2]]

[15] [[串]]は、計測や制限を行う[[応答]]を[[転送]]する際、
[[クライアント]] ([[串]]であれ[[利用者エージェント]]であれ) が[[計測部分木]]に含まれないなら、
[CODE(HTTP)@en[[[Meter:]]]] [[ヘッダー]]を削除し、 
[CODE(HTTP)@en[[[Cache-Control:]] [[s-maxage]]=0]]
を含めなければ[['''なりません''']] [SRC[>>2]]。

;; [16] これにより[[計測部分木]]外の[[共有キャッシュ]]は常に[[計測部分木]]内の[[鯖]]に[[再検証]]しなくてはならなくなりますから、
[[計測部分木]]内の[[串]]が常に計測できることとなります。

[17] [[串]]の[[下流]]に複数の[[計測部分木]]内の[[串]]がある場合、
利用可能回数を分配することができます。また計測結果は合算して[[上流]]に報告することとなります。
[SRC[>>2]]

* 歴史

[1] [CITE@en[draft-ietf-http-hit-metering-00 - Simple Hit-Metering and Usage-Limiting for HTTP]]
( ([TIME[2012-01-20 20:05:43 +09:00]] 版))
<http://tools.ietf.org/html/draft-ietf-http-hit-metering-00>
