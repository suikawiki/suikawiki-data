[36] [DFN[[CITE[Referrer Policy]]]] は、[[参照元]]の [[URL]] の決定方法を規定した[[仕様書]]です。

* 仕様書

[REFS[
- [30] [CITE@en[Referrer Policy]] ([TIME[2016-04-13 19:33:46 +09:00]] 版) <https://w3c.github.io/webappsec-referrer-policy/>
-- [44] [CITE@en[Referrer Policy]] ([TIME[2016-05-21 07:45:08 +09:00]]) <https://w3c.github.io/webappsec-referrer-policy/#referrer-policies>
-- [55] [CITE@en[Referrer Policy]] ([TIME[2016-05-21 07:45:08 +09:00]]) <https://w3c.github.io/webappsec-referrer-policy/#referrer-policy-header>
-- [60] [CITE@en[Referrer Policy]] ([TIME[2016-05-21 07:45:08 +09:00]]) <https://w3c.github.io/webappsec-referrer-policy/#parse-referrer-policy-from-header>
-- [70] [CITE@en[Referrer Policy]] ([TIME[2016-05-21 07:45:08 +09:00]]) <https://w3c.github.io/webappsec-referrer-policy/#determine-policy-for-token>
- [76] [CITE@en-US[Fetch Standard]] ([TIME[2016-05-24 18:42:15 +09:00]]) <https://fetch.spec.whatwg.org/#concept-request-referrer>
- [78] [CITE@en-US[Fetch Standard]] ([TIME[2016-05-24 18:42:15 +09:00]]) <https://fetch.spec.whatwg.org/#concept-request-referrer-policy>
- [80] [CITE@en-US[Fetch Standard]] ([TIME[2016-05-24 18:42:15 +09:00]]) <https://fetch.spec.whatwg.org/#concept-referrer-policy>
- [85] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-05-24 17:09:37 +09:00]]) <https://html.spec.whatwg.org/#referrer-policy-attribute>
- [87] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-05-24 17:09:37 +09:00]]) <https://html.spec.whatwg.org/#concept-document-referrer-policy>
]REFS]

* 意味

[42] [DFN[[RUBYB[参照元ポリシー]@en[referrer policy]]]]は、
[[fetch]] の際に [CODE(HTTP)@en[Referer:]] [[ヘッダー]]の値を決める[[アルゴリズム]]の動作を指定するものです
[SRC[>>30]]。

[37] 次のような理由から、[[著者]]が[[参照元]]を制御したいことがあります [SRC[>>30]]。
[[参照元ポリシー]]は、こうした用法を考慮して設計されています。
[FIG(list)[
- [38] [[SNS]] の [[URL]] に当該 [[URL]] の[[著者]]の識別子が含まれているような場合に、
[[プライバシー]]保護のため、その漏洩を防ぎたい。
- [40] [[URL]] に含まれる[[セッション識別子]]や [[capability URL]] の漏洩を防ぎたい。
- [39] 具体的な [[URL]] は知らせたくないが、当該 [[SNS]] 
からリンクされていることはリンク先に知らせたい。
- [41] [[HTTPS]] の[[ブログ]]から、 [[素のHTTP]]の[[ブログ]]へと[[リンク]]し、
[[トラックバックリンク]]を受信したい。
]FIG]

* 値

[81] [[参照元ポリシー]]は、次の値です。

[45] [DFN[[CODE[no-referrer]]]] は、
[[参照元]]を決して送らないことを表します [SRC[>>44]]。

;; [77] [CODE[no-referrer]] [SRC[>>76]] は、[[要求]]の[F[参照元]]において、
[[参照元]]を送らないことを表すために ([[URL]] のかわりの値として) 使われることがあります。

[46] [DFN[[CODE[no-referrer-when-downgrade]]]] は、
[[TLS保護]]された[[環境設定群オブジェクト]]から
非 [[a priori authenticated URL]] への[[要求]]には何も送らず、
そうでない[[要求]]では完全な [[URL]] を送ることを表します [SRC[>>44]]。

[47] [CODE[no-referrer-when-downgrade]] は、指定がない場合の[[既定値]]としても使われます
[SRC[>>44]]。

;; [CODE(HTTP)@en[Referer:]] 参照。

[48] [DFN[[CODE[same-origin]]]] は、
[[同一起源要求]]なら [[Strip [VAR[url]] for use as a referrer]] を適用した結果を送り、
[[交差起源要求]]なら何も送らないことを表します [SRC[>>44]]。

[49] [DFN[[CODE[origin]]]] は、
[[要求クライアント]]の[F[起源]]の[[ASCII直列化]]を送ることを表します [SRC[>>44]]。

[50] [DFN[[CODE[origin-when-cross-origin]]]] は、
[[同一起源要求]]なら [[Strip [VAR[url]] for use as a referrer]] を適用した結果を送り、
[[交差起源要求]]なら[[要求クライアント]]の[F[起源]]の[[ASCII直列化]]を送ることを表します [SRC[>>44]]。

[51] [DFN[[CODE[unsafe-url]]]] は、
[[[VAR[url]] for use as a referrer]] を適用した結果を送ることを表します [SRC[>>44]]。

[52] [[空文字列]]は、その文脈で値が明示されない時に使うべき値に従うことを表します。
そのような値が無い時は、 [CODE[no-referrer-when-downgrade]] を表します。 [SRC[>>44]]
[[参照元ポリシー属性]]の[[非妥当値既定値]]と[[欠値既定値]]としても使われます [SRC[>>85]]。

[82] これらの値は、 [CODE(HTTP)@en[Referrer-Policy:]] [[ヘッダー]]の[[リスト][リスト (HTTP)]]要素としても使えます。
[[ASCII大文字・小文字不区別]]です。

[84] これらの値は、 [[列挙型]] [DFN[[CODE[ReferrerPolicy]]]] [SRC[>>80]]
として使えます。 [CODE(DOMi)@en[Request]] [[インターフェイス]]の
[CODE(DOMa)@en[referrerPolicy]] [[IDL属性]]などで使われます。
すべて[[ASCII小文字]]で表します。

[86] これらの値は、[DFN[[RUBYB[[[参照元ポリシー属性]]]@en[referrer policy attribute]]]]である[[列挙型属性]]の[[属性値]]として使えます
[SRC[>>85]]。[[ASCII大文字・小文字不区別]]です。
[[非妥当値既定値]]と[[欠値既定値]]は、[[空文字列]]です [SRC[>>85]]。

[71] 指定された値[VAR[字句]]の解釈は、 [DFN[Determine [VAR[token]]’s Policy]]、
すなわち次のようにします [SRC[>>70]]。

[FIG(steps)[
= [72] [VAR[字句]]を[[ASCII小文字に変換]]した結果により、
[FIG(switch)[
: [DFN[[CODE[never][no-referrer]]]] か [CODE[no-referrer]] か[[空文字列]] : 
[CODE[no-referrer]] を返し、ここで停止します。
: [DFN[[CODE[default][no-referrer-when-downgrade]]]] か [CODE[no-referrer-when-downgrade]] : 
[CODE[no-referrer-when-downgrade]] を返し、ここで停止します。
: [CODE[origin][Referrer Policy]] : [CODE[origin][Referrer Policy]] を返し、ここで停止します。
: [CODE[same-origin]] : [CODE[same-origin]] を返し、ここで停止します。
: [CODE[origin-when-cross-origin]] : 
[CODE[origin-when-cross-origin]] を返し、ここで停止します。
: [DFN[[CODE[always][unsafe-url]]]] か [CODE[unsafe-url]] :
[CODE[unsafe-url]] を返し、ここで停止します。
]FIG]
= [73] [[空文字列]]を返します。
]FIG]

[74] [CODE[never][no-referrer]]、[CODE[default][no-referrer-when-downgrade]]、
[CODE[always][unsafe-url]] は、古い値であり、使う[RUBYB[べきではありません]@en[encouraged to avoid]]。
[SRC[>>70]] [CODE(HTML)@en[<meta name=referrer>]] 以外では認識もしないことが意図されていると思われます。

* 文脈

[53] [[著者]]は、[[参照元ポリシー]]を次の方法で明示できます。
[FIG(list middle)[
- [CODE(HTTP)@en[Referrer-Policy:]] [[HTTPヘッダー]]
- [CODE(HTML)@en[<meta name=referrer>]]
- [CODE(HTMLa)@en[referrerpolicy]] [[属性]]
- [CODE(HTML)@en[rel=noreferrer]]
]FIG]

[HISTORY[
[54] 一時、[[CSP]] の[[指令]]としても指定できましたが、[[廃止]]されました。
]HISTORY]

[69] [[HTTPリダイレクト]]では、[[応答]]の [CODE(HTTP)@en[Referrer-Policy:]]
[[ヘッダー]]の値が (あれば) [[リダイレクト]]先の[[要求]]の[[参照元]]の決定に使われます。

;; [[HTTPリダイレクト]]参照。

[43] [[環境設定群オブジェクト]]は、[F[参照元ポリシー]]を取得する[[アルゴリズム]]を持ちます。
これは、当該[[環境設定群オブジェクト]]を[[要求]]の[F[クライアント][要求クライアント]]とするときに、
原則として用いられるものです。 [SRC[>>30]]

[88] [[文書]]は、[DFN[[F[[RUBYB[[[参照元ポリシー]]]@en[referrer policy]]]]]]を持ちます。
[[既定値]]は、[[空文字列]]です。 [SRC[>>87]]

[79] [[要求]]は、[DFN[[F[[RUBYB[[[参照元ポリシー]]]@en[referrer policy]]]]]]を持ちます。
値は[[参照元ポリシー]]、[[既定値]]は[[空文字列]]です。
これは[[環境設定群オブジェクト]]の[F[参照元ポリシー]]を上書きしたいときに使います。 [SRC[>>78]]

* 適用対象

[HISTORY[
[13] かつては [[WebSocket]] に適用されるのかは明確になっていませんでした。
現在は [[WebSocket]] が [[Fetch]] 経由で処理される規定となっているため、
[[WebSocket]] にも適用されることが明確になっています。
]HISTORY]

* [CODE(HTTP)@en[Referrer-Policy:]] ヘッダー

[56] [CODE(HTTP)@en[Referrer-Policy:]] [[HTTPヘッダー]]は、
当該[[資源]]から作成される[[要求]]や[[閲覧文脈]]における[[参照元ポリシー]]を指定するものです
[SRC[>>55]]。

[57] [[ヘッダー値]]は、1つ[[以上]]の値の[[リスト][リスト (HTTP)]]です [SRC[>>55]]。

[FIG(railroad)[
= 値
= *
== [[OWS]]
== [CODE[,]]
== [[OWS]]
== 値
]FIG]

[58] 各値は、[[参照元ポリシー]]を指定するもの
(歴史的な値以外) で、 [[ASCII大文字・小文字不区別]]です
[SRC[>>55]]。

[68] 値を複数指定すると、[[Webブラウザー]]は、対応している最後のものを使います。
新しい値が追加されて未対応の [[Webブラウザー]]が存在する時は、
新しい値を後の方に指定すると、新旧どちらの [[Webブラウザー]]にも適当な指定を与えられます。

;; [[CSS]] などと同じです。

[59] [[構文解析]]は、[VAR[応答]]について次
([DFN[Parse a referrer policy from a [CODE[Referrer-Policy]] header]])
のようにします [SRC[>>60]]。
[FIG(steps)[
= [61] [VAR[リスト]]を、[VAR[応答]]の[F[ヘッダーリスト]]の [CODE[Referrer-Policy:]]
[[ヘッダー]]を[[構文解析][ヘッダー値]]した結果に設定します。
= [62] [VAR[リスト]]の各要素を [[Determine [VAR[token]]’s Policy]] を適用した結果に設定します。
= [63] [VAR[リスト]]から[[空文字列]]を除去します。
= [65] [VAR[リスト]]が空なら、
== [66] [[空文字列]]を返します。
= [67] それ以外なら、
== [64] [VAR[リスト]]の最後の要素を返します。
]FIG]

[75] [[ヘッダー値]]の[[構文解析]]をどう行うべきなのかはあまり明確ではありません。
[[Fetch Standard]] の規定も踏まえて仕様書の文字通りに解釈すると、
未対応の値が含まれるときに[[ヘッダー]]全体が無視されてしまうことになり、
意図通りでもなさそうです。 [CODE[,]] で分割して [[HTTP]] の[[空白]]を前後から除去したものを[VAR[リスト]]とするべきなのでしょうか。

* 歴史

[1] [CITE@en[GoogleのHTTPS版でRefererがoriginだけになりそう (meta referrer="origin") - fragmentary]]
( ([TIME[2012-03-25 11:14:22 +09:00]] 版))
<http://myakura.hatenablog.com/entry/2012/03/20/191406>

[2] [CITE[HTML - Referrer を制御する - Qiita]]
( ([TIME[2014-06-09 09:11:02 +09:00]] 版))
<http://qiita.com/wakaba@github/items/707d72f97f2862cd8000>

[3] [CITE@en[Bug 22675 – Features to control the "Referer" header]]
( ([TIME[2014-06-09 09:12:19 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=22675>

[4] [CITE@en[Meta referrer - WHATWG Wiki]]
( ([TIME[2013-12-18 19:23:27 +09:00]] 版))
<http://wiki.whatwg.org/wiki/Meta_referrer>

[5] [CITE@en[Bug 26058 – "noreferrer" support in Fetch.]]
( ([TIME[2014-06-13 15:07:09 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=26058>

[6] [CITE@en[Referrer Policy]]
( ([TIME[2014-06-12 14:53:39 +09:00]] 版))
<https://w3c.github.io/webappsec/specs/referrer-policy/>

[7] [CITE[REFERRER: Defining <meta> delivery. · 1475cfd · w3c/webappsec]]
( ([TIME[2014-06-13 15:13:33 +09:00]] 版))
<https://github.com/w3c/webappsec/commit/1475cfd0d1ba2e61c4f0bb13fa8ec1bb8f353c62>

[8] [CITE@en[REFERRER/CSP2/CSP3: Move 'referrer' to the Referrer Policy spec. · d8fee06 · w3c/webappsec]]
([TIME[2015-02-08 11:36:28 +09:00]] 版)
<https://github.com/w3c/webappsec/commit/d8fee06f18d96ccd7cb6e8cbdf144878560459d5>

[9] [CITE@en[Re: CfC: Transition CSP2 to CR.]]
([[Mike West]] 著, [TIME[2015-02-07 16:15:36 +09:00]] 版)
<https://lists.w3.org/Archives/Public/public-webappsec/2015Feb/0121.html>

[10] [CITE@en[Re: referrer spec and backwards compatibility]]
([[Mike West]] 著, [TIME[2015-02-09 17:51:06 +09:00]] 版)
<https://lists.w3.org/Archives/Public/public-webappsec/2015Feb/0154.html>

[11] [CITE@en[REFERRER: Drop draconian conflict/typo handling. · 45b449e · w3c/webappsec]]
([TIME[2015-02-11 16:39:16 +09:00]] 版)
<https://github.com/w3c/webappsec/commit/45b449e610e5c8b6d893067d6be15bcccf384b5d>

- [12] [CITE@en[Referrer Policy]] ([TIME[2015-05-17 18:30:14 +09:00]] 版) <https://w3c.github.io/webappsec/specs/referrer-policy/>

[14] [CITE@en[Provide an API for referrer and referrer policies (both at Fetch and … · whatwg/fetch@3a21ed3]]
([TIME[2015-07-18 11:41:38 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/3a21ed3cec04cbe75a0704ed14b7b2fb91837b64>

[15] [CITE@en[22675 – Features to control the "Referer" header]]
([TIME[2015-08-08 11:44:36 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=22675>

[16] [CITE@en[24613 – Why wouldn't referrer for about:blank be based on the origin it inherits?]]
([TIME[2015-09-18 17:35:00 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=24613#c27>

[17] [CITE@en[Integrate Fetch into HTML · whatwg/html@7c5555a]]
([TIME[2015-09-18 18:50:44 +09:00]] 版)
<https://github.com/whatwg/html/commit/7c5555a16f2920c02244c10756bb2f1a11e87a22>

[18] [CITE@en[Referrer Policy]]
([TIME[2015-10-01 19:48:32 +09:00]] 版)
<https://w3c.github.io/webappsec-referrer-policy/>

[19] [CITE@en[w3c/webappsec-referrer-policy]]
([TIME[2015-10-06 23:23:12 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy>

[20] [CITE@en[Move `referrer` from CSP to some other header.]]
([[Mike West]] 著, [TIME[2015-10-09 22:45:19 +09:00]] 版)
<https://lists.w3.org/Archives/Public/public-webappsec/2015Oct/0043.html>

[FIG(quote)[
[FIGCAPTION[
[21] [CITE@en[Creating a 'Deploy to Heroku' Button | Heroku Dev Center]]
([TIME[2015-10-25 09:12:23 +09:00]] 版)
<https://devcenter.heroku.com/articles/heroku-button>
]FIGCAPTION]

> GitHub does not send a referer header for private repos

]FIG]

[22] [CITE@en[Yay, Emily. · w3c/webappsec-referrer-policy@74bde1b]]
([TIME[2015-11-12 11:39:26 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/74bde1b77bfc11ea669019dcbad6c9c79b399714>

[23] [CITE@en[Merge pull request #7 from estark37/issue-4 · w3c/webappsec-referrer-policy@e6f81e3]]
([TIME[2015-11-17 16:33:46 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/e6f81e37b057fcf2ea32388f84ae789aa32c2315>

[24] [CITE@en[Revert changes to content attribute spelling, and fix attribute descr… · w3c/webappsec-referrer-policy@d232b6d]]
([TIME[2015-11-20 18:44:43 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/d232b6d457504d29379f7f83ec737d92ecc42c6f>

[25] [CITE@en[Merge pull request #8 from jeisinger/referrerPolicy-idl · w3c/webappsec-referrer-policy@77be4ed]]
([TIME[2015-11-20 18:47:06 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/77be4edd64deb158b90662cf449ee7d0a9abd731>

[26] [CITE@en[specify empty directive == No-Referrer · w3c/webappsec-referrer-policy@387e875]]
([TIME[2015-11-20 18:47:31 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/387e8754c0b114a094eecc7cfddb1fcba81ab491>

[27] [CITE@en[Modify referrer algorithm to use referrerpolicy attribute if present · w3c/webappsec-referrer-policy@6a92457]]
([TIME[2015-11-20 18:47:44 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/6a9245711dc9da1af7d5e59a33c6cb34c4302393>

[28] [CITE@en[Merge pull request #14 from estark37/referrer-header · w3c/webappsec-referrer-policy@cdc809b]]
([TIME[2015-12-18 18:08:22 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/cdc809ba5be73dec0b56298e09722ddb9cd8a89a>

[29] [CITE@en[Update request's referrer policy when fetching · whatwg/fetch@2812f6a]]
([TIME[2016-04-15 22:32:18 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/2812f6aa873968002215b284e05d01715560400b>

[31] [CITE@en[965727 – Implement CSP 1.1 referrer directive]]
([TIME[2016-04-19 13:54:03 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=965727>

[32] [CITE@en[Referrer policy: rename "origin-only" to "origin" · whatwg/fetch@0edf4a3]]
([TIME[2016-04-19 15:04:58 +09:00]] 版)
<https://github.com/whatwg/fetch/commit/0edf4a3d5fb96db52b8a7bb32bea55c1de6540cc>

[33] [CITE@en[Rewrite Fetch integration, especially around redirects · w3c/webappsec-referrer-policy@4d227ee]]
([TIME[2016-05-01 13:44:09 +09:00]] 版)
<https://github.com/w3c/webappsec-referrer-policy/commit/4d227ee81961b21913915632614039f076200961>

[34] [CITE@en[Move to string-named referrer policies]]
( ([[domenic]]著, [TIME[2016-05-05 05:06:19 +09:00]]))
<https://github.com/w3c/webappsec-referrer-policy/commit/718658acd2150f50dcd006508f990e266e90ce9e>

[35] [CITE@en["origin", not "origin-only"]]
( ([[domenic]]著, [TIME[2016-05-05 05:14:00 +09:00]]))
<https://github.com/w3c/webappsec-referrer-policy/commit/ae3e8933125caa5f39eeadff235eeee49ac12ee1>

[83] [CITE@en[Introduce a "Same-Origin Only" policy state]]
( ([[fmarier]]著, [TIME[2016-01-19 11:27:15 +09:00]]))
<https://github.com/w3c/webappsec-referrer-policy/commit/894da98efed842073d52fe0b0f7eee4c9389e1ff>