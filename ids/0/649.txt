[91] [[SGML]] 派生[[マーク付け言語]]における[DFN[[RUBYB[[[文字参照]]]@en[character reference]]]]は、[[文字]]の番号や短い名前によって表す[[文字]]の代替表現です。
[[マーク付け]]の一部を表す[[文字]]を[[データ]]として含めるために使ったり、
通常の方法で入力しがたい[[文字]]を表すために使ったりします。

* 仕様書

[REFS[
- [89] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-07-02 23:06:24 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#character-references>'''
- [93] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-07-02 23:06:24 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#elements-0>
- [94] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-07-02 23:06:24 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#syntax-attribute-value>
- [103] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-07-02 23:06:24 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#consume-a-character-reference>
]REFS]

* 呼称と定義・分類

[90] [[HTML]] では、[[名前付き文字参照]]、[[十進数文字参照]]、[[十六進数文字参照]]の総称を[[文字参照]]と呼んでいます
[SRC[>>89]]。

* 文脈

[92] [[HTML]] では[[文字参照]]は、
[[通常要素]]、[[外来要素]]、[[エスケープ可能生テキスト要素]]の[[内容]]の一部として [SRC[>>93]]、
あるいは[[属性値]]の一部として [SRC[>>94]] 用いることができます。

[95] >>92 のいずれも[[文字参照]]の他に[[テキスト]]を用いることができる文脈ですが、
[[曖昧アンド]]が禁止されています [SRC[>>93, >>94]]。[[文字参照]]にも[[曖昧アンド]]にも一致しない
[CODE[[[&]]]] は[[テキスト]]として解釈され、[[著者]]はこれを用いても構いません。
[[曖昧アンド]]である [CODE[[[&]]]] は[[著者]]が用いてはなりません。

[96] [DFN[[RUBYB[[[曖昧アンド]]]@en[ambiguous ampersand]]]]は、
[CODE[[[&]]]] の後に1文字以上の[[ASCII英数字]]が続き、その後に [CODE[[[;]]]]
が続くもののうち、[[名前付き文字参照]]でないものです [SRC[>>89]]。

[FIG(railroad)[
= [CODE[[[&]]]]
= +
== [[ASCII英数字]]
= [CODE[[[;]]]]
]FIG]

;; [102] [CODE[[[;]]]] で終わらない ([[不適合]]の) [[文字参照]]を禁止しないといけない気がしますが、 >>99 で禁止がなくなってしまっています。
また、正しい[[文字参照]]が[[曖昧アンド]]に含まれないので、[[文字参照]]は[[テキスト]]としても解釈し得る状態になっていて、厳密には不適切な状態になっています。。。

* HTML 文字参照 XML DTD

[18] [[XML]] においてはいくつかの[[公開識別子]]を持つ[[外部実体]]は
[[HTML]] の[[名前付き文字参照]]を[[宣言]]するものと解釈されることになっています。

;; [[XHTML名前付き文字参照DTD]]を参照。

* 歴史

** 曖昧アンドの縮小

[101] [[HTML]] の[[曖昧アンド]]の定義は徐々に縮小していき、最終的には[[名前付き文字参照]]と同じ構文のものになっています。
言い換えると、[[エスケープ]]しなくても良い [CODE[[[&]]]]
が徐々に増えていき、現在又は将来の[[名前付き文字参照]]と構文上区別可能ならすべて認められることになっています。

[REFS[
- [97] [CITE@en[Web Applications 1.0 r1296    Fix the definition of ambiguous ampersand, and allow quoted attributes to end in ampersands.]] ([TIME[2008-03-02 20:00:00 +09:00]] 版) <http://html5.org/r/1296>
- [98] [CITE@en[Web Applications 1.0 r3146    Allow href='http://example.com/demo?id=hello&copy=1&world=fun' experimentally.]] ([TIME[2009-05-29 09:02:00 +09:00]] 版) <http://html5.org/tools/web-apps-tracker?from=3145&to=3146>
- [99] [CITE@en[Web Applications 1.0 r4960  Allow a few more unescaped &s.]] ([TIME[2010-04-03 08:18:00 +09:00]] 版) <http://html5.org/r/4960>
- [100] [CITE@en[Web Applications 1.0 r7490 Use some new predefined terms for common character ranges.]] ([TIME[2012-10-31 07:15:00 +09:00]] 版) <http://html5.org/r/7490>
]REFS]

* メモ

[9]

>
:(275) 文字参照 (character reference):
1[[文字]]に[[置換]]される[[参照]]。
[SRC[[[JIS X 4151]]-1992 3.]]
- 備考 [[名前指定文字参照]]及び[[数値指定文字参照]]の2種類がある。

[1] 【[[SGML]]】 SGML の[DFN[文字参照]]には、[[数値指定文字参照]]と[[名前指定文字参照]]があります。
前者は[[文書文字集合]]における[[文字番号]]を使って文字を参照します。例えば [CODE(SGML)[&#33]] は、文字番号 [CODE(SGML)[33]] の文字 [WEAK[([[ISO/IEC 646]]:1991 [[IRV]] では [CODE[!]]。)]]
を表します。後者は[[機能文字]]又は [[SGML宣言]]の[[具象構文]]の追加機能に指定してある文字を、その名前を使って参照します。
たとえば、 [SAMP(SGML)[&#RE]] は機能文字 [CODE(SGML)[[[RE]]]]
[WEAK[([[記録終了]])]] を表します。

Web SGML では、更に[[16進文字参照]]が追加されました。

[2] これに類したものとして、[[文字実体参照]]があります。
これは、[[文字]]1文字 [WEAK[(と判断されるもの。)]]
だけの[[一般実体]]を参照するものです。例えば、
[SAMP(SGML)[&Aacute]] は[[アキュート・アクセント]]つきの文字
[SAMP[A]] に置換されるかもしれません。

(ちなみに、「[[文字実体]]」・「文字[[実体集合]]」
という言葉は SGML には出てきますが、
「文字実体参照」という言葉は [[HTML4]] で出てきます。
[WEAK[(という話は言葉遊びみたいなものですが。)]])

[3] 文字参照は、その文字が他の手段で簡便に書けない場合に限って使うことが望ましいとされています。
([[JISX4151]]‐1992 8.5 参照。)

[7]
- [CODE(ABNF)[[DFN[文字参照]] := [[名前指定文字参照]] / [[数値文字参照]] / [[16進文字参照]] ;; Web SGML [62] ]]

- [4] 文字参照の文字番号の上限ってあるのかなあ?と思って読み返してみたけどわかんなかった。ないのかなあ。もっとも、文書文字集合の最後の数より大きいのを指定してもどうせエラーになるんだろうから意味はないんだけどさあ。
- [5] どうして >>4 みたいなことを考えたかというと、[[規格参照具象構文]]の文書文字集合は 0〜127 までしか定義してないのに、[[回避文字]]に 128〜255 が載ってるの。だから 128〜255 は回避文字になって、[[非SGML文字]]にもなる。非 SGML 文字を数値指定文字参照できるんだから、以下略。って。じゃあそれなら、一切言及のない 256 以上の値だったらどうなんだ、って疑問がわいてくる。[WEAK[もっとも、 SGML 考えた連中はせいぜい 255 までしか頭になかったんだろう。]]

[6] 文字参照を使うと良い場面 (JIS 参考3 7.2 参照。) :
- 入力装置の鍵盤に対応するものがない文字
- 表示できない文字
- [[非SGML文字]]
- [[機能文字]]になっているがデータとして使いたい文字

など。
- [8] [[HTML4]] の文字参照についてイの規定 <IW:HTML4:charset.html#spec-char-encoding> によれば、 HTML では、文字参照は (1) 数値文字参照 : 10進または16進 (2) [[文字実体参照]]の2つの形で現れるとされています。一見 SGML の定義とは異なるように思えますが、 (規定中でわざわざ「SGML 文字参照」と言っていることを見ても) そうではなく、文字実体参照は文字参照を値に持つ実体であることを考えれば矛盾はないことが分かります。

[10]
[[Firefox]] 2.0 で [CODE(char)[[[U+10FFFF]]]] より大きな[[16進数]]を指定すると、値によって:

[CODE(char)[[[U-7FFFFFFF]]]] までなら[[サロゲート・ペア]]への変換の計算を拡張したらしき2[[文字]]の列になります。

;; <http://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cbody%3E%0A%3Cp%3E%26%23x110000%3B%3C%2Fp%3E%0A%3Cscript%3E%0A%20%20var%20pv%20%3D%20document.getElementsByTagName%20('p')%5B0%5D.firstChild.data%3B%0A%20%20if%20(pv%20%3D%3D%20%22%5CuFFFD%22)%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DPASS%3EPASS%3C%2Fp%3E')%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DFAIL%3EFAIL%20(')%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20pv.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20document.write%20(pv.charCodeAt%20(i).toString%20(16)%20%2B%20'%2C')%3B%0A%20%20%20%20%7D%0A%20%20%20%20document.write%20(')%3C%2Fp%3E')%3B%0A%20%20%7D%0A%3C%2Fscript%3E%3Cnoscript%3E%3Cp%20id%3Dtest%20class%3DFAIL%3EFAIL%20(noscript)%3C%2Fp%3E%3C%2Fnoscript%3E%0A>,
<http://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cbody%3E%0A%3Cp%3E%26%23x7fffffff%3B%3C%2Fp%3E%0A%3Cscript%3E%0A%20%20var%20pv%20%3D%20document.getElementsByTagName%20('p')%5B0%5D.firstChild.data%3B%0A%20%20if%20(pv%20%3D%3D%20%22%5CuFFFD%22)%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DPASS%3EPASS%3C%2Fp%3E')%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DFAIL%3EFAIL%20(')%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20pv.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20document.write%20(pv.charCodeAt%20(i).toString%20(16)%20%2B%20'%2C')%3B%0A%20%20%20%20%7D%0A%20%20%20%20document.write%20(')%3C%2Fp%3E')%3B%0A%20%20%7D%0A%3C%2Fscript%3E%3Cnoscript%3E%3Cp%20id%3Dtest%20class%3DFAIL%3EFAIL%20(noscript)%3C%2Fp%3E%3C%2Fnoscript%3E%0A>

[CODE(char)[[[0x80000000]]]]〜[CODE(char)[[[0xFFFFFFFF]]]]
だと、 [CODE(char)[[[&]]]] を除く[[文字列]]がそのまま[[文字データ]]として解釈されます。

;; <http://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cbody%3E%0A%3Cp%3E%26%23x80000000%3B%3C%2Fp%3E%0A%3Cscript%3E%0A%20%20var%20pv%20%3D%20document.getElementsByTagName%20('p')%5B0%5D.firstChild.data%3B%0A%20%20if%20(pv%20%3D%3D%20%22%5CuFFFD%22)%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DPASS%3EPASS%3C%2Fp%3E')%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DFAIL%3EFAIL%20(')%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20pv.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20document.write%20(pv.charCodeAt%20(i).toString%20(16)%20%2B%20'%2C')%3B%0A%20%20%20%20%7D%0A%20%20%20%20document.write%20(')%3C%2Fp%3E')%3B%0A%20%20%7D%0A%3C%2Fscript%3E%3Cnoscript%3E%3Cp%20id%3Dtest%20class%3DFAIL%3EFAIL%20(noscript)%3C%2Fp%3E%3C%2Fnoscript%3E%0A>

[CODE(char)[0x100000000]] 以上だと、下位8桁 (32ビット) 以外は無視されます。

;; 
<http://software.hixie.ch/utilities/js/live-dom-viewer/?%3Cbody%3E%0A%3Cp%3E%26%23x100000000%3B%3C%2Fp%3E%0A%3Cscript%3E%0A%20%20var%20pv%20%3D%20document.getElementsByTagName%20('p')%5B0%5D.firstChild.data%3B%0A%20%20if%20(pv%20%3D%3D%20%22%5CuFFFD%22)%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DPASS%3EPASS%3C%2Fp%3E')%3B%0A%20%20%7D%20else%20%7B%0A%20%20%20%20document.write%20('%3Cp%20id%3Dresult%20class%3DFAIL%3EFAIL%20(')%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20pv.length%3B%20i%2B%2B)%20%7B%0A%20%20%20%20%20%20document.write%20(pv.charCodeAt%20(i).toString%20(16)%20%2B%20'%2C')%3B%0A%20%20%20%20%7D%0A%20%20%20%20document.write%20(')%3C%2Fp%3E')%3B%0A%20%20%7D%0A%3C%2Fscript%3E%3Cnoscript%3E%3Cp%20id%3Dtest%20class%3DFAIL%3EFAIL%20(noscript)%3C%2Fp%3E%3C%2Fnoscript%3E%0A>

[11]
>>10 [[WinIE 6]] ではすべて [CODE(char)[[[U+003F]]]] になるようです。

[12]
>>10 [[Opera]] 9 は:

[CODE(char)[[[U-00110000]]]]〜[CODE(char)[[[0xFFFFFFFF]]]]
は[[サロゲート・ペア]]風のなにか ([[Firefox]] とは違います。)
になります。

[CODE(char)[[[0xFFFFFFFF]]]] 以上は
[CODE(char)[[[0xFFFFFFFF]]]] と同じ結果になります。
([[名無しさん]])

[13]
>>10-12 いずれも[[文字長]]の制限はないように見えます。
([[名無しさん]])

[14]
[CITE@en[XML Entity definitions for Characters]] ([CODE[2008-07-21 22:50:47 +09:00]] 版) <http://www.w3.org/TR/2008/WD-xml-entity-names-20080721/>
([[名無しさん]])


[15]
[CITE[Bug 4948 - Incorrect HTML entity error recovery doesn't match other browsers]] ([TIME[2008-07-31 09:44:14 +09:00]] 版) <https://bugs.webkit.org/show_bug.cgi?id=4948>

[63] [CITE@en[MAMA: Character entities - Opera Developer Community]] ([TIME[2008-11-25 20:22:30 +09:00]] 版) <http://dev.opera.com/articles/view/mama-character-entities/>

[64] [CITE[Business::PayPal::API - PayPal API - search.cpan.org]]
([TIME[2009-07-29 15:59:31 +09:00]] 版)
<http://search.cpan.org/~scottw/Business-PayPal-API-0.62/lib/Business/PayPal/API.pm#PayPal_Munging_URLs>

[65] [CITE@en[XML Entity Definitions for Characters]]
([TIME[2010-02-11 23:56:43 +09:00]] 版)
<http://www.w3.org/TR/2010/PR-xml-entity-names-20100211/>

[66] [CITE[Bug 9207 – Anything else: This part of the spec is problematic, for example, a query string variable &lang_id=1 in as part of an attribute of say an img tag, will get converted into an character token when it shouldn't be. Why is the set of characters a-z, A-Z, 0-]]
([TIME[2010-04-03 12:54:02 +09:00]] 版)
<http://www.w3.org/Bugs/Public/show_bug.cgi>

[67] [CITE@en[HTML5 Revision Tracker]]
([TIME[2010-04-03 12:53:38 +09:00]] 版)
<http://html5.org/tools/web-apps-tracker?from=4958&to=4959>

[68] [CITE@en[XML Entity Definitions for Characters]]
([TIME[2010-04-02 02:35:33 +09:00]] 版)
<http://www.w3.org/TR/2010/REC-xml-entity-names-20100401/>

[69] [CITE[IRC logs: freenode / #whatwg / 20100403]]
([TIME[2010-04-18 19:51:34 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20100403#l-73>

[70] [CITE[Bug 10067 – this only lists entities whose replacement text is a single character, for example many of the negated operators, for example]]
( ([TIME[2010-10-09 19:15:18 +09:00]] 版))
<http://www.w3.org/Bugs/Public/show_bug.cgi?id=10067>

[71] [CITE[IRC logs: freenode / #whatwg / 20100927]]
( ([TIME[2010-10-10 13:19:34 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20100927>

[72] [CITE@EN[XQuery 1.0: An XML Query Language (Second Edition)]]
( ([TIME[2011-01-05 01:29:08 +09:00]] 版))
<http://www.w3.org/TR/2010/REC-xquery-20101214/#dt-predefined-entity-reference>

[73] [CITE@EN[XQuery 1.0: An XML Query Language (Second Edition)]]
( ([TIME[2011-01-05 01:29:08 +09:00]] 版))
<http://www.w3.org/TR/2010/REC-xquery-20101214/#dt-character-reference>

[74] [CITE[IRC logs: freenode / #whatwg / 20120525]]
( ([TIME[2012-06-03 11:15:18 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20120525#l-480>

[75] [CITE@en[Web Applications 1.0 r7133 Add a JSON file for entities for convenience.]]
( ([TIME[2012-06-15 04:11:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7132&to=7133>

[78] [CITE[Additional named entities for HTML]]
( ([TIME[2000-03-13 23:37:21 +09:00]] 版))
<http://www.w3.org/TR/WD-entities-961125>

[79] [CITE@en[Web Applications 1.0 r7679  Make <a href='?guitar=2&amp=1&pedal=6'> a parse error since IE9 misparses it '?guitar=2&=1&pedal=6' apparently.]]
( ([TIME[2013-01-31 09:36:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7678&to=7679>

[81] [[テキスト形式TRONコード]]

[83] [CITE@en[Help:Formatting - MediaWiki]]
( ([TIME[2014-01-22 11:53:48 +09:00]] 版))
<http://www.mediawiki.org/wiki/Help:Formatting#Inserting_symbols>

[84] [CITE@en[XML Entity Definitions for Characters (2nd Edition)]]
( ([TIME[2014-02-10 23:03:18 +09:00]] 版))
<http://www.w3.org/TR/2014/PER-xml-entity-names-20140211/>

[86] [CITE[ncsa-mosaic/CHANGES at master · alandipert/ncsa-mosaic]]
( ([TIME[2014-04-07 05:42:16 +09:00]] 版))
<https://github.com/alandipert/ncsa-mosaic/blob/master/CHANGES#L1310>

[87] [CITE@en[XML Entity Definitions for Characters (2nd Edition)]]
( ([TIME[2014-04-10 02:49:23 +09:00]] 版))
<http://www.w3.org/TR/2014/REC-xml-entity-names-20140410/>

[88] [CITE@EN[XQuery 3.0: An XML Query Language]]
( ([TIME[2014-04-08 08:26:21 +09:00]] 版))
<http://www.w3.org/TR/xquery-30/#dt-character-reference>

[104] [CITE@en[Bug 13108 – Add &zwsp; as named character reference for zero width space (U+200B)]]
( ([TIME[2014-07-23 03:14:12 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=13108>

[105] [CITE@en[Re: ''''''[''''''whatwg'''''']'''''' several messages about the HTML syntax]]
( ([[fantasai]] 著, [TIME[2014-07-23 00:47:47 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-whatwg-archive/2014Jul/0132.html>

[106] [CITE@en[''''''[''''''whatwg'''''']'''''' Markup-related feedback]]
( ([[Ian Hickson]] 著, [TIME[2014-10-28 05:41:30 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-whatwg-archive/2014Oct/0239.html>

[107] [CITE@en[abc:standard:v2.1 ''''''[''''''abc wiki'''''']'''''']]
( ([TIME[2015-01-16 18:37:29 +09:00]] 版))
<http://abcnotation.com/wiki/abc:standard:v2.1#supported_accents_ligatures>

[FIG(quote)[
[FIGCAPTION[
[16] [CITE[XHTMLBasic変換仕様 | Durianマニュアル]]
([TIME[2015-02-09 13:39:46 +09:00]] 版)
<http://durian.symmetric.jp/dev/doc/technical/xhtmlbasic_conversion.html>
]FIGCAPTION]

> 書式	*****で指定可能な記述	説明
> &i-mode_*****;	63647から63919	DoCoMo基本絵文字のShift_JISコード
> &i-mode-ex_*****;	63921から63996	DoCoMo拡張絵文字のShift_JISコード
> &i-mode_U*****;	Unicode	DoCoMo用絵文字のUnicode
> &YahooKeitai-C_*****;	'''['''ページ番号1文字''']'''-'''['''ページ内のコード2文字''']'''	SoftBankC型端末用絵文字
> &YahooKeitai-P_*****;	'''['''ページ番号1文字''']'''-'''['''ページ内のコード2文字''']'''	SoftBankP型端末用絵文字
> &YahooKeitai_U*****;	Unicode	SoftBank用絵文字のUnicode
> &ezweb-1_*****;	アイコン番号またはアイコン名	au cdmaOne300シリーズ、Tu-Ka0Xシリーズ、白黒端末用絵文字
> &ezweb-2_*****;	アイコン番号またはアイコン名	au cdmaOne400シリーズ、Tu-Ka1Xシリーズ用絵文字
> &ezweb-3_*****;	アイコン番号またはアイコン名	au cdmaOne1000/3000シリーズ、Tu-Ka2Xシリーズ、Tu-Ka3Xシリーズ用絵文字
> &ezweb-4_*****;	アイコン番号またはアイコン名	au cdmaOne5000シリーズ、WINシリーズ、Tu-Ka4Xシリーズ、Tu-Ka5Xシリーズ用絵文字
> &ezweb_U*****;	Unicode	au用絵文字のUnicode

]FIG]


[FIG(quote)[
[FIGCAPTION[
[17] [CITE[XHTMLBasic変換仕様 | Durianマニュアル]]
([TIME[2015-02-09 13:40:17 +09:00]] 版)
<http://durian.symmetric.jp/dev/doc/technical/xhtmlbasic_conversion.html>
]FIGCAPTION]

> XHTMLBasicの仕様では規定されていない絵文字および入力モードについては、Durianにより拡張された構文を使用します。構文の詳細については、開発リファレンスを参照してください。
> 機能	表記方法
> 絵文字	&i-mode_63647; や &YahooKeitai-C1-21; のようなエンティティ参照
> 入力モード	inputまたはtextarea要素のtext:type属性で、text:type="hiragana"のように指定
> 

]FIG]