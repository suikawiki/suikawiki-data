[5] [DFN[[RUBYB[[[媒体素片]]]@en[Media Fragments]]]]は、[[動画]]や[[音声]]の一部を識別するための[[素片識別子]]の構文です。

* 仕様書

[REFS[
- [4] '''[CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/>'''
-- [9] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#standardisation-URI-fragments>
-- [11] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#standardisation-URI-queries>
-- [13] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#fragment-query>
-- [24] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#media-fragment-syntax>
-- [33] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#media-fragment-processing>
-- [45] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/media-frags/#media-fragment-semantics>
]REFS]

* 構文

[25] [[媒体素片]]は、名前と値を [CODE(URI)[[[=]]]] で連結した組を1つ[[以上]]
[CODE(URI)[[[&]]]] で区切ったリストです。ただし [CODE(URI)[[[=]]]] と値なしで名前だけの組も含められます。
[SRC[>>24]]

[FIG(railroad)[
[FIGCAPTION[
[[媒体素片]]
]FIGCAPTION]
= 名前と値
= *
== [CODE(URI)[[[&]]]]
== 名前と値
]FIG]

[FIG(railroad)[
[FIGCAPTION[
名前と値
]FIGCAPTION]
= 名前
= ?
== [CODE(URI)[[[=]]]]
== 値
]FIG]

[26] 名前と値は、任意の [[Unicode]] 文字列を [[UTF-8]]
で[[符号化]]し、[[パーセント符号化]]したものです。
ただし名前に [CODE(URI)[[[&]]]] と [CODE(URI)[[[=]]]] を使うことはできず、
値に [CODE(URI)[[[&]]]] を使うことはできません。 [SRC[>>24]]

;; [27] [[RFC 3986]] が参照されており [SRC[>>24]]、 
[[URI]] で使えない[[文字]]は[[パーセント符号化]]しなければならず、
それ以外は[[パーセント符号化]]してもしなくても良いと思われます。

;; [28] [CODE(URI)[[[&]]]] や [CODE(URI)[[[=]]]] を名前や値に含めたい時は、
[[パーセント符号化]]すれば良いようです。

;; [46] 名前や値の部分には [CODE(URI)[[[:]]]] のような記号が含まれることもありますが、
それも含めて[[パーセント符号化]]してもしなくても同義であり、
どちらも[RUBYB[妥当]@en[valid]]です [SRC[>>45]]。

[29] 名前は[[次元]]を表し、値はそれに対応する値を表します。
値の構文は、[[次元]]の規定によります。 [SRC[>>24]]

* 構文解析

[34] [[媒体素片]]を解釈する場合には、 [[URL]] の一部として与えられた[[オクテット列]]を
[CODE(URI)[[[&]]]] によって区切ったリストとして分割し、
その各要素を [CODE(URI)[[[=]]]] によって区切った名前と値の組として分割し、
名前と値をそれぞれ[[パーセント復号]]します。 [SRC[>>33]]

;; [36] [CODE(URI)[[[=]]]] が複数あれば、最初のもので分割します。
また [CODE(URI)[[[=]]]] がなければ、値なしとします。

;; [37] [CODE(URI)[[[&]]]] だけが区切りであり、 [CODE(URI)[[[;]]]]
は区切りではありません。また [CODE(URI)[[[+]]]] は [CODE[0x20]] ではありません。

[35] ただし [CODE(URI)[[[=]]]] で分割した名前と値が[[パーセント符号化]]された[[オクテット列]]として正しくない場合や、
[[パーセント復号]]した結果が [[UTF-8]] で[[復号]]できない場合には、
その名前と値の組は無視します。 [SRC[>>33]]

;; [38] 同じ名前がリスト中に複数含まれることもあります。

* 次元

[30] [DFN[[RUBYB[次元]@en[dimension]]]]は[[媒体素片]]において一部分を選択する観点を表しています。
[[次元]]は互いに論理的に独立しており、組み合わせることができます [SRC[>>24]]。
[[次元]]の順序に関わらず、得られる結果は同じです [SRC[>>24]]。

;; [44] [CODE(URI)[[[t]]]] と [CODE(URI)[[[id]]]] が共に[[時間]][[次元]]を表すなど、
例外はあります。

[31] 次の[[次元]]があります。
[FIG(short list)[
- [CODE(URI)@en[[[id=]]]]
- [CODE(URI)@en[[[t=]]]]
- [CODE(URI)@en[[[track=]]]]
- [CODE(URI)@en[[[xywh=]]]]
]FIG]

[41] 同じ[[次元]]を複数指定することは禁止されていません。
[[利用者エージェント]]は最後の指定を使う[['''べきです''']] [SRC[>>45]]。
それ以外は[[妥当]]であれ[[非妥当]]であれ、無視するべきです [SRC[>>45]]。

;; [48] ただし例外的に [CODE(URI)[[[track=]]]] は複数指定できます [SRC[>>45]]。
([CODE(URI)[[[track=]]]] 参照。)

[47] [[利用者エージェント]]は、未知の[[次元]]の指定を無視する[['''べきです''']]
[SRC[>>45]]。

* MIME 型

[8] [[媒体素片]]が適用される対象となる[[MIME型]]について、
[[媒体素片]]仕様書は、各[[MIME型]]の仕様が採用することを[RUBYB[推奨]@en[recommend]]
[SRC[>>9]] するにとどめており、実際に特定の [[MIME型]]に適用できるとはしていません。

[FIG(corollary)[
[10] [CODE(MIME)@en[[[audio/*]]]], [CODE(MIME)@en[[[image/*]]]], 
[CODE(MIME)@en[[[video/*]]]] の[[MIME型]]は[[媒体素片]]を採用することを[RUBYB[推奨]@en[recommend]]されています
[SRC[>>9]]。
]FIG]

* query での利用

[12] [[媒体素片]]は[[素片識別子]]だけでなく、[[query]] として使うこともできます。
しかし一般に [[HTTP]] や [[RTSP]] では [[query]] は[[鯖]]が任意の方法で解釈することとなっており、
[[媒体素片]]の仕様も [[query]] で用いることを強制はしていません。
[[鯖]]は[[媒体素片]]と既存の [[query]] とを調和させることを[RUBYB[推奨]@en[recommend]]される
[SRC[>>11]] にとどまっています。

[16] [[媒体素片]]によって表される[[資源]]の部分の中には、
[[包含子]]の形式と[[コーデック]]に依存して「[RUBYB[なじむ]@en[fit]]」
ものとそうでないものがあります。ここで「なじむ」とは、
元の[[資源]]の構文要素を変更したり、ビット列を[[転符号化]]したりせずに求める部分を取り出せることをいいます。 [SRC[>>13]]

[17] 「なじむ」ものは[[素片識別子]]によって表すこともできますが、
「なじまない」ものは [[query]] によって表すしかありません [SRC[>>13]]。
[[query]] によって指定された場合は、[[鯖]]が適宜[[符号化]]し直すなどして求める部分を返すことになります。

* 処理

[14] [[媒体素片]]の[[素片識別子]]の適用後の[[素片]]と元の[[資源]]は同じ
[[MIME型]]であるべきです [SRC[>>13]]。

[EG[
[15] 例えば[[動画]]のうちの1つの[[フレーム]]を識別する[[媒体素片]]によって得られるのは[[静止画]]ではなく、
[[フレーム]]が1つの[[動画]]であるべきです [SRC[>>13]]。
]EG]

[18] [[媒体素片]]が[[素片識別子]]として指定された場合、
[[利用者エージェント]]は元の[[資源]]を取得し、
そこから[[媒体素片]]で指定された部分を取り出すこととなります。
[[利用者エージェント]]の機能と[[資源]]の形式次第では、
元の[[資源]]の必要となる範囲を特定してそこだけ[[鯖]]から取得することができるかもしれません。
また、[[媒体素片]]を[[鯖]]に送信して処理を委ねる方法を用意することも想定はされています
[SRC[>>13]] (が実際にはありません)。

[EG[
[19] 例えば[[動画形式]]によっては[[動画]]上の範囲と[[バイト範囲]]との対応関係の索引データが含まれていて、
それに従い[[範囲要求]]を使って必要な部分だけ取得できるかもしれません [SRC[>>13]]。
]EG]

[22] [[媒体素片]]が [[query]] として指定された場合、
[[鯖]]は元の[[資源]]から[[媒体素片]]で指定された部分を取り出し、
必要な変換を施して新しい[[資源]]として[[利用者エージェント]]に返すこととなります
[SRC[>>13]]。[[バイト列]]として一部分を取り出すだけでは不十分で、
当該データ形式において適切な形式で完全な[[資源]]として、
必要なら再[[符号化]]も行った上で返すことになります。

;; [23] 例えば 30s から 70s までの範囲のような[[媒体素片]]が指定されたとしても、
返される[[資源]]の開始位置は 0s で終了位置は 40s になります。
また新しい[[資源]]と元の[[資源]]の関係は明確にはなっていません。 [SRC[>>13]]
ですから通常は指定範囲の外に[[シーク]]することもできません。
データ形式によっては、あるいは[[プロトコル]]の拡張によって元の[[資源]]との関係や元の[[資源]]における新しい[[資源]]の範囲がどこであるかを明示できるかもしれません
[SRC[>>13]] が、[[媒体素片]]の仕様の範囲ではそのような仕組みは用意されていないようです。

[39] [[媒体素片]]は、構文解析した後、リストに含まれる各名前と値の組を、
名前によって示された[[次元]]の仕様に基づき、指定された順に解釈します [SRC[>>33]]。

;; [40] 同じ[[次元]]が複数指定された場合には、最後の指定が最終的に有効になります [SRC[>>33]]。

[42] 未対応の[[次元]]がある場合、[[利用者エージェント]]は無視しなければなりません。
[[検証器]]は警告するべきです。 [SRC[>>33]]

[32] [[次元]]によっては、条件次第で[[媒体素片]]全体を無視するよう求めている場合があります。

;; [CODE(URI)[[[xywh]]]] 参照。

* 歴史

[1]
[CITE@en[W3C Media Fragments Working Group]] ([TIME[2008-08-15 22:39:44 +09:00]] 版) <http://www.w3.org/2008/WebVideo/Fragments/>

[2] [CITE@en-us[Use cases and requirements for Media Fragments]] ([TIME[2009-05-01 02:03:22 +09:00]] 版) <http://www.w3.org/TR/2009/WD-media-frags-reqs-20090430/>

[6] [CITE@en-us[Media Fragments URI 1.0]]
([TIME[2009-12-16 20:09:16 +09:00]] 版)
<http://www.w3.org/TR/2009/WD-media-frags-20091217/>

[20] [CITE[IRC logs: freenode / #whatwg / 20091229]]
([TIME[2010-01-06 07:47:25 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20091229>

[3] [CITE@en-us[Media Fragments URI 1.0 (basic)]] ([TIME[2012-09-27 23:08:40 +09:00]] 版) <http://www.w3.org/TR/2012/REC-media-frags-20120925/>

[21] [CITE@en[Re: is spec complete?]]
( ([[Silvia Pfeiffer]] 著, [TIME[2013-06-11 07:32:04 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-media-fragment/2013Jun/0002.html>

[43] 次の機能は「basic」には含まれず、未完成のまま放置されています。
[FIG(short list)[
- [[次元]] [CODE(URI)[[[t]]]] の[[単位]] [CODE(URI)[[[smtpe]]]]
- [[次元]] [CODE(URI)[[[t]]]] の[[単位]] [CODE(URI)[[[clock]]]]
- [[次元]] [CODE(URI)[[[id]]]]
- [[次元]] [CODE(URI)[[[track]]]]
- [[HTTP]] による解決
]FIG]

[7] [CITE@en[Bug 23492 – Linking to a page with a fragment identifier that causes a particular media element to be shown and to seek to a particular position]]
( ([TIME[2013-10-14 22:54:45 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=23492>