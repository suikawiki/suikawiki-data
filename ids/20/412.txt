[5] 
[CODE[Geolocation]]
[[オブジェクト]]の[[メソッド]]で[[位置情報]]を取得できます。

* 仕様書

[REFS[
- [3] [CITE@en[Geolocation API Specification]], [TIME[2019-11-24 18:38:51 +09:00]] <https://w3c.github.io/geolocation-api/#geolocation_interface>
]REFS]

* 処理

[6] 
[CODE[Geolocation]]
[[インターフェイス]]の
[DFN[[CODE[getCurrentLocation]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [7] [VAR[成功コールバック]]を、
必須の第1引数を [CODE[PositionCallback]] と解釈した結果に設定します。
= [8] [VAR[エラーコールバック]]を、
第2引数を [CODE[PositionErrorCallback]] と解釈した結果に設定します。
= [9] [VAR[オプション群]]を、
第3引数を [CODE[PositionOptions]]
と解釈した結果に設定します。
]FIG]

[10] 
更に、[[非同期的]]に、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [17] [[環境設定群オブジェクト]]の[F[非保安文脈]]が[[真]]の場合、
== [18] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[PERMISSION_DENIED][GeolocationPositionError]]

]FIG]
== [19] [[開発者コンソール]]に[VAR[エラー]]を表示して[MAY[構いません]]。
== [20] [VAR[エラーコールバック]]に[VAR[エラー]]を報告し、ここで停止します。
= [11] [VAR[位置]]を、
キャッシュされた [CODE[GeolocationPosition]] に設定します。
= [23] [VAR[位置]]の[F[齢]]が[VAR[オプション群]]の
[F[[CODE[maxAge]]]]
[[以下]]の場合、
== [24] [VAR[成功コールバック]]に[VAR[位置]]を報告し、ここで停止します。
= [15] [VAR[オプション群]]の [F[[CODE[timeout][PositionOptions]]]] が [N[0]]
の場合、
== [26] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[TIMEOUT][GeolocationPositionError]]

]FIG]
== [21] [VAR[エラーコールバック]]に[VAR[エラー]]を報告し、ここで停止します。
= [81] 
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]について、
取得の手順群 (>>82) を実行します。

]FIG]

-*-*-

[42] 
[CODE[Geolocation]]
[[インターフェイス]]の
[DFN[[CODE[watchPosition]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [43] [VAR[成功コールバック]]を、
必須の第1引数を [CODE[PositionCallback]] と解釈した結果に設定します。
= [44] [VAR[エラーコールバック]]を、
第2引数を [CODE[PositionErrorCallback]] と解釈した結果に設定します。
= [45] [VAR[オプション群]]を、
第3引数を [CODE[PositionOptions]]
と解釈した結果に設定します。
= [52] [VAR[識別子]]を、新しい [[watch process]] を固有に識別する
[CODE[long]] の値に設定します。
= [53] [VAR[識別子]]を返します。
]FIG]

[46] 
更に、
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]、
[VAR[識別子]]について、
[[非同期的]]に次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [47] [[環境設定群オブジェクト]]の[F[非保安文脈]]が[[真]]の場合、
== [48] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[PERMISSION_DENIED][GeolocationPositionError]]

]FIG]
== [49] [[開発者コンソール]]に[VAR[エラー]]を表示して[MAY[構いません]]。
== [50] [VAR[エラーコールバック]]に[VAR[エラー]]を報告し、ここで停止します。
= [51] [VAR[成功コールバック]]、
[VAR[失敗コールバック]]、
[VAR[オプション群]]、
[VAR[識別子]]について [[watch process]] を実行します。

]FIG]

[58] 
[VAR[成功コールバック]]、
[VAR[失敗コールバック]]、
[VAR[オプション群]]、
[VAR[識別子]]について
[DFN[watch process]]
は、
次のようにします。
[SRC[>>3]]

[FIG(steps)[
= [36] [VAR[以前の位置]]を、
[CODE[null]]
に設定します。
= [59] [VAR[位置]]を、
キャッシュされた [CODE[GeolocationPosition]] に設定します。
= [60] [VAR[位置]]の[F[齢]]が[VAR[オプション群]]の
[F[[CODE[maxAge]]]]
[[以下]]の場合、
== [62] [VAR[成功コールバック]]に[VAR[位置]]を報告します。
== [35] [VAR[以前の位置]]を、[VAR[位置]]に設定します。
= [61] 
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]、
[VAR[識別子]]、
[VAR[以前の位置]]について、
[[acquisition steps]]
を実行します。
]FIG]

[63] 
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]、
[VAR[識別子]]、
[VAR[以前の位置]]について
[DFN[acquisition steps]]
は、
次のようにします。
[SRC[>>3]]

[FIG(steps)[
= [34] 
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]、
[VAR[以前の位置]]について、
取得の手順群 (>>82)
を実行します。
[VAR[watch]] は[[真]]とします。
]FIG]





[82] 
[VAR[成功コールバック]]、
[VAR[エラーコールバック]]、
[VAR[オプション群]]、
[VAR[以前の位置]]、
[VAR[watch]]
について取得の手順群は、
次のようにします。
[SRC[>>3]]

[FIG(steps)[

= [70] [VAR[中断信号]]を、[[偽]]に設定します。
= [28] [VAR[タイマー]]を、新しいタイマーを作成した結果に設定します。
[FIG(list members)[

: 時間 :
[VAR[オプション群]]の [F[[CODE[timeout][PositionOptions]]]]
[[ミリ秒]]
: 時間経過後[[非同期的]]に実行する処理 :
[FIG(steps)[
= [32] [VAR[タイマー]]の[F[停止済み]]が[[真]]の場合、
== [33] ここで停止します。
= [69] [VAR[中断信号]]を、[[真]]に設定します。
= [29] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[TIMEOUT][GeolocationPositionError]]

]FIG]
= [30] [VAR[エラーコールバック]]に[VAR[エラー]]を報告します。

]FIG]

]FIG]
= [27] 
[[プラットフォーム]]から[[位置情報]]を取得します。
[FIG(list members)[

: 取得方法決定のヒント :
[VAR[オプション群]]の [F[[CODE[enableHighAccuracy]]]]
: 取得成功時に[[非同期的]]に実行する処理 :
[FIG(steps)[
= [31] [VAR[中断信号]]が[[真]]の場合、
== [78] ここで停止します。
= [72] [VAR[タイマー]]の[F[停止済み]]を[[真]]に設定します。
= [79] [VAR[位置]]を、
新しい
[CODE[GeolocationPosition]]
に設定します。
= [74] 
キャッシュされた 
[CODE[GeolocationPosition]]
を、
[VAR[位置]]に設定します。
= [39] [VAR[watch]] が[[真]]で、
[[実装依存]]の基準で[[コールバック]]が呼ばれすぎていると判断される場合、
== [40] ここで停止します。
= [75] [VAR[成功コールバック]]に[VAR[以前の位置]]について[VAR[位置]]を報告します。

]FIG]
: 取得失敗時に[[非同期的]]に実行する処理 :
[FIG(steps)[
= [76] [VAR[中断信号]]が[[真]]の場合、
== [73] ここで停止します。
= [77] [VAR[タイマー]]の[F[停止済み]]を[[真]]に設定します。
= [41] [VAR[watch]] が[[真]]で、
[[実装依存]]の基準で[[コールバック]]が呼ばれすぎていると判断される場合、
== [64] ここで停止します。
= [80] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[POSITION_UNAVAILABLE]]

]FIG]
= [71] [VAR[エラーコールバック]]に[VAR[エラー]]を報告します。
]FIG]
: 取得を中断する条件 :
[VAR[中断信号]]が[[真]]になったとき

]FIG]

]FIG]

-*-*-

[54] 
[DFN[[CODE[PositionCallback]]]]
は、
[[コールバック関数]]で、
[CODE[GeolocationPosition]]
を[[引数]]として実行されます。
[[返り値]]は使われません。 [SRC[>>3]]

[56] 
[CODE[getCurrentLocation]]
[[メソッド]]と
[CODE[watchPosition]]
[[メソッド]]の第1引数として指定でき、必須です。
[CODE[getCurrentLocation]]
では高々1回呼び出されます。
[CODE[watchPosition]]
では任意の回数呼び出されます。


[13] [VAR[成功コールバック]]に省略可能な[VAR[以前の位置]]について
[CODE[GeolocationPosition]] [VAR[位置]]を報告するには、
次のようにします。 [SRC[>>3]]

[FIG(steps)[
= [37] [VAR[以前の位置]]が [CODE[null]] でなく、
[[実装依存]]の基準により[RUBYB[[VAR[以前の位置]]と[VAR[位置]]が十分異なる][[DFN[new position differs significantly from the previous position]]]]と''いえない''と判断される場合、
== [38] ここで停止します。
= [12] [VAR[位置]]について、
[VAR[成功コールバック]]を[[呼び出し][コールバックの実行]]ます。
]FIG]

[55] 
[DFN[[CODE[PositionErrorCallback]]]]
は、
[[コールバック関数]]で、
[CODE[GeolocationPositionError]]
を[[引数]]として実行されます。
[[返り値]]は使われません。
[SRC[>>3]]


[57] 
[CODE[getCurrentLocation]]
[[メソッド]]と
[CODE[watchPosition]]
[[メソッド]]の第2引数として指定できますが、
省略可能です。
省略された場合エラーは捨てられます。
[CODE[getCurrentPosition]]
[[メソッド]]では高々1回呼び出されます。


[25] [VAR[エラーコールバック]]に
[CODE[GeolocationPositionError]] [VAR[エラー]]を報告するには、
次のようにします。 [SRC[>>3]]

[FIG(steps)[
= [14] [VAR[エラーコールバック]]が指定された場合、
== [16] [VAR[エラー]]について、
[VAR[エラーコールバック]]を[[呼び出し][コールバックの実行]]ます。
]FIG]

-*-*-

[22] キャッシュの利用可能範囲は仕様書に明記がありません。
現在の文書でしょうか。

* 歴史

[1] [CITE@en[Geolocation API Specification]]
( ([TIME[2013-10-22 23:10:42 +09:00]] 版))
<http://www.w3.org/TR/geolocation-API/#get-current-position>

[4] [CITE@en[Geolocation API Specification]]
([TIME[2019-03-18 21:22:13 +09:00]])
<https://w3c.github.io/geolocation-api/#dom-geolocation-watchposition>

[2] 
[[Android]] の [[Chrome]] では、既定の状態で、ほぼ毎秒くらいの頻度でコールバックが呼び出されます。[TIME[2020-04-15T08:06:25.400Z]]
