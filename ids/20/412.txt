[5] 
[CODE[Geolocation]]
[[オブジェクト]]の[[メソッド]]で[[位置情報]]を取得できます。

* 仕様書

[REFS[
- [3] [CITE@en[Geolocation API Specification]], [TIME[2019-11-24 18:38:51 +09:00]] <https://w3c.github.io/geolocation-api/#geolocation_interface>
]REFS]

* 処理

[6] 
[CODE[Geolocation]]
[[インターフェイス]]の
[DFN[[CODE[getCurrentLocation]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [7] [VAR[成功コールバック]]を、
必須の第1引数を [CODE[PositionCallback]] と解釈した結果に設定します。
= [8] [VAR[エラーコールバック]]を、
第2引数を [CODE[PositionErrorCallback]] と解釈した結果に設定します。
= [9] [VAR[オプション群]]を、
第3引数を [CODE[PositionOptions]]
と解釈した結果に設定します。
]FIG]

[10] 
更に、[[非同期的]]に、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [17] [[環境設定群オブジェクト]]の[F[非保安文脈]]が[[真]]の場合、
== [18] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[PERMISSION_DENIED][GeolocationPositionError]]

]FIG]
== [19] [[開発者コンソール]]に[VAR[エラー]]を表示して[MAY[構いません]]。
== [20] [VAR[エラー]]を報告し、ここで停止します。
= [11] [VAR[キャッシュ位置]]を、
キャッシュされた [CODE[GeolocationPosition]] に設定します。
== [23] [VAR[キャッシュ位置]]の[F[齢]]が[VAR[オプション群]]の
[F[[CODE[maxAge]]]]
[[以下]]の場合、
=== [24] [VAR[キャッシュ位置]]を報告し、ここで停止します。
= [15] [VAR[オプション群]]の [F[[CODE[timeout][PositionOptions]]]] が [N[0]]
の場合、
== [26] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[TIMEOUT][GeolocationPositionError]]

]FIG]
== [21] [VAR[エラー]]を報告し、ここで停止します。
= [28] 新しいタイマーを作成します。
[FIG(list members)[

: 時間 :
[VAR[オプション群]]の [F[[CODE[timeout][PositionOptions]]]]
[[ミリ秒]]
: 時間経過後[[非同期的]]に実行する処理 :
[FIG(steps)[
= [29] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[TIMEOUT][GeolocationPositionError]]

]FIG]
= [30] [VAR[エラー]]を報告します。

]FIG]

]FIG]
= [27] 
[[プラットフォーム]]から[[位置情報]]を取得します。
[FIG(list members)[

: 取得方法決定のヒント :
[VAR[オプション群]]の [F[[CODE[enableHighAccuracy]]]]
: 取得成功時に[[非同期的]]に実行する処理 :
[FIG(steps)[
= [40] [VAR[報告済]]の場合、
== [41] ここで停止します。
= [36] [VAR[報告済]]を、[[真]]に設定します。
= [39] [VAR[位置]]を、
新しい
[CODE[GeolocationPosition]]
に設定します。
= [35] 
キャッシュされた 
[CODE[GeolocationPosition]]
を、
[VAR[位置]]に設定します。
= [34] [VAR[位置]]を報告します。


]FIG]
: 取得失敗時に[[非同期的]]に実行する処理 :
[FIG(steps)[
= [37] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[POSITION_UNAVAILABLE]]

]FIG]
= [38] [VAR[エラー]]を報告します。
]FIG]

]FIG]

]FIG]

-*-*-

[42] 
[CODE[Geolocation]]
[[インターフェイス]]の
[DFN[[CODE[watchPosition]]]]
[[メソッド]]は、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [43] [VAR[成功コールバック]]を、
必須の第1引数を [CODE[PositionCallback]] と解釈した結果に設定します。
= [44] [VAR[エラーコールバック]]を、
第2引数を [CODE[PositionErrorCallback]] と解釈した結果に設定します。
= [45] [VAR[オプション群]]を、
第3引数を [CODE[PositionOptions]]
と解釈した結果に設定します。
= [52] [VAR[識別子]]を、新しい [[watch process]] を固有に識別する
[CODE[long]] の値に設定します。
= [53] [VAR[識別子]]を返します。
]FIG]

[46] 
更に、[[非同期的]]に、
次のようにしなければ[MUST[なりません]]。
[SRC[>>3]]

[FIG(steps)[
= [47] [[環境設定群オブジェクト]]の[F[非保安文脈]]が[[真]]の場合、
== [48] [VAR[エラー]]を、
新しい
[CODE[GeolocationPositionError]]
に設定します。
[FIG(list members)[ [CODE[GeolocationPositionError]]

: [F[[CODE[code][GeolocationPositionError]]]] : [CODE[PERMISSION_DENIED][GeolocationPositionError]]

]FIG]
== [49] [[開発者コンソール]]に[VAR[エラー]]を表示して[MAY[構いません]]。
== [50] [VAR[エラー]]を報告し、ここで停止します。
= [51] [VAR[識別子]]の [[watch process]] を実行します。

]FIG]


-*-*-

[54] 
[DFN[[CODE[PositionCallback]]]]
は、
[[コールバック関数]]で、
[CODE[GeolocationPosition]]
を[[引数]]として実行されます。
[[返り値]]は使われません。 [SRC[>>3]]

[56] 
[CODE[getCurrentLocation]]
[[メソッド]]と
[CODE[watchPosition]]
[[メソッド]]の第1引数として指定でき、必須です。
[CODE[getCurrentLocation]]
では高々1回呼び出されます。
[CODE[watchPosition]]
では任意の回数呼び出されます。


[13] [CODE[GeolocationPosition]] [VAR[位置]]を報告するには、
次のようにします。 [SRC[>>3]]

[FIG(steps)[
= [12] [VAR[位置]]について、
[VAR[成功コールバック]]を[[呼び出し][コールバックの実行]]ます。
]FIG]

[55] 
[DFN[[CODE[PositionErrorCallback]]]]
は、
[[コールバック関数]]で、
[CODE[GeolocationPositionError]]
を[[引数]]として実行されます。
[[返り値]]は使われません。
[SRC[>>3]]


[57] 
[CODE[getCurrentLocation]]
[[メソッド]]と
[CODE[watchPosition]]
[[メソッド]]の第2引数として指定できますが、
省略可能です。
省略された場合エラーは捨てられます。
[CODE[getCurrentPosition]]
[[メソッド]]では高々1回呼び出されます。


[25] [CODE[GeolocationPositionError]] [VAR[エラー]]を報告するには、
次のようにします。 [SRC[>>3]]

[FIG(steps)[
= [31] [VAR[報告済]]の場合、
== [32] ここで停止します。
= [33] [VAR[報告済]]を、[[真]]に設定します。
= [14] [VAR[エラーコールバック]]が指定された場合、
== [16] [VAR[エラー]]について、
[VAR[エラーコールバック]]を[[呼び出し][コールバックの実行]]ます。
]FIG]

-*-*-

[22] キャッシュの利用可能範囲は仕様書に明記がありません。
現在の文書でしょうか。

* 歴史

[1] [CITE@en[Geolocation API Specification]]
( ([TIME[2013-10-22 23:10:42 +09:00]] 版))
<http://www.w3.org/TR/geolocation-API/#get-current-position>

[4] [CITE@en[Geolocation API Specification]]
([TIME[2019-03-18 21:22:13 +09:00]])
<https://w3c.github.io/geolocation-api/#dom-geolocation-watchposition>

[2] 
[[Android]] の [[Chrome]] では、既定の状態で、ほぼ毎秒くらいの頻度でコールバックが呼び出されます。[TIME[2020-04-15T08:06:25.400Z]]
