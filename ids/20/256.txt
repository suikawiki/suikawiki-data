[4] [DFN[[RUBYB[環境設定群オブジェクト]@en[environment settings object]]]]
(旧[DFN[[RUBYB[[[スクリプト設定群オブジェクト]]]@en[script settings object]]]]) は、
[[スクリプト]]実行や[[イベントループ]]に関わる諸条件の集合体です。

* 仕様書

[REFS[
- [3] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-10-14 21:54:07 +09:00]] 版) <https://html.spec.whatwg.org/#environment-settings-object>'''
-- [49] 旧 [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2014-04-03 03:44:44 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#script-settings-object>
- [34] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-10-14 21:54:07 +09:00]] 版) <https://html.spec.whatwg.org/#set-up-a-worker-environment-settings-object>
-- [50] 旧 [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2014-04-03 03:44:44 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#set-up-a-worker-script-settings-object>
- [39] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2014-04-03 03:44:44 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#calling-scripts>
- [59] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-04-25 04:40:19 +09:00]] 版) <https://html.spec.whatwg.org/#garbage-collection-and-browsing-contexts>
]REFS]

* 環境設定群オブジェクト

[18] [[環境設定群オブジェクト]]と[[大域オブジェクト]]には常に1対1の関係があります。
[DFN[[RUBYB[[[大域オブジェクトの関連する設定群オブジェクト]]]@en[relevant settings object for a global object]]]]とは、
その[[大域オブジェクト]]が用いられている (>>8) [[環境設定群オブジェクト]]のことをいいます。 [SRC[>>3]]

;; [19] [[大域オブジェクト]]が[[ごみ収集]]されない間は[[大域オブジェクトのスクリプト設定群オブジェクト]]も[[ごみ収集]]されないものと思われます。

[5] [[環境設定群オブジェクト]]は次のものにより構成されます。
[FIG(list members)[
:[6] [DFN[[RUBYB[[[スクリプト実行環境]]]@en[script execution environment]]]]:
[[利用者エージェント]]が対応している各[[スクリプト言語]]について、
当該[[スクリプト言語]]に依存した[[スクリプト実行環境]]の性質です。 [SRC[>>3]]
[7] [[JavaScript]] の場合、[RUBYB[[[解釈器]]]@en[interpreter]]、
[[実行文脈のスタック]]、[[大域コード]]と[[関数コード]]と得られた [CODE(JS)@en[[[Function]]]]
[[オブジェクト]]、その他です。 [SRC[>>3]]
:[8] [DFN[[RUBYB[[[大域オブジェクト]]]@en[global object]]]]:
本[[設定群オブジェクト]]を使う[[スクリプト]]の[[コード]]が呼べる [[API]] 
を提供する[[オブジェクト]]です。 [SRC[>>3]]
[9] これが空の[[オブジェクト]]だと、環境に作用することを何もできません。 [SRC[>>3]]
[60] [[強い参照]]です [SRC[>>59]]。
:[10] [DFN[[RUBYB[[[有責閲覧文脈]]]@en[responsible browsing context]]]]:
本[[設定群オブジェクト]]を使う[[スクリプト]]による動作に責任をもつ[[閲覧文脈]]です。 [SRC[>>3]] [[強い参照]]です [SRC[>>59]]。
:[11] [DFN[[RUBYB[[[有責文書]]]@en[responsible document]]]]:
本[[設定群オブジェクト]]を使う[[スクリプト]]による動作に責任を持つ[[文書]]です。 [SRC[>>3]]
[[強い参照]]です [SRC[>>59]]。
:[12] [DFN[[RUBYB[[[有責イベントループ]]]@en[responsible event loop]]]]:
どの[[イベントループ]]を使うか自明でない時に使う[[イベントループ]]です。 [SRC[>>3]]
:[13] [DFN[[RUBYB[[[API参照子源]]]@en[API referrer source]]]]:
[[fetch]] 内で [CODE(HTTP)@en[[[Referer]]]] の値を決めるために使われる[[文書]]または [[URL]]
です。 [SRC[>>3]]
:[14] [DFN[[RUBYB[[[API URL文字符号化]]]@en[API URL character encoding]]]]:
本[[設定群オブジェクト]]を使う[[スクリプト]]が呼ぶ [[API]] で [[URL]]
を[[符号化]]するために使われる[[文字符号化]]です。 [SRC[>>3]]
:[15] [DFN[[RUBYB[[[API基底URL]]]@en[API base URL]]]]:
本[[設定群オブジェクト]]を使う[[スクリプト]]が呼ぶ [[API]] で[[相対URL]]
を[[解決]]するために使われる[[絶対URL]]です。 [SRC[>>3]]
:[16] [DFN[[RUBYB[[[起源]]]@en[origin]]]] [SRC[>>3]]:
:[17] [DFN[[RUBYB[[[実効スクリプト起源]]]@en[effective script origin]]]] [SRC[>>3]]:
:[[HTTPS状態]]:本[[環境設定群オブジェクト]]を作成することになった[[応答]]の[[輸送路]]の状態です。
]FIG]

;; [23] 仕様上各構成要素は値ではなく、[[アルゴリズム]]となっています。各構成要素は固定の値を持つのではなく、
参照される時点で評価した結果の値が用いられることになります。

** [CODE(DOMi)@en[Window]]

[21] [CODE(DOMi)@en[[[Window]]]] の[[環境設定群オブジェクト]]は次のものです [SRC[>>3]]。
[FIG(list members)[
[FIGCAPTION[
[[環境設定群オブジェクト]]
]FIGCAPTION]
:[22] [[スクリプト実行環境]]:[[利用者エージェント]]が対応している各[[スクリプト言語]]について作成した実行環境です。
:[24] [[大域オブジェクト]]:当該 [CODE(DOMi)@en[[[Window]]]] です。
:[25] [[有責閲覧文脈]]:当該 [CODE(DOMi)@en[[[Window]]]] の[[閲覧文脈]]です。
:[26] [[有責文書]]:ありません。
:[27] [[有責イベントループ]]:当該 [CODE(DOMi)@en[[[Window]]]] の[[閲覧文脈]]が属する[[関連する類似起源閲覧文脈の単位]]の[[イベントループ]]です。
:[28] [[API参照子源]]:当該 [CODE(DOMi)@en[[[Window]]]] の現在の [CODE(DOMi)@en[[[Document]]]] です。
:[29] [[API URL文字符号化]]:当該 [CODE(DOMi)@en[[[Window]]]] の現在の [CODE(DOMi)@en[[[Document]]]] 
の[[文字符号化]]です。
:[30] [[API基底URL]]:当該 [CODE(DOMi)@en[[[Window]]]] の現在の [CODE(DOMi)@en[[[Document]]]] 
の[[基底URL]]です。
:[31] [[起源]]:当該 [CODE(DOMi)@en[[[Window]]]] の現在の [CODE(DOMi)@en[[[Document]]]] 
の[[起源]]です。
:[32] [[実効スクリプト起源]]:当該 [CODE(DOMi)@en[[[Window]]]] の現在の [CODE(DOMi)@en[[[Document]]]] 
の[[実効スクリプト起源]]です。
]FIG]

[33] この通り、いずれも (値を取得した時点での) [CODE(DOMi)@en[[[Window]]]] や [CODE(DOMi)@en[[[Document]]]] 
から自明に決まる値となります。

** ワーカー

[35] [[ワーカー]]については、
[DFN[[RUBYB[[[ワーカー環境設定群オブジェクトを設定]]]@en[set up a worker environment settings object]]]]する手順により次の通り[[スクリプト設定群オブジェクト]]が作られます
[SRC[>>34]]。
[FIG(list members)[
[FIGCAPTION[
[[環境設定群オブジェクト]]
]FIGCAPTION]
:[36] [[スクリプト実行環境]]:[[利用者エージェント]]が対応している各[[スクリプト言語]]について作成した実行環境です。
:[37] [[大域オブジェクト]]:与えられた[[大域スコープ]]です。
:[25] [[有責閲覧文脈]]:本[[設定群オブジェクト]]作成時点での [[incumbent settings object]] の[[有責閲覧文脈]]です。
:[26] [[有責文書]]:本[[設定群オブジェクト]]作成時点での [[incumbent settings object]] の[[有責文書]]です。
:[27] [[有責イベントループ]]:新たに作成した本[[ワーカー]]用の[[イベントループ]]です。
:[28] [[API参照子源]]:[[ワーカー]]の[[スクリプト]]の [[URL]] です。
:[29] [[API URL文字符号化]]: [[UTF-8]] です。
:[30] [[API基底URL]]:[[ワーカー]]の[[スクリプト]]の [[URL]] です。
:[31] [[起源]]: [[incumbent settings object]] の[[起源]]です。
:[32] [[実効スクリプト起源]]: [[incumbent settings object]] の[[起源]]です。
]FIG]

* 演算

[38] [CODE(DOMm)@en[[[postMessage]]]] では、[[設定群オブジェクト]]に関して
[[transfer a [CODE(DOMi)@en[Transferable]] object]] が実行されます。この手順では、
特定環境で作られたオブジェクトを他の環境へと移し替える操作が行われます。

* スタック

[40] [[関連する類似起源閲覧文脈の単位]]ごとに1つ、
[DFN[[RUBYB[[[スクリプト設定群オブジェクトのスタック]]]@en[stack of script settings objects]]]]があります。 [SRC[>>39]]

;; [54] [[Web IDL]] では[DFN[[RUBYB[現職スクリプトのスタック]@en[stack of incumbent scripts]]]]となっています。

[41] この[[スタック]]は、[[環境設定群オブジェクト]]を追加 ([[push]]) したり削除 ([[pop]])
したりできるものです。この[[スタック]]は、初期状態では空でなければ[['''なりません''']] [SRC[>>39]]。
このスタックに含まれる各項目 ([[環境設定群オブジェクト]]) には、
「[RUBYB[[[候補入口設定群オブジェクト]]]@en[candidate entry settings object]]」
というフラグをつけることができます [SRC[>>39]]。

[58] [[コード入口点に飛ぶ]]手順では、 [[JavaScript]] コードの実行の直前に[[スタック]]に [[push]]
され、直後に [[pop]] されます。

[55] [[コールバック関数の呼び出し]]では、 [[JavaScript]] [[関数]]の呼び出しの直前に[[スクリプト]]が[[現職スクリプトのスタック]]に [[push]]
され、直後に [[pop]] されます。

[56] 最も直近に [[push]] されたものを、[[現職設定群オブジェクト]]といいます。

[57] 最も直近に [[push]] された[[候補入口設定群オブジェクト]]フラグ付きのものを、
[[入口設定群オブジェクト]]といいます。

;; [61] 用法は、[[現職設定群オブジェクト]]と[[入口設定群オブジェクト]]を参照。

* 起源

[43] [[スクリプト]]を介した色々な操作のアクセス制御が[[同一起源ポリシー]]によって行われます。
この時利用されるのが、[[スクリプト設定群オブジェクト]]の[[起源]]や[[実効スクリプト起源]]です。

;; [44] これらは以前は単に「[[スクリプト]]の[[起源]]」、「[[スクリプト]]の[[実効スクリプト起源]]」などと呼ばれていたこともありました。

[45] [[起源]]や[[実効スクリプト起源]]は、 >>21 や >>35 の通り、[[環境設定群オブジェクト]]の作成時に決まります。

* 歴史

[REFS[
- [246] [CITE@en[Web Applications 1.0 r7236     Recast how the origin handling is done for data: URLs in workers, and fix the shared worker origin handling for data: URLs so that you can actually reconnect to a data: shared worker.]]
( ([TIME[2012-08-10 03:29:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7235&to=7236>
- [282] [CITE@en[Web Applications 1.0 r8262 Move the spec from a stack of incumbent scripts to a stack of script settings object. This should in theory have no concrete effects (though I may have changed some of the origin used for Web Workers started from document.domain-affected scripts that were called from other scripts with different original origins).]]
( ([TIME[2013-11-09 08:21:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8261&to=8262>
- [1] [CITE@en[Web Applications 1.0 r8263 Prepare for WebIDL integration]]
( ([TIME[2013-11-12 03:10:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8262&to=8263>
- [2] [CITE@en[Web Applications 1.0 r8264 Some more tidying around script settings objects.]]
( ([TIME[2013-11-12 03:53:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8263&to=8264>
]REFS]

[46] [[スクリプトの起源]]は[[スクリプト設定群オブジェクト]]導入前は次のような規定でした。

[FIG[

[REFS[
- [135] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-02-22 20:11:59 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#origin>
- [248] [CITE@en-US-x-hixie[HTML Standard]] ([TIME[2012-11-16 20:26:18 +09:00]] 版) <http://www.whatwg.org/specs/web-apps/current-work/#worker-origin>
]REFS]

* 所有者により決まる場合

[164] [[スクリプト]]の[[起源]]は[DFN[[RUBYB[所有子]@en[owner]]]]の[[起源]]の[[別名]]であり、
[[実効スクリプト起源]]は[[所有子]]の[[実効スクリプト起源]]の[[別名]]です。
[[所有子]]は[[スクリプト]]の種類により次の通り定まります。 [SRC[>>135]]

:[CODE(HTMLe)@en[[[script]]]] [[要素]]:[CODE(HTMLe)@en[[[script]]]] [[要素]]の所属する [CODE(DOMi)@en[[[Document]]]]
[SRC[>>135]]
:[[事象取扱器内容属性]]:[[属性]]の所属する [CODE(DOMi)@en[[[Document]]]] [SRC[>>135]]
:他の[[スクリプト]]により作られた[[関数]]その他のコード参照:作った[[スクリプト]] [SRC[>>135]]
:[[HTTP]] [[リダイレクト]] (や[[他のプロトコルで等価なもの]]) により返された [CODE(URI)@en[[[javascript]]]] [[URL]]:
[CODE(URI)@en[[[javascript:]]]] [[URL]] に[[リダイレクト]]した [[URL]] [SRC[>>135]]
:[[属性]]にあった [CODE(URI)@en[[[javascript]]]] [[URL]]:
[[属性]]の所属する [CODE(DOMi)@en[[[Document]]]] [SRC[>>135]]
:[[スタイル・シート]]にあった [CODE(URI)@en[[[javascript]]]] [[URL]]:[[スタイル・シート]]の [[URL]] [SRC[>>135]]
:[[閲覧文脈]]が [[navigate]] 中の [CODE(URI)@en[[[javascript]]]] [[URL]] であって、[[利用者]]によって提供されたもの (例えば[[ブックマークレット]]):
[[閲覧文脈]]の[[活性文書]]の [CODE(DOMi)@en[[[Document]]]] [SRC[>>135]]
:[[閲覧文脈]]が [[navigate]] 中の [CODE(URI)@en[[[javascript]]]] [[URL]] であって、[[マーク付け]]によって提供されたもの:
[[URL]] を宣言している[[要素]] (例えば [CODE(HTMLe)@en[[[a]]]] [[要素]]) の [CODE(DOMi)@en[[[Document]]]]
[SRC[>>135]]
:[[閲覧文脈]]が [[navigate]] 中の [CODE(URI)@en[[[javascript]]]] [[URL]] であって、[[スクリプト]]によって提供されたもの:
[[URL]] を提供した[[スクリプト]] [SRC[>>135]]

* その他のものから決まる場合

[223] その他の場合、[[スクリプト]]の[[起源]]・[[実効スクリプト起源]]は次に示すように定まります。

:[[ワーカー]]で走っている[[スクリプト]]:[[ワーカー]]の [CODE(JS)@en[[[location]]]]
[[属性]]の[[絶対URL]]の[[起源]]
(通常はその [[URL]] 自体から決まる[[起源]]・[[実効スクリプト起源]]であるが、
[CODE(URI)@en[[[data]]]] [[URL]] が[[構築子]]に指定されて作られた[[ワーカー]]ではその
[[entry script]] の[[起源]]・[[実効スクリプト起源]]と同じ値となる (>>243)。) [SRC[>>131]]

* ワーカー起源

[249] [DFN[[RUBYB[ワーカー起源]@en[worker origin]]]]は、 [CODE(DOMi)@en[[[WorkerGlobalScope]]]]
[[オブジェクト]]が作られるときに決まる[[起源]]です。 [SRC[>>248]]
[[エントリー・スクリプト]]の[[起源]]だったり、 [CODE(DOMi)@en[[[SharedWorker]]]]
[[構築子]]の引数として指定された [[URL]] の[[起源]]だったりします。
>>246 で導入されました。
]FIG]

[42] [CITE[IRC logs: freenode / #whatwg / 20140416]]
( ([TIME[2014-04-17 16:38:42 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20140416>

[283] [CITE[IRC logs: freenode / #whatwg / 20141013]]
( ([TIME[2014-10-18 02:52:30 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20141013#l-519>

** 改称

[48] 2014年10月に[[スクリプト設定群オブジェクト]]から[[環境設定群オブジェクト]]に改称されました
[SRC[>>47]]。

[REFS[
- [51] [CITE@en[Bug 26836 – Extend script settings objects to be environment settings objects for use by fetch et al]] ([TIME[2014-10-23 02:47:17 +09:00]] 版) <https://www.w3.org/Bugs/Public/show_bug.cgi?id=26836>
- [47] [CITE@en[Web Applications 1.0 r8834 Rename script settings objects to environment settings objects to make reuse saner.]] ([TIME[2014-10-11 08:43:00 +09:00]] 版) <https://html5.org/r/8834>
- [284] [CITE@en[Make client refer to an environment settings object rather than a JavaSc... · 88b1117 · whatwg/fetch]]
( ([TIME[2014-10-18 14:21:51 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/88b11177f158406479284ae3412c5fa34d184440>
- [285] [CITE@en[MIX: Drop "JavaScript Global Environment". · 5d32821 · w3c/webappsec]]
( ([TIME[2014-10-21 09:48:40 +09:00]] 版))
<https://github.com/w3c/webappsec/commit/5d32821b21f3cb06a651c966f729b3044292a08a>
]REFS]

** 

[REFS[
- [53] [CITE@en[Web Applications 1.0 r8853  Drop the 'responsible document' concept. This also changes the referrer to use when launching a nested worker to be the URL of the outer worker instead of the URL of the outer Document, which made no sense really.]] ([TIME[2014-11-20 08:35:00 +09:00]] 版) <https://html5.org/r/8853>
]REFS]

* 関連

[20] [[スクリプト]]はその構成要素として[[環境設定群オブジェクト]]を1つ持っています。
これを[[スクリプトの関連する設定群オブジェクト]]といいます。

[52] [[環境設定群オブジェクト]]と類する概念として他に[[クライアント]]、 [[Realm]]、
[[大域オブジェクト]]などがありますが、各仕様からはそれらよりも[[環境設定群オブジェクト]]を参照する方が良いとされています
[SRC[>>51]]。


[286] [CITE@en[Service workers, dedicated workers, and the environment settings object]]
( ([[Anne van Kesteren]] 著, [TIME[2014-10-24 20:09:56 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-webappsec/2014Oct/0120.html>

[287] [CITE@en[Service workers, dedicated workers, and the environment settings object]]
( ([[Anne van Kesteren]] 著, [TIME[2014-10-24 20:09:56 +09:00]] 版))
<http://lists.w3.org/Archives/Public/public-webappsec/2014Oct/0120.html>

[288] [CITE@en[MIX: Convert checks to environment settings objects. · d065309 · w3c/webappsec]]
( ([TIME[2014-10-30 03:03:36 +09:00]] 版))
<https://github.com/w3c/webappsec/commit/d06530978dafbd99881ca74f93ed67d720b161da>

[289] [CITE@en[Web Applications 1.0 r8860 Used the wrong variable in the worker's environment settings objects]]
( ([TIME[2014-11-27 07:18:00 +09:00]] 版))
<https://html5.org/r/8860>