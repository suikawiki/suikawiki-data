* 仕様書

[REFS[
- [10] [CITE@en[RFC 7838 - HTTP Alternative Services]] ([TIME[2016-04-17 23:25:39 +09:00]] 版) <https://tools.ietf.org/html/rfc7838>
]REFS]

* 代替サービス

[27] 普通 [[HTTP]] の[[資源]]へのアクセスは [[URL]] で指定された[[起源サーバー]]に接続して行いますが、
それとは異なるアクセス方法を[[起源サーバー]]が提供したい場合があり、
それを[DFN[[RUBYB[代替サービス]@en[alternative service]]]]と言っています。
より正確には、[[資源]]群に異なる[[プロトコル]]、[[ホスト]]、[[ポート]]の組み合わせでアクセスできるとき、
[[起源]]の[[代替サービス]]が利用可能であるといいます [SRC[>>10]]。

[EG[
[31] [[起源サーバー]]は、[[負荷]]が大きい時や、
[[クライアント]]により近い[[サーバー]]があるときに、
他の[[サーバー]]を使うよう[[クライアント]]に求めたいことがあります。 [SRC[>>10]]
]EG]

[EG[
[28] [[起源サーバー]]は、 [[HTTP/2]] など新しいプロトコルや、
[[TLS]] など[[セキュリティー]]を向上させたプロトコルを使ったアクセスを提供したいことがあります。
[SRC[>>10]]
]EG]

[EG[
[29] [[起源サーバー]]は、運用上、例えば [[SNI]] に対応しているかどうかなどで、
[[クライアント]]群を分類したいことがあるかもしれません。 [SRC[>>10]]
]EG]

[36] [[代替サービス]]は、 ([[ALPNプロトコル名]], [[RFC 3986]] [[ホスト]],
[[RFC 3986]] [[ポート]]) の組で表します。 [SRC[>>10]]

** 発見

[42] [[起源サーバー]]も[[代替サービス]]も、
[[代替サービス]]を更新したり、消去したり、
[[新鮮寿命]]を伸ばしたりできます。 [SRC[>>10]]

** 代替サービスキャッシュ

[45] [[クライアント]]は、[[キャッシュ]]に、[[起源]]ごとの[[代替サービス]]群を保持します。

[46] これは、 [[fingerprinting vector]] です。

[37] [[代替サービス]]は、[[秒]]単位の[DFN[[F[[RUBYB[[[新鮮寿命]]]@en[freshness lifetime]]]]]]を持ちます [SRC[>>10]]。

[40] [[クライアント]]は、[[代替サービス]]が[[新鮮]]である間、
いつでも当該[[代替サービス]]を使うことができます。 [SRC[>>10]]

[41] [[クライアント]]は、既にある[[接続]]については、
[[新鮮寿命]]を過ぎてもそのまま使い続けることができます。 [SRC[>>10]]

[44] [[クライアント]]は、[[ネットワーク]]設定が変化した時、
[CODE[persist]] フラグの値が [CODE[1]] であるものを除き、
[[代替サービス]]の情報を[[キャッシュ]]から削除する[SHOULD[べきです]]。
これは、[[代替サービス]]によって[[クライアント]]を最適なサーバーに向けていた場合に、
[[ネットワーク]]設定の変化で最適性が変化する可能性があるからです。 [SRC[>>10]]

** 利用

[32] [[代替サービス]]は[[URL]]や[[起源]]に影響せず、
接続先の決定とプロトコルの選択のみに関わるものです。 [[HTTPリダイレクト]]とは異なります。
特に、
[FIG(list)[
- [33] [[service identity]] の検証では、
元の [[URL]] の[F[ホスト]]を使わなければなりません。 [SRC[>>10]]
- [47] [[SNI]] では、元の [[URL]] の[F[ホスト]]を使わなければなりません。 [SRC[>>10]]
- [34] [[HTTP]] [CODE(HTTP)@en[Host:]] には、
元の [[URL]] の[F[ホスト]]や[F[ポート]]を使わなければなりません。
[SRC[>>10]]
]FIG]

;; [35] もちろん、[[開発者コンソール]]の類には実際に使った[[代替サービス]]の情報を表示できます
[SRC[>>10]]。

[43] [[代替サービス]]は当該[[起源]]について完全に [[authoritative]]
とみなされます [SRC[>>10]]。[[代替サービス]]に関する制御はもちろん、
[[キャッシュ]]その他あらゆる面で、[[起源サーバー]]と等価に扱われるようです。

;; この点、[[プロキシ]]や[[ミラーサーバー]]とは異なります。

[30] [[代替サービス]]は[[起源]]全体に適用されるものですから、
一部の[[資源]]のみに適用することはできません [SRC[>>10]]。

[38] [[クライアント]]は、[[代替サービス]]が当該[[起源]]全体の制御下にあり、妥当であることの[RUBYB[十分な保証]@en[reasonable assurances]]を有しなければ[MUST[なりません]]。
ここでいう「十分な保証」は、
[[HTTPSサーバー認証]]で確立できます。[[クライアント]]は更に他の要件を加えても構いません。
[SRC[>>10]]

[EG[
[39] [[起源]]の[F[ホスト]]が [CODE[www.example.com]] のとき、
[[代替サービス]]の[F[ホスト]]が [CODE[other.example.com]] で[F[プロトコル]]が
[CODE[h2]] (= [[HTTP/2]] over [[TLS]]) なら、[[証明書]]が [CODE[www.example.com]]
で有効かどうかを検証することで、
十分な保証があるとみなすことができます。しかし[F[プロトコル]]が [CODE[h2c]]
(= [[HTTP/2]] over [[TCP]]) では、同様の検査ができないので、
十分な保証が得られないと判断せざるを得ません。 [SRC[>>10]]
]EG]

[48] [[代替サービス]]の[F[プロトコル]]が [[TLS]] を使う場合、
[[クライアント]]が [[SNI]] に対応していなければ、
その[[代替サービス]]を使っては[MUST[なりません]] [SRC[>>10]]。

;; [49] なぜか [[SNI]] を使わなければ[MUST[ならない]]とはされていませんが、
普通に考えれば、[F[ホスト]]が[[ドメイン名]]の場合、使わなければならないはずです
(そうでなければ[[Web互換]]ではありません)。[F[ホスト]]が[[IPアドレス]]なら、
[[SNI]] は使えません。

* 歴史

** [CODE(HTTP)@en[Alternate-Protocol:]] ヘッダー

[1] [CITE[SPDY Protocol - Draft 2 - The Chromium Projects]]
( ([TIME[2013-10-19 15:06:10 +09:00]] 版))
<http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft2#TOC-Server-Advertisement-of-SPDY-through-the-HTTP-Alternate-Protocol-header>

[2] [CITE[Re: Add QUIC to Alternate-Protocol support. (issue 12156005) - Google グループ]]
( ([TIME[2013-10-20 06:22:12 +09:00]] 版))
<https://groups.google.com/a/chromium.org/forum/#!topic/chromium-reviews/NhzeGXtLCOA>

[3] [CITE[Actually enable Alternate-Protocol support for QUIC. (issue 17410014) - Google グループ]]
( ([TIME[2013-10-20 06:22:43 +09:00]] 版))
<https://groups.google.com/a/chromium.org/forum/#!topic/chromium-reviews/y2RjueIsQbM>

[4] 
>
[PRE(HTTP code)[
HTTP/1.1 304 Not Modified
X-GData-User-Country: JP
Date: Sun, 20 Oct 2013 06:20:16 GMT
Server: GSE
Alternate-Protocol: 80:quic

]PRE]

[5] [CITE[SPDY Protocol - Draft 2 - The Chromium Projects]]
( ([TIME[2014-11-01 00:36:56 +09:00]] 版))
<http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft2#TOC-Server-Advertisement-of-SPDY-through-the-HTTP-Alternate-Protocol-header>

[6] 
[PRE(HTTP example code)[
Alternate-Protocol: 80:quic,p=0.01
]PRE]


[FIG(quote)[
[FIGCAPTION[
[7] [CITE[QUIC FAQ - The Chromium Projects]]
([TIME[2016-04-16 07:05:17 +09:00]] 版)
<https://www.chromium.org/quic/quic-faq>
]FIGCAPTION]

> How do I aim Chrome at the test server?
> If you have an HTTP server, you'll need it to emit a response header that looks like:
> Alternate-Protocol: quic:<QUIC server port>

]FIG]

[8] [CITE[Issue 1720163002: When Alt-Svc header processing is enabled, do not process Alternate-Protocol - Code Review]]
([TIME[2016-04-18 00:42:12 +09:00]] 版)
<https://codereview.chromium.org/1720163002/>

[9] [CITE@en[698362 – Decide what to do regarding Alternate-Protocol vs redirects]]
([TIME[2016-04-18 17:03:45 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=698362>

** [CODE(HTTP)@en[Alt-Svc:]] ヘッダー

[16] [CITE@en[HTTP Alternative Services]]
( ([TIME[2014-07-24 13:19:57 +09:00]] 版))
<https://httpwg.github.io/http-extensions/alt-svc.html>

[17] [CITE@en[Certificate verification bypass through the HTTP/2 Alt-Svc header — Mozilla]]
([TIME[2015-04-04 05:00:27 +09:00]] 版)
<https://www.mozilla.org/en-US/security/advisories/mfsa2015-44/>

[18] [CITE[Bits Up!: Opportunistic Encryption For Firefox]]
([TIME[2015-04-06 16:35:05 +09:00]] 版)
<http://bitsup.blogspot.jp/2015/03/opportunistic-encryption-for-firefox.html>

[19] [CITE[Mozilla Dials Back on Firefox Opportunistic Encryption]]
([TIME[2015-06-18 11:58:10 +09:00]] 版)
<http://www.eweek.com/security/mozilla-dials-back-on-firefox-opportunistic-encryption.html>

[20] [CITE@en[Certificate verification bypass through the HTTP/2 Alt-Svc header — Mozilla]]
([TIME[2015-04-04 05:00:27 +09:00]] 版)
<https://www.mozilla.org/en-US/security/advisories/mfsa2015-44/>

[21] [CITE@en[draft-ietf-httpbis-alt-svc-07 - HTTP Alternative Services]]
([TIME[2015-05-21 10:26:13 +09:00]] 版)
<https://tools.ietf.org/html/draft-ietf-httpbis-alt-svc-07>

[22] [CITE@en[1003448 – http/2 alt-svc support]]
([TIME[2015-06-18 11:59:58 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=1003448>

[23] [CITE@en[1113790 – pref change to true for network.http.altsvc.enabled and altsvc.oe]]
([TIME[2015-06-18 12:00:13 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=1113790>

[24] [CITE@en[HTTP Alternative Services]]
([TIME[2015-05-30 15:33:33 +09:00]] 版)
<http://http2.github.io/http2-spec/alt-svc.html>

[25] [CITE[Issue 438263 - chromium - Update HTTP/2 AltSvc frame wire format - An open-source project to help move the web forward. - Google Project Hosting]]
([TIME[2015-06-18 12:04:09 +09:00]] 版)
<https://code.google.com/p/chromium/issues/detail?id=438263>

[11] [CITE[Issue 392575 - chromium - Implement the Alt-Svc spec - An open-source project to help move the web forward. - Google Project Hosting]]
([TIME[2015-06-18 12:04:58 +09:00]] 版)
<https://code.google.com/p/chromium/issues/detail?id=392575>

[12] [CITE@en[Issue 585876 - chromium - QUIC connections to "remote" Alt-Svcs should use the origin hostname in the SNI field - Monorail]]
([TIME[2016-04-18 00:10:27 +09:00]] 版)
<https://bugs.chromium.org/p/chromium/issues/detail?id=585876>

[13] [CITE[Issue 1720163002: When Alt-Svc header processing is enabled, do not process Alternate-Protocol - Code Review]]
([TIME[2016-04-18 00:42:21 +09:00]] 版)
<https://codereview.chromium.org/1720163002/>

[FIG(quote)[
[FIGCAPTION[
[14] [CITE@ja[YouTube]]
([TIME[2016-04-18 00:49:55 +09:00]] 版)
<https://www.youtube.com/>
]FIGCAPTION]

> alt-svc:quic=":443"; ma=2592000; v="32,31,30,29,28,27,26,25"
> alternate-protocol:443:quic

]FIG]


[FIG(quote)[
[FIGCAPTION[
[15] [CITE@ja[Google]]
([TIME[2016-04-18 00:50:55 +09:00]] 版)
<https://www.google.co.jp/>
]FIGCAPTION]

> alt-svc:quic=":443"; ma=2592000; v="32,31,30,29,28,27,26,25"
> alternate-protocol:443:quic

]FIG]

[26] [CITE@en[Implement ALT-SVC · Issue #535 · nghttp2/nghttp2]]
([TIME[2016-04-18 17:19:51 +09:00]] 版)
<https://github.com/nghttp2/nghttp2/issues/535>