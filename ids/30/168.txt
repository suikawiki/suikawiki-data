[3] [DFN[[RUBYB[サービスワーカー登録]@en[service worker registration]]]]

* 仕様書

[REFS[
- [1] [CITE@en[Service Workers Nightly]] ([TIME[2017-02-16 20:10:49 +09:00]]) <https://w3c.github.io/ServiceWorker/#dfn-containing-service-worker-registration>
- [2] '''[CITE@en[Service Workers Nightly]] ([TIME[2017-02-16 20:10:49 +09:00]]) <https://w3c.github.io/ServiceWorker/#service-worker-registration-concept>'''
- [12] [CITE@en[Service Workers Nightly]] ([TIME[2017-02-25 12:50:35 +09:00]]) <https://w3c.github.io/ServiceWorker/#selection>
- [25] [CITE@en[Service Workers Nightly]] ([TIME[2017-03-02 15:00:14 +09:00]]) <https://w3c.github.io/ServiceWorker/#serviceworkercontainer-interface>
-- [21] [CITE@en[Service Workers Nightly]] ([TIME[2017-03-02 15:00:14 +09:00]]) <https://w3c.github.io/ServiceWorker/#navigator-service-worker-register>
-- [37] [CITE@en[Service Workers Nightly]] ([TIME[2017-03-02 15:00:14 +09:00]]) <https://w3c.github.io/ServiceWorker/#navigator-service-worker-getRegistration>
-- [54] [CITE@en[Service Workers Nightly]] ([TIME[2017-03-02 15:00:14 +09:00]]) <https://w3c.github.io/ServiceWorker/#navigator-service-worker-getRegistrations>
]REFS]

* 状態

[8] [[サービスワーカー登録]]は、次の状態を持ちます。

[FIG(list members)[
: [F[適用範囲URL]] :
: [F[インストール中ワーカー]] :
: [F[待機中ワーカー]] :
: [F[活性ワーカー]] :
: [DFN[[F[last update check time]]]] :
初期値は [CODE[null]] [SRC[>>2]]。
: [DFN[[F[use cache]]]] :
[[ブール型]]。初期値は[[偽]]。 [SRC[>>2]]
: [DFN[[F[uninstalling flag]]]] :
初期値は[[未設定]]。 [SRC[>>2]]
: [F[タスクキュー群]] :
: [F[[CODE(DOMi)@en[NavigationPreloadManager]]]] :
: [F[navigation preload enabled flag]] :
: [F[navigation preload header value]] :
]FIG]

* [CODE(DOMi)@en[ServiceWorkerContainer]] インターフェイス [CODE(DOMm)@en[register]] メソッド

[22] [CODE(DOMi)@en[ServiceWorkerContainer]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[register]]]] [[メソッド]]は、
次の[[引数]]を持ちます。

[FIG(list members)[
: [VAR[スクリプトURL]] : [CODE(IDL)@en[USVString]] [SRC[>>25]]。
: [VAR[オプション群]] :[[辞書]] [CODE(IDL)@en[RegistrationOptions]] (省略可能) [SRC[>>25]]。
]FIG]

[24] [[辞書]] [DFN[[CODE(IDL)@en[RegistrationOptions]]]]
は、次の[[メンバー][辞書メンバー]]を持ちます [SRC[>>25]]。

[FIG(list members middle)[
- [DFN[[CODE(DOMa)@en[scope]]]] ([CODE(IDL)@en[USVString]])
- [CODE(DOMa)@en[type][スクリプト型]] ([CODE(IDL)@en[WorkerType]], 既定値 [CODE[classic][古典スクリプト]])
- [DFN[[CODE(DOMa)@en[useCache]]]] ([CODE(IDL)@en[boolean]], 既定値[[偽]])
]FIG]

[23] この[[メソッド]]は、 [CODE(IDL xattr)@en[NewObject]] です [SRC[>>25]]。

[26] 次のようにしなければ[MUST[なりません]] [SRC[>>21]]。

[FIG(steps)[
= [28] [VAR[約束]]を、[[約束]]に設定します。
= [29] [VAR[クライアント]]を、[[文脈オブジェクト]]の[F[サービスワーカークライアント]]に設定します。
= [30] [VAR[URL]]を、[VAR[スクリプトURL]]を[[文脈オブジェクト]]の[F[関連設定群オブジェクト]]の[F[API基底URL]]に対して[[構文解析][URL構文解析]]した結果に設定します。
= [31] [VAR[オプション群]]の [CODE(DOMa)@en[scope]] が[[存在]]するなら、
== [32] [VAR[適用範囲URL]]を、[VAR[オプション群]]の [CODE(DOMa)@en[scope]]
を[[文脈オブジェクト]]の[F[関連設定群オブジェクト]]の[F[API基底URL]]に対して[[構文解析][URL構文解析]]した結果に設定します。
= [33] それ以外の場合、
== [27] [VAR[適用範囲URL]]を、 [CODE[null]] に設定します。
= [34] [VAR[適用範囲URL]]、[VAR[URL]]、[VAR[約束]]、[VAR[クライアント]]、
[VAR[クライアント]]の[F[作成URL]]、[VAR[オプション群]]の [CODE(DOMa)@en[type][WorkerType]]、
[VAR[オプション群]]の [CODE(DOMa)@en[useCache]] について[[登録開始]]します。
= [35] [VAR[約束]]を返します。
]FIG]

* [CODE(DOMi)@en[ServiceWorkerContainer]] インターフェイス [CODE(DOMm)@en[getRegistration]] メソッド

[36] [CODE(DOMi)@en[ServiceWorkerContainer]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[getRegistration]]]] [[メソッド]]は、
次のようにしなければ[MUST[なりません]] [SRC[>>37]]。

[FIG(steps)[
= [38] [VAR[クライアントURL]]を、[[省略可能]]な第1引数を
[CODE(IDL)@en[USVString]] と解釈した結果に設定します。
[[既定値]]は[[空文字列]]とします。 [SRC[>>25]]
= [39] [VAR[クライアント]]を、[[文脈オブジェクト]]の[F[サービスワーカークライアント]]に設定します。
= [40] [VAR[URL]]を、[VAR[クライアントURL]]を[[文脈オブジェクト]]の[F[関連設定群オブジェクト]]の[F[API基底URL]]に対して[[構文解析][URL構文解析]]した結果に設定します。
= [41] [VAR[URL]] が[[失敗]]の場合、
== [42] [CODE(JS)@en[TypeError]] で[[拒絶]]した[[約束]]を返し、ここで停止します。
= [43] [VAR[URL]]の[F[起源][URLの起源]]が[VAR[クライアント]]の[F[起源]]と[[同じ起源]]でない場合、
== [44] [CODE(JS)@en[SecurityError]] [[例外]]で[[拒絶]]した[[約束]]を返し、ここで停止します。
= [45] [VAR[約束]]を、新しい[[約束]]に設定します。
= [46] 並列の処理を開始します。
= [47] [VAR[約束]]を返します。
]FIG]

[48] 並列の処理は、次のようにします [SRC[>>37]]。

[FIG(steps)[
= [49] [VAR[登録]]を、[VAR[URL]] についての[[サービスワーカー登録の一致]]の結果に設定します。
= [50] [VAR[登録]]が [CODE[null]] 以外の場合、
== [51] [VAR[約束]]を、[VAR[登録]]を表す [CODE(DOMi)@en[ServiceWorkerRegistration]]
で[[解決][約束の解決]]します。
= [52] それ以外の場合、
== [53] [VAR[約束]]を、[[未定義]]で[[解決][約束の解決]]します。
]FIG]

* [CODE(DOMi)@en[ServiceWorkerContainer]] インターフェイス [CODE(DOMm)@en[getRegistrations]] メソッド

[55] [CODE(DOMi)@en[ServiceWorkerContainer]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[getRegistration''s'']]]] [[メソッド]]は、
次のようにしなければ[MUST[なりません]] [SRC[>>54]]。

[FIG(steps)[
= [56] [VAR[クライアント]]を、[[文脈オブジェクト]]の[F[サービスワーカークライアント]]に設定します。
= [57] [VAR[約束]]を、新しい[[約束]]に設定します。
= [58] 並列の処理を開始します。
= [59] [VAR[約束]]を返します
]FIG]

[60] 並列の処理は、次のようにします [SRC[>>54]]。

[FIG(steps)[
= [61] [VAR[配列]]を、新しい[[配列]]に設定します。
= [62] [[scope to registration map]] の各 ([VAR[キー]], [VAR[値]]) について、
== [63] [VAR[キー]]を[[構文解析][URL構文解析]]した結果の[F[起源][URLの起源]]が[VAR[クライアント]]の[F[起源]]と[[同じ起源]]で、
[VAR[値]]の [F[uninstalling flag]] が[[偽]]なら、
=== [64] [VAR[配列]]に、
@@ [VAR[値]]と関連付けられた [CODE(DOMi)@en[ServiceWorkerRegistration]]
を追加します。
= [65] [VAR[約束]]を、[VAR[配列]]で[[解決][約束の解決]]します。
]FIG]

* 処理

** 管理

[9] [[利用者エージェント]]は、
登録されてまだ登録解除されていない[[サービスワーカー登録]]のリストを保持しなければ[MUST[なりません]]。
[[利用者エージェント]]の [DFN[[F[scope to registration map]]]] は、
[[サービスワーカー登録]]の[F[適用範囲URL]]から[[サービスワーカー登録]]への[[写像]]です。
[SRC[>>2]]

;; [10] [[サービスワーカー登録]]の[[寿命]]は、 [CODE(DOMi)@en[ServiceWorkerRegistration]]
[[オブジェクト]]の[[寿命]]より長いです。 [SRC[>>2]]

[5] [F[適用範囲URL]]が同じ[[サービスワーカー登録]]が既にあれば、新しいもので置き換えられます。
[SRC[>>2]]

[4] [[利用者エージェント]]は、[F[適用範囲URL]]が異なる限り、
同じ[[起源]]の複数の[[サービスワーカー登録]]を有効化して構いません。
[SRC[>>2]]

@@ [20] [[scope to registration map]] 追加時に [CODE[ready]] の処理

** 選択

[11] [[サービスワーカークライアント]][VAR[クライアント]]は、
[VAR[要求]]の処理に当たり、
[[サービスワーカー登録]]を次のように[DFN[[RUBYB[選択]@en[select]]]]します [SRC[>>12]]。

[FIG(steps)[
= [13] [VAR[要求]]の[F[URL][要求URL]]が[F[局所][局所URL]]で''ない''なら、
== [14] [VAR[クライアント]]が[[利用者エージェント]]の [F[scope to registration map]] から[[サービスワーカー登録一致]]した結果を返します。
= [15] それ以外の場合、
== [16] [VAR[クライアント]]の[F[有責閲覧文脈]]が[[入れ子閲覧文脈]]の場合、
=== [18] [VAR[クライアント]]の[F[親閲覧文脈]]の環境の[[サービスワーカー登録]]を
(あれば) 返します。
== [19] [VAR[クライアント]]が[[ワーカークライアント]]なら、
=== [17] [VAR[クライアント]]の[F[ワーカーの文書群]]のいずれかの環境の[[サービスワーカー登録]]を
(あれば) 返します。
]FIG]

@@ [DFN[サービスワーカー登録の一致]]

* 文脈

[6] [[サービスワーカー]]は、[DFN[[F[containing service worker registration]]]]
を持ちます。値は[[サービスワーカー登録]]です。 [SRC[>>1]]

[7] [[サービスワーカー]]の[F[containing service worker registration]]は、
その[[サービスワーカー]]を含むものです。 [SRC[>>1]]
