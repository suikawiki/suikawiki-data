[3] [DFN[[RUBYB[サービスワーカー登録]@en[service worker registration]]]]

* 仕様書

[REFS[
- [1] [CITE@en[Service Workers Nightly]] ([TIME[2017-02-16 20:10:49 +09:00]]) <https://w3c.github.io/ServiceWorker/#dfn-containing-service-worker-registration>
- [2] '''[CITE@en[Service Workers Nightly]] ([TIME[2017-02-16 20:10:49 +09:00]]) <https://w3c.github.io/ServiceWorker/#service-worker-registration-concept>'''
- [12] [CITE@en[Service Workers Nightly]] ([TIME[2017-02-25 12:50:35 +09:00]]) <https://w3c.github.io/ServiceWorker/#selection>
]REFS]

* 状態

[8] [[サービスワーカー登録]]は、次の状態を持ちます。

[FIG(list members)[
: [F[適用範囲URL]] :
: [F[インストール中ワーカー]] :
: [F[待機中ワーカー]] :
: [F[活性ワーカー]] :
: [DFN[[F[last update check time]]]] :
初期値は [CODE[null]] [SRC[>>2]]。
: [DFN[[F[use cache]]]] :
[[ブール型]]。初期値は[[偽]]。 [SRC[>>2]]
: [DFN[[F[uninstalling flag]]]] :
初期値は[[未設定]]。 [SRC[>>2]]
: [F[タスクキュー群]] :
: [F[[CODE(DOMi)@en[NavigationPreloadManager]]]] :
: [F[navigation preload enabled flag]] :
: [F[navigation preload header value]] :
]FIG]

* 処理

** 管理

[9] [[利用者エージェント]]は、
登録されてまだ登録解除されていない[[サービスワーカー登録]]のリストを保持しなければ[MUST[なりません]]。
[[利用者エージェント]]の [DFN[[F[scope to registration map]]]] は、
[[サービスワーカー登録]]の[F[適用範囲URL]]から[[サービスワーカー登録]]への[[写像]]です。
[SRC[>>2]]

;; [10] [[サービスワーカー登録]]の[[寿命]]は、 [CODE(DOMi)@en[ServiceWorkerRegistration]]
[[オブジェクト]]の[[寿命]]より長いです。 [SRC[>>2]]

[5] [F[適用範囲URL]]が同じ[[サービスワーカー登録]]が既にあれば、新しいもので置き換えられます。
[SRC[>>2]]

[4] [[利用者エージェント]]は、[F[適用範囲URL]]が異なる限り、
同じ[[起源]]の複数の[[サービスワーカー登録]]を有効化して構いません。
[SRC[>>2]]

@@ [20] [[scope to registration map]] 追加時に [CODE[ready]] の処理

** 選択

[11] [[サービスワーカークライアント]][VAR[クライアント]]は、
[VAR[要求]]の処理に当たり、
[[サービスワーカー登録]]を次のように[DFN[[RUBYB[選択]@en[select]]]]します [SRC[>>12]]。

[FIG(steps)[
= [13] [VAR[要求]]の[F[URL][要求URL]]が[F[局所][局所URL]]で''ない''なら、
== [14] [VAR[クライアント]]が[[利用者エージェント]]の [F[scope to registration map]] から[[サービスワーカー登録一致]]した結果を返します。
= [15] それ以外の場合、
== [16] [VAR[クライアント]]の[F[有責閲覧文脈]]が[[入れ子閲覧文脈]]の場合、
=== [18] [VAR[クライアント]]の[F[親閲覧文脈]]の環境の[[サービスワーカー登録]]を
(あれば) 返します。
== [19] [VAR[クライアント]]が[[ワーカークライアント]]なら、
=== [17] [VAR[クライアント]]の[F[ワーカーの文書群]]のいずれかの環境の[[サービスワーカー登録]]を
(あれば) 返します。
]FIG]

@@ [DFN[サービスワーカー登録の一致]]

* 文脈

[6] [[サービスワーカー]]は、[DFN[[F[containing service worker registration]]]]
を持ちます。値は[[サービスワーカー登録]]です。 [SRC[>>1]]

[7] [[サービスワーカー]]の[F[containing service worker registration]]は、
その[[サービスワーカー]]を含むものです。 [SRC[>>1]]
