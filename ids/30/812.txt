* 仕様書

[REFS[
- [2] [CITE@en[RFC 8030 - Generic Event Delivery Using HTTP Push]], [TIME[2020-03-09 00:13:33 +09:00]] <https://tools.ietf.org/html/rfc8030>
- [63] [CITE@en[RFC 8292 - Voluntary Application Server Identification (VAPID) for Web Push]], [TIME[2020-03-09 00:13:41 +09:00]] <https://tools.ietf.org/html/rfc8292#section-4.2>
- [73] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dfn-push-subscription>
- [77] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dfn-push-endpoint>
- [78] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dfn-subscription-expiration-time>
- [90] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dfn-refresh>
- [103] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#dfn-deactivate>
- [105] [CITE@en-US[Push API]], [TIME[2020-02-04 16:21:34 +09:00]] <https://w3c.github.io/push-api/#security-and-privacy-considerations>
]REFS]

* 意味

[3] 
[DFN[[RUBYB[プッシュメッセージ購読][push message subscription]]]]は、
[[利用者エージェント]]と[[プッシュサービス]]の間で確立された[RUBYB[メッセージ配送文脈][message delivery context]]であって、
[[アプリケーションサーバー]]と共有されるものです。
[[プッシュメッセージ]]はすべてある[[プッシュメッセージ購読]]と関連付けられています。
[SRC[>>2 1.1.]]
[[プッシュサービス資源]]により作成されます。

[74] 
[DFN[[RUBYB[プッシュ購読][push subscription]]]]は、
[[利用者エージェント]]と[[プッシュサービス]]の間に、
[[Webアプリケーション]]にかわって確立されたメッセージ配送文脈です。
[SRC[>>73]]



[4] [[プッシュメッセージ購読集合]]の[[要素]]です。

[5] [[RFC 8030]] が [DFN[message subscription]]、
[DFN[subscription]] とだけ言っているものも、
[[プッシュメッセージ購読]]を意味すると思われます。

[FIG(list members)[ [75] [[プッシュ購読]] ([[利用者エージェント]])
: [F[サービスワーカー登録]] :
[[プッシュ購読]]は、
[[サービスワーカー登録]]に関連付けられます。
[[サービスワーカー登録]]は、[[高々]]1つ[[プッシュ購読]]を持ちます。
[SRC[>>73]]
: [F[プッシュエンドポイント]] :
[[絶対URL]]。
: [F[購読満期時刻]] :
[[ミリ秒Unix time]]。
: [F[鍵ペア]] : [[作成][プッシュサービス資源]]時に設定された[[鍵ペア]]。 [SRC[>>73]]
: [F[authentication secret]] : [[作成][プッシュサービス資源]]時に設定された [[authentication secret]]。 [SRC[>>83]]

]FIG]

-*-*-


[32] 
[DFN[[RUBYB[プッシュメッセージ購読集合][push message subscription set]]]]は、
[[利用者エージェント]]と[[プッシュサービス]]の間で確立される[RUBYB[メッセージ配送文脈][message delivery context]]であって、
複数の[[プッシュメッセージ購読]]を集めて[[集合]]としたものです。
[SRC[>>2 1.1.]]


[33] 
[[RFC]] は「subscription set」と省略して表記することもあるようです。


[34] 
[[プッシュメッセージ購読]]を集めて[[集合]]化することで、
[[プッシュサービス]]と[[利用者エージェント]]にとって効率化できます。
[SRC[>>2 4.1.]]

[35] 
[[プッシュサービス資源]]を使った[[プッシュメッセージ購読]]作成時に、
[[利用者エージェント]]は[[要求]]で[[プッシュメッセージ購読集合]]を指定し、
そこに作成した[[プッシュメッセージ購読]]を所属させることができます。


[36] 
[[プッシュサービス資源]]を使った[[プッシュメッセージ購読]]作成時に、
[[プッシュサービス]]は[[応答]]で[[プッシュメッセージ購読集合]]を示すことができます。



* プロトコル

[8] 
まず、[[利用者エージェント][利用者エージェント (プッシュ)]]は、
新しい[[プッシュメッセージ購読]]を作成します。
[SRC[>>2 2.]]
作成には[[プッシュサービス資源]]を使います。

[13] 
作成した[[プッシュメッセージ購読]]は、
[[アプリケーション][アプリケーション (プッシュ)]]依存の方法で、
[[アプリケーションサーバー][アプリケーションサーバー (プッシュ)]]へ配布します。
[SRC[>>2 2., 4.]]
特に[[プッシュ資源]]の [[URL]]
の配布は、
秘密の保護や、[[アプリケーションサーバー]]の認証を講じて漏らさないようにしなければ[MUST[なりません]]。
[SRC[>>2 4.]]



[9] 
[[アプリケーションサーバー]]は、
[[プッシュメッセージ購読]]に対し、
[[プッシュ資源]]を使って、
[[利用者エージェント]]に配送する[[プッシュメッセージ]]を、
[[プッシュサービス]]へと送信します。
[SRC[>>2 2., 2.1., 5.]]

[10] 
[[利用者エージェント]]は、
[[プッシュメッセージ購読]]を使って、
到着[[プッシュメッセージ]]がないか[[プッシュサービス]]を[RUBYB[監視][monitor]]します。
[SRC[>>2 2.]]


[11] 
[[プッシュメッセージ購読]]は[[アプリケーション]]に、
1対1で配布して使うことが期待されています。
しかしこれはプロトコル上の制約ではなく、
1つの[[アプリケーション]]が複数の[[プッシュメッセージ購読]]を作ることもできますし、
複数の[[アプリケーション]]が1つの[[プッシュメッセージ購読]]を共有することもできます。
ただ、共有すると[[セキュリティー]]や[[プライバシー]]の問題になりかねないことには要注意です。
[SRC[>>2 2.]]



* 作成

[81] 
[[利用者エージェント]]は、
[DFN[[RUBYB[プッシュ購読の作成][create a push subscription]]]]を、
[CODE[PushSubscriptionOptions]]
[VAR[オプション群]]について、
次のようにしなければ[MUST[なりません]]。
[SRC[>>73]]

[FIG(steps)[
= [83] 
[VAR[プッシュ購読]]を、
新しい[[プッシュ購読]]に設定します。
[FIG(list members)[
: [F[[CODE[options]]]] :
[VAR[オプション群]]の[[複製][辞書の複製]]
]FIG]
= [80] 
[VAR[プッシュ購読]]について、
[CODE[aes128gcm]]
の[[プッシュ購読]]作成時の手順を実行します。
= [86] 
[VAR[プッシュ購読]]と[VAR[オプション群]]の [F[[CODE[applicationServerKey]]]]
について、
[[プッシュサービス資源]]を実行します。
[[非同期的]]に結果を待ちます。
[NOTE[
[111] 仕様書に明記がないですが、
[[fecth]]
なので失敗することがあります。
]NOTE]
= [87] [VAR[プッシュ購読]]を返します。

]FIG]

[110] [CODE[subscribe]] や[[更新][プッシュ購読の更新]]から呼び出されます。

-*-*-

[82] 
[[利用者エージェント]]は、
[[プッシュ購読]][VAR[プッシュ購読]]について、
何らかの理由で[[鍵]]を変更せざるを得ないとき、
次のようにしなければ[MUST[なりません]]。
[SRC[>>73]]

[FIG(steps)[
= [84] [VAR[新プッシュ購読]]を、新しい[[鍵]]を使った[[プッシュ購読]]に設定します。
= [85] [[[CODE[pushsubscriptionchange]]イベントを発火]]します。
[FIG(list members)[
: [VAR[登録]] : [VAR[プッシュ購読]]の[F[サービスワーカー登録]]
: [VAR[旧購読]] : [VAR[プッシュ購読]]
: [VAR[新購読]] : [VAR[新プッシュ購読]]

]FIG]

]FIG]

* プッシュ資源

[7] 
[DFN[[RUBYB[プッシュ資源][push resource]]]]
([[リンク関係型]] [DFN[[CODE[urn:ietf:params:push]]]])
は、
[[アプリケーションサーバー]]が[[プッシュメッセージ購読]]に[[プッシュメッセージ]]を送信するために使います。
[SRC[>>2 2., 2.1.]]
[[利用者エージェント]]と[[アプリケーションサーバー]]とで共有されます。
[SRC[>>2 2.]]
[[プッシュ資源]]は、
[[プッシュメッセージ購読]][[資源]]をちょうど1つ持ちます。
[SRC[>>2 2.1.]]
[[プッシュサービス資源]]により作成されます。
[[プッシュ資源]]の [[URL]]
は、[[プッシュメッセージ購読集合]]で[[プッシュメッセージ購読]]を区別するために使われます。

[76] 
[[プッシュ購読]]は、
[DFN[[F[[RUBYB[[[プッシュエンドポイント]]][push endpoint]]]]]]を持ちます。
[[プッシュサービス]]が晒した[[絶対URL]]であって、
[[アプリケーションサーバー]]が[[プッシュメッセージ]]の送信先とできるものでなければ[MUST[なりません]]。
[[プッシュエンドポイント]]は、
[[プッシュ購読]]を[[固有]]に識別するものでなければ[MUST[なりません]]。
[SRC[>>77]]


[59] [[プライバシー]]のため、
[[プッシュ資源]]の
[[URL]]
は特定[[利用者エージェント]]への通信と関係付けられるものであっては[MUST[なりません]]。
[[利用者]]や[[装置]]に関する情報を含めては[MUST[なりません]]。
複数の[[プッシュ資源]]の [[URL]]
から相互の関係を知れるものであっては[MUST[なりません]]。
同じ[[利用者エージェント]]の[[プッシュ資源]]の [[URL]]
から[[利用者エージェント]]との関係を知れるものであっては[MUST[なりません]]。
[SRC[>>2 8.2.]]
[[非活性化][プッシュ購読の非活性化]]済みの[[プッシュエンドポイント]]を再利用しては[MUST[なりません]]
[SRC[>>105]]。

[14] 
[[アプリケーションサーバー]]は、
[[プッシュメッセージ]]を[[プッシュ資源]]に送信し、
配送を要求します。
[SRC[>>2 5.]]

[15] 
[[アプリケーションサーバー]]は、
[CODE[POST]] [[要求]]を送信します。
[SRC[>>2 5.]]

[20] 
[[プッシュメッセージ]]について[[利用者エージェント]]が受理肯定したとき確認
(配送確認) したいなら、
[[要求]]に
[CODE[[[Prefer:]] [[respond-async]]]]
を指定できます。
[SRC[>>2 5.1.]]

[23] 
以前に[[同じ起源]]に配送確認を[[要求]]して[[受領証購読資源]]の [[URL]]
を受け取っていた場合、
[[要求]]に[[リンク関係型]]
[CODE[urn:ietf:params:push:receipt]]
で[[受領証購読資源]]の [[URL]]
を指定する[SHOULD[べきです]]。
[SRC[>>2 5.1.]]


[25] 
[[アプリケーションサーバー]]は、
[[受領証購読]]の寿命の間、
受領証を集約して受信することができないなら、
[[受領証購読]]を省略して[MAY[構いません]]。
[[アプリケーションサーバー]]が他の[[プッシュメッセージ]]送信者のかわりに[[受領証購読]]を監視するような場合に、
その必要があるかもしれません。
[SRC[>>2 5.1.]]

[28] 
[CODE[TTL:]] [[ヘッダー]]を指定しなければなりません。
[CODE[Urgency:]] [[ヘッダー]],
[CODE(HTTP)@en[Topic:]] [[ヘッダー]]を指定できます。

[64] 
[[プッシュメッセージ購読]]が特定[[アプリケーションサーバー]]に制限されている場合
([[プッシュサービス資源]]を使って作成したときに[[公開鍵]]が指定された場合)、
[[秘密鍵]]で[[署名]]した [[JWT]]
を含めなければ[MUST[なりません]]。
[SRC[>>63]]
[[auth-scheme]] [CODE[vapid]]
の 
[[credentials]] を指定します。


[16] 
[[要求本体]]は、
[[プッシュメッセージ]]の内容とします。
[SRC[>>2 5.]]

-*-*-

[19] 
[[プッシュサービス]]は、
[[プッシュメッセージ]]を受け取ったら[[プッシュメッセージ資源]]を作成します。

[24] 
配送確認 ([CODE[[[Prefer:]] [[respond-async]]]])
が求められた場合、
[[受領証購読資源]]を必要なら作成します。
[[要求]]で指定されている場合は、
可能ならそれを再利用する[SHOULD[べき]]ですが、
無理なら新しいものを作っても[MAY[構いません]]
[SRC[>>2 5.1.]]。
実装依存の制約 (有効期限など) で再利用できないこともありましょう。

[26] 
[[要求]]で指定された[[受領証購読]]が非妥当なら、
[CODE[400]]
[[応答]]を返さなければ[MUST[なりません]]。
[SRC[>>2 5.1.]]
異なる[[アプリケーションサーバー]]用の[[受領証購読資源]]が指定されるのは不適当でしょうし、
[[受領証購読資源]]でないものが指定された場合もそうでしょう。

[27] 
[[受領証購読]]数を制限したい場合、
[[受領証購読]]の指定のない[[要求]]を、
[CODE[429]]
[[応答]]で拒絶して[MAY[構いません]]。
[SRC[>>2 5.1.]]


[29] 
[CODE[TTL:]] [[ヘッダー]]、
[CODE[Urgency:]] [[ヘッダー]]、
[CODE[Topic:]] [[ヘッダー]]を処理しなければなりません。


[50] 
配送のため蓄積する[[プッシュメッセージ]]には、
[[アプリケーションサーバー]]が配送を求めた時刻を表す
[CODE[Last-Modified:]]
[[ヘッダー]]を含める[SHOULD[べきです]]。
[SRC[>>2 7.2.]]
これは[[要求]]を受理した時点での[[現在時刻]]を保存するべきとの趣旨と思われますが、
後に[[プッシュメッセージ]]を配送するときにこの時刻を[[利用者エージェント]]に送付するべきなのかどうかは、
何とも書かれていません。


[51] 
[[プッシュサービス]]は、
[[実体本体]]が大きすぎる場合、
[CODE[413]]
[[応答]]を返して[MAY[構いません]]。
[N[4096]]
[[バイト]][[以下]]なら、
[CODE[413]]
を返しては[MUST[なりません]]。
[SRC[>>2 7.2.]]

;; [52] 実装によって上限が異なると、[[相互運用性]]の問題を生じる危険性があります。
[[プッシュサービス]]は、
[N[4096]] [[バイト]]を超えたら [CODE[413]]
[[応答]]を返すのが非常に好ましいでしょう。


[54] 
[[プッシュサービス]]は、
[[プッシュメッセージ購読]]が[[満期]]の場合、
[CODE[404]]
[[応答]]を返さなければ[MUST[なりません]]
[SRC[>>2 7.3.]]。

[60] [[プッシュサービス]]は、任意の方法で[[認証]]できます。
[SRC[>>2 8.3.]]

[61] 
[[プッシュサービス]]は、 [[DoS攻撃]]対策として、
[[プッシュメッセージ]]を特定[[利用者エージェント]]に配送する速度を制限する[SHOULD[べきです]]。
制限を超えた時[[プッシュサービス]]は
[CODE[429]]
[[応答]]を返すことが[MAY[できます]]。
[CODE[Retry-After:]]
[[ヘッダー]]に待機時間を指定する[SHOULD[べきです]]。
過大な[[プッシュメッセージ]]を受け取った[[プッシュメッセージ購読]]を終端させても構いません。
[SRC[>>2 8.4.]]

[62] 
[[プッシュメッセージ購読]]が特定[[アプリケーションサーバー]]に制限されている場合
([[プッシュサービス資源]]を使って作成したときに[[公開鍵]]が指定された場合)、
妥当な [CODE[vapid]] の [[credentials]]
を含まないなら拒絶しなければ[MUST[なりません]]。
[[認証]]がないとき
[CODE[401]]
[[応答]]を返せますし、
[[認証]]が非妥当なとき
[CODE[403]]
[[応答]]を返せます。
非妥当には次のような場合があります。
[SRC[>>63]]

- [65] [[JWT]] か[[公開鍵]]が含まれない時。
- [66] [[JWT]] の[[署名]]の[[検証]]に成功しない時
- [67] [[現在時刻]]が [[JWT]] の [CODE[exp]] を過ぎている時
- [68] [[現在時刻]]が [[JWT]] の [CODE[exp]] まで24時間を超える時
- [69] [[プッシュ資源]]の[[URLの起源]]が [[JWT]] の [CODE[aud]]
でない時
- [70] [[JWT]] の[[署名]]の[[公開鍵]]が[[プッシュメッセージ購読]]作成時に指定された[[公開鍵]]でない時

[71] その他 [[VAPID]] の処理の要件があります。

[72] [[プッシュサービス]]は、
[[JWT]] や[[公開鍵]]を[[利用者エージェント]]に[[転送]]しては[MUST[なりません]]。
[SRC[>>63]]

-*-*-

[17] 
[[プッシュメッセージ]]を受理した場合、
[CODE[201]]
[[応答]]を返します。
まだこれは[[利用者エージェント]]に[[プッシュメッセージ]]が配送されたことを意味''しません''。
[SRC[>>2 5.]]

[21] 
[[プッシュメッセージ]]を受理した場合で、
配送確認 ([CODE[[[Prefer:]] [[respond-async]]]])
が求められた場合、
[CODE[202]]
[[応答]]を返さなければ[MUST[なりません]]
[SRC[>>2 5.1.]]。

[18] 
[CODE[Location:]]
[[ヘッダー]]に、
作成した[[プッシュメッセージ資源]]の [[URL]]
を記述しなければ[MUST[なりません]]。
[SRC[>>2 5., 5.1.]]

[22] 
配送確認が求められた場合、
[[リンク関係型]]
[CODE[urn:ietf:params:push:receipt]]
で[[受領証購読資源]]の [[URL]]
を記述しなければなりません。
[SRC[>>2 5.1.]]
[CODE[Link:]]
[[ヘッダー]]を使えます。

* プッシュメッセージ購読資源とプッシュメッセージ購読集合資源

[6] 
[DFN[[RUBYB[購読資源][subscription resource]]]]、
[DFN[[RUBYB[プッシュメッセージ購読資源][push message subscription resource]]]]は、
[[プッシュメッセージ購読]]から[[プッシュメッセージ]]を受信したり、
[[プッシュメッセージ購読]]を削除したりするため使います。
[SRC[>>2 2., 2.1.]]
[[利用者エージェント]]にのみ使えるものです。
[SRC[>>2 2.1.]]
[[プッシュメッセージ購読資源]]は、
[[プッシュ資源]]をちょうど1つ持ちます。
[SRC[>>2 2.1.]]



[37] 
[DFN[[RUBYB[プッシュメッセージ購読集合資源][push message subscription set resource]]]]
([[リンク関係型]] [DFN[[CODE[urn:ietf:params:push:set]]]])
は、
[[プッシュメッセージ購読]]の[[集成]]に対する読み取りや削除のアクセスを提供します。
[[利用者エージェント]]は、
[[集合]]中すべての[[プッシュメッセージ購読]]の[[プッシュメッセージ]]を受信できます。
[SRC[>>2 2.1.]]

-*-*-

[48] 
[[利用者エージェント]]は、
[[プッシュメッセージ購読]]と[[プッシュメッセージ購読集合]]の両方がある場合、
[[プッシュメッセージ購読集合]]を使って[[プッシュメッセージ]]を監視する[SHOULD[べきです]]。
[SRC[>>2 6.1.]]

[30] 
[[利用者エージェント]]は、
[[プッシュメッセージ購読資源]]や[[プッシュメッセージ購読集合]]に対し、
[CODE[GET]]
[[要求]]を送信して新しい[[プッシュメッセージ]]の配送を要求します。
[SRC[>>2 6., 6.1.]]


[38] 
[[利用者エージェント]]は、
[[要求]]に
[CODE[Urgency:]] [[ヘッダー]]を指定できます。
[SEE[ [[Urgency:]] ]]

[43] 
[[利用者エージェント]]は、
[CODE[Prefer:]]
[[ヘッダー]]に
[CODE[wait][Prefer: wait]]
を値 [CODE[0]]
で指定 ([CODE[[[Prefer: wait]]=0]]) して、
即座に[[プッシュメッセージ]]を送信するように求めることができます。
[SRC[>>2 6., 6.1.]]


-*-*-

[39] 
[[プッシュサービス]]は
[CODE[Urgency:]] [[ヘッダー]]を処理しなければなりません。
[SEE[ [[Urgency:]] ]]

[53] 
対象の[[プッシュメッセージ購読]]または[[プッシュメッセージ購読集合]]が[[満期]]となった場合、
[CODE[404]]
[[応答]]を返さなければ[MUST[なりません]]。
[SRC[>>2 7.3., 7.3.1.]]

-*-*-

[31] 
[[プッシュサービス]]は、
[[要求]]に対して[[応答]]しません。
[[HTTP/2 server push]]
によって[[プッシュメッセージ]]の内容を送信します。
[SRC[>>2 6., 6.1.]]

[40] 
[[プッシュサービス]]は、[[プッシュメッセージ]]ごとに、
[CODE[PUSH_PROMISE]]
で
[CODE[GET]] [[要求]]を[[利用者エージェント]]に送信します。
この [CODE[GET]]
[[要求]]は、
[[プッシュメッセージ資源]]を取得するものです。
[SRC[>>2 6., 6.1.]]

[41] 
それに対する[[応答]]は、
[[HTTPヘッダー]]で、
[[プッシュメッセージ購読]]に対応する[[プッシュ資源]]の [[URL]] を、
[[リンク関係型]]
[CODE[urn:ietf:params:push]]
で示す[SHOULD[べきです]]。
[SRC[>>2 6.]]
[[プッシュメッセージ購読集合]]では、
示さなければ[MUST[なりません]]。 [SRC[>>2 6.1.]]
[CODE[Link:]]
[[ヘッダー]]に指定できます。
これを使って[[プッシュメッセージ購読]]を区別できます。

[42] その[[応答本体]]には、
[[アプリケーションサーバー]]が[[プッシュ資源]]に送信した直近の[[要求]]の[[実体本体]]を指定します。
[SRC[>>2 6., 6.1.]]
(と規定されていますが、直近のというのは意味がよくわかりません。
当該[[プッシュメッセージ]]を送るべきでしょう。)

[44] 
[[プッシュサービス]]は、
[[要求]]の
[CODE[Prefer:]]
[[ヘッダー]]で
[CODE[wait][Prefer: wait]]
が
[CODE[0]]
に設定されていた場合、
未配送の[[プッシュメッセージ]]をすべて
[[server  push]]
しなければ[MUST[なりません]]。
[SRC[>>2 6., 6.1.]]

[45] 
[[プッシュサービス]]は、
[CODE[204]]
[[応答]]を送信し、
[[server push]]
を送信しないことで、
[[プッシュメッセージ]]の不存在を示すことができます。
[SRC[>>2 6., 6.1.]]

[46] このような規定の理由は名言されていませんが、
[CODE[wait=0][Prefer: wait]]
が指定されていない限り、
[[プッシュサービス]]は[[プッシュメッセージ]]送信のタイミングを調整してよいということと思われます。

[47] 
特に明言されていないので、
[CODE[204]]
[[応答]]を返しても、そのまま[[ストリーム]]を残し
([CODE[END_STREAM]] を送信せず)
随時 [[server push]]
してもよいとみられます。

[49] 
仕様書では明文規定がありませんが、
例示によると、
[[プッシュサービス]]は適当なタイミングで最後に
[CODE[200]]
[[応答]]を送り[[ストリーム]]を閉じてよいようです。
[SRC[>>2 6., 6.1.]]

[58] 並行送信数を[[利用者エージェント]]は
[CODE[SETTINGS_MAX_CONCURRENT_STREAMS]] 
で指定することが[MAY[でき]]、
[[プッシュサービス]]はこれに従い抑制[MAY[できます]]。
[SRC[>>2 7.5.]]

-*-*-

[55] 
[[利用者エージェント]]は、
[[プッシュメッセージ購読資源]]に
[CODE[DELETE]]
[[要求]]を送信して、
削除を要求できます
[SRC[>>2 7.3.]]。
その場合所属する[[プッシュメッセージ購読集合]]からも削除されます。
同様に[[プッシュメッセージ購読集合資源]]に
[CODE[DELETE]]
[[要求]]を送信して、
削除を要求できます 
[SRC[>>2 7.3.1.]]。
その場合所属するすべての[[プッシュメッセージ購読]]が同時に削除されます。

* 削除

[89] 
[[プッシュ購読]]や[[プッシュメッセージ購読集合]]は、
無効化されることがあります。
[[満期]] ([RUBYB[寿命][lifetime]]到来) による場合、
[[利用者エージェント]]の指示による場合 (>>55)、
その他[[プッシュサービス]]の事情による場合があり得ます。
[SRC[>>2 2., 7.3., 7.3.1.]]

[56] 
[[プッシュメッセージ購読]]が[[満期]]になったり削除されたりした場合、
[[プッシュメッセージ購読集合]]からも削除しなければ[MUST[なりません]]。
[SRC[>>2 7.3.1.]]

[57] 
[[プッシュメッセージ購読集合]]が[[満期]]になったり削除されたりした場合、
所属する[[プッシュメッセージ購読]]もすべて[[満期]]・削除しなければなりません。
[SRC[>>2 7.3.1.]]


[12] 
[[利用者エージェント]]や[[アプリケーションサーバー]]は、
これに対応する準備が必要です。
[SRC[>>2 2., 7.3.]]

[88] 
[[プッシュ購読]]は、
[DFN[[F[[RUBYB[購読満期時刻][subscription expiration time]]]]]]
を持つことが[MAY[できます]]。
その場合、
[[ミリ秒Unix time]]であって、
[[プッシュ購読]]が[[非活性化][プッシュ購読の非活性化]]される[[時刻]]を表すものでなければ[MUST[なりません]]。
[SRC[>>78]]

-*-*-

[91] [[利用者エージェント]]や[[プッシュサービス]]は、
いつでも、例えば一定時間経過後、
[[プッシュ購読]]を[DFN[[RUBYB[更新][refresh]]][プッシュ購読を更新]]することが[MAY[できます]]。
[SRC[>>90]]

[99] 
[[利用者エージェント]]は、
[[プッシュ購読を更新]]できない場合、
定期的にこれを再試行する[SHOULD[べきです]]。
[SRC[>>90]]

[79] 
[[利用者エージェント]]は、
[[プッシュ購読]]の[F[購読満期時刻]]の到来前に、
[[プッシュ購読の更新]]を試みる[SHOULD[べきです]]。
[SRC[>>78]]

[92] 
[[利用者エージェント]]は、[VAR[旧プッシュ購読]]の[[更新][プッシュ購読を更新]]時、
次のようにしなければ[MUST[なりません]]。
[SRC[>>90]]

[FIG(steps)[
= [93] 
[VAR[プッシュ購読]]を、
[VAR[旧プッシュ購読]]の [F[[CODE[options]]]]
について、
[[新しいプッシュ購読を作成]]した結果に設定します。
[[非同期的]]に待ちます。
[NOTE[
[94] [VAR[旧プッシュ購読]]と[VAR[プッシュ購読]]は、
別の[F[鍵ペア]]でなければ[MUST[なりません]]。
]NOTE]
= [95] [[[CODE[pushsubscriptionchange]]イベントを発火]]します。
[FIG(list members)[
: [VAR[登録]] : [VAR[プッシュ購読]]の[F[サービスワーカー登録]]
: [VAR[旧購読]] : [VAR[旧プッシュ購読]]
: [VAR[新購読]] : [VAR[プッシュ購読]]

]FIG]
= [96] 
[[利用者エージェント]]依存の時間、
最大で[VAR[プッシュ購読]]が[[プッシュメッセージ]]を受け取るまで、
待ちます。
[NOTE[
[97] 
[[アプリケーションサーバー]]の移行を待つべく、
しばらく[VAR[旧プッシュ購読]]を受け付け続けて[MAY[構いません]]。
]NOTE]
= [98] 
[VAR[旧プッシュ購読]]を[[非活性化][プッシュ購読を非活性化]]します。


]FIG]

-*-*-

[100] 
[[利用者エージェント]]は、
[[満期]]その他の理由で[[プッシュ購読]][VAR[プッシュ購読]]が最早利用できないとき、
次のようにしなければ[MUST[なりません]]。
[SRC[>>90]]

[FIG(steps)[
= [101] [[[CODE[pushsubscriptionchange]]イベントを発火]]します。
[FIG(list members)[
: [VAR[登録]] : [VAR[プッシュ購読]]の[F[サービスワーカー登録]]
: [VAR[旧購読]] : [VAR[プッシュ購読]]
: [VAR[新購読]] : [CODE[null]]

]FIG]

]FIG]

-*-*-

[106] 
[[利用者]]は [[permission]] を[[失効]]できます。
[SEE[ [CODE[subscribe]] ]]
[[利用者エージェント]]は、
[[失効]]時、
当該 [[permission]]
により作られた[[プッシュ購読]][VAR[プッシュ購読]]を次のようにしなければ[MUST[なりません]]。
[SRC[>>105]]

[FIG(steps)[
= [108] [[並列に]]、
== [109] [VAR[プッシュ購読]]を[[非活性化][プッシュ購読の非活性化]]します。
= [107] [[[CODE[pushsubscriptionchange]]イベントを発火]]して[MAY[構いません]]。
[FIG(list members)[
: [VAR[登録]] : [VAR[プッシュ購読]]の[F[サービスワーカー登録]]
: [VAR[旧購読]] : [VAR[プッシュ購読]]
: [VAR[新購読]] : [CODE[null]]

]FIG]

]FIG]

-*-*-


[102] 
[[利用者エージェント]]や[[プッシュサービス]]は、
[[プッシュ購読]]が[DFN[[RUBYB[非活性化][deactivated]]][プッシュ購読の非活性化]]されたとき、
その詳細情報を削除しなければ[MUST[なりません]]。
それ以後当該[[プッシュ購読]]に対する[[プッシュメッセージ]]を配送しては[MUST[なりません]]。
[SRC[>>103]]

[104] 
[[サービスワーカー登録]]が[[登録解除]]されたとき、
[[プッシュ購読]]は[[非活性化][プッシュ購読の非活性化]]しなければ[MUST[なりません]]
[SRC[>>105]]。
それより早く[[非活性化][プッシュ購読の非活性化]]しても[MAY[構いません]]。
[SRC[>>103]]


* 歴史

[1] [CITE@en[Define exposure of the Push API interfaces]]
([[beverloo]]著, [TIME[2017-05-04 01:32:20 +09:00]])
<https://github.com/w3c/push-api/commit/350ee328178b1635f141412831892b16cb711305>