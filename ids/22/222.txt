[2] [DFN[[RUBYB[[[要素を文書に挿入]]]@en[insert an element into a document]]]]するとは、
[[要素]]を[[文書]]の[[子孫]]とすることをいいます。

* 仕様書

[REFS[
- [1] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-07-20 22:41:10 +09:00]] 版) <https://www.whatwg.org/specs/web-apps/current-work/#insert-an-element-into-a-document>'''
- [14] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-04-09 09:15:24 +09:00]] 版) <https://html.spec.whatwg.org/#parser-inserted>
- [18] [CITE@en-US[Fetch Standard]] ([TIME[2016-04-15 18:13:01 +09:00]] 版) <https://fetch.spec.whatwg.org/#concept-request-parser-metadata>
- [24] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-04-16 15:05:57 +09:00]] 版) <https://html.spec.whatwg.org/#concept-module-script-parser>
]REFS]

* 意味

[13] [[要素]]の[F[根]]が変化して[[文書]]となった時、
[DFN[[RUBYB[[[文書に挿入]]]@en[inserted into a document]]]]されたといいます [SRC[>>1]]。

[HISTORY[
[3] [[要素]]の[[根要素]]が変更され、[[文書]]の[[根要素]]となったとき、
[DFN[[RUBYB[[[文書に挿入]]]@en[inserted into a document]]]]されたといいます [SRC[>>1]]。

;; [4] この定義によれば、[[根要素]]が[[文書]]に挿入されて[[文書]]の[[根要素]]となった時には、
[[根要素]]自身は変化していませんから、[[文書に挿入]]はされていないこととなります。
(意図通りなのかは不明です。) 他の定義との整合性を考えると、
このケースも該当すると考えるべきかもしれません。
]HISTORY]

* 文書への挿入の処理

[7] [[文書への挿入]]のタイミングで行われる[[要素]]ごとの処理も存在しています。

[FIG(list middle)[
- [CODE(HTMLe)@en[[[meta]]]]
-- [CODE(HTML)@en[[[http-equiv]]=[[content-language]]]] [SRC[[[HTML Standard]]]]
-- [CODE(HTML)@en[[[http-equiv]]=[[default-style]]]] [SRC[[[HTML Standard]]]]
-- [CODE(HTML)@en[[[http-equiv]]=[[refresh]]]] [SRC[[[HTML Standard]]]]
-- [CODE(HTML)@en[[[http-equiv]]=[[set-cookie]]]] [SRC[[[HTML Standard]]]]
-- [CODE(HTML)@en[[[name]]=[[theme-color]]]] [SRC[[[meta-theme-color]]]]
- [CODE(HTMLe)@en[[[style]]]] ※ [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[link]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[img]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[iframe]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[frame]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[object]]]] ※ [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[param]]]]
- [[フォーム被関連付け要素]] ※ [SRC[[[HTML Standard]]]]
- [[ID]] のある[[要素]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLa)@en[[[autofocus]]]] のある[[要素]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[script]]]] ※ [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[embed]]]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[applet]]]] ※ [SRC[[[HTML Standard]]]]
]FIG]

;; [8] [CODE(HTMLe)@en[[[embed]]]] と [CODE(HTMLe)@en[[[applet]]]]
と [CODE(HTMLe)@en[[[frame]]]]
については仕様上 [[in a [CODE(DOMi)@en[Document]]]] を使って半ば宣言的に規定されていますが、
実質的に「[[要素の文書からの挿入]]」の処理に該当します。

[9] 「※」のあるものは、[[構文解析器]]による挿入か否かで動作が異なります。

;; [10] [[レンダリング]]の更新は、また別のタイミングで行われます。
[CODE(HTMLe)@en[[[title]]]] [[要素]]など[[画布]]外の[[UI]]に関する更新は特に規定がありませんが、
[[レンダリング]]と同タイミングが好ましいでしょうか。 ([[相互運用性]]に直接影響しないためか規定がありません。)

[11] [[Webブラウザー]]によっては、[[文書要素]]の[[文書への挿入]]のタイミングで[[内容スクリプト]]が実行されるかもしれません。

* 構文解析による挿入

[15] [CODE(HTMLe)@en[script]] [[要素]]は、
[F[[DFN[[RUBYB[[[「構文解析器挿入」]]]@en["parser inserted"]]]]フラグ]]を持ちます [SRC[>>14]]。
[[構文解析器]]が挿入した [CODE(HTMLe)@en[[[script]]]] [[要素]]に設定されます。
初期状態では未設定です [SRC[>>14]]。

;; [20] これは [CODE(HTMLe)@en[script]] [[要素]]の動作に深く関与します。
[CODE(HTMLe)@en[script]] 参照。

[23] [[モジュールスクリプト]]の[DFN[[F[[RUBYB[[[構文解析器状態]]]@en[parser state]]]]]]を持ちます
[SRC[>>24]]。
[[モジュールスクリプトのfetch]]の際に[F[構文解析器メタデータ]]として使う値を保持するものです。

[17] [[要求]]は、[DFN[[F[[RUBYB[[[構文解析器メタデータ]]]@en[parser metadata]]]]]]を持ちます。
値は[[空文字列]]、 [DFN[[CODE[parser-inserted]]]]、
[DFN[[CODE[not-parser-inserted]]]] のいずれかです。
初期状態では[[空文字列]]です。 [SRC[>>18]]

;; [21] これは [[CSP]] の指定 [CODE[unsafe-dynamic]] の挙動に影響します。

* 関連

[5] [[文書]]が属する[[木]]以外の場合や、[[要素]]以外の場合も含まれる
「[[節点の挿入]]」という[[フック]]も存在します。

[6] 逆に[[要素が文書から削除]]される場合に発生する処理もあり、
挿入時と共通しているものも多くあります。

* 歴史

[12] [CITE@en[Editorial: synchronize with the DOM Standard · whatwg/html@21c6ec7]] ([TIME[2016-03-20 17:40:31 +09:00]] 版) <https://github.com/whatwg/html/commit/21c6ec77594eb89b836d4872222f5916910967fd>

[16] [CITE@en[Add 'parser metadata' to requests · whatwg/fetch@bc399d5]] ([TIME[2016-04-15 23:11:56 +09:00]] 版) <https://github.com/whatwg/fetch/commit/bc399d58e4dacc625857bd37671e6c1a7844e3ec>

[19] [CITE@en[Use the 'parser metadata' concept from Fetch · w3c/webappsec-csp@4793499]]
([TIME[2016-04-15 23:16:40 +09:00]] 版)
<https://github.com/w3c/webappsec-csp/commit/479349944cc90e1584dcade60e80d17ea1e6b56b>

[22] [CITE@en[Pass parser metadata to Fetch · whatwg/html@e6500b9]]
([TIME[2016-04-16 22:23:08 +09:00]] 版)
<https://github.com/whatwg/html/commit/e6500b90244376c023e7b78642dbc7b86829233f>