* 仕様書

[REFS[
- [1] [CITE@en-US[DOM Standard]] ([TIME[2014-08-19 13:36:28 +09:00]] 版) <http://dom.spec.whatwg.org/#concept-node-insert-ext>
]REFS]

* 構文解析器による挿入

[8] [[構文解析器]]によって[[挿入]]される[[節点]]は、すべて[[構文解析器]]によって新たに作られたものです。
[[挿入]]の時点ではまだ一度も[[スクリプト]]からアクセスされたことがないものですし、
[[子孫]]も存在しません。[[属性]]は、[[挿入]]と同時に設定されることがありますが、
それ以外の方法で追加されたものは存在しません。

;; [11] ただし [[AAA]] で既存の[[節点]]を[[親]]から別の[[要素]]に移動することはあります。
移動対象となる[[節点]]は[[スクリプト]]によって編集されているかもしれませんし、
元々[[スクリプト]]が作ったものである可能性もあります。

[9] [[里親付け]]が発生する場合と、[[根要素]]外を[[構文解析器]]中の場合を除き、
すべての[[節点]]の[[挿入]]・[[append]] 先は[[要素]]です。

[10] [[里親付け]]の場合、挿入先となるはずだった[[節点]]が [CODE(HTMLe)@en[[[table]]]]
[[要素]]などだった時、その[[兄]]として挿入されるので、その[[親]]が
[CODE(DOMi)@en[[[Document]]]] や [CODE(DOMi)@en[[[DocumentFragment]]]] のこともあります。

;; [CODE(DOMi)@en[[[Document]]]] の場合、2つ目の[[根要素]]または
[CODE(DOMi)@en[[[Document]]]] 直下の[[テキスト]]となるので、
[[挿入]]は失敗して捨てられます。 ([[注釈]]は[[里親付け]]の対象となりません。)

* 挿入手順

[2] [[節点]]が別の[[節点]]の[[子供]]として[[挿入]]されると、
[DFN[[RUBYB[[[挿入手順]]]@en[insertion steps]]]] [SRC[>>1]] が呼び出されます。
[[挿入]]された[[節点]]自体のみならず、その[[子孫]]についても[[木順]]に呼び出されます。

;; [3] [[DOM Standard]] 上の[[アルゴリズム]]である [[pre-insert]]、[[replace]]、
[[replace all]] によって呼び出されます。

[4] この[[フック]]によって次の[[節点]]が何らかの処理を行います。

[FIG(list middle)[
- [CODE(HTMLe)@en[[[option]]]] [SRC[[[HTML Standard]]]]
- ([CODE(HTMLe)@en[[[script]]]] に対して) [[子供]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[source]]]] ([[媒体要素]]) ※ [SRC[[[HTML Standard]]]]
- [[媒体要素]] ※ [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[img]]]] ([CODE(HTMLe)@en[[[picture]]]]) [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[source]]]] ([CODE(HTMLe)@en[[[picture]]]]) [SRC[[[HTML Standard]]]]
]FIG]

[5] 仕様上明確には規定されていませんが、次の動作もこの[[フック]]のタイミングで処理されると思われます。

[FIG(list middle)[
- [[要素の文書への挿入]] ※ [SRC[[[HTML Standard]]]]
- [[画像写像]] [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[style]]]] の[[子孫]] ※ [SRC[[[HTML Standard]]]]
- [CODE(HTMLe)@en[[[track]]]] ※ [SRC[[[HTML Standard]]]]
- [CODE(XML)@en[[[<?xml-stylesheet?>]]]] [SRC[[[CSSOM]]]]
- [[フォーム被関連付け要素]] ※ [SRC[[[HTML Standard]]]]
- [[文書基底URL]]・[[凍結基底URL]]の更新 [SRC[[[HTML Standard]]]]
]FIG]

;; [6] 「※」は[[構文解析器]]による挿入かどうかで動作が異なることがあります。

;; [19] 多くは[[要素]]の[[挿入]]に関する処理ですが、
それ以外の種類の[[節点]]の場合もあります。

[7] なお、[[pre-insert]], [[replace]], [[replace all]] 操作は[[挿入]]に先立って [[adopt]]
を行いますので、その中で[[節点]]の種類によっては [[adopting steps]] も実行されます。

* 歴史

[14] [[挿入手順]]は、 >>12 までは[DFN[[RUBYB[[[節点の挿入]]]@en[node is inserted]]]]と呼ばれていました。

[16] [[HTML Standard]] は現在でも「nodes are inserted」という用語を使っていますが、
[[DOM Standard]] の「insertion steps」を参照するようになっています [SRC[>>15, >>17]]。

[REFS[
- [12] [CITE@en[Fix the low-level remove/insert hooks and rewrite NodeIterator in terms ... · 4937f1a · whatwg/dom]] ([TIME[2014-08-21 15:10:21 +09:00]] 版) <https://github.com/whatwg/dom/commit/4937f1a5e39c0914ad2f0a3a35558cf1678e8b89>
- [13] [CITE@en[Bug 24653 – Planning on changing mutation hooks]] ([TIME[2014-08-21 15:10:10 +09:00]] 版) <https://www.w3.org/Bugs/Public/show_bug.cgi?id=24653#c3>
- [15] [CITE@en[Web Applications 1.0 r8769 Integrate with DOM for 'removing steps' and 'insertion steps'.]] ([TIME[2014-09-13 03:23:00 +09:00]] 版) <http://html5.org/r/8769>
- [17] [CITE@en[Sync with r8769 (Integrate with DOM for 'removing steps' and 'insertion ... · 4a62050 · ResponsiveImagesCG/picture-element]] ([TIME[2014-09-15 08:59:45 +09:00]] 版) <https://github.com/ResponsiveImagesCG/picture-element/commit/4a620502e75e2839842fa737a3bc25894836e895>
]REFS]

[18] [CITE@en[Need to grab children of a DocumentFragment before an insert. Fixes h… · whatwg/dom@1b9e2f9]]
([TIME[2015-05-11 13:27:23 +09:00]] 版)
<https://github.com/whatwg/dom/commit/1b9e2f9765884460410d1396dbba99951eafe838>