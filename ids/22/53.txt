
* 仕様書

[REFS[
- [6] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-06-07 01:59:35 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-3>
- [73] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-4.3>
- [82] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-5.5>
- [84] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-6.5.2>
- [90] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-7>
- [92] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-8.1.2>
- [101] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-10.3>
- [104] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-10.5>
- [111] [CITE@en[RFC 7540 - Hypertext Transfer Protocol Version 2 (HTTP/2)]] ([TIME[2015-05-15 10:14:54 +09:00]] 版) <https://tools.ietf.org/html/rfc7540#section-10.6>
- [4] [CITE@en[RFC 7541 - HPACK: Header Compression for HTTP/2]] ([TIME[2015-05-15 10:13:02 +09:00]] 版) <https://tools.ietf.org/html/rfc7541#section-1.3>
- [3] [CITE@en-US[Fetch Standard]] ([TIME[2015-05-07 18:42:14 +09:00]] 版) <https://fetch.spec.whatwg.org/#concept-header-list>
]REFS]

* ヘッダー部

[7] [[HTTPメッセージ]]のうち0個以上の[[頭欄]]の部分のことを、
[DFN[[RUBYB[頭部]@en[header section]]]]や[DFN[[RUBYB[ヘッダー群]@en[headers]]]]といいます [SRC[>>6]]。

[8] >>7 の定義によると[[開始行]]は[[頭部]]には含まれていません。
[[トレーラー部]]も[[ヘッダー部]]の一部では無さそうです。

[9] [[頭部]]のそれぞれの項目のことを仕様上は[[頭欄]]、一般的には[[ヘッダー]]と呼んでいます。
[[頭部]]のことを[[ヘッダー群]]と言うのはこの[[ヘッダー]]という呼称に由来します。
[[HTTP]] に影響を与えた [[RFC 822]] の本来の用語では、
[[頭部]]全体のことを[RUBYB[[[ヘッダー]]]@en[header]]と呼んでいました。

* ヘッダーリスト

[5] [[Fetch]] [SRC[>>3]] と [[HTTP/2]] [SRC[>>73]] や [[HPACK]] [SRC[>>4]] は、
0個以上の[[ヘッダー]]の順序付きのリストを[DFN[[RUBYB[ヘッダーリスト]@en[header list]]]]と呼んでいます。

[10] [[HTTP/2]] や [[HPACK]] では、[[トレーラー部]]も (独立した) [[ヘッダーリスト]]です。

* HTTP/2 ヘッダー

[99] [[HTTP/1.1]] と共通の通常の [[HTTPヘッダー]]の他に、
[[HTTP/1.1]] の[[開始行]]に相当する[[疑似ヘッダー]]があります。
[[疑似ヘッダー]]は、通常の[[ヘッダー]]より前になければなりません [SRC[>>92]]。
また[[疑似ヘッダー]]は[[trailer]]では使えません [SRC[>>92]]。

;; [[疑似ヘッダー]]を参照。

[75] [[ヘッダーリスト]]は、 [[HTTPヘッダー圧縮]]により[DFN[[RUBYB[[[ヘッダーブロック]]]@en[header block]]]]として[[直列化]]されます [SRC[>>3]]。

[76] [[直列化]]された[[ヘッダーブロック]]は、1つ[[以上]]の[DFN[[RUBYB[[[ヘッダーブロック素片]]]@en[header block fragment]]]]に分割されて
[CODE[[[HEADERS]]]], [CODE[[[PUSH_PROMISE]]]], [CODE[[[CONTINUATION]]]]
の[[フレーム]]の [[payload]] で転送されます [SRC[>>3]]。

[77] [[ヘッダー]]を表す[[フレーム]]群は、 [CODE[[[HEADERS]]]] または
[CODE[[[PUSH_PROMISE]]]] で始まり、0個[[以上]]の [CODE[[[CONTINUATION]]]]
が続きます。最後の[[フレーム]]は [CODE[[[END_HEADERS]]]] [[フラグ]]が設定され、
それ以外の[[フレーム]]は設定されません。 [SRC[>>3]]

[80] [[ヘッダーブロック]]は連続した[[フレーム]]として転送しなければ[['''なりません''']]。
他の[[フレーム]]を挟んではなりません。 [SRC[>>3]]

[83] 未知の[[フレーム型]]の[[フレーム]]も挟めません [SRC[>>82]]。
[[接続エラー]] [CODE[[[PROTOCOL_ERROR]]]] としなければ[['''なりません''']] [SRC[>>82]]。

[FIG(railroad)[
= |
== [CODE[[[HEADERS]]]] ([CODE[[[END_HEADERS]]]])
== [CODE[[[PUSH_PROMISE]]]] ([CODE[[[END_HEADERS]]]])
== =
=== |
==== [CODE[[[HEADERS]]]] (¬[CODE[[[END_HEADERS]]]])
==== [CODE[[[PUSH_PROMISE]]]] (¬[CODE[[[END_HEADERS]]]])
=== *
==== [CODE[[[CONTINUATION]]]] (¬[CODE[[[END_HEADERS]]]])
=== [CODE[[[CONTINUATION]]]] ([CODE[[[END_HEADERS]]]])
]FIG]

[78] [[ヘッダー圧縮]]は状態を持ちます。[[接続]]毎に、
[[接続]]全体の[[圧縮文脈]]と[[展開文脈]]を1つずつ持ちます。 [SRC[>>3]]

[112] 機密データと攻撃者が制御できるデータを (同じ圧縮辞書で)
一緒に[[圧縮]]しては[['''なりません''']]。データの出所が不明なら、
[[圧縮]]しては[['''なりません''']]。 [SRC[>>111]]

[79] [[ヘッダーブロック]]の[[復号エラー]]は、[[接続エラー]]
[DFN[[CODE[[[COMPRESSION_ERROR]]]]]] としなければ[['''なりません''']] [SRC[>>3]]。

[81] [[受信者]]は、[[フレーム]]群が捨てられる場合であっても、
その[[フレーム]]群から[[ヘッダーブロック]]を結合し展開する必要があります。
[[受信者]]が持つ[[圧縮文脈]]を変更する可能性があります。 [SRC[>>3]]
[[展開]]しない場合は、[[接続エラー]]
[CODE[[[COMPRESSION_ERROR]]]] としなければ[['''なりません''']] [SRC[>>3]]。

[91] [[誤り符号]] [DFN[[CODE[[[COMPRESSION_ERROR]]]]]] ([CODE[[[0x9]]]])
は、[[接続]]の[[ヘッダー圧縮文脈]]を維持できないことを示します [SRC[>>90]]。

[85] [[設定]] [DFN[[CODE[[[SETTINGS_HEADER_TABLE_SIZE]]]]]] ([CODE[[[0x1]]]])
は、[[header block]] の[[復号]]に使う[[ヘッダー圧縮表]]の最大長を[[バイト]]単位で通知するものです。
[[符号化器]]は、[[header block]] 内の[[ヘッダー圧縮形式]]に依存した方法により、
この値[[以下]]の大きさを選ぶことができます。 [SRC[>>84]]

[87] 初期値は、 4096 [[バイト]]です。 [SRC[>>84]]

[86] [[設定]] [DFN[[CODE[[[SETTINGS_MAX_HEADER_LIST_SIZE]]]]]] ([CODE[[[0x6]]]]) は、
[[送信者]]が受け付ける準備のできている [[header list]] の最大長を知らせる[[ヒント]]です。
この値は、圧縮前の状態で、[[header field]] ごとに名前と値の長さとオーバーヘッドとして 32
を足した合計値を[[バイト]]単位にしたものです。 [SRC[>>84]]

[89] 各[[要求]]で、この値よりも小さな制限を課しても構いません [SRC[>>84]]。

[88] 初期値は、無制限です [SRC[>>84]]。

[95] [[ヘッダー名]]は[[小文字]]に変換してから記述しなければ[['''なりません''']] [SRC[>>92]]。

[96] 構文上認められない[[ヘッダー名]] [SRC[>>101]] や[[大文字]]の[[ヘッダー名]] [SRC[>>92]]
を含む[[メッセージ]]は、[[奇形]]です。

[102] 構文上認められない[[ヘッダー]]の値を含む[[メッセージ]]は、[[奇形]]です [SRC[>>101]]。
具体的には [CODE[0x00]]-[CODE[0x08]], [CODE[0x0D]], [CODE[0x0C]], 
[CODE[0x0E]]-[CODE[0x1F]], [CODE[0x7F]] が含まれる場合や、
先頭や末尾に [CODE[0x20]], [CODE[0x09]], [CODE[0x0A]], [CODE[0x0D]] がある場合、
[CODE[0x0D]] [CODE[0x0A]] の後に [CODE[0x09]] または [CODE[0x0A]]
という形以外で [CODE[0x0D]], [CODE[0x0A]] が含まれる場合が該当するとみられます。
[CODE[0x80]]-[CODE[0xFF]] は該当しません。

[103] [[ヘッダー圧縮]]は、無駄な処理をさせるために濫用できます。
[[エンドポイント]]は利用状況を監視して制限する[['''べきです''']]。
[[接続エラー]] [CODE[[[ENHANCE_YOUR_CALM]]]] としても構いません。 [SRC[>>104]]

[105] [[header block]] が大きいと、大量のデータを保持する必要が生じ、
不都合が生じるかもしれません。 [[header block]] の大きさに厳密な上限は設けていませんが、
[[設定]] [CODE[[[SETTINGS_MAX_HEADER_LIST_SIZE]]]]
によって [[header block]] の大きさの制限を [[peer]] に[[ヒント]]として伝えられます。
[[peer]] はそれより大きな [[header block]] を送っても構いませんが、
[[奇形]]とみなされるリスクが有ります。 [SRC[>>104]]

[106] [[設定]] [CODE[[[SETTINGS_MAX_HEADER_LIST_SIZE]]]]
は[[接続]]に対するもので、[[中間器]]を介した別の[[ホップ]]はより厳しい制限を持つかもしれません。
[[中間器]]は[[設定]]を[[転送]]することで問題を避けられますが、
そうする義務はありません。 [SRC[>>104]]

[107] [[サーバー]]は、 [[header block]] が大きすぎて処理したくないときは
[CODE(HTTP)[[[431]]]] [[応答]]を送ることができます。 [SRC[>>104]]

[108] [[クライアント]]は、 [[header block]] が大きすぎて処理したくないときは捨てることができます。
[SRC[>>104]]

[109] いずれにせよ、 [[header block]] は、接続の状態の一貫性を保つため、
[[接続]]を閉じる場合以外は処理しなければ[['''なりません''']] [SRC[>>104]]。

;; [110] ということは本当に大きすぎて無視したい時は[[接続エラー]]にしなければならないのでしょう。

* 歴史

[1] [CITE[Add sketch for headers · 50b8147 · whatwg/fetch]]
( ([TIME[2014-05-31 02:34:28 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/50b8147869f3d8d9fc2e29e09445176ac07391a6>

[2] [CITE[Define Headers object · 37526e4 · whatwg/fetch]]
( ([TIME[2014-06-12 03:55:34 +09:00]] 版))
<https://github.com/whatwg/fetch/commit/37526e41d1da81e8b19a9d089ff16727eeda9dc8>