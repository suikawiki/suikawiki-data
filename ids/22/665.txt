[2] [[キャッシュ]]に[[蓄積]]されるデータの単位を[DFN[[RUBYB[[[キャッシュ項目]]]@en[cache entry]]]]といいます。

* 仕様書

[REFS[
- [1] '''[CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-2>'''
- [93] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2>
-- [101] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.2.1>
-- [104] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.2.7>
- [23] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-4>
-- [36] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-4.2.4>
- [54] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.1.1>
- [46] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.1>
- [43] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.2>
- [49] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.3>
]REFS]

* 構成

[3] [[キャッシュ項目]]は、[RUBYB[キャッシュキー]@en[cache key]]と、
1つ以上の [[HTTP応答]]との組です [SRC[>>1]]。この[[応答]]のことを[RUBYB[[[蓄積]]された[[応答]]]@en[stored response]]といいます。

;; [9] [[蓄積された応答]]には[[腐敗]]したものと[[新鮮]]なものがあり、また[[満期時刻]]や[[齢]]のような特性もあります。

[6] [[キャッシュ項目]]には、[[完全]]なものと[[不完全]]なものがあります。

;; [7] [[不完全]]かどうかは[[メッセージ]]の性質なので、正確には[[キャッシュ項目]]ではなく[[キャッシュ項目]]に含まれる[[応答]]それぞれの性質だと思うのですが、
仕様上[[キャッシュ項目]]の性質となっています。

[4] キャッシュキーは[[要求メソッド]]と[[対象URL]]です。
しかし一般的な[[HTTPキャッシュ]]は [CODE(HTTP)@en[[[GET]]]] に対する[[応答]]しか[[キャッシュ]]しないので、
その場合は[[対象URL]]だけをキャッシュキーとすることができます。 [SRC[>>1]]

[5] [[対象資源]]で[[内容折衝]]が使われている場合には、
複数の[[HTTP応答]]が蓄積されることになります。 [SRC[>>1]]

* 処理モデル

[8] [[キャッシュ可能性]]、[[検証]]、[[条件付き要求]]、[[部分要求]]も参照。

[10] [[キャッシュ]]からの[[応答]]の決定は、次のように行います。

[FIG(steps)[
= [12] エラーその他の[[応答]]を返す場合や、[[キャッシュ]]を使わない[[要求メソッド]]の場合などは、そちらの方法で処理し、ここで終わります。
= [24] [[キャッシュ項目]]として[[蓄積された応答]]から、
次のような[[キャッシュ再利用]]可能な[[応答]]を探します [SRC[>>23]]。
=- [25] [[実効要求URL]]が一致する
=- [26] [[蓄積された応答]]の[[要求メソッド]]が現在の[[要求]]に再利用して構わないこと
=- [27] [CODE(HTTP)@en[[[Vary:]]]] [[ヘッダー]]の条件が一致すること
([CODE(HTTP)@en[[[Vary:]]]] 参照)
= [28] 複数の候補が見つかった時は、次のいずれかとします [SRC[>>23]]。
=- [29] [CODE(HTTP)@en[[[Date:]]]] が最新のものを選びます。
=- [30] 候補がなかったこととし、かわりに次のようにします。
=-= [31] 転送要求を[[要求]]の複製とします。
=-= [32] 転送要求に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]=0]]
または [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] を追加します。
= [68] 候補がなかった場合、
== [96] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[only-if-cached]]]]
があれば、 [CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>93]]。
== [95] 転送要求を[[要求]]の複製とします。
= [13] 候補があった場合で、[[時計]]がある場合 [SRC[>>23]]、
== [18] 候補の複製を[[応答]]とします。
== [19] [[齢]]を計算し、その結果を[[応答]]に [CODE(HTTP)@en[[[Age:]]]]
[[ヘッダー]]として追加 (既にあれば置換) します ([[齢]]参照)。
== [14] [[明示的満期時刻]]がある場合、これを使って[[新鮮寿命]]を決定します。
== [15] そうでない場合、
=== [16] [[発見的満期時刻]]を使って[[新鮮寿命]]を決定します。
=== [17] [[新鮮寿命]]が24時間を超えていて、[[応答]]に[[警告符号]] [CODE(HTTP)[[[113]]]] の
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]がなければ、追加します
([[新鮮寿命]]参照)。
== [20] [[齢]]が[[新鮮寿命]][[以上]]の場合や、
[[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]]] が指定されていれば、
その[[秒]]数より[[齢]]が大きい場合 [SRC[>>54]] には、
=== [34] [[腐敗]]フラグを設定します。
=== [35] [[検証]]必要フラグを設定します。
== [22] 
no-store, no-cache, must-revalidate, s-maxage, proxy-revalidate 
なら、[[検証]]必要フラグを削除します。
== [47] [[検証]]必要フラグが設定されている場合、
=== [97] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[only-if-cached]]]]
があれば、 [CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>93]]。
=== [98] [[検証]]します。
=== [100] [[検証]]できなかった場合、
==== [102] [[蓄積された応答]]に
[CODE(HTTP)@en[[[Cache-Control:]] [[must-revalidate]]]] があれば、
[CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>101]]。
==== [103] [[共有キャッシュ]]であって、[[蓄積された応答]]に
[CODE(HTTP)@en[[[Cache-Control:]] [[proxy-revalidate]]]] があれば、
[CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>104, >>101]]。
=== [55] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]]] が指定されている場合、
[[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-stale]]]] が指定されていなければ、
@@ [[腐敗応答]]は使えません。
=== [56] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-stale]]]] が指定されている場合や[[上流]]に接続できなかった場合、
==== [45] [[応答]]に[[警告符号]] [CODE(HTTP)[[[110]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します ([['''SHOULD''']]) [SRC[>>46, >>36]]。
==== [52] 意図的に切断されていた場合には、
[[応答]]に[[警告符号]] [CODE(HTTP)[[[112]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します ([['''SHOULD''']]) [SRC[>>49, >>36]]。
==== [57] [[上流]]への接続に失敗した場合には、
[[応答]]に[[警告符号]] [CODE(HTTP)[[[111]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します ([['''SHOULD''']]) [SRC[>>43, >>36]]。
=== [48]
@@ それ以外で[[腐敗]]の場合、この[[応答]]は使えません。

@@
-[37] 当該要求に Cache-Control: no-cache や Pragma: no-cache が含まれていないこと
--[38] ただし蓄積された応答の検証に成功した場合を除く
-[39] 蓄積されている応答に Cache-Control: no-cache が含まれていないこと
--[40] ただし蓄積された応答の検証に成功した場合を除く
-[41] 蓄積されている応答が新鮮、腐敗していても提供することが認められている、 検証に成功したのいずれかであること

= [33] 転送要求があれば、それを[[要求]]として[[上流]]に[[転送]]します。
= 
@@ XXX 応答...
= [99] エラーの[[応答]]や[[リダイレクト]]の[[応答]]の場合、
それを返してここで終わります。 [SRC[>>18]]
= [11] [[事前条件]]をあれば適用します。真なら、あるいは事前条件がなければ、
[[応答]]を返します。詳しくは[[条件付き要求]]を参照。
]FIG]