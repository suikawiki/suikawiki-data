[2] [[キャッシュ]]に[[蓄積]]されるデータの単位を[DFN[[RUBYB[[[キャッシュ項目]]]@en[cache entry]]]]といいます。

* 仕様書

[REFS[
- [1] '''[CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-2>'''
- [23] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-4>
-- [36] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-4.2.4>
- [93] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2>
-- [54] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.1.1>
-- [50] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.1.2>
-- [53] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.1.3>
-- [71] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.1.4>
-- [101] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.2.1>
-- [73] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.2.2>
-- [104] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.2.2.7>
- [39] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.4>
- [46] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.1>
- [43] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.2>
- [49] [CITE@en[RFC 7234 - Hypertext Transfer Protocol (HTTP/1.1): Caching]] ([TIME[2014-09-11 10:19:59 +09:00]] 版) <https://tools.ietf.org/html/rfc7234#section-5.5.3>
- [85] [CITE@en[RFC 7230 - Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing]] ([TIME[2014-09-11 10:00:03 +09:00]] 版) <https://tools.ietf.org/html/rfc7230#section-5.7.2>
]REFS]

* 構成

[3] [[キャッシュ項目]]は、[RUBYB[キャッシュキー]@en[cache key]]と、
1つ以上の [[HTTP応答]]との組です [SRC[>>1]]。この[[応答]]のことを[RUBYB[[[蓄積]]された[[応答]]]@en[stored response]]といいます。

;; [9] [[蓄積された応答]]には[[腐敗]]したものと[[新鮮]]なものがあり、また[[満期時刻]]や[[齢]]のような特性もあります。

[6] [[キャッシュ項目]]には、[[完全]]なものと[[不完全]]なものがあります。

;; [7] [[不完全]]かどうかは[[メッセージ]]の性質なので、正確には[[キャッシュ項目]]ではなく[[キャッシュ項目]]に含まれる[[応答]]それぞれの性質だと思うのですが、
仕様上[[キャッシュ項目]]の性質となっています。

[4] キャッシュキーは[[要求メソッド]]と[[対象URL]]です。
しかし一般的な[[HTTPキャッシュ]]は [CODE(HTTP)@en[[[GET]]]] に対する[[応答]]しか[[キャッシュ]]しないので、
その場合は[[対象URL]]だけをキャッシュキーとすることができます。 [SRC[>>1]]

[5] [[対象資源]]で[[内容折衝]]が使われている場合には、
複数の[[HTTP応答]]が蓄積されることになります。 [SRC[>>1]]

* 処理モデル

[8] [[キャッシュ可能性]]、[[検証]]、[[条件付き要求]]、[[部分要求]]も参照。

[10] [[キャッシュ]]からの[[応答]]の決定は、次のように行います。

[FIG(steps)[
= [12] エラーその他の[[応答]]を返す場合や、[[キャッシュ]]を使わない[[要求メソッド]]の場合などは、そちらの方法で処理し、ここで終わります。
= [24] [[キャッシュ項目]]として[[蓄積された応答]]から、
次のような[[キャッシュ再利用]]可能な[[応答]]を探します [SRC[>>23]]。
=- [25] [[実効要求URL]]が一致する
=- [26] [[蓄積された応答]]の[[要求メソッド]]が現在の[[要求]]に再利用して構わないこと
=- [27] [CODE(HTTP)@en[[[Vary:]]]] [[ヘッダー]]の条件が一致すること
([CODE(HTTP)@en[[[Vary:]]]] 参照)
= [28] 複数の候補が見つかった時は、次のいずれかとします [SRC[>>23]]。
=- [29] [CODE(HTTP)@en[[[Date:]]]] が最新のものを選びます。
=- [30] 候補がなかったこととし、かわりに次のようにします。
=-= [67] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[only-if-cached]]]]
があれば、 [CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>93]]。
=-= [31] 転送要求を[[要求]]の複製とします。
=-= [32] 転送要求に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]=0]]
または [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] を追加します。
= [68] 候補がなかった場合、
== [96] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[only-if-cached]]]]
があれば、 [CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>93]]。
== [95] 転送要求を[[要求]]の複製とします。
= [70] 候補があった場合、
== [69] [[時計]]がない場合、[[検証]]必要フラグを設定します [SRC[>>23]]。
== [13] それ以外の場合、
=== [18] 候補の複製を[[応答]]とします。
=== [19] [[齢]]を計算し、その結果を[[応答]]に [CODE(HTTP)@en[[[Age:]]]]
[[ヘッダー]]として追加 (既にあれば置換) します ([[齢]]参照)。
=== [14] [[明示的満期時刻]]がある場合、これを使って[[新鮮寿命]]を決定します。
=== [15] そうでない場合、
==== [16] [[発見的満期時刻]]を使って[[新鮮寿命]]を決定します。
==== [17] [[新鮮寿命]]が24時間を超えていて、[[応答]]に[[警告符号]] [CODE(HTTP)[[[113]]]] の
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]がなければ、追加します
([[新鮮寿命]]参照)。
=== [20] 次のいずれかを満たす場合には、[[検証]]必要フラグを設定します。
===- [60] [[齢]]が[[新鮮寿命]][[以上]]の場合。
===- [61] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]]] が指定されていれば、
その[[秒]]数より[[齢]]が大きい場合 [SRC[>>54]]。
===- [62] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[min-fresh]]]] が指定されていれば、
その[[秒]]数と[[齢]]の[[和]]の方が[[新鮮寿命]]より大きい場合 [SRC[>>53]]。
===- [72] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] がある場合 [SRC[>>71]]。
===- [78] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]]]] [[ヘッダー]]がなく、
[CODE(HTTP)@en[[[Pragma:]] [[no-cache]]]] がある場合 [SRC[>>71, >>39]]。
===- [74] [[応答]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] がある場合で、
[[ヘッダー名]]が指定されていない場合 [SRC[>>73]]。
===- [63] [[応答]]に [CODE(HTTP)@en[[[Cache-Control:]] [[must-revalidate]]]] 
がある場合 [SRC[>>101]]。
===- [80] [[応答]]に [CODE(HTTP)@en[[[Pragma:]] [[no-cache]]]]
がある場合 ([CODE(HTTP)@en[[[no-cache]]]] 参照)。
===- [64] [[共有キャッシュ]]であって、[[応答]]に
[CODE(HTTP)@en[[[Cache-Control:]] [[proxy-revalidate]]]] がある場合 [SRC[>>104, >>101]]。
== [47] [[検証]]必要フラグが設定されている場合、
=== [97] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[only-if-cached]]]]
があれば、 [CODE(HTTP)[[[504]]]] [[応答]]を返してここで終わります [SRC[>>93]]。
=== [34] 使う応答を「検証済み応答」に初期化します。
=== [98] [[検証]]します。
=== [21] [[検証]]できなかった場合、
==== [38] 使う応答を「エラー応答」に設定します。
==== [58] 次のいずれかを満たす場合には、使う応答を「エラー応答」に設定します。
====- [102] [[応答]]に
[CODE(HTTP)@en[[[Cache-Control:]] [[must-revalidate]]]] がある場合 [SRC[>>101]]。
====- [103] [[共有キャッシュ]]であって、[[応答]]に
[CODE(HTTP)@en[[[Cache-Control:]] [[proxy-revalidate]]]] がある場合 [SRC[>>104, >>101]]。
====- [83] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] がある場合 [SRC[>>23]]。
====- [84] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]]]] [[ヘッダー]]がなく、
[CODE(HTTP)@en[[[Pragma:]] [[no-cache]]]] がある場合 [SRC[>>23, >>39]]。
====- [75] [[応答]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] 
がある場合 [SRC[>>73, >>23]]。
====- [81] [[応答]]に [CODE(HTTP)@en[[[Pragma:]] [[no-cache]]]]
がある場合 ([CODE(HTTP)@en[[[no-cache]]]] 参照)。
====- [82] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-store]]]] がある場合 [SRC[>>23]]。
====- [22] 
@@s-maxage
==== [40] それ以外で、[[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-stale]]]]
が指定されている場合、
===== [42] 値が指定されている場合、[[齢]]と[[新鮮寿命]]の[[差]]が指定された値[[以下]]なら、
使う応答を「腐敗応答」に設定します [SRC[>>50]]。
===== [44] 値が指定されていない場合、使う応答を「腐敗応答」に設定します [SRC[>>50]]。
==== [41] そうでない場合、
===== [55] [[要求]]に [CODE(HTTP)@en[[[Cache-Control:]] [[max-age]]]] が指定されていない場合
[SRC[>>54]]、使う応答を「腐敗応答」に設定します。
===== [51] それ以外で[[上流]]に接続できなかった場合、使う応答を「腐敗応答」に設定します。
=== [56] 使う応答が「腐敗応答」の場合、
==== [45] [[応答]]に[[警告符号]] [CODE(HTTP)[[[110]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します [SRC[>>46, >>36]]。
==== [52] 意図的に切断されていた場合には、
[[応答]]に[[警告符号]] [CODE(HTTP)[[[112]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します [SRC[>>49, >>36]]。
==== [57] [[上流]]への接続に失敗した場合には、
[[応答]]に[[警告符号]] [CODE(HTTP)[[[111]]]] の 
[CODE(HTTP)@en[[[Warning:]]]] [[ヘッダー]]を追加します [SRC[>>43, >>36]]。
=== [59] 使う応答が「エラー応答」の場合、[[応答]]は新しい [CODE(HTTP)[[[504]]]] 
[[応答]]とします [SRC[>>104, >>101]]。
== [79] それ以外の場合、
=== [76] [[応答]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-cache]]]] があって、
[[ヘッダー名]]が指定されている場合、
==== [77] [[応答]]から指定されている[[ヘッダー]]をすべて削除します [SRC[>>73]]。
= [33] 転送要求があれば、
== [65] それを[[要求]]として[[上流]]に[[転送]]します。
== [66] 
@@ XXX 応答...
= [37] [[要求]]または[[応答]]に [CODE(HTTP)@en[[[Cache-Control:]] [[no-transform]]]]
が含まれない場合、
== [86] 必要に応じて[[変形]]を適用して構いません [SRC[>>85]]。
= [99] エラーの[[応答]]や[[リダイレクト]]の[[応答]]の場合、
それを返してここで終わります。 [SRC[>>18]]
= [11] [[事前条件]]をあれば適用します。真なら、あるいは事前条件がなければ、
[[応答]]を返します。詳しくは[[条件付き要求]]を参照。
]FIG]

;; [48] この[[アルゴリズム]]は [[HTTP]] [[仕様書]]に含まれる要件をできるだけ矛盾なく満たそうと試みたものです。
[[HTTP]] 仕様書には曖昧な記述や境界での動作が不明瞭なケース、
機能同士の相互作用が明確に規定されていないケースが多く、
細部においてこの[[アルゴリズム]]が正しいか (あるいは仕様上必ずしも要求されていないことまで求めていないか) 判断することは困難です。
また仕様上なぜか推奨や[[事実の文]]に留まっていて要件となっていない箇所などもあります。
詳しくは関連各項も参照してください。