[2] [CODE(HTTP)@en[[[Range:]]]] が指定された[[要求]]を、[DFN[[RUBYB[[[範囲要求]]]@en[range request]]]]といいます。

* 仕様書

[REFS[
- [1] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233>
-- [5] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233#section-4.3>
]REFS]

* 構成要素

[4] [[範囲要求]]は次の[[プロトコル要素]]により構成されます。

[FIG(list short)[
- [CODE(HTTP)@en[[[Range:]]]]
- [CODE(HTTP)@en[[[If-Range:]]]]
- [[範囲単位]]
- [CODE(HTTP)@en[[[Accept-Ranges:]]]]
- [CODE(HTTP)[[[206]]]]
- [CODE(HTTP)[[[416]]]]
- [CODE(HTTP)@en[[[Content-Range:]]]]
- [CODE(MIME)@en[[[multipart/byteranges]]]]
]FIG]

* 処理モデル

[3] [[範囲要求]]への対応は必須ではありません [SRC[>>1]]。[[範囲要求]]を受信した時、
これに対応していない場合は、通常の [CODE(HTTP)@en[[[GET]]]]
[[要求]]として処理して構いません [SRC[>>1]]。

** 結合

[7] [[クライアント]]は、
[[HTTP接続]]が閉じられるのが早すぎた場合 (不完全な [CODE(HTTP)[[[200]]]] [[応答]])や、
[[範囲要求]]によって[[応答]]を得た場合 ([CODE(HTTP)[[[206]]]] [[応答]]) に、
同じ[[強い検証子]]を持っていればそれらを安全に組み合わせることができます [SRC[>>5]]。

[8] 結合した[[応答]]は次のように決めます。
[FIG(steps)[
= [13] 蓄積されている[[応答]]と新しい[[応答]]で[[強い検証子]]が一致するもの
([CODE(HTTP)[[[200]]]] [[応答]]と [CODE(HTTP)[[[206]]]] [[応答]]) を集めます。
= [10] 集めた[[応答]]のいずれかが [CODE(HTTP)[[[200]]]] [[応答]]なら、 [SRC[>>5]]
== [20] 最新の [CODE(HTTP)[[[200]]]] [[応答]]の各[[ヘッダー]]を結合した[[応答]]の[[ヘッダー]]とします。
= [21] そうでない場合 (いずれも [CODE(HTTP)[[[206]]]] [[応答]]の場合)、 [SRC[>>5]]
== [22] 蓄積されている最新の[[応答]]の各[[ヘッダー]]を結合した[[応答]]の[[ヘッダー]]とします。
== [23] 新しい[[応答]]の[[ヘッダー]]で結合した[[応答]]の各[[ヘッダー]]で結合した[[応答]]の[[ヘッダー]]を置き換えます。ただし [CODE(HTTP)@en[[[Content-Range:]]]] [[ヘッダー]]は除きます。
= [14] 集めた[[応答]]から元のデータの復元を試みます。
= [15] データの全体が復元できた場合、
== [9] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[200]]]] とします。 [SRC[>>5]]
== [12] 結合した[[応答]]の [CODE(HTTP)@en[[[Content-Length:]]]] 
[[ヘッダー]]は得られたデータの長さとします。 [SRC[>>5]]
== [38] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Type:]]]] [[ヘッダー]]は適切に設定します。
== [27] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
== [16] 結合した[[応答]]の[[メッセージ本体]]は得られたデータとします。
= [19] 全体にはならなかった場合、
== [18] 得られたデータが元のデータの最初の部分だった時は、次のようにして構いません。
=== [24] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[200]]]] とします。 [SRC[>>5]]
=== [25] 結合した[[応答]]の [CODE(HTTP)@en[[[Content-Length:]]]] 
[[ヘッダー]]は得られたデータの長さとします。 [SRC[>>5]]
=== [37] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Type:]]]] [[ヘッダー]]は適切に設定します。
=== [28] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
=== [26] 結合した[[応答]]の[[メッセージ本体]]は得られたデータとします。
== [29] そうしない場合、次のようにして構いません。
=== [17] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[206]]]] とします。 [SRC[>>5]]
=== [11] 結合した[[応答]]の[[メッセージ本体]]は得られたデータの各連続部分を含む
[CODE(MIME)@en[[[multipart/byteranges]]]] [[実体]]とします。 [SRC[>>5]]
=== [30] 結合した[[応答]]の [COD(HTTP)@en[[[Content-Type:]]]],
[CODE(HTTP)@en[[[Content-Length:]]]] は適当に設定し、
[CODE(HTTP)@en[[[Content-Range:]]]], [CODE(HTTP)@en[[[Transfer-Encoding:]]]]
は削除します。
== [31] そうしない場合、得られたデータの各連続部分について、
=== [32] 結合した[[応答]]の複製を用意します。
=== [33] その[[状態符号]]は [CODE(HTTP)@en[[[206]]]] とします。 [SRC[>>5]]
=== [34] その[[メッセージ本体]]はデータの連続部分とします。 [SRC[>>5]]
=== [35] その [CODE(HTTP)@en[[[Content-Range:]]]] [[ヘッダー]]を適切に設定します。 [SRC[>>5]]
=== [36] その [CODE(HTTP)@en[[[Content-Type:]]]] [[ヘッダー]]と 
[CODE(HTTP)@en[[[Content-Length:]]]] [[ヘッダー]]を適切に設定し、
[CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
]FIG]

* メモ

[6] [CITE[http - Paging in a Rest Collection - Stack Overflow]]
( ([TIME[2014-09-17 02:47:22 +09:00]] 版))
<http://stackoverflow.com/questions/924472/paging-in-a-rest-collection>