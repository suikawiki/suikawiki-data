[2] [CODE(HTTP)@en[[[Range:]]]] が指定された[[要求]]を、[DFN[[RUBYB[[[範囲要求]]]@en[range request]]]]といいます。

* 仕様書

[REFS[
- [1] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233>
-- [14] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233#section-3.1>
-- [61] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233#section-4.1>
-- [5] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233#section-4.3>
-- [40] [CITE@en[RFC 7233 - Hypertext Transfer Protocol (HTTP/1.1): Range Requests]] ([TIME[2014-09-11 09:57:55 +09:00]] 版) <https://tools.ietf.org/html/rfc7233#section-6.1>
]REFS]

* 構成要素

[4] [[範囲要求]]は次の[[プロトコル要素]]により構成されます。

[FIG(list short)[
- [CODE(HTTP)@en[[[Range:]]]]
- [CODE(HTTP)@en[[[If-Range:]]]]
- [[範囲単位]]
- [CODE(HTTP)@en[[[Accept-Ranges:]]]]
- [CODE(HTTP)[[[206]]]]
- [CODE(HTTP)[[[416]]]]
- [CODE(HTTP)@en[[[Content-Range:]]]]
- [CODE(MIME)@en[[[multipart/byteranges]]]]
]FIG]

* 処理モデル

[3] [[範囲要求]]への対応は必須ではありません [SRC[>>1]]。[[範囲要求]]を受信した時、
これに対応していない場合は、通常の [CODE(HTTP)@en[[[GET]]]]
[[要求]]として処理して構いません [SRC[>>1]]。

** 範囲要求への応答

[42] [[鯖]]は、[[範囲要求]]を次のように処理しなければなりません。

[FIG(steps)[
= [41] [[条件付き要求]]なら、[[条件付き要求]]の処理の規定に従い条件を評価します。
それによって[[応答]]が決まるなら、ここで終わります。
= [45] [[鯖]]が [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]に対応しないなら、
ここで終わり通常の方法で処理します [SRC[>>14]]。
= [43] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]がなければ、
[[範囲要求]]ではないので、ここで終わり通常の方法で処理します。
= [44] [[要求メソッド]]が [CODE(HTTP)@en[[[GET]]]] 以外なら、
[CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]は無視します [SRC[>>14]]。
ここで終わり通常の方法で処理します。
= [46] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]の[[範囲単位]]が対応しないものなら、
== [47] [[起源鯖]]は、 [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]を無視します [SRC[>>14]]。
== [48] [[串]]は、 [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]を捨てても構いません [SRC[>>14]]。
== [49] いずれにせよ、ここで終わり通常の方法で処理します。
= [53] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]の値を[[範囲単位]]ごとの構文に従い解釈します。
= [54] 3つ[[以上]]の重複する範囲を含む [CODE(HTTP)@en[[[Range:]]]]
[[ヘッダー]]や、多数の[[昇順]]でない小さな範囲を指定した [CODE(HTTP)@en[[[Range:]]]]
[[ヘッダー]]を無視したり、拒絶したりして構いません [SRC[>>14]]。
=- [55] これらを送信した[[クライアント]]は壊れているのかもしれませんし、
[[DoS攻撃]]かもしれません。 [SRC[>>14, >>40]]
== [56] 拒絶する場合は、 [CODE(HTTP)[[[416]]]] [[応答]]を返してここで終わります。
== [57] 無視する場合は、ここで終わり通常の方法で処理します。
= [60] 指定された範囲が[[非妥当]]か[[満足不能]]なら、
[CODE(HTTP)[[[416]]]] [[応答]]を返してここで終わります [SRC[>>14]]。
= [59] 指定された範囲が[[妥当]]で[[満足可能]]なら、
[[満足可能]]な[[範囲]]に対応する1つ以上の部分[[表現]]を含む [[payload]]
をもった [CODE(HTTP)[[[206]]]] [[応答]]を送信します [SRC[>>14]]。
== [71] 複数の範囲が指定されていた場合に、範囲の指定の順序に関わらず、
重なり合う範囲をまとめたり、 [[multipart]] 
による[[オーバーヘッド]]より隙間が小さいときにまとめたりしても構いません。 [SRC[>>61]]
==- [72] 一般的には [CODE(MIME)@en[[[multipart/byteranges]]]] の[[オーバーヘッド]]は
80バイト程度です。 [SRC[>>61]]
==- [73] >>54 の [[DoS攻撃]]への対策にもなります。
== [75] [CODE(MIME)@en[[[multipart/byteranges]]]] を使うか判断します。
=== [76] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]で指定された範囲が1つの時は、
使用しません [SRC[>>61]]。
=== [77] >>71 の場合は、どちらでも構いません [SRC[>>61]]。
=== [78] それ以外の場合は、使用します [SRC[>>61]]。
== [63] [CODE(MIME)@en[[[multipart/byteranges]]]] を使用する時は、
=== [66] 各範囲を[[本体部分]]とする [CODE(MIME)@en[[[multipart/byteranges]]]] を
[[payload]] に含めます [SRC[>>61]]。
==== [68] 範囲を指定した [CODE(HTTP)@en[[[Content-Range:]]]]
[[ヘッダー]]を[[本体部分]]に含めます [SRC[>>61]]。
==== [70] [[選択された表現]]が [CODE(HTTP)[[[200]]]] [[応答]]だった場合の[[応答]]の
[CODE(HTTP)@en[[[Content-Type:]]]] [[ヘッダー]]と同じ値の
[CODE(HTTP)@en[[[Content-Type:]]]] [[ヘッダー]]を[[本体部分]]に含める[['''べきです''']]
[SRC[>>61]]。
==== [69] 範囲のデータを[[本体部分]]の[[実体本体]]に含めます。
==- [74] [[満足不能]]な[[範囲]]や他の[[範囲]]とまとめた場合 (>>71) を除き、
[CODE(HTTP)@en[[[Range:]]]] に指定された順序で[[本体部分]]を並べる[['''べきです''']] [SRC[>>61]]。
==- [67] [[応答]]の[[ヘッダー]]としては [CODE(HTTP)@en[[[Content-Range:]]]]
を[[生成]]しては[['''なりません''']] [SRC[>>61]]。
== [62] それ以外の場合、
=== [64] 範囲を指定した [CODE(HTTP)@en[[[Content-Range:]]]]
[[ヘッダー]]を[[生成]]します [SRC[>>61]]。
=== [65] 範囲のデータを [[payload]] に含めます [SRC[>>61]]。
]FIG]

;; [51] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]が複数指定された時の動作は規定されていません。

;; [58] [CODE(HTTP)@en[[[Range:]]]] [[ヘッダー]]の値が構文的に正しくない場合の動作は規定されていません。

;; [52] [[起源鯖]]と中間[[キャッシュ]]は可能なら[[バイト範囲]]に対応する[RUBYB[べき]@en[ought to]]です [SRC[>>14]]。

;; [50] >>60 と >>59 はなぜか [['''MUST''']] ではなく [['''SHOULD''']]
です [SRC[>>14]]。 >>54 や >>45 の場合を考慮してなのかもしれませんが、
説明がないのでよくわかりません。また妥当・満足可能な範囲と非妥当・満足不能な範囲が混在する時、
どちらを返すべきかは不明瞭です。

;; [79] [CODE(HTTP)[[[206]]]] や [CODE(HTTP)[[[416]]]] の[[応答]]の[[ヘッダー]]については、
それぞれの項も参照してください。

** 部分応答の結合

[7] [[クライアント]]は、
[[HTTP接続]]が閉じられるのが早すぎた場合 ([[不完全]]な [CODE(HTTP)[[[200]]]] [[応答]])や、
[[範囲要求]]によって[[応答]]を得た場合 ([CODE(HTTP)[[[206]]]] [[応答]]) に、
同じ[[強い検証子]]を持っていればそれらを安全に組み合わせることができます [SRC[>>5]]。

[8] 結合した[[応答]]は次のように決めます。
[FIG(steps)[
= [13] 蓄積されている[[応答]]と新しい[[応答]]で[[強い検証子]]が一致するもの
([CODE(HTTP)[[[200]]]] [[応答]]と [CODE(HTTP)[[[206]]]] [[応答]]) を集めます。
= [10] 集めた[[応答]]のいずれかが [CODE(HTTP)[[[200]]]] [[応答]]なら、 [SRC[>>5]]
== [20] 最新の [CODE(HTTP)[[[200]]]] [[応答]]の各[[ヘッダー]]を結合した[[応答]]の[[ヘッダー]]とします。
= [21] そうでない場合 (いずれも [CODE(HTTP)[[[206]]]] [[応答]]の場合)、 [SRC[>>5]]
== [22] 蓄積されている最新の[[応答]]の各[[ヘッダー]]を結合した[[応答]]の[[ヘッダー]]とします。
== [23] 新しい[[応答]]の[[ヘッダー]]で結合した[[応答]]の各[[ヘッダー]]で結合した[[応答]]の[[ヘッダー]]を置き換えます。ただし [CODE(HTTP)@en[[[Content-Range:]]]] [[ヘッダー]]は除きます。
= [39] 集めた[[応答]]から元のデータの復元を試みます。
= [15] データの全体が復元できた場合、
== [9] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[200]]]] とします。 [SRC[>>5]]
== [12] 結合した[[応答]]の [CODE(HTTP)@en[[[Content-Length:]]]] 
[[ヘッダー]]は得られたデータの長さとします。 [SRC[>>5]]
== [38] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Type:]]]] [[ヘッダー]]は適切に設定します。
== [27] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
== [16] 結合した[[応答]]の[[メッセージ本体]]は得られたデータとします。
= [19] 全体にはならなかった場合、
== [18] 得られたデータが元のデータの最初の部分だった時は、次のようにして構いません。
=== [24] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[200]]]] とします。 [SRC[>>5]]
=== [25] 結合した[[応答]]の [CODE(HTTP)@en[[[Content-Length:]]]] 
[[ヘッダー]]は得られたデータの長さとします。 [SRC[>>5]]
=== [37] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Type:]]]] [[ヘッダー]]は適切に設定します。
=== [28] 結合した[[応答]]の [CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
=== [26] 結合した[[応答]]の[[メッセージ本体]]は得られたデータとします。
== [29] そうしない場合、次のようにして構いません。
=== [17] 結合した[[応答]]の[[状態符号]]は [CODE(HTTP)[[[206]]]] とします。 [SRC[>>5]]
=== [11] 結合した[[応答]]の[[メッセージ本体]]は得られたデータの各連続部分を含む
[CODE(MIME)@en[[[multipart/byteranges]]]] [[実体]]とします。 [SRC[>>5]]
=== [30] 結合した[[応答]]の [COD(HTTP)@en[[[Content-Type:]]]],
[CODE(HTTP)@en[[[Content-Length:]]]] は適当に設定し、
[CODE(HTTP)@en[[[Content-Range:]]]], [CODE(HTTP)@en[[[Transfer-Encoding:]]]]
は削除します。
== [31] そうしない場合、得られたデータの各連続部分について、
=== [32] 結合した[[応答]]の複製を用意します。
=== [33] その[[状態符号]]は [CODE(HTTP)@en[[[206]]]] とします。 [SRC[>>5]]
=== [34] その[[メッセージ本体]]はデータの連続部分とします。 [SRC[>>5]]
=== [35] その [CODE(HTTP)@en[[[Content-Range:]]]] [[ヘッダー]]を適切に設定します。 [SRC[>>5]]
=== [36] その [CODE(HTTP)@en[[[Content-Type:]]]] [[ヘッダー]]と 
[CODE(HTTP)@en[[[Content-Length:]]]] [[ヘッダー]]を適切に設定し、
[CODE(HTTP)@en[[[Transfer-Encoding:]]]] [[ヘッダー]]は削除します。
]FIG]

;; [80] [[不完全メッセージ]]も参照。

* メモ

[6] [CITE[http - Paging in a Rest Collection - Stack Overflow]]
( ([TIME[2014-09-17 02:47:22 +09:00]] 版))
<http://stackoverflow.com/questions/924472/paging-in-a-rest-collection>