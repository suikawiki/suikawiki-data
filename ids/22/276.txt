* 仕様書

[REFS[
- [59] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2016-05-14 09:55:50 +09:00]]) <https://html.spec.whatwg.org/#semantics-2>
- [10] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-11-21 03:08:35 +09:00]] 版) <https://html.spec.whatwg.org/#processing-model-9>'''
- [23] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2014-11-21 03:08:35 +09:00]] 版) <https://html.spec.whatwg.org/#pause>
]REFS]

* 文書の意味とレンダリング

[60] [[文書の意味]]は、[[スクリプト]]その他の方法でいつ変化するとも限りません。
[[利用者エージェント]]は、[[文書の意味]]が変化したら、
[[文書]]の[RUBYB[表現]@en[presentation]]を更新しなければ[MUST[なりません]] [SRC[>>59]]。

[67] [[Webブラウザー]]の[F[既読URLリスト]]の変化も、随時[[レンダリング]]に反映されます。

* レンダリングの更新

[8] [[イベントループ]]は、[[ワーカー]]でなく[[閲覧文脈]]に関するものであるなら、
ループ各回の最後に[RUBYB[[[レンダリングの更新]]]@en[update the rendering]]処理を行います
[SRC[>>10]]。

;; [11] [[タスク]]や[[マイクロタスク]]の後に実行されます。

[12] 当該[[イベントループ]]に関連付けられた [CODE(DOMi)@en[[[Document]]]]
が対象となります。対象となる [CODE(DOMi)@en[[[Document]]]] のリストでは、
[[入れ子閲覧文脈]]の [CODE(DOMi)@en[[[Document]]]] は[[親閲覧文脈]]の
[CODE(DOMi)@en[[[Document]]]] より後となります。また同じ[[閲覧文脈]]の[[入れ子閲覧文脈]]の
[CODE(DOMi)@en[[[Document]]]] 同士は、[[閲覧文脈包含器]]の[[木順]]となります。
それ以外の順序は任意とされています。 [SRC[>>10]]

[124] [[イベントループ]]で毎回[[レンダリング]]の更新を行う必要はなく、
いつ更新するかの正確なタイミングは実装に任されています。
特定の更新頻度よりも多く実行しないように間引いても構いませんし、
表示されていない[[最上位閲覧文脈]]の更新を著しく低頻度にすることもできます。
ある[[最上位閲覧文脈]]の更新を行わない場合、その[[最上位閲覧文脈]]に属する[[閲覧文脈]]の
[CODE(DOMi)@en[[[Document]]]] を >>12 のリストから除去します。 [SRC[>>10]]

[49] 加えて、[[入れ子閲覧文脈]]の更新も低頻度または更新なしとすることができます。
更新を行わない場合は、当該[[入れ子閲覧文脈]]の [CODE(DOMi)@en[[[Document]]]]
を >>12 のリストから除去します。 [SRC[>>10]]

[EG[
[50] 例えば[[第三者]]内容 ([[広告]]や[[SNS]]ボタンの類など)
が非表示だったり[[資源]]の制約が厳しかったりする場合には、
その更新頻度を低下させることができます。 [SRC[>>10]]
]EG]

[EG[
[56] 例えば[[イベントループ]]の今回の一巡と次回の一巡で実行される動作の種別次第で、
[[レンダリングの更新]]を省略できます。
([[アニメーションフレームコールバック]]間では省略しない方が良いでしょうが、
[[タイマー]]コールバックだけなら省略しても良いかもしれません。)
]EG]

;; [205] [[レンダリング]]の更新は[[一時停止]]でも行われますが、 >>52 
は[[イベントループ]]における更新 ([[イベントループ]>>28]) を指しています。

[25] こうした処理を次にいつ実行するかは、[[アイドル期間]]の締切の決定に影響を及ぼすことがあります。

-*-*-

[13] 具体的には次のように処理しなければ[MUST[なりません]] [SRC[>>10]]。
[FIG(steps)[
= [66] [VAR[時刻印]]を、[[現在時刻]]に設定します。
= [14] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[サイズ変更手順を実行]]します。
= [15] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[スクロール手順を実行]]します。
= [16] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[媒体クエリーを評価して報告]]します。
= [17] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[CSSアニメーションを実行してイベントを送信]]します。
= [18] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[全画面レンダリング手順を実行]]します。
= [19] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[アニメーションフレームコールバックを実行]]します。
= [54] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[run the update intersection observations steps]] します。
= [21] リスト中の [CODE(DOMi)@en[[[Document]]]] のうち[F[[[完全に活性]]]]なものそれぞれについて、
[VAR[時刻印]]に関して、
[[レンダリングや利用者インターフェイスを更新]]します。
]FIG]

[26] [[文書]]が[[完全に活性]]かどうかの判断は、それぞれの時点で行われます。
前の方の手順で[[完全に活性]]の基準を満たさなくなることがあると、後の方の手順は実行されないこともあります。

* レンダリングや利用者インターフェイスの更新

[24] [[レンダリングの更新]]の最後 (>>21) や[[一時停止]] [SRC[>>23]]
では、「[RUBYB[[[レンダリングや利用者インターフェイスの更新]]]@en[update the rendering or user interface]]」
を行います。

[52] 具体的に何を行うかは明確に定義されているわけではありませんが、次のものが含まれています。
[FIG(list)[
- [53] [[canvas]] における[[利用者へ通知]]
([[タスク]]内で同期的に行なって良いしこのタイミングで行なっても良いし、行わなくても良い)
-- [204] <http://www.whatwg.org/specs/web-apps/current-work/#inform>
- [113] 外部参照を含む[[スタイルシート]]に[[スクリプト]]がアクセスできるようになるのは、
最初のレンダリング更新のタイミング以降です。
-- <http://www.whatwg.org/specs/web-apps/current-work/#style-sheet-ready>
]FIG]

[32] [[event loop step 1]] 時点での状態が参照されているもの ([[event loop step 1]]
参照) は、次の [[event loop step 1]] を過ぎた時点でレンダリングを更新する必要が生じます。

* 閲覧文脈のレンダリング

[44] [[閲覧文脈]]の存在と、それが[[レンダリング]]されて[[利用者]]から観察可能かどうかは、
必ずしも等しくありません。

[EG[
[45] 最も明確な例は、現在選択されていない[[タブ]]です。
]EG]

[EG[
[46] [[Webブラウザー]]によっては、[[タブ]]の表示位置の移動の際、
一時的に [[viewport]] が消滅することがあります。
]EG]

[EG[
[47] [[Webブラウザー]]や[[ウィンドウマネージャー]]の実装によっては、
[[最小化]]されていたり[[画面]]の表示領域外にあったり、
隠れていたりする[[窓]]や[[タブ]]であっても、その現在の状態を表示できる機能があるかもしれません。
例えば [KBD[[KBD[[[Ctrl]]] + [KBD[[[Tab]]]]]] で[[窓]]の切り替えメニューが表示され、
最新の[[窓]]の状態が表示されるかもしれません。
[[タスクバー]]上の[[窓]]の表示に[[マウスカーソル]]を合わせると、
最新の[[窓]]の状態が表示されるかもしれません。
]EG]

@@ [[Page Visibility]] との関係

[35] [CODE(JS)@en[[[location.reload]]]] は、文脈によっては[[閲覧文脈]]を [[repaint]]
することになっています。

;; [CODE(JS)@en[[[location.reload]]]] は [CODE(DOMm)@en[[[refresh]]]]
[[メソッド]]から呼び出されることもあります。

* 関係が不明瞭なもの

[9] [[イベントループ]]の明文化以前から存在する機能は、
[[イベントループ]]との相互作用が明文化されていないものがあります。

[63] [[fetch]] が[[画像]]や [[XML]] の[[タスク]]を複数生成する時に、
それを[[インクリメンタル・レンダリング]]する処理モデルは定義されていません。

;; [36] [[Web]] で使われる[[画像形式]]は、データが到着した部分から順次[[レンダリング]]できるのが普通です。
通常は[[上]]の[[画素]]から順に表示されていきますが、[[プログレッシブJPEG]]
など全体を最初にレンダリングし、徐々に高解像度化して表示できる形式もあります。

[194] [CODE(HTMLe)@en[[[blink]]]] [[要素]]や [[CSS]] の [CODE(CSS)@en[[[text-decoration]]: [[blink]]]]
では[[点滅]]が発生します。

[195] [CODE(HTMLe)@en[[[marquee]]]] の[[アニメーション]]は [[HTML Standard]] で定義されていますが、
[[イベントループ]]との関係には言及がありません。

[40] [CODE(HTMLe)@en[[[progress]]]] [[要素]]は[[アニメーション]]で[[レンダリング]]されることがあります。

[193] [[レンダリング]]を行うタイミングは[[イベントループ]]で定義されていますので、
[[レンダリング]]の変化はその時に発生するのでしょうが、
[[ハードウェア]]に[[動画]]の再生を任せている場合など、
独自のタイミングで更新が発生するかもしれません。

[37] [[プラグイン]]は、 [[Webブラウザー]]本体とは独立して[[レンダリング]]を行うかもしれません。

[64] [[アニメーションGIF]]の[[レンダリング]]との関係は定義されていません。
ただし同じ[[URL]]の[[アニメーションGIF]]は、最初に読み込まれたものの再生と同期する、
と [[HTML]] により規定されています。

[38] テキスト入力の現在位置を表す[[カーソル]] ([[キャレット]]) は、
[[プラットフォーム]]によっては[[点滅]]するかもしれません。

@@ [197] [[CSS Transitions]], [[SMIL Animations]], [[SVG]] 

@@ [[スクロール]]や[[ズーム]]との関係、
[[窓]]や[[タブ]]の切り替えによる再描画との関係

@@ 動画やアニメーションと [[pause]] との関係

* 閲覧文脈外の利用者インターフェイス

[41] 普通[[レンダリング]]というとき、[[閲覧文脈]]内 ([[画布]])
のことをいいます。

[42] しかし[[利用者エージェント]]によっては[[閲覧文脈]]外の[[利用者インターフェイス]]も同じようなタイミングで更新するかもしれません。
例えば次のものがあります。
[FIG(list)[
- [[タイトルバー]] ([CODE(JS)@en[[[document.title]]]])
- [[favicon]]
- [[アドレスバー]] ([[文書の番地]]、[[service identity]]、[[EV証明書]])
- [[検索]] ([[OpenSearch]] など)
- [[状態バー]] ([CODE(JS)@en[[[window.status]]]])
- [[ツールチップ]]
- [[フォームの検証]]に関する表示
- 読み込み中の表示 ([[navigate]] 参照)
- [[色]] ([CODE(HTML)@en[[[theme-color]]]])
- [[履歴]]に関するメニューやボタン
- [[Site Navigation Bar]] や [[Link Toolbar]] の類 ([CODE(HTMLe)@en[[[link]]]])
- [[文脈メニュー]]や[[命令]]の一覧の[[メニュー]]
- [39] [[マウスカーソル]]は、通常は [[OS]] の機能によって実現され、
[[Webブラウザー]]とは独立して動作します。[[アニメーション]]に対応しているかもしれません。
- [[Permission]] や[[スクリプト無効]]等の[[文書]]や[[起源]]や[[閲覧文脈]]に依存する設定の表示
- [[基本認証]]や[[パスワードマネージャー]]等認証情報に関する表示
- [[開発者ツール]]の表示、[[コンソール]]など
]FIG]

[43] なお、更新が必要になることはないかもしれませんが、次のような[[閲覧文脈]]外の[[利用者インターフェイス]]もあります。
[FIG(list short)[
- [[ダイアログ]]
- [[通知]]
]FIG]

* 文脈

@@ [[イベントループ]]からの呼び出し

@@ [[CSSOM View]] からの呼び出し

* 歴史

[22] [[レンダリング]]に関する諸々の処理は従来[[イベントループ]]において
(このタイミングで実行してもよいという以上には) 明確には規定されていませんでした。
しかし個々の規定が詳細化され、相互作用も明確にする必要が生じてきたことから、
2014年11月に [[HTML Standard]] の[[イベントループ]]の規定が各仕様の処理を呼び出す形に詳細化されました。

[REFS[
- [1] [CITE[Define fullscreen in terms of "animation frame tasks" and reduce the amo... · 5187282 · whatwg/fullscreen]]
( ([TIME[2014-07-31 07:28:54 +09:00]] 版))
<https://github.com/whatwg/fullscreen/commit/5187282e5fd24a1c4ff0164d444e1bfc2bdf44ef>
- [2] [CITE@en[Animation frame task]]
( ([[Anne van Kesteren]] 著, [TIME[2014-07-31 00:29:07 +09:00]] 版))
<http://lists.w3.org/Archives/Public/www-style/2014Jul/0586.html>
- [3] [CITE@en[Bug 26440 – Allow fullscreenchange events to be synchronized with animation frames]]
( ([TIME[2014-07-31 14:28:12 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=26440>
- [4] [CITE@en[Re: Animation frame task]]
( ([[Elliott Sprehn]] 著, [TIME[2014-08-22 12:37:46 +09:00]] 版))
<http://lists.w3.org/Archives/Public/www-style/2014Aug/0365.html>
- [5] [CITE@en[Bug 26636 – We need to flush out step 8 of the event loop processing model per http://lists.w3.org/Archives/Public/www-dom/2014JulSep/0091.html and other emails in that thread]]
( ([TIME[2014-08-24 02:30:54 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=26636>
- [20] [CITE@en[Web Applications 1.0 r8782 Reframe the 'update the rendering' step so we can add substeps.]] ([TIME[2014-09-18 05:42:00 +09:00]] 版) <https://html5.org/r/8782>
- [6] [CITE@en[Make list of fullscreenElements during animation frame task https://www.... · 13e267c · whatwg/fullscreen]]
( ([TIME[2014-08-27 02:50:42 +09:00]] 版))
<https://github.com/whatwg/fullscreen/commit/13e267c9bf275b645d4e7652e3acbc16f3dc5efb>
- [7] [CITE@en[Bug 26839 – Integrate "Timing control for script-based animations" spec into HTML]]
( ([TIME[2014-11-22 00:51:57 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=26839>
- [27] [CITE@en[Web Applications 1.0 r8849  Flesh out how rendering happens in the event loop. This also defines requestAnimationFrame() and obsoletes the 'Timing control for script-based animations' spec (by request of that spec's editors)]] ([TIME[2014-11-20 06:56:00 +09:00]] 版) <https://html5.org/r/8849>
- [28] [CITE@en[Web Applications 1.0 r8850 Teach the event loop that it might not have a task to run]] ([TIME[2014-11-20 07:20:00 +09:00]] 版) <https://html5.org/r/8850>
- [29] [CITE@en[Web Applications 1.0 r8851  Handle the case of a 'resize' handler removing the Document from the rendering]] ([TIME[2014-11-20 07:42:00 +09:00]] 版) <https://html5.org/r/8851>
- [30] [CITE@en-US[csswg: changeset 14799:1e907e3ac50c]] ([TIME[2014-11-22 14:34:29 +09:00]] 版) <https://dvcs.w3.org/hg/csswg/rev/1e907e3ac50cf28bb21750d49d1229195e79d33c>
]REFS]

[206] [CITE@en[Re: ''''''[''''''cssom-view'''''']'''''''''['''css3-animations''']''' Sync events with  requestAnimationFrame]]
( ([[Simon Pieters]] 著, [TIME[2014-12-09 19:00:26 +09:00]] 版))
<http://lists.w3.org/Archives/Public/www-style/2014Dec/0133.html>

[31] [CITE[IRC logs: freenode / #whatwg / 20150212]]
([TIME[2015-02-13 13:18:09 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20150212>

[33] [CITE[IRC logs: freenode / #whatwg / 20150702]]
([TIME[2015-07-03 11:15:58 +09:00]] 版)
<http://krijnhoetmer.nl/irc-logs/whatwg/20150702>

[34] [CITE@en[Bug 28876 – Doing too much stuff around animation frame tick may cause rendering updates to be postponed]]
([TIME[2015-07-03 11:16:06 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=28876>

[48] [CITE@en[Allow not rendering nested browsing contexts · whatwg/html@ee77b87]]
([TIME[2016-02-14 00:29:33 +09:00]] 版)
<https://github.com/whatwg/html/commit/ee77b8710cea05aa1c56b32b9d7d790c39a62aef>

[51] [CITE@en[Add intersection observer to the event loop's rendering · whatwg/html@a5f708c]]
([TIME[2016-02-29 17:41:57 +09:00]] 版)
<https://github.com/whatwg/html/commit/a5f708cf5cbb909345a0da695fb86b2a6cd9d3a0>

[55] [CITE@en[Fix #818: add another example of when to skip updating the rendering · whatwg/html@a999104]]
([TIME[2016-03-09 15:37:09 +09:00]] 版)
<https://github.com/whatwg/html/commit/a9991042e27cb9e90538b287352577db3b427780>

[57] [CITE@en[New 'update the rendering' process may have negative consequences with respect to callbacks · Issue #818 · whatwg/html]]
([TIME[2016-03-09 15:48:53 +09:00]] 版)
<https://github.com/whatwg/html/issues/818>

[58] [CITE@en[28001 – Formalize rendering tasks]]
([TIME[2016-03-26 12:00:14 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=28001>

[FIG(quote)[
[FIGCAPTION[
[61] [CITE[W3M FAQ]]
( ([TIME[2001-02-01 18:02:39 +09:00]]))
<http://homepage2.nifty.com/aito/w3m/FAQ.html>
]FIGCAPTION]

> w3mはHTML文書を2パスで整形するので,文書全体を読みこまないと 表示ができません.Netscapeなどは文書を読みながら表示するので, 表示が速いように思えるのでしょう.

]FIG]


[62] [CITE@en[Remove the concept of CSS Bindings]]
([[annevk]]著, [TIME[2016-07-08 02:00:41 +09:00]])
<https://github.com/whatwg/html/commit/6c96beabfa41d6d28ab23633966b82c5cdb9fd94>

[65] [CITE@en[Reject exitFullscreen() in inactive documents]]
([[foolip]]著, [TIME[2016-12-16 22:39:22 +09:00]])
<https://github.com/whatwg/fullscreen/commit/59574a4dc4cebf5dc13cb9823ef4f91fbb496be3>