* 仕様書

[REFS[
- [72] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#current-document-readiness>
- [7] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#dom-document-open>'''
- [31] '''[CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#dom-open>'''
- [43] [CITE@en[CSSOM View Module]] ([TIME[2015-05-06 18:05:35 +09:00]] 版) <http://dev.w3.org/csswg/cssom-view/#the-features-argument-to-the-open()-method>
- [58] [CITE@en-GB-x-hixie[HTML Standard]] ([TIME[2015-05-06 10:42:35 +09:00]] 版) <https://html.spec.whatwg.org/#an-overridden-reload>
]REFS]

* メソッド呼び出し

[75] [CODE(DOMi)@en[[[Window]]]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[[[open]]]]]] [[メソッド]]は、
新しい[[窓]] ([[補助閲覧文脈]]) を[[ポップアップ]]するものです。
次の[[引数]]があります。
[FIG(table)[
:n:
:t:[[型]]
:o:省略
:d:説明

:n:1
:t:[CODE(IDL)@en[[[DOMString]]]]
:o:省略可能
:d:新しく表示する[[文書]]の [[URL]]。

:n:2
:t:[CODE(IDL)@en[[[DOMString]]]]
:o:省略可能
:d:[[妥当な閲覧文脈名またはキーワード]]。省略時は [CODE(HTML)@en[[[_blank]]]]。

:n:3
:t:[CODE(IDL)@en[[[DOMString]]]]
:o:省略可能
:d:[[ポップアップ]]の表示オプション。
]FIG]

[32] [CODE(DOMi)@en[[[Window]]]] [[インターフェイス]]の
[CODE(DOMm)@en[[[open]]]] [[メソッド]]は、次のように処理しなければ[['''なりません''']]
[SRC[>>31]]。
[FIG(steps)[
= 最初の[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。既定値は
[CODE(MIME)@en[[[about:blank]]]] とします。
= 2つ目の[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。既定値は
[CODE(HTML)@en[[[_blank]]]] とします。
= 3つ目の[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。既定値は[[空文字列]]とします。
ただし [[null]] は[[空文字列]]とします ([CODE(IDL)@en[[[TreatNullAs=EmptyString]]]])。
= 4つ目の[[引数]]は [CODE(IDL)@en[[[boolean]]]] として解釈します。既定値は[[偽]]とします。
= [CODE(DOMi)@en[[[Window]]]] 用の処理を実行します。
]FIG]

[8] [CODE(DOMi)@en[[[Document]]]] [[インターフェイス]]の
[DFN[[CODE(DOMm)@en[[[open]]]]]] [[メソッド]]は、現在の[[文書]]を
[CODE(JS)@en[[[document.write]]]] によって指定した [[HTML]] ソースコードで置き換えるべく、
現在の内容を消去して[[構文解析器]]を起動するものです。次の[[引数]]があります。
[FIG(table)[
:n:
:t:[[型]]
:o:省略
:d:説明

:n:1
:t:[CODE(IDL)@en[[[DOMString]]]]
:o:省略可能
:d:[[MIME型]] (実用上 [CODE(MIME)@en[[[text/html]]]] のみ利用可能)

:n:2
:t:[CODE(IDL)@en[[[DOMString]]]]
:o:省略可能
:d:[CODE[[[replace]]]] なら[[置換有効]]、[[空文字列]] (既定値) なら無効
]FIG]

;; [74] このメソッドは [[DOM0]] 時代のもので、現在では通常の [[DOM木]]の操作を用いるべきと一般的には考えられています。

[73] [CODE(DOMi)@en[[[Document]]]] [[インターフェイス]]の
[CODE(DOMm)@en[[[open]]]] [[メソッド]]は、次のように処理しなければ[['''なりません''']]
[SRC[>>7]]。
[FIG(steps)[
= [[引数]]が3つ[[以上]]あれば、
== 最初の3つの[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。
== 4つ目の[[引数]]は [CODE(IDL)@en[[[boolean]]]] として解釈します。既定値は[[偽]]とします。
== [[文脈オブジェクト]]の [CODE(DOMi)@en[[[Window]]]] [[オブジェクト]]があれば、
=== その [CODE(DOMi)@en[[[Window]]]] 用の処理を実行します。
= それ以外なら、
== 最初の[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。既定値は
[CODE(MIME)@en[[[text/html]]]] とします。
== 2つ目の[[引数]]を [CODE(IDL)@en[[[DOMString]]]] として解釈します。既定値は[[空文字列]]とします。
== [CODE(DOMi)@en[[[Document]]]] 用の処理を実行します。
]FIG]

;; [69] [CODE(JS)@en[[[document.open]]]] 相当の処理は、 [CODE(JS)@en[[[document.write]]]]
から呼び出されることがあります。

* [CODE(DOMi)@en[Window]] 用の処理

[33] 次のようにしなければ[['''なりません''']] [SRC[>>31]]。
[FIG(steps)[
= [34] [VAR[[[始点閲覧文脈]]]]を、[[入口設定群オブジェクト]]の[[有責閲覧文脈]]とします。
= [40] [[閲覧文脈の選択]]を行います。
=- [41] 第2引数を[[閲覧文脈名]]として引き渡します。
=- [42] [VAR[対象閲覧文脈]]を、選ばれた[[閲覧文脈]]とします。
=- [44] 選択中に[VAR[[[置換有効]]]]と[VAR[明示的自己ナビゲーション上書き]]のフラグが設定されることがあります。
=- [79] 新しい[[補助閲覧文脈]]が開かれる場合、第3引数 [VAR[features]]
の処理 (>>77) が呼び出されます。[VAR[機能群]]を、構文解析結果に設定します。
新しい[[補助閲覧文脈]]を開かない場合は、[VAR[機能群]]を、空集合に設定します。
= [76] [VAR[対象閲覧文脈]]が「なし」なら、
[CODE(DOMe)@en[[[InvalidAccessError]]]] [[例外]]を投げ、ここで停止します。
= 第1引数が[[空文字列]]以外なら、
== 第1引数について[[入口設定群オブジェクト]]の[[API基底URL]]について[[URLの解決]]を行います。
== 解決が失敗したら、
=== 第1引数を[[空文字列]]に設定しても構いません。
=== そうでなければ、[VAR[新しい[[資源]]]]はエラーページとします ([[navigate]] の非文書の項を参照)。
== そうでなければ、
=== [VAR[新しい[[資源]]]]は、解決結果の [[URL]] とします。
= 第1引数が[[空文字列]]なら、
== [VAR[[[置換有効]]]]が[[偽]]なら、
=== [VAR[対象閲覧文脈]]の [CODE(DOMi)@en[[[WindowProxy]]]] [[オブジェクト]]を返し、停止します。
== それ以外なら、
=== [VAR[新しい[[資源]]]]は、 [[URL]] [CODE(URI)@en[[[about:blank]]]] とします。
= [90] [VAR[新しい[[資源]]]]が [[URL]] [CODE(URI)@en[[[about:blank]]]] で[VAR[[[置換有効]]]]が[[真]]なら、
== [91] [[タスク]]を[[タスクキュー]]に追加します。
[FIG(list members)[
[FIGCAPTION[
[[タスク]]
]FIGCAPTION]
:[[タスク源]]:?
:処理:
[FIG(steps)[
= [89] [[単純イベントを発火]]します。
[FIG(list members)[
[FIGCAPTION[
[[単純イベント]]
]FIGCAPTION]
:[[イベント型]]:[CODE(DOMe)@en[[[load]]]]
:[[対象]]:[VAR[対象閲覧文脈]]の [CODE(DOMi)@en[[[Window]]]] [[オブジェクト]]
:[[target override]]:[VAR[対象閲覧文脈]]の [CODE(DOMi)@en[[[Window]]]] [[オブジェクト]]の[[文書]]
]FIG]
]FIG]
]FIG]
= [78] それ以外なら、
== [[navigate]] します。
[FIG(list members)[
:[[navigate]] する[[閲覧文脈]]:[VAR[対象閲覧文脈]]
:新しい[[資源]]:[VAR[新しい[[資源]]]]
:[[例外有効]]:[[真]]
:[[置換有効]]:[VAR[[[置換有効]]]]
:[[始点閲覧文脈]]:[VAR[始点閲覧文脈]]
:[[明示的自己ナビゲーション上書き]]:[VAR[[[明示的自己ナビゲーション上書き]]]]
]FIG]
= [100] [VAR[機能群]]に [CODE[[[noopener]]]] が指定されていれば、
== [104] [VAR[対象閲覧文脈]]について [[disown]] します ([CODE(JS)@en[[[window.opener]]]] 参照)。
== [101] [[null]] を返します。
= [102] それ以外なら、
== [103] [VAR[対象閲覧文脈]]の [F[[CODE(DOMi)@en[[[WindowProxy]]]] [[オブジェクト]]]]を返します。
]FIG]

;; [81] [[Chrome]] は[[ポップアップ]]がブロックされた場合 ([VAR[対象閲覧文脈]]が無い場合)
に [CODE(JS)@en[[[undefined]]]] を返し、[[例外]]は投げないようです。 [TIME[2015-07-19T02:02:52.700Z]]

* [CODE(DOMi)@en[Document]] 用の処理

[46] 次のようにしなければ[['''なりません''']]。

[FIG(steps)[
= [118] 事前条件確認:
== [119] [[文書]]が [[HTML文書]]でなければ、
=== [120] [CODE(DOMe)@en[[[InvalidStateError]]]] [[例外]]を投げ、停止します [SRC[>>7]]。
== [121] [[文書]]が[[活性文書]]でなければ、
=== [122] [[文脈オブジェクト]]を返します。
=== [123] 停止します [SRC[>>7]]。
== [128] [[文書]]の[F[[[文書の起源]]]]が[[入口設定群オブジェクト]]の[F[[[有責文書]]]]の[F[[[文書の起源]]]]と[[同じ起源]]でなければ、
=== [129] [CODE(DOMe)@en[[[SecurityError]]]] [[例外]]を投げ、停止します [SRC[>>7]]。
== [124] [[文書]]が[[活性構文解析器]]を持ち、その [[script nesting level]] が[[正]]なら、
=== [125] [[文脈オブジェクト]]を返し、停止します [SRC[>>7]]。
== [126] [[文書]]の [[ignore-opens-during-unload counter]] が[[正]]なら、
=== [127] [[文脈オブジェクト]]を返し、停止します [SRC[>>7]]。
= [VAR[型]]:
== 第''1''引数が [CODE[[[replace]]]] ([[ASCII大文字・小文字不区別]]) なら、
=== [VAR[型]]を、 [[HTML]] に設定します [SRC[>>7]]。
== それ以外で、第1引数から [CODE[[[;]]]] とそれ以降を (あれば) 削除してから、
先頭と末尾から[[HTMLの空白文字]]を (あれば) 削除し、
[CODE(MIME)@en[[[text/html]]]] ([[ASCII大文字・小文字不区別]]) となれば、
=== [VAR[型]]を、 [[HTML]] に設定します [SRC[>>7]]。
== それ以外なら、
=== [VAR[型]]を、[[平文]]に設定します [SRC[>>7]]。
= [VAR[置換]]:
== 第2引数が [DFN[[CODE[[[replace]]]]]] ([[ASCII大文字・小文字不区別]]) なら、
=== [VAR[置換]]を、[[真]]に設定します [SRC[>>7]]。
== それ以外で、
[FIG(list)[
- [[文書]]の[[閲覧文脈]]の[[セッション履歴]]が[[文書]]を1つだけ含み、
- それが[[初期「[CODE(URI)@en[about:blank]]」文書]]で、
- その[[文書]]について [[unload a document]] が呼ばれていないなら、
]FIG]
=== [VAR[置換]]を、[[真]]に設定します [SRC[>>7]]。
== それ以外なら、
=== [VAR[置換]]を、[[偽]]に設定します [SRC[>>7]]。
=== [56] [VAR[新しい[[セッション履歴エントリー]]]]を作成します。
[FIG(list members)[
[FIGCAPTION[
[[セッション履歴エントリー]]
]FIGCAPTION]
:[[navigate]] の[[引数]]の新しい[VAR[資源]]:[[応答]]は、
[FIG(list members)[
[FIGCAPTION[
[[応答]]
]FIGCAPTION]
:[CODE(HTTP)@en[[[Content-Type]]]]:[CODE(MIME)@en[[[text/html]]]]
:[[本体]] ([[文字列]]):[[文書]]の[[構文解析器]]の[[構文解析]]したテキスト [SRC[>>7]] (≒ [[reload override buffer]])
]FIG]
:[[文書]]:なし [SRC[>>7]]
:その他:現在の[[文書]]の状態 [SRC[>>7]]
:[[上書きURL]]:[[文書の番地]] [SRC[明記されておらず]]
:[[reload override flag]]:[[真]] [SRC[明記されておらず]]
]FIG]
= [[unload]]:
== [[文書]]の [[''salvageable'']] を[[偽]]に設定します [SRC[>>7]]。
== [[prompt to unload a document]] を実行します [SRC[>>7]]。
== [[refused to allow the document to be unloaded]] が返されたら、
=== [CODE(JS)@en[[[document.write]]]] からの呼び出しなら、
[[refused to allow the document to be unloaded]] を返します。
=== それ以外なら、[[文脈オブジェクト]]を返します [SRC[>>7]]。
=== 停止します [SRC[>>7]]。
== [[unload a document]] を実行します。 [VAR[recycle]] は[[真]]とします。 [SRC[>>7]]
= [87] [[文書]]の新規化:
== [[文書のabort]] を実行します [SRC[>>7]]。
== [[文書節点]]およびそのすべての[[子孫]]に登録された[[イベントリスナー]]を削除します [SRC[>>7]]。
== [[文書]]と関連付けられた[[タスク]]をすべて[[タスクキュー]]から削除します [SRC[>>7]]。
== [108] [[文書]]から[[子供]]をすべて削除します [SRC[>>7]]。
== [110] [VAR[窓]]を、新しい [CODE(DOMi)@en[[[Window]]]] に設定します。
== [109] [CODE[[[InitializeHostDefinedRealm]]]] [[抽象操作]]を実行します [SRC[>>7]]。
[FIG(list members)[
:[[大域オブジェクト]]: [VAR[窓]]
:[[大域[CODE(JS)@en[this]]値]]: [[閲覧文脈]]の [F[[CODE(DOMi)@en[[[WindowProxy]]]]]]
:[[スクリプト]]や[[モジュール]]の[[ソーステキスト]]: なし
]FIG]
== [115] [VAR[realm実行文脈]]を、前項で作成された[[JavaScript実行文脈]]に設定します [SRC[>>7]]。
== [111] [VAR[窓]]の [F[[CODE(DOMi)@en[[[Document]]]]]] を、[[文書]]に設定します [SRC[>>7]]。
== [112] [VAR[realm実行文脈]]について[[閲覧文脈環境設定群オブジェクトの設定]]を行います [SRC[>>7]]。
== [113] [[文書]]の [[singleton]] をすべて[VAR[窓]]の [[realm]]
で新たに作成したものに置き換えます [SRC[>>7]] (>>47)。
== [88] [[文書]]の [F[[CODE(DOMi)@en[[[Window]]]]]] の [F[[[HTTPS状態]]]]を、
[[入口設定群オブジェクト]]の[F[[[有責文書]]]]の [F[[CODE(DOMi)@en[[[Window]]]]]]
の [F[[[HTTPS状態]]]]に設定します [SRC[>>7]]。
== [[文書の文字符号化]]を [[utf-8]] に変更します [SRC[>>7]]。
== [[文書]]の [[''salvageable'']] を[[真]]に設定します [SRC[>>7]]。
== [[文書の番地]]を[[入口設定群オブジェクト]]の[[有責文書]]の[[文書の番地]]に設定します [SRC[>>7]]。
= [[文書]]が [[ready for post-load tasks]] なら、
== [[文書]]の [[reload override flag]] を設定します [SRC[>>7]]。
== [[文書]]の [[reload override buffer]] を[[空文字列]]に設定します [SRC[>>7]]。
= [[文書]]の [[iframe load in progress]] フラグが設定されていれば、
== [[文書]]の [[mute iframe load]] フラグを設定します [SRC[>>7]]。
= 新しい[[HTML構文解析器]]を作成し、[[文書]]に関連付けます [SRC[>>7]]。
[FIG(list members)[
[FIGCAPTION[
[[HTML構文解析器]]
]FIGCAPTION]
:[[script-created parser]]:[[真]]
:[[confidence]]:[[irrelevant]]
]FIG]
= [70] [[文書]]の[[現在文書準備度]]を [CODE[[[loading]]]] とします [SRC[>>7]]。
= [71] [[単純イベントを発火]]します。 [SRC[>>72]]
[FIG(list members)[
[FIGCAPTION[
[[単純イベント]]
]FIGCAPTION]
:[[イベント型]]:[CODE(DOMe)@en[[[readystatechange]]]]
:[[対象]]:[[文書]]
]FIG]
= [VAR[型]]が[[平文]]なら、[[テキストファイルのDOM構築]]を開始します [SRC[>>7]]。
= [[文書]]の[[閲覧文脈]]の[[セッション履歴]]の[[エントリー]]のうち、[[現在エントリー]]よりも後のものを
(あれば) 削除します。 ([[現在エントリー]]は含みません。) [SRC[>>7]]
= [[文書]]の[[閲覧文脈]]の[[セッション履歴]]の[[閲覧文脈]]の[[最上位閲覧文脈]]の[[文書族]]の[[文書]]に関連付けられた[[履歴探索タスク源]]の[[タスク]]を (あれば) [[タスクキュー]]から削除します。 [SRC[>>7]]
= [[文書]]の[[閲覧文脈]]の[[セッション履歴]]の[[エントリー]]のうち、[[現在エントリー]]より前で[[文書]]が同じものを (あれば) 削除します。 [SRC[>>7]]
= [VAR[置換]]が[[偽]]なら、
== [[文書]]の[[閲覧文脈]]の[[セッション履歴]]の[[現在エントリー]]の前に[VAR[新しい[[セッション履歴エントリー]]]]を挿入します。 [SRC[>>7]]
= [[文書]]の[[構文解析器]]の[[挿入点]]を[[入力ストリーム]]の末尾に設定します。 [SRC[>>7]]
= [[文脈オブジェクト]]を返します。 [SRC[>>7]]
]FIG]

[45] [[文書]]は、 [DFN[[[ignore-opens-during-unload counter]]]] を持ちます [SRC[>>7]]。
初期値は 0 です [SRC[>>7]]。 [[prompt to unload a document]] や
[[unload a document]] からの [CODE(JS)@en[[[document.open]]]] を抑制するために使われます。

[51] 第1引数の元々の意図は [[MIME型]]の指定だったようですが、実際には [[HTML]]
かどうかの区別の意味しか無くなっているようです。

[52] しかも元の[[文書]]の[[HTML構文解析器]]の動作中には必ず [[HTML]]
と解釈されるようです。 [[IE]] と [[Firefox]] は[[構文解析器]]の停止後には[[平文]]にも対応するようですが、
[[Chrome]] は常に [[HTML]] と解釈します。 [TIME[2015-05-06T13:57:53.00Z]]

;; [53] [[IE]] は [CODE(URI)@en[[[javascript:]]]] の [[navigate]]
なら正しく処理できますが、 [CODE(DOMa)@en[[[onclick]]]] ではなぜか
[CODE(JS)@en[[[document.write]]]] が反映されずに真っ白な状態になります。

;; [54] デモ:
[REFS[
- [50] [CITE[Index of /~wakaba/test/web/dom/document/writing/open]] ([TIME[2015-05-06 22:54:55 +09:00]] 版) <http://suika.suikawiki.org/~wakaba/test/web/dom/document/writing/open/>
]REFS]

[93] [CODE(JS)@en[[[document.open]]]] は [[DOM0]] 時代の遺物です。当時は[[文書]]の[[要素]]の書き換えができなかった
(せいぜい[[フォーム制御子]]の現在の状態や[[画像]]の [[URL]] を変更できる程度だった)
ので、[CODE(URI)@en[[[data:]]]] [[URL]] もありませんから、
[[クライアント]]側で[[文書]]を生成する必要があれば [CODE(JS)@en[[[document.open]]]]
を使う他ありませんでした。

[94] 現在となっては [CODE(JS)@en[[[document.open]]]] を使うべき理由はまったくありません。
実装により細かな挙動が異なり不安定なので、使うべきではありません。

* 文書の singleton オブジェクトの置き換え

[47] [[文書]]の [[singleton]] を置き換える際、具体的にどの[[オブジェクト]]が該当するかは、
例示にとどまっていて、完全なリストはありません。

[48] 次のものが該当します。
[FIG(list)[
- [CODE(DOMi)@en[[[Window]]]] と[[環境設定群オブジェクト]] [SRC[>>7]]
-- [CODE(DOMi)@en[[[Location]]]] [SRC[>>7]]
-- [CODE(DOMi)@en[[[History]]]] [SRC[>>7]]
-- [CODE(DOMi)@en[[[ApplicationCache]]]] [SRC[>>7]]
-- [CODE(DOMi)@en[[[Navigator]]]] [SRC[>>7]]
--- [CODE(DOMi)@en[[[PluginArray]]]]
---- [CODE(DOMi)@en[[[Plugin]]]]
--- [CODE(DOMi)@en[[[MimeTypeArray]]]]
---- [CODE(DOMi)@en[[[MimeType]]]]
-- 各種 [CODE(DOMi)@en[[[BarProp]]]] [SRC[>>7]]
-- 両 [CODE(DOMi)@en[[[Storage]]]] [SRC[>>7]]
-- [CODE(DOMi)@en[[[Selection]]]] [SRC[>>7]]
- 各種 [CODE(DOMi)@en[[[HTMLCollection]]]] [SRC[>>7]]
- [[Web IDL]] [[プロトタイプ]] [SRC[>>7]]
]FIG]

[49] [[大域オブジェクト]]も置き換わるので、他のフラグの再設定も合わせて、
[CODE(DOMa)@en[[[document]]]] [[オブジェクト]]への参照がすべて別の[[文書]]に書き換わったのとほぼ同じ結果となるようです。しかし引き継がれる状態もあるようです。

[62] 自[[文書]]を [CODE(JS)@en[[[document.open]]]] する[[スクリプト]]の
[CODE(JS)@en[[[document.open]]]] 前に [CODE(DOMa)@en[[[window]]]] の [[expando]]
を設定し、後に参照すると、 [[IE]] と [[Firefox]] では [CODE(JS)@en[[[undefined]]]]
になっていますが (仕様通り)、 [[Chrome]] では前と同じ値が得られます。
[TIME[2015-05-07T00:32:37.800Z]]

[63] [CODE(JS)@en[[[var]]]] で宣言した変数はどのブラウザーでも前後同じ値が得られます。
前に [CODE(JS)@en[[[var]]]] で宣言した変数に後で [CODE(JS)@en[[[window]]]]
からアクセスしてもどのブラウザーでも [CODE(JS)@en[[[undefined]]]] になります。
前に [[expando]] で設定したのと同じ名前の [CODE(JS)@en[[[var]]]] に後でアクセスしても、
どのブラウザーでも [CODE(JS)@en[[[undefined]]]] になります。
[TIME[2015-05-07T00:37:34.100Z]]

[64] [[Chrome]] では [CODE(JS)@en[[[history]]]] や [CODE(JS)@en[[[location]]]]
や [CODE(JS)@en[[[document.forms]]]] にアクセスしても、前と同じ値が得られます。
[[IE]] と [[Firefox]] では違う値になります。 [TIME[2015-05-07T00:42:56.400Z]]

[82] [[Chrome]] では[[適切な雛形内容所有子文書]]は変化しないように見えます。 [TIME[2015-07-19T09:54:06.700Z]]

* 履歴移動

[60] [CODE(JS)@en[[[document.open]]]] で作られた[[文書]]の再読込や履歴の移動も、
あたかも通常のページであるかのように扱われることが意図されているようですが、
実装も仕様書も不安定な状態のようです。

[65] [[閲覧文脈]][VAR[閲覧文脈]]の[[再読込]]は、 [CODE(JS)@en[[[document.open]]]] 後の時、
通常の処理ではなく [[overridden reload]] となります。
[DFN[[[overridden reload]]]] は次のようにしなければ[['''なりません''']]。

[FIG(steps)[
= [84] 次の通り [[navigate]] します。
[FIG(list members)[
:[F[[[navigate]] する[[閲覧文脈]]]]: [VAR[[[閲覧文脈]]]]
:[F[新しい[[資源]]]]: 新しい[[応答]] [SRC[>>58]] で、
[FIG(list members)[
[FIGCAPTION[
[96] [[応答]]
]FIGCAPTION]
:[F[[[HTTPS状態]]]]: [VAR[[[閲覧文脈]]]]の[F[[[活性文書]]]]の [F[[[HTTPS状態]]]] [SRC[>>58]]
:[F[[[CSPリスト]]]]: [VAR[[[閲覧文脈]]]]の[F[[[活性文書]]]]の[F[[[CSPリスト]]]] [SRC[>>58]]
:[F[[[ヘッダーリスト]]]]:
[FIG(list members)[
:[CODE(HTTP)@en[[[Content-Type]]]]:[CODE(MIME)@en[[[text/html]]]]
]FIG]
:[F[[[本体]]]] ([[文字列]]): [VAR[[[閲覧文脈]]]]の[F[[[活性文書]]]]の 
[F[[[reload override buffer]]]] の値 [SRC[>>58]]
]FIG]
:[F[[[始点閲覧文脈]]]]:[[引数]]として指定されたもの [SRC[>>58]]
:[F[[[reload override flag]]]]:[[真]] [SRC[>>58]]
:[F[[[上書きURL]]]]: [VAR[[[閲覧文脈]]]]の[F[[[活性文書]]]]の[F[[[文書の番地]]]] [SRC[>>58]]
:[F[キャッシュ上書き]]: [[引数]]として指定されたもの
]FIG]
]FIG]

;; [66] [[HTML Standard]] は[F[キャッシュ上書き]]フラグに言及していませんが、
本 [[navigate]] が作成した[[文書]]からの [[fetch]] に影響するかもしれません
(ししないかもしれません)。

;; [67] [CODE(JS)@en[[[location.reload]]]] も参照。

[59] [[文書]]は、 [DFN[[F[[[reload override flag]]]]]] と
[DFN[[F[[[reload override buffer]]]]]] を持ちます [SRC[>>58]]。
初期状態では未設定で [SRC[>>58]]、 [CODE(JS)@en[[[document.open]]]] 
などが設定することがあります。

[61] [[IE]] と [[Firefox]] は [[overridden reload]] に対応しているようですが、
[[Chrome]] は対応していないようです。 [TIME[2015-05-06T08:14:43.800Z]]

[55] [[IE]] は[[平文]]を [CODE(JS)@en[[[location.reload]]]] した後も[[平文]]として扱うようです。
[[Firefox]] は[[平文]]でも [CODE(JS)@en[[[location.reload]]]] 後に [[HTML]]
にしてしまうようです。現在の [[HTML Standard]] は [[Firefox]]
の動作です。 [TIME[2015-05-06T14:10:21.200Z]]

[68] [CODE(JS)@en[[[document.open]]]] で作られた[[文書]]から他の[[文書]]に移動したら、
元の[[文書]]は通常通り処理されます。 [CODE(JS)@en[[[document.open]]]]
から再度 [CODE(JS)@en[[[document.open]]]] を再度実行したら、
前の状態は [CODE(JS)@en[[[document.write]]]] で生成されたソースコードで保存されます
(>>56)。

[57] >>56 は [[Firefox]] の動作で、 [[IE]] は[[文書]]の [F[[[reload override flag]]]]
が[[偽]]なら [[navigate]] の新しい[[資源]]をソースでなく [[URL]] としているようです。
(最初の [CODE(JS)@en[[[document.open]]]] より前の[[セッション履歴エントリー]]に戻った時にネットワークアクセスが発生します。そちらの仕様なら、 [[script-created parser]] でない普通の[[構文解析器]]の時に、[[構文解析]]したテキストを保持し続けずに済みます。)
[TIME[2015-05-06T15:18:32.400Z]]

* [VAR[features]] 引数の処理

[80] 新しい[[補助閲覧文脈]]が開かれる場合 ([[ポップアップ]]の場合)、
第3引数 [DFN[[VAR[features]]]] の指示が適用されます。

[77] [VAR[対象閲覧文脈]]が新しい[[閲覧文脈]]かつ[[補助閲覧文脈]]なら [SRC[>>243]]、
[[CSSOM View]] の規定を適用しなければ[['''なりません''']] [SRC[>>231]]。

@@ XX

[FIG(short list)[
- [CODE(HTML)@en[[[noopener]]]]
]FIG]

* 歴史

[5]
[CITE[Latest topics > Chromeウィンドウを最前面にする・最背面にする - outsider reflex]] ([[Piro(SHIMODA Hiroshi)]] 著, [CODE[2007-09-29 12:59:12 +09:00]] 版) <http://piro.sakura.ne.jp/latest/blosxom/mozilla/xul/2007-09-26_zlevel.htm>
([[名無しさん]])

[6]
[[Firefox]] 2、[[Safari]] 3.1.1、[[Opera]] 9.27 
のいずれも、
[CODE(DOMm)@en[[[createDocument]]]] で作成した [CODE(DOMi)@en[[[Document]]]]
は [CODE(DOMi)@en[[[HTMLDocument]]]] ではなく、したがって
[CODE(JS)@en[[[document]].[[open]]()]] は使えないようです。


[9]
[CITE@ja[ブラウザごとのwindowオブジェクトの違いを理解する :CodeZine]] ([TIME[2008-10-25 14:23:50 +09:00]] 版) <http://codezine.jp/article/detail/3065?p=4>

[10] [CITE[Bug 325352 – document.open doesn't clear the document]] ([TIME[2008-11-30 18:28:19 +09:00]] 版) <https://bugzilla.mozilla.org/show_bug.cgi?id=325352>

[11] [CITE[window.openでポップアップブロックされた時の挙動はブラウザによって違う - SEの行き着くところ…]] ([TIME[2009-04-19 17:07:23 +09:00]] 版) <http://d.hatena.ne.jp/AWAWA/20090414/1239691058>

[12]
>>11 <http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#dom-open>,
<http://www.whatwg.org/specs/web-apps/current-work/multipage/browsers.html#the-rules-for-choosing-a-browsing-context-given-a-browsing-context-name>

[CODE(JS)@en[[[null]]]] を返すのが仕様上正しい実装かな。不可視の[[閲覧文脈]]が選ばれているとみなすなら [[Opera]] も正しいといえるかも。

[13] [CITE@en[Web Applications 1.0 r7304     Fix an infinite loop. There's no interop here, really, so I tried to find a compromise between what browsers do and keeping the requirements sane and simple. Tests at: http://www.hixie.ch/tests/adhoc/dom/level0/document/open/unload/ -- See also IRC ranting starting at http://krijnhoetmer.nl/irc-logs/whatwg/20120831#l-67 and ending at http://krijnhoetmer.nl/irc-logs/whatwg/20120901#l-140]]
( ([TIME[2012-09-01 08:46:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7303&to=7304>

[14] [CITE[IRC logs: freenode / #whatwg / 20120831]]
( ([TIME[2012-09-07 20:52:20 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20120831>

[15] [CITE[''''''[''''''whatwg'''''']'''''' Details on window.open]]
( ([TIME[2012-12-19 08:53:20 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2012-December/038408.html>

[16] [CITE@en[Web Applications 1.0 r7593 Try to better define how popup blockers work.]]
( ([TIME[2012-12-19 08:48:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7592&to=7593>

[17] [CITE@en[Web Applications 1.0 r7626     Make document.open() do nothing on non-active documents]]
( ([TIME[2012-12-31 14:16:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7625&to=7626>

[18] [CITE@en[Web Applications 1.0 r7729     document.open() legacy hack for compat]]
( ([TIME[2013-03-05 10:07:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=7728&to=7729>

[19] [CITE@en[Web Applications 1.0 r8201     Make the parser not execute scripts pending for the document after document.open() has been called on it.]]
( ([TIME[2013-10-02 03:46:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8200&to=8201>

[20] [CITE@en[Bug 25709 – Take over open() features argument spec http://dev.w3.org/csswg/cssom-view/#the-features-argument-to-the-open()-method]]
( ([TIME[2014-05-17 05:29:27 +09:00]] 版))
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=25709>

[21] [CITE@en-US[Window.open - Web API Interfaces | MDN]]
( ([TIME[2014-03-27 08:00:30 +09:00]] 版))
<https://developer.mozilla.org/en-US/docs/Web/API/Window.open>

[22] [CITE[解決:window.open()を使いつつIEでRefererを渡す方法 - @blog.justoneplanet.info]]
( ([TIME[2014-07-25 00:52:00 +09:00]] 版))
<http://blog.justoneplanet.info/2007/07/18/windowopen%E3%82%92%E4%BD%BF%E3%81%84%E3%81%A4%E3%81%A4ie%E3%81%A7referer%E3%82%92%E6%B8%A1%E3%81%99%E6%96%B9%E6%B3%95/>

[23] [CITE@en[Web Applications 1.0 r8701     Defer to CSSOM View for window.open(..., ..., features, ...)]]
( ([TIME[2014-08-05 03:57:00 +09:00]] 版))
<http://html5.org/r/8701>

[24] [CITE[IRC logs: freenode / #whatwg / 20140820]]
( ([TIME[2014-08-21 02:29:23 +09:00]] 版))
<http://krijnhoetmer.nl/irc-logs/whatwg/20140820#l-856>

[25] [CITE@en[Web Applications 1.0 r8777 Recast window.open() in terms of an algorithm.]]
( ([TIME[2014-09-17 06:23:00 +09:00]] 版))
<https://html5.org/r/8777>

[26] [CITE@en[Web Applications 1.0 r8778 Simplify window.open even further]]
( ([TIME[2014-09-17 06:26:00 +09:00]] 版))
<https://html5.org/r/8778>

[27] [CITE@en[Web Applications 1.0 r8779     Fix window.open('') to be more like deployed browsers rather than defaulting to 'about:blank'.]]
( ([TIME[2014-09-17 06:36:00 +09:00]] 版))
<https://html5.org/r/8779>

[28] [CITE@en[Web Applications 1.0 r8795     Match browsers better]]
( ([TIME[2014-09-20 06:21:00 +09:00]] 版))
<https://html5.org/r/8795>

[29] [CITE@en[Web Applications 1.0 r8816     Make window.open() match browsers better]]
( ([TIME[2014-09-25 07:21:00 +09:00]] 版))
<https://html5.org/r/8816>

[30] [CITE@en[RE: Figuring out the behavior of WindowProxy in the face of  non-configurable properties]]
( ([[Travis Leithead]] 著, [TIME[2015-01-15 10:49:45 +09:00]] 版))
<https://lists.w3.org/Archives/Public/public-script-coord/2015JanMar/0033.html>

[FIG(quote)[
[FIGCAPTION[
[1] [CITE@ja[IE11 の環境で DPI が既定値から変更されていると HTML アプリケーション (.hta) が縮小表示される]]
([TIME[2015-02-16 12:47:44 +09:00]] 版)
<http://support.microsoft.com/kb/2923604/ja>
]FIGCAPTION]

> Internet Explorer 11 の環境で、DPI 値 を既定の 100% から変更していると、HTML アプリケーション (.hta) が縮小表示される場合があります。
> HTML アプリケーションが frame 構造で、frame 内のコンテンツより window.open を使用して同一 frame 内にコンテンツを表示する場合、縮小表示される現象が発生します。 

]FIG]

[3] [[Gecko]]、[[Opera]] は [CODE(JS)@en[[[document.open]]]] [[メソッド]]で開かれた[[文書]]の
[[charset]] を [[UTF-8]]、 [[WinIE]] は [[UTF-16]] ([CODE(charset)@en[[[unicode]]]])
にしますが、 [[WebKit]] は元(?)の [[charset]] を引き継ぎます。

[2] [CITE[Part2 - browsersec - Browser Security Handbook, part 2 - Browser Security Handbook - Google Project Hosting]]
([TIME[2015-03-31 16:48:24 +09:00]] 版)
<https://code.google.com/p/browsersec/wiki/Part2#Window_appearance_restrictions>

[4] [CITE@en[717339 – Selection's Ranges should be removed on document.open()]]
([TIME[2015-05-05 19:42:43 +09:00]] 版)
<https://bugzilla.mozilla.org/show_bug.cgi?id=717339>

[35] [CITE[Bug 9726 – Spec the features argument]]
( ([TIME[2010-09-29 01:57:54 +09:00]] 版))
<http://www.w3.org/Bugs/Public/show_bug.cgi?id=9726>

[36] [CITE[Inline Images on Web Pages]]
( ([TIME[2005-10-31 14:52:43 +09:00]] 版))
<http://elf.org/essay/inline-image.html>

[37] [CITE[''''''[''''''whatwg'''''']'''''' location.reload() on document.open()ed documents]]
( ([TIME[2010-12-08 08:41:11 +09:00]] 版))
<http://lists.whatwg.org/htdig.cgi/whatwg-whatwg.org/2010-December/029360.html>

[38] [CITE@en[Web Applications 1.0 r8058     Try to match reality a bit better for popup blockers.]]
( ([TIME[2013-07-16 05:45:00 +09:00]] 版))
<http://html5.org/tools/web-apps-tracker?from=8057&to=8058>

[39] [CITE[''''''[''''''whatwg'''''']'''''' Details on window.open]]
( ([TIME[2013-07-16 07:02:49 +09:00]] 版))
<http://lists.whatwg.org/pipermail/whatwg-whatwg.org/2013-July/040083.html>

[FIG(quote)[
[FIGCAPTION[
[83] [CITE[Web Security Context: User Interface Guidelines]]
([TIME[2010-08-04 20:09:50 +09:00]] 版)
<http://www.w3.org/TR/wsc-ui/#robustness-apis-obscure-security-ui>
]FIGCAPTION]

> Web user agents MUST prevent web content from obscuring, hiding, or disabling user interfaces that display security context information, except in response to a user interaction.
> User agents MUST restrict window sizing and moving operations consistent with section 7.1 Keep Security Chrome Visible. This prevents attacks wherein agent chrome is obscured by moving it off the edges of the visible screen.
> User agents MUST NOT allow web content to open new windows with the agent's security UI hidden. Allowing this operation facilitates picture-in-picture attacks, where artificial chrome (usually indicating a positive security state) is supplied by the web content in place of the hidden UI.
> User agents MUST prevent web content from overlaying chrome. This helps to ensure that user interactions that are perceived to target agent chrome are not redirected to Web applications.

]FIG]


[85] [CITE@en[Integrate Fetch into HTML · whatwg/html@7c5555a]]
([TIME[2015-09-18 18:00:18 +09:00]] 版)
<https://github.com/whatwg/html/commit/7c5555a16f2920c02244c10756bb2f1a11e87a22>

[86] [CITE@en[Add 'HTTPS state' to settings objects · whatwg/html@6de5241]] ([TIME[2015-09-29 23:41:32 +09:00]] 版) <https://github.com/whatwg/html/commit/6de524157fcf341e10efb3eec634bcf7325e6ee4>

[FIG(quote)[
[FIGCAPTION[
[92] [CITE@ja[window.open() の dialog オプションは非対応となりました | Firefox サイト互換性情報]]
([TIME[2015-11-05 06:12:09 +09:00]] 版)
<https://www.fxsitecompat.com/ja/docs/2015/dialog-option-for-window-open-is-no-longer-supported/>
]FIGCAPTION]

> window.open メソッドの dialog オプションが Web コンテンツから使用できなくなりました。この非標準機能は、最小化、最大化、復元ボタンをウィンドウのタイトルバーから取り除くものでしたが、Windows 版の Firefox とその他 Gecko ベースのブラウザしか対応していませんでした。

]FIG]

[95] [CITE@en[Add and populate global object's "CSP list" · whatwg/html@479dfbf]] ([TIME[2015-11-06 22:58:26 +09:00]] 版) <https://github.com/whatwg/html/commit/479dfbf1ff68b746ed3f81cc7415165e3342709e>

[97] [CITE@en[Move 'HTTPS state' from Window to Document · whatwg/html@68390ce]] ([TIME[2015-11-06 23:19:37 +09:00]] 版) <https://github.com/whatwg/html/commit/68390cea99f9f19881a16e1c8adaf1b130b4d1cc>

[99] [CITE@en[Add a 'noopener' <link rel> keyword and window feature · whatwg/html@2992ea9]] ([TIME[2015-11-12 22:22:48 +09:00]] 版) <https://github.com/whatwg/html/commit/2992ea921bc75e44157451a37a807a8ce0b9a884>

[98] [CITE@en[Per #290 window.open() can now return null · whatwg/html@1cf1475]]
([TIME[2015-11-08 16:36:26 +09:00]] 版)
<https://github.com/whatwg/html/commit/1cf14758fda3d7c157c0a89334bd3bc0cad7686e>

[105] [CITE@en[27419 – Need to define that document.open() also creates a new Realm and global environment record per https://esdiscuss.org/topic/relationship-between-globals-realms-and-global-environment-records]]
([TIME[2015-12-16 12:29:04 +09:00]] 版)
<https://www.w3.org/Bugs/Public/show_bug.cgi?id=27419>

[106] [CITE@en[Remove the storage mutex due to lack of implementation · whatwg/html@1b918cf]] ([TIME[2015-12-16 14:38:10 +09:00]] 版) <https://github.com/whatwg/html/commit/1b918cf72fcbba011f83b92ab5d1f483fb1cafa3>

[107] [CITE@en[Rewrite global object initialization to delegate to ES · whatwg/html@cf0355d]]
([TIME[2015-12-16 19:05:13 +09:00]] 版)
<https://github.com/whatwg/html/commit/cf0355d7e0e229b98f7fbd51b8c7608010c787f5>

[114] [CITE@en[Rewrite script execution on top of ES · whatwg/html@4891d18]]
([TIME[2015-12-23 01:03:30 +09:00]] 版)
<https://github.com/whatwg/html/commit/4891d18aaf2df1d40aa61f467a5a10cfc19dd85d>

[FIG(quote)[
[FIGCAPTION[
[116] [CITE[Windows XP SP2上でのwindow.open: Oka Laboratory 備忘録]]
([TIME[2016-01-18 20:49:58 +09:00]] 版)
<http://okalab.cocolog-nifty.com/blog/2004/11/windows_xp_sp2w.html>
]FIGCAPTION]

> 例えば<a>タグ内にwindow.openを組み込んでいる場合、開いた別窓の下部にステータスバーが常時表示されてしまいます。またアドレスバーを非表示に設定しているときはタイトルバーのタイトルの前にドメイン名が表示されます。

]FIG]


[117] [CITE@en[Fix #536: abort document.open() if origins mismatch · whatwg/html@05599ab]]
([TIME[2016-01-29 17:57:18 +09:00]] 版)
<https://github.com/whatwg/html/commit/05599abc3f79d5ef644f9a8464532cc4626a3d46>