head	1.5;
access;
symbols
	suika-20100509:1.1
	before-graph-20090923:1.1;
locks; strict;
comment	@# @;
expand	@b@;


1.5
date	2014.03.28.13.28.46;	author wakaba;	state Exp;
branches;
next	1.4;

1.4
date	2014.03.28.13.23.28;	author wakaba;	state Exp;
branches;
next	1.3;

1.3
date	2014.03.28.13.21.08;	author wakaba;	state Exp;
branches;
next	1.2;

1.2
date	2014.03.28.13.02.04;	author wakaba;	state Exp;
branches;
next	1.1;

1.1
date	2008.11.15.10.48.42;	author wakaba;	state Exp;
branches;
next	;


desc
@@


1.5
log
@updated by (anon)
@
text
@[3] [DFN[[RUBYB[実体が宣言されていること]@@en[Entity Declared]]]]は、[[実体参照]]によって[[参照]]されている[[実体]]が存在することを要求する
[[XML]] の[[整形式制約]]・[[妥当性制約]]です。

* 仕様書

[REFS[
- [4] [CITE@@EN[Extensible Markup Language (XML) 1.0 (Fifth Edition)]] ([TIME[2013-05-28 20:49:56 +09:00]] 版) <http://www.w3.org/TR/xml/#wf-entdeclared>
]REFS]

* 定義

** 整形式制約「実体が宣言されていること」

>
[5] [[DTD]] のない[[文書]]、[[引数実体参照]]のない[[内部DTD部分集合]]のみの[[文書]]、
[CODE(XML)@@en[[[standalone]]="[[yes]]"]] のある[[文書]]にあっては、
[[外部部分集合]]内や[[引数実体]]内以外に現れる[[実体参照]]について、
[[実体参照]]内の [CODE(XML)@@en[[[Name]]]] は[[外部部分集合]]内や[[引数実体]]内以外に現れる[[実体宣言]]の
[CODE(XML)@@en[[[Name]]]] に[[一致]]しなければ[['''なりません''']]。
ただし、[[整形式]][[文書]]は[[実体]] [CODE(XML)@@en[[[amp]]]], [CODE(XML)@@en[[[lt]]]],
[CODE(XML)@@en[[[gt]]]], [CODE(XML)@@en[[[apos]]]], [CODE(XML)@@en[[[quot]]]] を[[宣言]]する必要はありません。
[[一般実体]]の[[宣言]]は、[[属性並び宣言]]中の[[既定値]]に現れるその[[実体]]への[[参照]]より前になければ[['''なりません''']]。
>
なお、[[妥当性]]を[[検証]]しない[[処理器]]は[[引数実体]]や[[外部部分集合]]に現れる[[実体宣言]]を[[読み]]、
[[処理]]する義務はありません。そのような[[文書]]にあっては、[[実体]]が[[宣言]]されなければならないとの規則は
[CODE(XML)@@en[[[standalone]]="[[yes]]"]] の時のみ[[整形式制約]]となります。
[SRC[>>4]]

** 妥当性制約「実体が宣言されていること」

>
[6] [[外部部分集合]]や[[引数実体参照]]のある[[文書]]では、
[[文書]]が[[単独]]である ([CODE(XML)@@en[[[standalone]]="[[no]]"]] が指定されているか、
[[単独宣言]]がない) 場合には、[[実体参照]]の [CODE(XML)@@en[[[Name]]]] は[[実体宣言]]の [CODE(XML)@@en[[[Name]]]]
に[[一致]]しなければ[['''なりません''']]。
[[相互運用性のために]]、[[妥当]]な[[文書]]は [CSECTION@@en[4.6 [[定義済み実体]]]]に定義する通りの形で[[実体]]
[CODE(XML)@@en[[[amp]]]], [CODE(XML)@@en[[[lt]]]],
[CODE(XML)@@en[[[gt]]]], [CODE(XML)@@en[[[apos]]]], [CODE(XML)@@en[[[quot]]]]
を[[宣言]]する[['''べきです''']]。[[引数実体]]の[[宣言]]はその[[実体]]への[[参照]]より前になければ[['''なりません''']]。
同様に[[一般実体]]の[[宣言]]は、[[属性並び宣言]]中の[[既定値]]に現れるその[[実体]]への直接または間接の[[参照]]より前になければ[['''なりません''']]。
[SRC[>>4]]

* 整形式制約と妥当性制約

[7] [[整形式制約]]と[[妥当性制約]]により、[[妥当]]な [[XML文書]]はすべての[[実体参照]]について[[実体宣言]]が含まれていることが要求されています。
ただし[[定義済み実体]]については [['''MUST''']] ではなく [['''SHOULD''']] となっています。

;; [8] 厳密に文言通り読むと[[定義済み実体]]についても[[妥当性制約]]の [['''MUST''']] の適用範囲から除外されていないのですが、
そう解釈すると [['''SHOULD''']] が意味をなさなくなるので、例外を規定しているものと読むべきでしょう。

[9] [[XML処理器]]は次のように[[文書]]を処理しながら状態を管理することで、ある[[実体参照]]についてどちらの制約が適用されるか決定できます。
[FIG[
- [12] 初期状態では[[整形式制約]]とする。
- [10] [[XML宣言]]に [CODE(XML)@@en[[[standalone]]="[[yes]]"]] が含まれていれば、[[整形式制約]]であり、以降の条件は無視する。
- [11] [[引数実体参照]]があると[[妥当性制約]]とする。
- [13] [[文書型宣言]]に[[システム識別子]]があると[[妥当性制約]]とする。
]FIG]

[14] ただし最初の[[引数実体参照]]より前に[[属性定義並び宣言]]があり、[[既定値]]に[[一般実体参照]]がある場合、
遡って (または先読みして) [[妥当性制約]]とする必要があります。従って上から下へと1パスで処理しながらどちらか決定することはできません。

[17] 逆に[[文書]]の[[構文解析]]が完了した段階で「[[実体が宣言されていること]]」がいくつか検出されていた場合に、
[[整形式制約]]違反か[[妥当性制約]]違反かは次の手順により決定できます。
[FIG[
= [18] 初期状態では[[整形式制約]]とします。
= [20] [CODE(XMLa)@@en[[[xmlStandalone]]]] が[[真]]なら、[[整形式制約]]として停止します。
= [19] [[文書型宣言]]に[[システム識別子]]があれば[[妥当性制約]]とします。
= [21] [[引数実体]]を展開しようとした形跡があれば[[妥当性制約]]とします。
= [22] 現在の値を返します。
]FIG]

* Web ブラウザー

[15] [[Webブラウザー]]は ([[文字実体参照]]が含まれる特別なものを除き) [[外部部分集合]]や[[引数実体参照]]を展開しないので、
[[引数実体参照]]に関する[[実体が宣言されていること]]制約違反は無視されます。

[16] [[Webブラウザー]]は[[定義済み実体]]以外の[[一般実体参照]]について[[一般実体]]が[[参照]]されていなければ、
[[DTD]] や[[単独文書宣言]]の有無に関わらず、[[致死的誤り]]とみなします。

* メモ
[1]
<http://suika.fam.cx/~wakaba/-temp/test/xml/entity/ref-declared/param-in-internal-subset/pini-1.xml>:
[PRE(XML example code)[
<!DOCTYPE root [%a;]><root/>
]PRE]

([[名無しさん]])


[2]
>>1 
- [[Firefox]] 1.5: エラーなしで表示 ([[JavaScriptコンソール]]にもなし)
- [[Opera]] 9: [Q[実体が宣言されていること]]整形式制約違反でエラー画面表示
- [[WinIE]] 6: 引数実体が宣言されていないとエラー画面表示


([[名無しさん]])
@


1.4
log
@updated by (anon)
@
text
@d62 10
@


1.3
log
@updated by (anon)
@
text
@d62 8
@


1.2
log
@updated by (anon)
@
text
@d43 19
@


1.1
log
@converted from SuikaWiki3 <http://suika.fam.cx/gate/cvs/suikawiki/wikidata/page/BCC2C2CEA4ACC0EBB8C0A4B5A4ECA4C6A4A4A4EBA4B3A4C8.txt>
@
text
@d1 53
a53 11

[1]
<http://suika.fam.cx/~wakaba/-temp/test/xml/entity/ref-declared/param-in-internal-subset/pini-1.xml>:
[PRE(XML example code)[
<!DOCTYPE root [%a;]><root/>
]PRE]

([[名無しさん]])


[2]
d59 2
a60 3

([[名無しさん]])

@

